[{"author":"shjie047","title":"1kbçš„JSæ¡†æ¶ - Hyperapp","tags":["å¼€å‘","å‰ç«¯","javascript","frontend","hyperapp","react","web"],"iso8601Date":"2018-04-08T08:00:00+08:00","basename":"hyperapp","body":"\n\n## 1. æ¦‚è§ˆ\n\n[Hyperapp](https://github.com/hyperapp/hyperapp)æ˜¯æœ€è¿‘å¼€æºçš„ä¸€ä¸ªå‰ç«¯webå¼€å‘æ¡†æ¶ï¼Œä½“ç§¯å¾ˆå° -- åªæœ‰**1.4kb**ï¼Œapiå¾ˆç®€å• -- åªæœ‰**ä¸¤ä¸ªå‡½æ•°**: hå’Œappï¼›å€Ÿé‰´äº†Reactã€Reduxå’ŒElmçš„æ€æƒ³,\n\nå®ƒçš„ä¸»è¦è¦ç‰¹ç‚¹æ˜¯ï¼š\n\n* **æœ€å°åŒ–** -- ç”¨æœ€å°‘çš„ä»£ç å®ç°äº†åŒç±»æ¡†æ¶(Reactã€Vueç­‰)çš„æ ¸å¿ƒåŠŸèƒ½\n\n* **é‡å®æ•ˆ** -- åšæŒå‡½æ•°å¼ç¼–ç¨‹æ¥ç®¡ç†çŠ¶æ€(state)ï¼ŒåŒæ—¶æä¾›æœ‰æ•ˆçš„æ–¹æ³•æ¥å¤„ç†è¾¹é™…æ•ˆåº”(side effects)æ¯”å¦‚ï¼šå¼‚æ­¥actionå’ŒDOMæ“ä½œ\n\n* **ç‹¬ç«‹æ€§** -- è‡ªèº«é›†æˆçŠ¶æ€ç®¡ç†å’Œè™šæ‹ŸDOMå¼•æ“(è™šæ‹ŸDOMæ”¯æŒkeyæ›´æ–° && ç”Ÿå‘½å‘¨æœŸäº‹ä»¶)ï¼Œæ²¡æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–\n\n\nä¸‹é¢ç”¨Hyperappå®ç°ä¸€ä¸ª**Counter**çš„demoï¼Œå®ç°äº†ç®€å•çš„åŠ å’Œå‡:\n\n```Javascript\n// ä¸¤ä¸ªAPI\nimport { h, app } from \"hyperapp\"\n\n// çŠ¶æ€\nconst state = {\n  count: 0\n}\n\n// ç”¨actionæ¥æ›´æ–°state\nconst actions = {\n  down: value => state => ({ count: state.count - value }),\n  up: value => state => ({ count: state.count + value })\n}\n\n// ç”¨jsxæ¥ç¼–å†™è§†å›¾\nconst view = (state, actions) => (\n  <div>\n    <h1>{state.count}</h1>\n    <button onclick={() => actions.down(1)}>-</button>\n    <button onclick={() => actions.up(1)}>+</button>\n  </div>\n)\n\n// æŠŠstateï¼Œactionsï¼Œviewè¿æ¥èµ·æ¥å¹¶æ¸²æŸ“åˆ°é¡µé¢çš„bodyå…ƒç´ ä¸Š\napp(state, actions, view, document.body)\n```\n\n## 2. API\n\nHyperappç”±ä¸¤ä¸ªå‡½æ•°APIç»„æˆï¼š**h**å’Œ**app**ã€‚\n\n**h**è¿”å›ä¸€ä¸ªæ–°çš„è™šæ‹ŸDOMèŠ‚ç‚¹æ ‘ï¼Œ**app**æŠŠä¸€ä¸ªæ–°çš„appæ¸²æŸ“åˆ°æŒ‡å®šDOMå…ƒç´ ä¸Šã€‚\n\nä»¥ä¸Šçš„ç¤ºä¾‹éœ€è¦æœ¬åœ°ç¯å¢ƒå®‰è£…ï¼šç¼–è¯‘å™¨ -- Babelæˆ–è€…TypeScriptï¼Œæ‰“åŒ…å·¥å…· -- Parcelæˆ–è€…Webpackï¼Œä½¿ç”¨JSXæ¥ç¼–å†™æ¨¡æ¿éœ€è¦åœ¨**.babelrc**å®‰è£…[transform plugin](https://babeljs.io/docs/plugins/transform-react-jsx)æ¥æ”¯æŒ:\n\n```JSON\n{\n  \"plugins\": [[\"transform-react-jsx\", { \"pragma\": \"h\" }]]\n}\n```\n\n### 2.1 JSX\n\n[JSX](https://en.wikipedia.org/wiki/React_(JavaScript_library)#JSX)æ˜¯JSçš„è¯­è¨€æ‰©å±•ï¼Œå¯ä»¥å†™å‡ºå’ŒHTMLç±»ä¼¼çš„æ ‡ç­¾å¼ç»„ä»¶ï¼Œæµè§ˆå™¨æœ¬èº«ä¸æ”¯æŒJSXï¼Œéœ€è¦é…åˆç¼–è¯‘å™¨æŠŠJSXç¼–è¯‘ä¸ºhyperapp.hå¯ä»¥è°ƒç”¨çš„ä»£ç ã€‚\n\nä½†æ˜¯JSXå¹¶ä¸æ˜¯Hyperappæ‰€å¿…éœ€çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨hyperapp.hçš„apiæ¥ç›´æ¥ç¼–å†™ç»„ä»¶ï¼Œçœå»ç¼–è¯‘JSXçš„æ­¥éª¤ï¼š\n\n```Javascript\n\n// ç›´æ¥ç”¨ `h` æ¥ç¼–å†™\nconst view = (state, actions) =>\n  h(\"div\", {}, [\n    h(\"h1\", {}, state.count),\n    h(\"button\", { onclick: () => actions.down(1) }, \"-\"),\n    h(\"button\", { onclick: () => actions.up(1) }, \"+\")\n  ])\n```\n\n## 3. æ¶æ„\n\nHyperappç¼–å†™çš„åº”ç”¨ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š**state**ã€**action**å’Œ**view**\n\nåœ¨ç¨‹åºåˆå§‹åŒ–å®Œæˆåï¼Œæ•´ä¸ªappä¼šå¤„äºä¸€ä¸ªæŒç»­çš„å¾ªç¯æ‰§è¡Œé‡Œã€‚é€šè¿‡ç”¨æˆ·æˆ–è€…å¤–éƒ¨äº‹ä»¶äº§ç”Ÿçš„actionæ¥æ›´æ–°stateï¼Œç”¨virtual domæ¥å±•ç¤ºviewå±‚çš„æ”¹åŠ¨ã€‚å¯ä»¥æŠŠactionå½“ä½œä¸€ä¸ªé€šçŸ¥Hyperappæ›´æ–°çŠ¶æ€é‡ç»˜viewçš„ä¿¡å·ï¼Œå½“actionå¤„ç†å®Œåï¼Œç”¨æˆ·ä¼šçœ‹åˆ°æ–°çš„çŠ¶æ€(state)ã€‚\n\n### 3.1 State\n\n`State`æ˜¯ä¸€ä¸ªæ‰å¹³å¯¹è±¡ï¼Œå­˜å‚¨appçš„æ‰€æœ‰åŠ¨æ€æ•°æ®ï¼Œç”¨æ¥æè¿°appçš„çŠ¶æ€ã€‚`State`åœ¨ç¨‹åºåˆ›å»ºåä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡`Action`æ¥æ›´æ–°ã€‚\n\n```Javascript\nconst state = {\n  count: 0\n}\n```\n`State`å¯ä»¥å…è®¸åµŒå¥—ï¼š\n\n```Javascript\nconst state = {\n  top: {\n    count: 0\n  },\n  bottom: {\n    count: 0\n  }\n}\n```\n\n### 3.2 Actions\n\næ”¹å˜`State`çš„å”¯ä¸€æ–¹å¼æ˜¯é€šè¿‡`Action`ã€‚`Action`æ˜¯ä¸€ä¸ªä¸€å…ƒå‡½æ•°ï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼›actioné€šè¿‡è¿”å›**éƒ¨åˆ†state**æ¥æ›´æ–°**å½“å‰state**ï¼Œ**æ–°çš„state**æ˜¯actionè¿”å›çš„**éƒ¨åˆ†state**å’Œ**å½“å‰state**çš„ç»„åˆã€‚\n\n```Javascript\nconst actions = {\n  setValue: value => ({ value })\n}\n```\n\n`Action`è¿˜å¯ä»¥è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°æ¥æ”¶å½“å‰stateå’Œactionä¸ºå‚æ•°ï¼Œè¿”å›éƒ¨åˆ†state:\n\n```Javascript\nconst actions = {\n  setValue: value => (state, actions) => ({value: state.count - count})\n}\n```\n\n####  3.2.1 å¼‚æ­¥Action\n\n`Action`ç”¨äºå¤„ç†è¾¹é™…æ•ˆåº”ï¼ˆæ¯”å¦‚ï¼šå†™æ•°æ®åˆ°æ•°æ®åº“ã€å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œç­‰ç­‰ï¼‰å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦è¿”å›ä¸€ä¸ªå€¼ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªactioné‡Œæˆ–è€…å›è°ƒå‡½æ•°é‡Œè°ƒç”¨å¦å¤–ä¸€ä¸ªactionã€‚å½“`Action`è¿”å›`Promise`ã€`undefined`æˆ–è€…`null`æ—¶ï¼Œä¸ä¼šè§¦å‘è§†å›¾é‡ç»˜æˆ–çŠ¶æ€æ›´æ–°ã€‚\n\n```Javascript\nconst actions = {\n  upLater: value => (state, actions) => {\n    setTimeout(actions.up, 1000, value)\n  },\n  up: value => state => ({ count: state.count + value })\n}\n```\n\n`Action`å¯ä»¥æ˜¯ä¸€ä¸ª`async`å¼‚æ­¥å‡½æ•°ã€‚å› ä¸ºasyncå‡½æ•°è¿”å›ä¸€ä¸ªPromiseè€Œä¸æ˜¯éƒ¨åˆ†stateï¼Œè¿™æ—¶å€™éœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªactionæ¥æ›´æ–°stateã€‚\n\n```Javascript\nconst actions = {\n  upLater: () => async (state, actions) => {\n    await new Promise(done => setTimeout(done, 1000))\n    actions.up(10)\n  },\n  up: value => state => ({ count: state.count + value })\n}\n```\n\n### 3.2.2 åµŒå¥—çš„Action\n\n`Action`å¯ä»¥åœ¨å‘½åç©ºé—´é‡ŒåµŒå¥—ã€‚æ›´æ–°æ·±åº¦åµŒå¥—çš„stateå°±åƒåœ¨åŒæ ·è·¯å¾„ä¸‹å£°æ˜ä¸€ä¸ªactionæ¥æ›´æ–°éƒ¨åˆ†stateä¸€æ ·ç®€å•ã€‚\n\n```Javascript\nconst state = {\n  counter: {\n    count: 0\n  }\n}\n\nconst actions = {\n  counter: {\n    down: value => state => ({ count: state.count - value }),\n    up: value => state => ({ count: state.count + value })\n  }\n}\n```\n\n#### 3.2.3 æ“ä½œæ€§\n\nappå‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«actionçš„å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥æ›´æ–°stateã€‚æš´éœ²è¿™ä¸ªå¯¹è±¡åˆ°å¤–éƒ¨å¯ä»¥æ–¹ä¾¿çš„å’Œå…¶ä»–ç¨‹åºæˆ–æ¡†æ¶äº¤äº’ã€è®¢é˜…å…¨å±€äº‹ä»¶ã€ç›‘å¬é¼ æ ‡æˆ–é”®ç›˜è¾“å…¥ï¼Œç­‰ç­‰ã€‚\n\n```Javascript\nconst main = app(state, actions, view, document.body)\n\nsetInterval(main.up, 250, 1)\nsetInterval(main.down, 500, 1)\n```\n\n### 4. View\n\nå½“stateæ”¹å˜æ—¶ï¼Œviewå‡½æ•°è¢«æ‰§è¡Œï¼›viewå‡½æ•°è¿”å›ä¸€ä¸ªjså¯¹è±¡ï¼Œè¢«ç§°ä½œvirtual domï¼ŒHyperappæ ¹æ®virtual domæ¥æ›´æ–°å®é™…çš„DOMèŠ‚ç‚¹ã€‚\n\n```Javascript\nimport { h } from \"hyperapp\"\n\nexport const view = (state, actions) =>\n  h(\"div\", {}, [\n    h(\"h1\", {}, state.count),\n    h(\"button\", { onclick: () => actions.down(1) }, \"-\"),\n    h(\"button\", { onclick: () => actions.up(1) }, \"+\")\n  ])\n```\n\n### 4.1 Virtual DOM\n\n`Virtual DOM`ä½¿ç”¨ä¸€ä¸ªæ ‘ç»“æ„çš„jså¯¹è±¡æ¥æè¿°çœŸå®DOMèŠ‚ç‚¹ï¼Œå…·ä½“å½¢å¼å¦‚ä¸‹ï¼š\n\n```Javascript\n{\n  nodeName: \"div\",\n  attributes: {},\n  children: [\n    {\n      nodeName: \"h1\",\n      attributes: {},\n      children: [0]\n    },\n    {\n      nodeName: \"button\",\n      attributes: { ... },\n      children: [\"-\"]\n    },\n    {\n      nodeName:   \"button\",\n      attributes: { ... },\n      children: [\"+\"]\n    }\n  ]\n}\n```\n\nä»¥ä¸Šä¾¿æ˜¯Hyperappçš„æ¦‚è¦ï¼Œåœ¨é¡¹ç›®ä½¿ç”¨ä¸­ï¼Œç”±äºhyperappä»£ç çŸ­å°ç²¾ç‚¼ï¼Œæ›´æ˜“äºè°ƒè¯•å’Œæ‰©å±•ï¼Œæ¨èæ„Ÿå…´è¶£çš„åŒå­¦è¯•ç”¨ã€‚\n","date":"2018-04-08"},{"author":"Wm Leler","title":"ä¸ºä»€ä¹ˆFlutteré€‰æ‹©Dart ?","from":"https://hackernoon.com/why-flutter-uses-dart-dd635a054ebf","tags":["Dartlang","Dart","Flutter","mobile","Programming Language","è·¨å¹³å°","ç§»åŠ¨ç«¯","backend"],"iso8601Date":"2018-01-26T08:00:00+08:00","basename":"why-flutter-uses-dart","body":"\n\nå¾ˆå¤šè¯­è¨€å­¦å®¶åšä¿¡è‡ªç„¶è¯­è¨€å½±å“ç€äººç±»æ€è€ƒçš„æ–¹å¼ã€‚é‚£ä¹ˆè¿™ç§æƒ…å†µå¯¹è®¡ç®—æœºè¯­è¨€æˆç«‹å—ï¼Ÿç¨‹åºå‘˜ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¤„ç†é—®é¢˜æ—¶å¸¸å¸¸ä¼šé‡‡ç”¨å®Œå…¨ä¸åŒçš„è§£å†³æ–¹æ³•ã€‚æ›´æç«¯ä¸€ç‚¹çš„ä¾‹å­ï¼Œè®¡ç®—æœºç§‘å­¦å®¶ä¸ºäº†é¼“åŠ±ç»“æ„åŒ–ç¼–ç¨‹è€Œç§»é™¤äº†*goto*è¯­å¥ã€‚\n\né‚£ä¹ˆè¿™äº›è·Ÿ[Flutter](https://flutter.io/)å’Œ[Dart](https://www.dartlang.org/)æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå…¶å®å…³ç³»å¾ˆå¤§ã€‚æ—©æœŸçš„Flutterå›¢é˜Ÿè¯„ä¼°äº†å¤§é‡ç¼–ç¨‹è¯­è¨€ï¼Œé€‰æ‹©Dartçš„åŸå› æ˜¯å®ƒä¸å›¢é˜Ÿåˆ›å»ºç”¨æˆ·ç•Œé¢çš„æ–¹å¼ç›¸åŒ¹é…ã€‚\n\nDartæ˜¯å¼€å‘è€…å–œçˆ±Flutterçš„ä¸€ä¸ªé‡è¦åŸå› ã€‚æ­£å¦‚ä¸€æ¡å¾®åšæ‰€è¯´ï¼š\n\n![](pic_01.jpeg)\n\nè¿™é‡Œæœ‰ä¸€ä¸ªDartç‰¹æ€§çš„å¿«é€Ÿåˆ—è¡¨ï¼Œè¿™äº›ç‰¹æ€§ä¸€èµ·ä½¿Dartå¯¹äºFlutterå˜å¾—ä¸å¯æˆ–ç¼ºï¼š\n\n* Dartè¢«AOT([Ahead Of Time](https://en.wikipedia.org/wiki/Ahead-of-time_compilation))ç¼–è¯‘ä¸ºå¿«é€Ÿçš„ã€å¯é¢„æµ‹çš„æœ¬åœ°ä»£ç (navtive code)ï¼Œè¿™ç§ç¼–è¯‘æ–¹å¼ä½¿å¾—å‡ ä¹æ‰€æœ‰çš„Flutterä»£ç éƒ½å¯ä»¥ç”¨Dartæ¥ç¼–å†™ã€‚è¿™æ ·ä¸ä»…ä½¿Flutterå¿«é€Ÿï¼Œè€Œä¸”å‡ ä¹å¯ä»¥å®šåˆ¶æ‰€æœ‰çš„æ¨¡å—ï¼ˆåŒ…æ‹¬å…¨éƒ¨çš„ç»„ä»¶ï¼‰ã€‚\n\n* Dartè¿˜å¯ä»¥è¢«[JIT](https://en.wikipedia.org/wiki/Just-in-time_compilation)ç¼–è¯‘ï¼Œä»¥åº”å¯¹æå…¶å¿«èŠ‚å¥çš„å¼€å‘å‘¨æœŸå’Œæ˜“å˜çš„å·¥ä½œæµç¨‹ï¼ˆåŒ…æ‹¬Flutterå—æ¬¢è¿çš„æ¯«ç§’çº§çš„ã€çŠ¶æ€é©±åŠ¨çš„hot reloadï¼‰\n\n* Dartå¯ä»¥è½»æ˜“åœ°åˆ›å»ºä»¥60fpsè¿è¡Œçš„æµç•…çš„åŠ¨ç”»å’Œå˜æ¢ã€‚Dartä¸éœ€è¦é”å°±å¯ä»¥å¤„ç†å¯¹è±¡åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚å’ŒJavascriptç±»ä¼¼ï¼ŒDarté¿å…[æŠ¢å å¼è°ƒåº¦](https://en.wikipedia.org/wiki/Preemption_(computing))å’Œå…±äº«å†…å­˜ï¼ˆå› æ­¤å¸¦æ¥çš„é”ï¼‰ã€‚å› ä¸ºFlutteråº”ç”¨è¢«ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç ï¼Œæ‰€ä»¥Flutterä¸éœ€è¦åœºæ™¯ä¸‹çš„ä½é€Ÿbridgeï¼ˆæ¯”å¦‚ï¼šJavascriptå’Œæœ¬åœ°ä»£ç ï¼‰ã€‚åŒæ—¶å¯åŠ¨ä¹Ÿæ›´å¿«ã€‚\n\n* Dartè®©Flutteré¿å…ä½¿ç”¨ç‹¬ç«‹çš„å£°æ˜å¼çš„å¸ƒå±€è¯­è¨€ï¼Œåƒ[JSX](https://en.wikipedia.org/wiki/React_(JavaScript_library)#JSX)æˆ–XMLï¼Œæˆ–è€…è§†å¯è§†åŒ–ç•Œé¢æ„å»ºå™¨ï¼Œå› ä¸ºDartçš„å£°æ˜å¼ã€å¯ç¼–ç¨‹çš„å¸ƒå±€æ˜“äºé˜…è¯»å’Œå‘ˆç°ã€‚åœ¨ä¸€ä¸ªåœ°æ–¹ç”¨ä¸€ç§è¯­è¨€ä¹¦å†™æ‰€æœ‰çš„å¸ƒå±€ï¼Œè®©Flutteræä¾›æ›´å…ˆè¿›çš„åˆ¶ä½œå¸ƒå±€çš„å·¥å…·å˜å¾—æ˜“å¦‚åæŒã€‚\n\n* å¼€å‘è€…å·²ç»å‘ç°Dartéå¸¸å®¹æ˜“æŒæ¡ï¼Œå› ä¸ºå®ƒå…·æœ‰å¯¹æ— è®ºæ˜¯ä½¿ç”¨é™æ€è¯­è¨€æˆ–æ˜¯åŠ¨æ€è¯­è¨€çš„ç”¨æˆ·æ¥è¯´éƒ½ç†Ÿæ‚‰çš„ç‰¹æ€§ã€‚\n\nå°½ç®¡è¿™äº›ç‰¹æ€§ä¸æ˜¯Dartç‹¬æœ‰çš„ï¼Œä½†æ˜¯ä»–ä»¬å®Œç¾åœ°ç»“åˆåœ¨ä¸€èµ·ï¼Œè®©Dartåœ¨å®ç°Flutteræ—¶å˜å¾—æ— ä¸ä¼¦æ¯”çš„å¼ºå¤§ã€‚\n\n![](pic_02.jpeg)\n\næ–‡ç« çš„å‰©ä½™éƒ¨åˆ†ä¼šæ·±å…¥åˆ°Dartçš„å¤§é‡ç‰¹æ€§ï¼ˆåŒ…æ‹¬å®ƒçš„æ ‡å‡†åº“ï¼‰ï¼Œè¿™äº›ç‰¹æ€§è®©Dartæˆä¸ºäº†*å®ç°Flutteræœ€å¥½çš„ç¼–ç¨‹è¯­è¨€*ã€‚\n\n### ç¼–è¯‘å’Œæ‰§è¡Œ\n\n*\\[å¦‚æœæ‚¨å·²ç»äº†è§£é™æ€å’ŒåŠ¨æ€è¯­è¨€ã€AOTå’ŒJITç¼–è¯‘ã€è™šæ‹Ÿæœºç­‰ä¸»é¢˜ï¼Œæ‚¨å¯ä»¥è·³è¿‡æœ¬ç« èŠ‚\\]*\n\nä»å†å²ä¸Šæ¥çœ‹ï¼Œè®¡ç®—æœºè¯­è¨€è¢«åˆ†æˆäº†ä¸¤ç»„ï¼šé™æ€è¯­è¨€ï¼ˆä¾‹å¦‚ï¼šFortranæˆ–Cï¼Œè¿™äº›è¯­è¨€çš„å˜é‡åœ¨ç¼–è¯‘æœŸæ˜¯é™æ€ç±»å‹ï¼‰å’ŒåŠ¨æ€è¯­è¨€ï¼ˆä¾‹å¦‚ï¼šSmalltalkæˆ–è€…Javascriptï¼Œè¿™äº›è¯­è¨€çš„å˜é‡åœ¨è¿è¡Œæ—¶ç±»å‹å¯ä»¥æ”¹å˜ï¼‰ã€‚é™æ€è¯­è¨€ä¸€èˆ¬è¢«ç¼–è¯‘äº§å‡ºä¸ºç›®æ ‡æœºå™¨çš„æœ¬åœ°æœºå™¨ç ï¼Œåœ¨è¿è¡Œæ—¶ç›´æ¥è¢«ç¡¬ä»¶æ‰§è¡Œã€‚åŠ¨æ€è¯­è¨€ä¸ä¼šäº§ç”Ÿæœºå™¨ç ï¼Œè¢«è§£é‡Šå™¨æ‰§è¡Œã€‚\n\nå½“ç„¶ï¼Œäº‹æƒ…é€šå¸¸ä¼šå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚è™šæ‹Ÿæœº(VM)çš„æ¦‚å¿µå¼€å§‹å˜å¾—æµè¡Œï¼Œå®ƒå…¶å®åªæ˜¯ä¸€ä¸ªé«˜çº§çš„è§£é‡Šå™¨ï¼Œç”¨è½¯ä»¶æ¨¡æ‹Ÿä¸€ä¸ªç¡¬ä»¶ã€‚è™šæ‹Ÿæœºèƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°æŠŠä¸€ä¸ªè¯­è¨€ç§»æ¤åˆ°æ–°çš„ç¡¬ä»¶å¹³å°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒVMçš„è¾“å…¥è¯­è¨€ç»å¸¸æ˜¯ä¸€ä¸ªä¸­é—´è¯­è¨€ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚Javaï¼‰è¢«ç¼–è¯‘ä¸ºä¸­é—´è¯­è¨€ï¼ˆå­—èŠ‚ç ï¼‰ç„¶ååœ¨VMï¼ˆJVMï¼‰ä¸Šè¢«æ‰§è¡Œã€‚\n\næ­¤å¤–ï¼Œç°åœ¨è¿˜å‡ºç°äº†[*just-in-time*](https://en.wikipedia.org/wiki/Just-in-time_compilation)(JIT)ç¼–è¯‘å™¨ã€‚JITç¼–è¯‘å™¨åœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´è¿è¡Œï¼ŒåŠ¨æ€ç¼–è¯‘ã€‚ä¹‹å‰åœ¨ç¨‹åºåˆ›å»ºæœŸé—´æ‰§è¡Œçš„ç¼–è¯‘å™¨ç°åœ¨è¢«ç§°ä½œ[*ahead-of-time*](https://en.wikipedia.org/wiki/Ahead-of-time_compilation)(AOT)ç¼–è¯‘å™¨ã€‚\n\nä¸€èˆ¬æ¥è®²ï¼Œåªæœ‰é™æ€è¯­è¨€æ‰èƒ½è¢«AOTç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œå› ä¸ºæœºå™¨è¯­è¨€ä¸€èˆ¬éœ€è¦çŸ¥é“æ•°æ®çš„ç±»å‹ï¼Œè€Œåœ¨åŠ¨æ€è¯­è¨€é‡Œç±»å‹åœ¨è¿è¡Œå‰æ˜¯ä¸å›ºå®šçš„ã€‚å› æ­¤ï¼ŒåŠ¨æ€è¯­è¨€ä¸€èˆ¬è¢«è§£é‡Šæˆ–JITç¼–è¯‘ã€‚\n\nå¼€å‘æœŸé—´ï¼Œå½“AOTç¼–è¯‘å®Œæˆæ—¶ï¼Œå®ƒæ€»æ˜¯ä¼šå¯¼è‡´ä¸€ä¸ªç›¸å¯¹è¾ƒæ…¢çš„å¼€å‘å‘¨æœŸï¼ˆæ”¹åŠ¨ä¸€æ®µä»£ç åˆ°æ‰§è¡Œä»£ç çœ‹åˆ°æ”¹å˜çš„ç»“æœçš„æ—¶é—´ï¼‰ã€‚ä½†æ˜¯AOTç¼–è¯‘ä½¿ç¨‹åºå¯ä»¥æ›´åŠ å¯é¢„æµ‹åœ°æ‰§è¡Œï¼Œæ²¡æœ‰å› ä¸ºä»£ç è§£æè€Œæš‚åœå’Œè¿è¡Œæ—¶ç¼–è¯‘ã€‚AOTç¼–è¯‘çš„ç¨‹åºè¿è¡Œé€Ÿåº¦ä¹Ÿæ›´å¿«ï¼ˆå› ä¸ºä»–ä»¬å·²ç»è¢«ç¼–è¯‘è¿‡ï¼‰ã€‚\n\nç›¸åï¼ŒJITç¼–è¯‘æä¾›äº†æ›´å¿«é€Ÿçš„å¼€å‘å‘¨æœŸï¼Œä½†æ˜¯å¯¼è‡´äº†æ›´æ…¢çš„æˆ–æ›´ä¸ç¨³å®šçš„è¿è¡Œã€‚ç‰¹åˆ«æ˜¯JITç¼–è¯‘å™¨æœ‰ç€éå¸¸æ…¢çš„å¯åŠ¨é€Ÿåº¦ï¼Œå› ä¸ºå½“ç¨‹åºå¼€å§‹è¿è¡Œæ—¶ï¼ŒJITç¼–è¯‘å™¨åœ¨ä»£ç å¯ä»¥è¢«æ‰§è¡Œå‰å¿…é¡»å»åšè§£æå’Œç¼–è¯‘ã€‚ç ”ç©¶å·²ç»è¡¨æ˜[*å¾ˆå¤šäººåœ¨åº”ç”¨å¯åŠ¨æ—¶é—´è¶…è¿‡æ•°ç§’åä¼šæ”¾å¼ƒä½¿ç”¨*](https://www.google.com/search?q=slow+startup+times+lead+to+abandonment)ã€‚\n\nèƒŒæ™¯çŸ¥è¯†ä»‹ç»å®Œæ¯•ã€‚è¯•æƒ³ä¸€ä¸‹å¦‚æœæŠŠAOTå’ŒJITçš„ä¼˜ç‚¹ç»“åˆèµ·æ¥ä¼šä¸ä¼šå¾ˆé…·å‘¢ï¼Ÿè¯·ç»§ç»­é˜…è¯»ã€‚\n\n### ç¼–è¯‘å’Œæ‰§è¡ŒDart\n\nåœ¨ç ”ç©¶Dartå‰ï¼ŒDartå›¢é˜Ÿæˆå‘˜åœ¨å…ˆè¿›çš„ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºæ–¹é¢åšäº†çªç ´æ€§çš„å·¥ä½œï¼Œä¸¤è€…éƒ½æ˜¯æœåŠ¡äºåŠ¨æ€è¯­è¨€ï¼ˆå°±åƒV8ä¹‹äºJavaScriptï¼Œ Strongtalkä¹‹äºSmalltalkï¼‰ã€‚ä»–ä»¬ä½¿ç”¨è¿™ä¸ªç»éªŒæŠŠDartå¦‚ä½•è¢«ç¼–è¯‘å’Œæ‰§è¡Œå˜å¾—å¼‚å¸¸çµæ´»ã€‚\n\nDartæ˜¯éå¸¸å°‘æœ‰çš„ã€éå¸¸é€‚åˆçš„ä¸€ç§åŒæ—¶å¯ä»¥è¢«AOTå’ŒJITç¼–è¯‘çš„è¯­è¨€ã€‚æ”¯æŒä¸¤ç§ç±»å‹çš„ç¼–è¯‘ä¸ºDartç‰¹åˆ«æ˜¯Flutterå¸¦æ¥äº†æ˜¾è‘—çš„ä¼˜åŠ¿ã€‚\n\nJITç¼–è¯‘è¢«ç”¨äºå¼€å‘æœŸé—´ï¼Œä½¿ç”¨ä¸€ä¸ªæå…¶å¿«é€Ÿçš„ç¼–è¯‘å™¨ã€‚ä¹‹åå½“åº”ç”¨å‡†å¤‡å‘å¸ƒæ—¶ï¼Œä½¿ç”¨AOTç¼–è¯‘ã€‚å› æ­¤ï¼Œåœ¨å…ˆè¿›çš„å·¥å…·å’Œç¼–è¯‘å™¨çš„å¸®åŠ©ä¸‹ï¼ŒDartå…¼å…·ä¸¤ç§ç¼–è¯‘æ–¹å¼çš„ä¼˜ç‚¹ï¼šæå…¶å¿«é€Ÿçš„å¼€å‘å‘¨æœŸã€å¿«é€Ÿçš„æ‰§è¡Œå’Œå¯åŠ¨æ—¶é—´ã€‚\n\nDartåœ¨ç¼–è¯‘æœŸå’Œæ‰§è¡ŒæœŸçš„çµæ´»æ€§è¿˜ä¸æ­¢äºæ­¤ã€‚ä¾‹å¦‚ï¼ŒDartå¯ä»¥è¢«ç¼–è¯‘ä¸ºJavascriptï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨æµè§ˆå™¨é‡Œè¿è¡Œã€‚è¿™ä¸ªå…è®¸ä»£ç åœ¨mobileå’Œwebç«¯é—´å¤ç”¨ã€‚å¼€å‘è€…æŠ¥å‘Šè¯´ä»–ä»¬çš„ä»£ç åœ¨mobileå’Œwebé—´å¤ç”¨ç‡è¾¾åˆ°70%ã€‚DartåŒæ ·å¯ä»¥è¢«ç¼–è¯‘ä¸ºæœºå™¨ä»£ç åœ¨åœ¨æœåŠ¡ç«¯ä½¿ç”¨ï¼Œæˆ–è€…ç¼–è¯‘ä¸ºJavascriptæ­é…nodejsä½¿ç”¨ã€‚\n\næœ€åï¼ŒDartè¿˜æä¾›äº†ç‹¬ç«‹çš„VMï¼Œä½¿ç”¨dartè¯­è¨€æœ¬èº«ä½œä¸ºä¸­é—´è¯­è¨€ã€‚\n\nDartå¯ä»¥é«˜æ•ˆåœ°è¢«AOTæˆ–JITç¼–è¯‘ã€è§£é‡Šæˆ–ç¼–è¯‘ä¸ºå…¶ä»–è¯­è¨€ã€‚Dartçš„ç¼–è¯‘å’Œæ‰§è¡Œä¸ä½†å¼‚å¸¸çµæ´»ï¼Œå¹¶ä¸”éå¸¸è¿…é€Ÿã€‚\n\nä¸‹ä¸€èŠ‚æä¾›ä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºDartçš„ç¼–è¯‘é€Ÿåº¦æ˜¯å¦‚ä½•æˆä¸ºæ¸¸æˆçš„æ”¹å˜è€…ã€‚\n\n### Stateful hot reload\n\nFlutteræœ€å—æ¬¢è¿çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å®ƒçš„æå…¶å¿«é€Ÿçš„hot reloadã€‚åœ¨å¼€å‘æœŸé—´ï¼ŒFlutterä½¿ç”¨JITç¼–è¯‘ï¼ŒJITå¯ä»¥åœ¨ä¸åˆ°ä¸€ç§’çš„æ—¶é—´å†…é‡åŠ è½½å’Œç»§ç»­æ‰§è¡Œä»£ç ã€‚åº”ç”¨çš„çš„çŠ¶æ€åœ¨é‡åŠ è½½æ—¶åªè¦æœ‰å¯èƒ½å°±ä¼šè¢«ä¿ç•™, æ‰€ä»¥ç”¨ç”¨å¯ä»¥ä»ä¸Šä¸€æ¬¡ç¦»å¼€çš„çŠ¶æ€ç»§ç»­æ‰§è¡Œã€‚\n\n![](pic_03.gif)\n\nå¾ˆéš¾é¢†ä¼šåœ¨å¼€å‘æ—¶çœŸæ­£è¿…é€Ÿçš„hot reloadæœ‰å¤šä¹ˆé‡è¦ï¼Œé™¤éä½ è‡ªå·±äº²èº«ä½“éªŒã€‚å¼€å‘è€…æŠ¥å‘Šè¯´è¯´å®ƒæ”¹å˜äº†ä»–ä»¬å¼€å‘åº”ç”¨çš„æ–¹å¼ï¼Œå¹¶æè¿°ä¸ºå°±åƒ[ç»˜åˆ¶ä»–ä»¬çš„åº”ç”¨åˆ°ç”Ÿæ´»é‡Œ](https://github.com/zilongc/blog/issues/3)ã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªmobileåº”ç”¨å¼€å‘è€…è¯´çš„å…³äºFlutterçš„hot reloadï¼š\n\n> æˆ‘æƒ³è¦æµ‹è¯•hot reloading, æ‰€ä»¥æˆ‘æ”¹äº†ä¸€ä¸ªé¢œè‰²ï¼Œä¿å­˜ä¿®æ”¹ï¼Œç„¶å...å å…¥çˆ±æ²³â¤ï¸ !\n\n> è¿™ä¸ªç‰¹æ€§çœŸçš„éå¸¸ä¸å¯æ€è®®ã€‚æˆ‘ä»¥å‰è®¤ä¸ºVisual Studioçš„**ç¼–è¾‘ & ç»§ç»­**å¾ˆå¥½ï¼Œä½†æ˜¯è¿™ä¸ªæ›´åŠ ä»¤äººéœ‡æƒŠã€‚åªç”¨è¿™ä¸ªï¼Œæˆ‘è®¤ä¸ºä¸€ä¸ªmobileå¼€å‘è€…çš„ç”Ÿäº§æ•ˆç‡å¯ä»¥æé«˜ä¸¤å€ã€‚\n\n> å¯¹äºæˆ‘æ¥è¯´è¿™ä¸ªç‰¹æ€§çœŸçš„æ˜¯æ¸¸æˆçš„æ”¹å˜è€…ã€‚å½“æˆ‘éƒ¨ç½²ä»£ç æ—¶ï¼ŒèŠ±è´¹äº†å¤§é‡æ—¶é—´ï¼Œæˆ‘å¤±å»äº†æˆ‘çš„æ³¨æ„åŠ›ï¼Œæˆ‘ä»å…¶ä»–äº‹æƒ…å†å›åˆ°æ¨¡æ‹Ÿå™¨/è®¾å¤‡æ—¶æˆ‘å·²ç»å¿˜è®°äº†æˆ‘æƒ³è¦æµ‹è¯•çš„ä¸œè¥¿ã€‚è¿˜æœ‰ä»€ä¹ˆæ¯”å¤±å»5åˆ†é’Ÿå»æ§åˆ¶2pxæ›´ä»¤äººæ²®ä¸§çš„å‘¢ï¼Ÿä½¿ç”¨Flutterè¿™äº›éƒ½ä¸å†å‘ç”Ÿã€‚\n\nFlutterçš„hot reloadåŒæ—¶è®©æµ‹è¯•æ–°æƒ³æ³•ã€è¯•éªŒæ–°ä¸œè¥¿å˜å¾—å®¹æ˜“ï¼Œä¸ºåˆ›æ–°æä¾›äº†å·¨å¤§çš„æ¨åŠ¨åŠ›ã€‚\n\nåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†Dartæ˜¯æ€ä¹ˆè®©å¼€å‘è€…çš„å·¥ä½œå˜å¾—ç¾å¥½çš„ã€‚ä¸‹ä¸€èŠ‚æ˜¯å…³äºDartåŒæ ·ä½¿åœ¨åˆ›å»ºæµç•…çš„åº”ç”¨æ–¹é¢å–æ‚¦ç”¨æˆ·å˜å¾—ç®€å•ã€‚\n\n### é¿å…å¡é¡¿\n\nä¸€ä¸ªå¿«é€Ÿçš„åº”ç”¨å¾ˆæ£’ï¼Œä½†æ˜¯ä¸€ä¸ªæµç•…çš„åº”ç”¨æ›´èƒœä¸€ç­¹ã€‚å°±ç®—å†å¿«çš„åŠ¨ç”»å¦‚æœä¸­é—´å¡é¡¿ä¹Ÿä¼šçœ‹èµ·æ¥å¾ˆç³Ÿç³•ã€‚ä½†æ˜¯ï¼Œé¿å…å¡é¡¿å¾ˆéš¾åšåˆ°ï¼Œå› ä¸ºè¿™é‡Œæœ‰ç§ç§å› ç´ ã€‚Dartæœ‰å¤§é‡ç‰¹æ€§å¯ä»¥ç”¨æ¥é¿å…å¼•èµ·å¡é¡¿çš„å¾ˆå¤šå¸¸è§çš„ä¸œè¥¿ã€‚\n\nå½“ç„¶ï¼Œï¼ˆåƒå…¶ä»–è¯­è¨€ä¸€æ ·ï¼‰åœ¨Flutteré‡Œä»ç„¶å­˜åœ¨å†™å‡ºå¡é¡¿åº”ç”¨çš„å¯èƒ½ï¼›Darté€šè¿‡æ›´åŠ çš„å¯é¢„æµ‹æ€§å’Œæä¾›ç»™å¼€å‘è€…å¯¹åº”ç”¨çš„æµç•…åº¦æ›´å¤šçš„æ§åˆ¶ï¼Œä½¿æä¾›æœ€å¥½çš„ç”¨æˆ·ä½“éªŒå˜å¾—æœ‰å¯èƒ½ï¼Œè€Œä¸æ˜¯æ²¡æœ‰ã€‚\n\nç»“æœå‘¢ï¼Ÿ\n\n> è¿è¡Œåœ¨60fpsï¼Œç”¨Flutteråˆ›å»ºçš„ç”¨æˆ·ç•Œé¢çš„è¡¨ç°è¿œæ¯”å…¶ä»–è·¨å¹³å°æ¡†æ¶åˆ›å»ºçš„è¦å¥½çš„å¤šã€‚\n\nåŒæ—¶ä¸ä»…æ¯”è·¨å¹³å°åº”ç”¨æ›´å¥½ï¼Œç”šè‡³å’Œæœ€å¥½çš„åŸç”Ÿåº”ç”¨ä¸€æ ·å¥½ã€‚\n\n### AOTç¼–è¯‘å’Œ\"bridge\"\n\næˆ‘ä»¬å·²ç»è®¨è®ºäº†ä¸€ä¸ªè®©åº”ç”¨ä¿æŒæµç•…çš„ç‰¹æ€§ï¼Œå®ƒæ˜¯Dartè¢«AOTç¼–è¯‘ä¸ºæœºå™¨ç çš„èƒ½åŠ›ã€‚é¢„ç¼–è¯‘çš„AOTä»£ç æ¯”JITæ›´åŠ å¯é¢„æµ‹ï¼Œå› ä¸ºæ²¡æœ‰è¿è¡Œæ—¶è¿›è¡ŒJITè§£ææˆ–ç¼–è¯‘å¸¦æ¥çš„æš‚åœã€‚\n\nä½†æ˜¯ï¼ŒAOTç¼–è¯‘è¿˜æœ‰æ›´å¤§çš„å¥½å¤„ï¼Œé‚£å°±æ˜¯é¿å…\"Javascript Bridge\"ã€‚å½“åŠ¨æ€è¯­è¨€ï¼ˆåƒJavascriptï¼‰åœ¨å¹³å°é‡Œéœ€è¦å’Œæœ¬åœ°è¯­è¨€äº¤äº’æ—¶ï¼Œä»–ä»¬å¿…é¡»é€šè¿‡ä¸€ä¸ªbridgeé€šä¿¡ï¼Œè¿™ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œä¼´éšç€å¿…é¡»ä¿å­˜ä¸€ä»½ç‰¹åˆ«å¤§çš„çŠ¶æ€(æ½œåœ¨çš„äºŒçº§å­˜å‚¨)ã€‚è¿™äº›ä¸Šä¸‹æ–‡åˆ‡æ¢ç¥¸ä¸å•è¡Œï¼Œå› ä¸ºä»–ä»¬ä¸ä»…ä¼šæŠŠé€Ÿåº¦å‡æ…¢ï¼ŒåŒæ—¶ä»–ä»¬è¿˜ä¼šå¯¼è‡´ä¸¥é‡çš„å¡é¡¿ã€‚\n\n![](pic_04.png)\n\næ³¨ï¼šç”šè‡³ä½¿ç¼–è¯‘åçš„ä»£ç ä¹Ÿéœ€è¦ä¸€ä¸ªæ¥å£å’Œå¹³å°ä»£ç é€šè¯ï¼Œè¿™ä¹Ÿå¯ä»¥ç§°ä½œbridgeï¼Œä½†æ˜¯é€šå¸¸æ¯”åŠ¨æ€è¯­è¨€è¦æ±‚çš„bridgeå¿«çš„å¤šã€‚æ­¤å¤–ï¼Œç”±äºDartå…è®¸åº”ç”¨é‡Œæœ‰åƒç»„ä»¶è¿™æ ·çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ç”¨æ¡¥é€šä¿¡çš„éœ€æ±‚è¢«ç¼©å‡ã€‚\n\n### æŠ¢å å¼è°ƒåº¦ï¼Œæ—¶é—´åˆ‡ç‰‡å’Œèµ„æºå…±äº«\n\nå¤§éƒ¨åˆ†æ”¯æŒå¤šçº¿ç¨‹çš„è®¡ç®—æœºè¯­è¨€é‡‡ç”¨æŠ¢å çš„æ–¹å¼åœ¨çº¿ç¨‹é—´åˆ‡æ¢ã€‚æ¯ä¸ªçº¿ç¨‹è¢«åˆ†é…ä¸€ä¸ªå¯æ‰§è¡Œçš„æ—¶é—´\\`åˆ‡ç‰‡\\`ï¼Œå¦‚æœçº¿ç¨‹è¶…å‡ºäº†å®ƒåˆ†é…çš„æ—¶é—´ï¼Œé‚£ä¹ˆçº¿ç¨‹é€šè¿‡ä½¿ç”¨ä¸Šä¸‹æ–‡åˆ‡æ¢è¢«æŠ¢å ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŠ¢å å‘ç”Ÿåœ¨çº¿ç¨‹é—´å…±äº«çš„èµ„æºæ­£åœ¨è¢«æ›´æ–°æ—¶ï¼Œé‚£ä¹ˆè¿™ä¼šå¯¼è‡´ä¸€ä¸ª[race condition](https://en.wikipedia.org/wiki/Race_condition).\n\nRace conditionsæ˜¯ä¸€ä¸ªç¾éš¾ï¼Œå› ä¸ºä»–ä»¬å¯ä»¥å¼•èµ·å¾ˆå¤šä¸¥é‡çš„bugï¼ŒåŒ…æ‹¬è®©ä½ çš„åº”ç”¨å´©æºƒå’Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼ŒåŒæ—¶ä»–ä»¬å¾ˆéš¾è¢«å‘ç°å’Œä¿®å¤ï¼Œå› ä¸ºä»–ä»¬ä¾èµ–ç‹¬ç«‹çº¿ç¨‹çš„ç›¸å¯¹æ—¶é—´ã€‚\n\nè§£å†³race conditionçš„å¸¸ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨é”æ¥ä¿æŠ¤å…±äº«èµ„æºï¼Œç”¨æ¥é˜²æ­¢å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œä½†æ˜¯é”ä½ä»–ä»¬è‡ªå·±å¯ä»¥å¼•èµ·å¡é¡¿ï¼Œæˆ–è€…[æ›´ä¸¥é‡çš„é—®é¢˜](https://en.wikipedia.org/wiki/Dining_philosophers_problem)ï¼ˆåŒ…æ‹¬[æ­»é”](https://en.wikipedia.org/wiki/Deadlock)å’Œ[Starvation](https://en.wikipedia.org/wiki/Starvation_%28computer_science%29)ï¼‰ã€‚\n\nDarté‡‡å–äº†ä¸ä¸€æ ·çš„æ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚Dartçš„çº¿ç¨‹å«åšisolatesï¼Œä¸ä¼šå…±äº«å†…å­˜ï¼Œä»è€Œé¿å…äº†å¤§å¤šæ•°é”çš„éœ€æ±‚ã€‚Isolatesé€šä¿¡é€šè¿‡ç®¡é“å‘é€ä¿¡æ¯ï¼Œè¿™ä¸ªæ–¹å¼å’ŒErlangçš„actoræˆ–è€…Javascriptçš„web workerç±»ä¼¼ã€‚\n\nDart, å’ŒJavascriptä¸€æ ·æ˜¯å•çº¿ç¨‹ï¼Œè¿™æ„å‘³ç€å®ƒä»æ ¹æºä¸å…è®¸æŠ¢å ã€‚ç›¸åº”çš„ï¼Œçº¿ç¨‹æ˜¾å¼åœ°æ±‚å€¼(yield)ï¼ˆé€šè¿‡async/await, Future, æˆ–è€…Streamï¼‰ã€‚è¿™ç§æ–¹å¼ç»™å¼€å‘è€…åœ¨æ‰§è¡Œä¸Šæ›´å¤šçš„æ§åˆ¶ã€‚å•çº¿ç¨‹å¸®åŠ©å¼€å‘è€…ä¿è¯å…³é”®çš„å‡½æ•°è¢«æ‰§è¡Œå®Œï¼Œæ²¡æœ‰æŠ¢å ã€‚è¿™ä¸ä»…å¯¹æ„å»ºç”¨æˆ·ç•Œé¢æ˜¯ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ï¼Œè€Œä¸”å¯¹å®¢æˆ·ç«¯-æœåŠ¡ç«¯ä»£ç ä¹Ÿæ˜¯ã€‚\n\nå½“ç„¶ï¼Œå¦‚æœå¼€å‘è€…å¿˜è®°æ˜¾ç¤ºçš„æ±‚å€¼(yield)ï¼Œè¿™å¯èƒ½ä¼šå»¶ç¼“å…¶ä»–ä»£ç çš„æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å‘ç°å¿˜è®°æ±‚å€¼é€šå¸¸è¦æ¯”å¿˜è®°ä¸Šé”æ›´å®¹æ˜“è¢«å‘ç°å’Œä¿®æ­£(å› ä¸ºrace conditionå¾ˆéš¾è¢«å‘ç°)ã€‚\n\n### åˆ†é…å’Œåƒåœ¾å›æ”¶\n\nå¦ä¸€ä¸ªé‡è¦çš„å¡é¡¿åŸå› æ˜¯åƒåœ¾å›æ”¶ã€‚äº‹å®ä¸Šï¼Œè¿™åªæ˜¯è®¿é—®å…±äº«èµ„æº(å†…å­˜)çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œè¿™åœ¨å¾ˆå¤šè¯­è¨€é‡Œéœ€è¦ä½¿ç”¨é”ã€‚è™½ç„¶ç©ºé—²å†…å­˜è¢«å›æ”¶äº†ï¼Œä½†æ˜¯é”å¯èƒ½ä¼šä½¿æ•´ä¸ªåº”ç”¨ä»è¿è¡Œä¸­åœæ­¢ã€‚ä½†æ˜¯ï¼ŒDartå¯ä»¥åœ¨æ‰§è¡Œåƒåœ¾å›æ”¶çš„å‡ ä¹æ‰€æœ‰æ—¶é—´é‡Œä¸éœ€è¦é”ã€‚\n\nDartä½¿ç”¨ä¸€ç§æ›´å…ˆè¿›çš„[åˆ†ä»£åƒåœ¾å›æ”¶å’Œåˆ†é…](https://en.wikipedia.org/wiki/Tracing_garbage_collection#Generational_GC_.28ephemeral_GC.29)æ–¹æ¡ˆï¼Œè¿™ç§æ–¹æ¡ˆåœ¨åˆ†é…çŸ­æš‚å›æ”¶çš„å¯¹è±¡æ—¶å¼‚å¸¸è¿…é€Ÿ(å®Œç¾é€‚é…åƒFlutterè¿™ç§æ¯ä¸€å¸§éƒ½éœ€è¦é‡æ–°ç¼–è¯‘ä¸å¯å˜çš„è§†å›¾æ ‘çš„å“åº”å¼ç”¨æˆ·ç•Œé¢)ã€‚Dartå¯ä»¥ç”¨ä¸€ä¸ªpointer bumpæ¥åˆ†é…å¯¹è±¡(ä¸éœ€è¦é”)ã€‚å†ä¸€æ¬¡ï¼Œç»“æœæ˜¯æµç•…çš„æ»‘åŠ¨å’ŒåŠ¨ç”»ï¼Œæ²¡æœ‰å¡é¡¿ã€‚\n\n### ç»Ÿä¸€çš„å¸ƒå±€\n\nå¦ä¸€ä¸ªDartçš„ä¼˜åŠ¿æ˜¯Flutterä¸ä¼šåœ¨ä½ çš„ç¨‹åºå’Œé™„åŠ çš„æ¨¡æ¿æˆ–å¸ƒå±€è¯­è¨€(åƒJSXæˆ–XML)é—´æ‹†åˆ†å¸ƒå±€ï¼Œå®ƒä¹Ÿä¸éœ€è¦ç‹¬ç«‹çš„è§†è§‰å¸ƒå±€å·¥å…·ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Flutterè§†å›¾ï¼Œç”¨Dartç¼–å†™ï¼š\n\n```dart\nnew Center(child:\n  new Column(children: [\n    new Text('Hello, World!'),\n    new Icon(Icons.star, color: Colors.green),\n  ])\n)\n```\n\n![](hello_world_flutter.png)\n\næ³¨æ„çœ‹ï¼Œè¿™æ®µä»£ç çš„äº§å‡ºåˆ°è§†è§‰åŒ–æ˜¯å¤šä¹ˆçš„ç®€æ´ã€‚ï¼ˆå³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨Dartçš„ç»éªŒï¼‰\n\nåŒæ—¶ï¼Œéšç€[Dart 2](https://www.dartlang.org/dart-2)çš„å³å°†å‘å¸ƒï¼Œä»£ç ä¼šå˜å¾—æ›´åŠ ç®€å•ï¼Œå› ä¸º`new`å’Œ`const`å…³é”®å­—å˜æˆäº†å¯é€‰çš„ï¼Œæ‰€ä»¥é™æ€å¸ƒå±€å¯ä»¥çœ‹èµ·æ¥åƒæ˜¯ç”¨å£°æ˜å¼å¸ƒå±€è¯­è¨€å†™çš„ä¸€æ ·ï¼š\n\n```dart\nCenter(child:\n  Column(children: [\n    Text('Hello, World!'),\n    Icon(Icons.star, color: Colors.green),\n  ])\n)\n```\n\nç„¶è€Œï¼Œæˆ‘çŸ¥é“ä½ å¯èƒ½åœ¨æƒ³ -- ç¼ºå°‘ä¸“ä¸šçš„å¸ƒå±€è¯­è¨€æ€ä¹ˆèƒ½è¢«ç§°ä½œä¸ºä¸€ä¸ªä¼˜åŠ¿å‘¢ï¼Ÿä½†æ˜¯å®ƒç¡®å®ä½¿ä¸€ä¸ªæ¸¸æˆçš„æ”¹å˜è€…ã€‚ä¸‹é¢æ¥è‡ªäºä¸€ä¸ªå¼€å‘è€…å†™çš„ä¸€ç¯‡åä¸º[\"ä¸ºä»€ä¹ˆåŸç”Ÿåº”ç”¨çš„å¼€å‘è€…åº”è¯¥ä¸¥è‚ƒå¯¹å¾…Flutter\"](https://hackernoon.com/why-native-app-developers-should-take-a-serious-look-at-flutter-e97361a1c073)çš„æ–‡ç« ã€‚\n\n> åœ¨Flutteré‡Œï¼Œå¸ƒå±€åªç”¨Dartä»£ç æ¥å®šä¹‰ã€‚è¿™é‡Œæ²¡æœ‰XML/æ¨¡æ¿è¯­è¨€ã€‚è¿™é‡Œä¹Ÿæ²¡æœ‰è§†è§‰è®¾è®¡/storyboardingå·¥å…·\n\n> æˆ‘çš„é¢„æ„Ÿæ˜¯ï¼Œå¬åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼Œæœ‰äº›äººç”šè‡³ä¼šæœ‰ç‚¹ç•ç¼©ã€‚ä¹ä¸€çœ‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘çš„ååº”ã€‚ä½¿ç”¨å¯è§†åŒ–å·¥å…·è¿›è¡Œå¸ƒå±€ä¸æ˜¯å¾ˆå®¹æ˜“å—? åœ¨ä»£ç ä¸­ç¼–å†™å„ç§çº¦æŸé€»è¾‘ä¸ä¼šä½¿äº‹æƒ…å˜å¾—è¿‡äºå¤æ‚å—?\n\n> å¯¹äºæˆ‘ç­”æ¡ˆæœ€åè¯æ˜æ˜¯ä¸ã€‚æˆ‘çš„å¤©ï¼è¿™æ˜¯å¤šä¹ˆä»¤äººæƒŠå¥‡çš„äº‹å•Šã€‚\n\nå›ç­”çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸Šé¢æåˆ°çš„hot reloadã€‚\n\n> æˆ‘æ— æ³•æ›´åŠ å¼ºè°ƒè¿™è¦æ¯”Androidçš„Instant Runæˆ–è€…ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆæ—©å¤šå°‘å¹´ã€‚å®ƒå°±æ˜¯å¾ˆç®¡ç”¨ï¼Œå³ä½¿åœ¨å¤§å‹åº”ç”¨ä¸Šã€‚åŒæ—¶å®ƒéå¸¸å¿«ã€‚è¿™æ˜¯Dartå¸¦ç»™ä½ çš„åŠ›é‡ã€‚\n\n> åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™ä½¿è§†è§‰ç¼–è¾‘å™¨å˜æˆå†—ä½™çš„ã€‚æˆ‘å¹¶æ²¡æœ‰é”™è¿‡XCodeçš„éå¸¸å¥½çš„è‡ªåŠ¨å¸ƒå±€ã€‚\n\nDartåˆ›å»ºç®€æ´æ˜“æ‡‚çš„å¸ƒå±€ï¼Œè€Œ\"æå…¶å¿«é€Ÿ\"çš„hot reloadè®©ä½ é©¬ä¸Šå°±èƒ½çœ‹åˆ°ç»“æœã€‚åŒæ—¶åŒ…æ‹¬ä½ çš„å¸ƒå±€é‡Œçš„éé™æ€éƒ¨åˆ†ã€‚\n\n> å› æ­¤ï¼Œæˆ‘åœ¨Flutter (Dart)ä¸­æ¯”Android/XCodeæ›´å¤šäº§ã€‚ä¸€æ—¦ä½ æŒæ¡äº†å®ƒçš„çªé—¨(å¯¹æˆ‘æ¥è¯´è¿™æ„å‘³ç€å‡ å‘¨çš„æ—¶é—´)ï¼Œå°±ä¼šæœ‰å¤§é‡çš„å¼€é”€å‡å°‘ï¼Œå› ä¸ºå‘ç”Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢éå¸¸å°‘ã€‚ä½ ä¸å¿…åˆ‡æ¢åˆ°è®¾è®¡æ¨¡å¼ï¼Œé€‰æ‹©é¼ æ ‡å¹¶å¼€å§‹ç‚¹å‡»ã€‚ç„¶åæƒ³çŸ¥é“æ˜¯å¦éœ€è¦é€šè¿‡ç¼–ç¨‹æ¥å®Œæˆï¼Œå¦‚ä½•å®ç°ç­‰ç­‰ï¼Œä¸€åˆ‡éƒ½æ˜¯ç¨‹åºåŒ–çš„ã€‚è¿™äº›apiè®¾è®¡å¾—å¾ˆå¥½ã€‚å®ƒå¾ˆå¿«å°±å˜å¾—ç›´è§‚èµ·æ¥ï¼Œå¹¶ä¸”æ¯”è‡ªåŠ¨å¸ƒå±€/å¸ƒå±€XMLsæä¾›çš„æ„å»ºæ›´å¼ºå¤§ã€‚\n\nä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„åˆ—è¡¨å¸ƒå±€ï¼Œå®ƒä¸ºæ¯ä¸€é¡¹æ·»åŠ åˆ†å‰²çº¿(æ°´å¹³çº¿)ï¼Œç¨‹åºåŒ–å®šä¹‰ï¼š\n\n```dart\nreturn new ListView.builder(itemBuilder: (context, i) {\n  if (i.isOdd) return new Divider();\n  // rest of function\n});\n```\n\nåœ¨Flutteré‡Œï¼Œæ‰€æœ‰çš„å¸ƒå±€å‡ºç°åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œä¸ç®¡å®ƒä½¿é™æ€å¸ƒå±€æˆ–è€…ä½¿ç¨‹åºåŒ–å¸ƒå±€ã€‚åŒæ—¶ï¼Œ[æ–°çš„Dart tools](https://groups.google.com/forum/#!topic/flutter-dev/lKtTQ-45kc4)ï¼ŒåŒ…æ‹¬Flutter Inspectorå’Œoutlint viewä½¿å¤æ‚çš„ã€ç¾ä¸½çš„å¸ƒå±€æ›´åŠ ç®€å•ã€‚\n\n### Dartæ˜¯ä¸€ä¸ªä¸“åˆ©è¯­è¨€å—ï¼Ÿ\n\nä¸ï¼ŒDartï¼ˆåƒFlutterä¸€æ ·ï¼‰æ˜¯å®Œå…¨å¼€æºçš„ï¼Œæœ‰ç€å¹²å‡€çš„åè®®ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ECMAçš„æ ‡å‡†ã€‚Dartåœ¨Googleå†…å¤–éƒ½éå¸¸å—æ¬¢è¿ã€‚åœ¨Googleå†…éƒ¨å®ƒä½¿ä¸€ä¸ªæˆé•¿è¿…é€Ÿçš„è¯­è¨€ï¼Œè¢«ç”¨åœ¨Adwordsï¼ŒFlutterï¼ŒFuchsiaå’Œå…¶å®ƒäº§å“é‡Œï¼›åœ¨å¤–éƒ¨ï¼ŒDartä»“åº“æœ‰è¶…è¿‡100å¤šä¸ªçš„å¤–éƒ¨è´¡çŒ®è€…ã€‚\n\nDartå¼€æ”¾çš„æ›´å¥½çš„æ ‡å¿—æ˜¯Googleå¤–éƒ¨ç¤¾åŒºçš„æˆé•¿ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬ä»ç¬¬ä¸‰æ–¹æ­£åœ¨çœ‹åˆ°æºæºä¸æ–­çš„å…³äºDartçš„æ–‡ç« å’Œè§†é¢‘ï¼ˆåŒ…æ‹¬Flutterå’ŒAngularDartï¼‰,ä¸€éƒ¨åˆ†æˆ‘åœ¨è¿™ç¯‡æ–‡ç« é‡Œå¼•ç”¨è¿‡ã€‚\n\né™¤äº†Dartæœ¬èº«å¤–éƒ¨çš„è´¡çŒ®è€…ï¼Œåœ¨Dartçš„å…¬å…±åº“é‡Œæœ‰è¶…è¿‡3000ä¸ªåŒ…ï¼ŒåŒ…æ‹¬åƒFirebase, Redux, RxDart, å›½å®¶åŒ–, åŠ å¯†, æ•°æ®åº“, è·¯ç”±, é›†åˆç­‰ç­‰åº“ã€‚\n\n### Dartç¨‹åºå‘˜å¾ˆéš¾æ‰¾å—ï¼Ÿ\n\nå¦‚æœæ²¡æœ‰å¾ˆå¤šç¨‹åºå‘˜çŸ¥é“Dartï¼Œå¯»æ‰¾åˆæ ¼çš„ç¨‹åºå‘˜ä¼šæ›´å›°éš¾å—ï¼Ÿå›ç­”ä½¿æ˜ç¡®çš„ä¸ã€‚Dartæ˜¯ä¸€ä¸ªéå¸¸å®¹æ˜“æŒæ¡çš„è¯­è¨€ã€‚äº‹å®ä¸Šï¼Œå·²ç»çŸ¥é“åƒJava, JavaScript, Kotlin, C# æˆ–è€… Swiftç­‰è¯­è¨€çš„ç¨‹åºå‘˜ï¼Œå¯ä»¥å‡ ä¹å¯ä»¥ç«‹å³ä½¿ç”¨Dartå¼€å§‹ç¼–ç¨‹ã€‚\n\nè¿™æ˜¯ä¸€åç¨‹åºå‘˜åœ¨ä¸€ç¯‡é¢˜ä¸º\"[ä¸ºä»€ä¹ˆFlutterä¼šåœ¨2018å¹´èµ·é£](https://codeburst.io/why-flutter-will-take-off-in-2018-bbd75f8741b0)\"çš„æ–‡ç« ä¸­è¯´çš„:\n\n> Dart, å¼€å‘Flutteråº”ç”¨çš„è¯­è¨€ï¼Œå­¦ä¹ ä¸Šéå¸¸ç®€å•ã€‚\n> Googleåœ¨åˆ›é€ ç®€å•ã€è‰¯å¥½æ–‡æ¡£åŒ–çš„è¯­è¨€æ–¹é¢å¾ˆæœ‰ç»éªŒï¼Œä¾‹å¦‚Goã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¯¹äºæˆ‘ï¼ŒDartè®©æˆ‘æƒ³èµ·äº†Rubyï¼Œå­¦ä¹ å®ƒå¾ˆå¼€å¿ƒã€‚ä¸ä»…ä½¿ä¸ºäº†mobileå¼€å‘ï¼Œä¹Ÿæ˜¯ä¸ºäº†webå¼€å‘ã€‚\n\nä»å¦å¤–ä¸€ç¯‡å…³äºFlutterå’ŒDartçš„æ–‡ç« ï¼Œæ ‡é¢˜ä¸º\"ä¸ºä»€ä¹ˆæ˜¯Flutterï¼Ÿè€Œä¸æ˜¯æ¡†æ¶Xï¼Ÿ\"\n\n> Flutterä½¿ç”¨Googleåˆ›å»ºçš„è¯­è¨€Dartï¼Œè¯´å®è¯æˆ‘ä¸æ˜¯å¼ºç±»å‹è¯­è¨€åƒC#æˆ–Javaçš„æ‹¥ç°‡ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆDartå†™ä»£ç çš„æ–¹å¼çœ‹èµ·æ¥ä¸ä¸€æ ·ã€‚æˆ‘åœ¨ç¼–å†™çš„æ—¶å€™æ„Ÿè§‰éå¸¸èˆ’æœã€‚ä¹Ÿè®¸ä½¿å› ä¸ºå®ƒéå¸¸å®¹æ˜“ç†è§£å’Œç›´æ¥ã€‚\n\nDartè¢«ç‰¹åˆ«åœ°è®¾è®¡ä¸ºç†Ÿæ‚‰çš„å’Œæ˜“äºå­¦ä¹ çš„ï¼Œåœ¨é€šè¿‡å¤§é‡çš„UXè°ƒç ”å’Œæµ‹è¯•åã€‚ä¾‹å¦‚ï¼Œåœ¨2017å¹´ä¸ŠåŠå¹´ï¼ŒFlutterå›¢é˜Ÿå¯¹8ä¸ªå¼€å‘äººå‘˜åšäº†UXè°ƒç ”ã€‚æˆ‘ä»¬ç»™äº†ä»–ä»¬Flutterç®€çŸ­çš„ä»‹ç»ï¼Œç„¶åè®©ä»–ä»¬æ”¾æ¾ä¸€ä¸ªå°æ—¶å·¦å³ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„è§†å›¾ã€‚æ‰€æœ‰çš„å‚ä¸è€…éƒ½èƒ½é©¬ä¸Šå¼€å§‹ç¼–ç¨‹ï¼Œå³ä½¿ä»–ä»¬ä»¥å‰ä»æ¥æ²¡æœ‰ç”¨è¿‡Dartã€‚ä»–ä»¬ä¸“æ³¨åœ¨å¼€å‘å“åº”å¼å¸ƒå±€ä¸Šï¼Œè€Œä¸æ˜¯è¯­è¨€ä¸Šã€‚Dartåªæ˜¯å¾ˆæœ‰æ•ˆã€‚\n\næœ€åï¼Œæœ‰ä¸€ä¸ªå‚ä¸è€…(ä»–åœ¨ä»»åŠ¡ä¸­å–å¾—äº†å¾ˆå¤§è¿›æ­¥)æ²¡æœ‰æåˆ°ä»»ä½•å…³äºè¯­è¨€çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬é—®ä»–ä»¬æ˜¯å¦æ„è¯†åˆ°ä»–ä»¬ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆè¯­è¨€ã€‚ä»–ä»¬ä¸çŸ¥é“ã€‚è¯­è¨€å¹¶ä¸é‡è¦;ä»–ä»¬åœ¨å‡ åˆ†é’Ÿå†…å°±å¯ä»¥ç”¨Dartç¼–ç¨‹ã€‚\n\nå­¦ä¹ æ–°ç³»ç»Ÿçš„éš¾ç‚¹é€šå¸¸ä¸æ˜¯å­¦ä¹ è¯­è¨€ï¼Œè€Œæ˜¯å­¦ä¹ è¯­è¨€çš„æ‰€æœ‰åº“ã€æ¡†æ¶ã€å·¥å…·ã€æ¨¡å¼å’Œæœ€ä½³å®è·µï¼Œä»è€Œå†™å‡ºå¥½çš„ä»£ç ã€‚Dartçš„åº“å’Œå·¥å…·éƒ½æœ‰éå¸¸å¥½çš„æ–‡æ¡£ã€‚æœ‰ä¸€ç¯‡æ–‡ç« ç§°â€œä½œä¸ºç¦åˆ©ï¼Œä»–ä»¬ä¹Ÿå¯¹ä»–ä»¬çš„ä»£ç åº“ä¿æŒç€æå¤§çš„å…³æ³¨ï¼Œä»–ä»¬æ‹¥æœ‰æˆ‘æ‰€è§è¿‡çš„æœ€å¥½çš„æ–‡æ¡£ã€‚â€\n\nä½œä¸ºç›´æ¥çš„è¯æ®ï¼ŒGoogleå†…éƒ¨çš„ä¸€ä¸ªå¤§é¡¹ç›®æƒ³è¦åšæŠŠæ‰‹æœºç«¯åº”ç”¨è½¬åˆ°iOSã€‚ä»–ä»¬æœ¬æ¥æƒ³è¦é›‡ä½£ä¸€äº›iOSå·¥ç¨‹å¸ˆä½†æ˜¯å†³å®šå»å°è¯•Flutterã€‚ä»–ä»¬ç»Ÿè®¡äº†åœ¨Flutterä¸Šå¼€å‘äººå‘˜çš„éœ€è¦å¤šé•¿æ—¶é—´æ‰èƒ½å…¨é€Ÿå¼€å‘ã€‚ç»“æœæ˜¾ç¤ºä¸€ä¸ªç¨‹åºå‘˜åœ¨ä¸‰å‘¨å†…å°±å¯ä»¥å­¦ä¼šDartå’ŒFlutterå¹¶å¯Œæœ‰æˆæ•ˆã€‚å¯¹æ¯”ä½¿ç”¨Androidéœ€è¦äº”å‘¨æ—¶é—´ï¼ˆæ²¡æœ‰æåˆ°ä½¿ç”¨iOSï¼‰ã€‚\n\næœ€åï¼Œåœ¨æ–‡ç« [ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©Flutterå’Œå®ƒå¦‚ä½•è®©æˆ‘ä»¬çš„å…¬å¸å˜å¾—æ›´å¥½](https://medium.com/@matthew.smith_66715/why-we-chose-flutter-and-how-its-changed-our-company-for-the-better-271ddd25da60)é‡Œï¼Œä¸€ä¸ªå…¬å¸æŠŠä»–ä»¬çš„å¤§å‹å•†ä¸šåº”ç”¨ä»ä¸‰ä¸ªå¹³å°ï¼ˆiOS, Androidå’Œwebï¼‰è¿ç§»åˆ°Dartï¼Œä»–ä»¬çš„ç»“è®ºæ˜¯ï¼š\n\n> æ›´ç®€å•çš„æ‹›è˜ã€‚æˆ‘ä»¬ç°åœ¨è¦è€ƒè™‘çš„æ˜¯æœ€å¥½çš„å€™é€‰äººï¼Œæ— è®ºä»–ä»¬æ¥è‡ªWebï¼ŒiOSè¿˜æ˜¯Androidã€‚\n\n> æˆ‘ä»¬ç°åœ¨æœ‰3xçš„å¸¦å®½ï¼Œæˆ‘ä»¬å›¢é˜Ÿé‡Œçš„æ‰€æœ‰äººç°åœ¨ç»Ÿä¸€åˆ°ä¸€ä¸ªä»£ç åº“é‡Œã€‚\n\n> çŸ¥è¯†å…±äº«å¤„äºä¸€ä¸ªç©ºå‰çš„é«˜å³°ã€‚\n\nä»–ä»¬ä½¿ç”¨Dartå’ŒFlutterå¯ä»¥æœ‰ä¸‰å€çš„ç”Ÿäº§åŠ›ã€‚è€ƒè™‘åˆ°ä»–ä»¬ä¹‹å‰æ‰€åšçš„äº‹æƒ…ï¼Œè¿™å¹¶ä¸å¥‡æ€ªã€‚ä»–ä»¬å°±åƒå¾ˆå¤šå…¬å¸ä¸€æ ·ï¼Œä»¥å‰ä¸ºæ¯ä¸€ä¸ªå¹³å°(web, iOSå’ŒAndroid)ï¼Œä½¿ç”¨åˆ†ç¦»çš„è¯­è¨€ã€å·¥å…·å’Œç¨‹åºå‘˜æ¥å¼€å‘ç‹¬ç«‹çš„åº”ç”¨ã€‚åˆ‡æ¢åˆ°Dartæ„å‘³ç€ä»–ä»¬ä¸åœ¨éœ€è¦é›‡ä½£ä¸åŒç§ç±»çš„ç¨‹åºå‘˜ã€‚åŒæ—¶ç°æœ‰çš„ç¨‹åºå‘˜è½¬åˆ°Dartéå¸¸å®¹æ˜“ã€‚\n\nä»–ä»¬å’Œå…¶ä»–å…¬å¸ä¸€æ ·å‘ç°ä¸€æ—¦ç¨‹åºå‘˜å¼€å§‹ä½¿ç”¨Flutterï¼Œä»–ä»¬ä¼šçœŸçš„å–œæ¬¢ä¸ŠDartã€‚ä»–ä»¬å–œæ¬¢è¿™ä¸ªè¯­è¨€çš„ç®€æ´å’ŒåŠ¡å®ã€‚ä»–ä»¬å–œçˆ±è¿™ä¸ªè¯­è¨€çš„ç‰¹æ€§è¯¸å¦‚cascades, named parameters, async/awaitå’Œstreamsã€‚æ›´é‡è¦çš„æ˜¯ï¼Œä»–ä»¬å–œæ¬¢Dartæ‰èƒ½å®ç°çš„Flutterç‰¹æ€§ï¼ŒDartå¸®åŠ©ä»–ä»¬æ„å»ºçš„æ¼‚äº®çš„ã€é«˜æ€§èƒ½çš„åº”ç”¨ã€‚\n\n### Dart 2\n\néšç€è¿™ç¯‡æ–‡å­—çš„å‘è¡¨ï¼Œ[Dart 2](https://www.dartlang.org/dart-2)å·²ç»å‘å¸ƒã€‚Dart 2å…³æ³¨æå‡å¼€å‘å®¢æˆ·ç«¯åº”ç”¨çš„ä½“éªŒï¼ŒåŒ…æ‹¬å¼€å‘é€Ÿåº¦ï¼Œæ”¹è¿›å¼€å‘è€…å·¥å…·å’Œç±»å‹å®‰å…¨ã€‚ä¾‹å¦‚ï¼ŒDart 2å®ç°äº†ä¸€ä¸ª[å£°éŸ³ç±»å‹ç³»ç»Ÿ](http://papl.cs.brown.edu/2014/safety-soundness.html)å’Œ[ç±»å‹æ¨æ–­](https://en.wikipedia.org/wiki/Type_inference)ã€‚\n\nDart 2åŒæ—¶æŠŠ`new`å’Œ`const`å…³é”®å­—å˜æˆå¯é€‰çš„ã€‚è¿™æ„å‘³ç€Flutterçš„è§†å›¾å¯ä»¥åœ¨æ ¹æœ¬ä¸ä½¿ç”¨ä»»ä½•å…³é”®å­—çš„æƒ…å†µä¸‹è¢«æè¿°ï¼Œå°‘äº†å‡Œä¹±ï¼Œæ›´å®¹æ˜“æ˜“è¯»ã€‚ä¾‹å¦‚ï¼š\n\n```dart\nWidge build(BuildContext context) =>\n  Container(\n    height: 56.0,\n    padding: EdgeInsets.symmetric(horizontal: 8.0),\n    decoration: BoxDecoration(color: Colors.blue[500]),\n    child: Row(\n      ...\n    ),\n);\n```\n\nDart 2è‡ªåŠ¨è¯†åˆ«å‡ºæ‰€æœ‰çš„æ„é€ å‡½æ•°ï¼Œä»¥åŠ\"padding:\"çš„å€¼æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚\n\n### ç§˜å¯†æ˜¯ä¸“æ³¨\n\nDart 2çš„æ”¹è¿›æ˜¯ä¸“æ³¨åœ¨å®¢æˆ·ç«¯å¼€å‘çš„ä¼˜åŒ–ã€‚ä½†æ˜¯Dartè¿˜å°†æ˜¯æ„å»ºæœåŠ¡ç«¯ã€æ¡Œé¢ç«¯ã€åµŒå…¥å¼ç³»ç»Ÿæˆ–è€…å…¶ä»–ç¨‹åºçš„ä¼Ÿå¤§è¯­è¨€ã€‚\n\nä¸“æ³¨æ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ã€‚å‡ ä¹æ‰€æœ‰ç»ä¹…ä¸è¡°çš„æµè¡Œè¯­è¨€éƒ½å—ç›Šäºéå¸¸ä¸“æ³¨ã€‚ä¾‹å¦‚ï¼š\n\n* Cæ˜¯ä¸€ä¸ªç¼–å†™æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿç¨‹åºè¯­è¨€ã€‚ \n* Javaè¢«è®¾è®¡ç”¨åœ¨åµŒå…¥å¼ç³»ç»Ÿã€‚\n* JavaScriptæ˜¯æµè§ˆå™¨çš„è„šæœ¬è¯­è¨€ã€‚\n* å³ä½¿æ˜¯é¥±å—è¯Ÿç—…çš„PHPä¹ŸæˆåŠŸäº†ï¼Œå› ä¸ºå®ƒä¸“æ³¨äºå†™ä¸ªäººä¸»é¡µ(Personal Home Pages)(å®ƒçš„åå­—å°±æ˜¯ä»è¿™æ¥çš„)ã€‚\n\nå¦ä¸€æ–¹é¢ï¼Œå¾ˆå¤šè¯­è¨€éƒ½æ˜ç¡®å°è¯•æˆä¸ºä¸€ä¸ªå…¨å¹³å°çš„è¯­è¨€ï¼Œä¾‹å¦‚PL/1å’ŒAdaç­‰ã€‚æœ€å¸¸è§çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä¸“æ³¨ï¼Œè¿™äº›è¯­è¨€å°±ä¼šå˜æˆä¼—æ‰€å‘¨çŸ¥çš„å¨æˆ¿æ´—æ¶¤å‰‚ã€‚\n\nå¾ˆå¤šç‰¹æ€§ä½¿Dartæˆä¸ºä¸€ä¸ªä¼Ÿå¤§çš„å®¢æˆ·ç«¯è¯­è¨€ï¼ŒåŒæ—¶ä¹Ÿä½¿å®ƒæˆä¸ºä¸€ä¸ªæ›´å¥½çš„æœåŠ¡ç«¯è¯­è¨€ã€‚ä¾‹å¦‚ï¼Œäº‹å®ä¸ŠDarté¿å…æŠ¢å å¼çš„å¤šä»»åŠ¡ç»™äº†å®ƒåœ¨æœåŠ¡ç«¯å’ŒNodeç›¸åŒçš„ä¼˜ç‚¹ï¼Œä½†æ˜¯è¿˜å¤šäº†æ›´å¥½çš„ç‰¹æ€§å’Œæ›´å®‰å…¨çš„ç±»å‹ã€‚\n\nè¿™äº›ä¼˜ç‚¹åŒæ ·å¯ä»¥å‡ºç°åœ¨ç¼–å†™åµŒå…¥å¼ç³»ç»Ÿä¸Šã€‚Dartå¤„ç†å¤šå¹¶å‘çš„èƒ½åŠ›æ˜¯å…³é”®ã€‚\n\næœ€åï¼ŒDartåœ¨å®¢æˆ·ç«¯çš„æˆåŠŸä¼šæœ€ç»ˆåœ¨æœåŠ¡ç«¯ä¸Šä½¿ç”¨å®ƒäº§ç”Ÿæ›´å¤šçš„å…´è¶£-- æ­£åƒå‘ç”Ÿåœ¨JavaScriptå’ŒNodeä¸Šçš„äº‹æƒ…ä¸€æ ·ã€‚ä¸ºä»€ä¹ˆè¦å¼ºè¿«è®¤ä¸ºä½¿ç”¨ä¸¤ç§ä¸åŒçš„è¯­è¨€æ¥å¼€å‘å®¢æˆ·ç«¯-æœåŠ¡ç«¯è½¯ä»¶å‘¢ï¼Ÿ\n\n### ç»“è®º\n\nç°åœ¨æ˜¯Dartä»¤äººå…´å¥‹çš„æ—¶åˆ»ã€‚ä½¿ç”¨Dartçš„äººä»¬å–œçˆ±å®ƒï¼Œè€ŒDart 2çš„æ–°åŠŸèƒ½ä½¿å®ƒæˆä¸ºä½ çš„å·¥å…·åº“ä¸­æ›´æœ‰ä»·å€¼çš„è¡¥å……ã€‚å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨è¿‡Dartï¼Œæˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« ä¸ºä½ æä¾›äº†å…³äºDartçš„æ–°çš„æˆ–è€…ä¸åŒçš„æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œå¹¶ä¸”ä½ ä¼šå°è¯•ç”¨ä¸€ä¸‹Dartå’ŒFlutterã€‚\n","date":"2018-01-26"},{"title":"Jackson ç®€æ˜æ•™ç¨‹","tags":["JSON","Java","Jackson","Translate","backend"],"iso8601Date":"2018-03-31T08:39:10+08:00","basename":"jackson-tutorial","body":"\n\n[åŸæ–‡åœ°å€](https://github.com/FasterXML/jackson-databind/)  \n\n#### ä¸€åˆ†é’Ÿæ•™ç¨‹ï¼šPOJOså’ŒJSONçš„äº’ç›¸è½¬æ¢\n\næœ€å¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯å°†ä¸€æ®µJSONç‰‡æ®µç»„è£…æˆPOJOsã€‚æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆä»è¿™ä¸ªå…¥æ‰‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ï¼Œæœ‰ä¸¤ä¸ªå±æ€§çš„POJOï¼š  \n\n```Java\n// Note: can use getters/setters as well; here we just use public fields directly:\npublic class MyValue {\n  public String name;\n  public int age;\n  // NOTE: if using getters/setters, can keep fields `protected` or `private`\n}\n```\n\næˆ‘ä»¬éœ€è¦ä¸€ä¸ª`com.fasterxml.jackson.databind.ObjectMapper`çš„å®ä¾‹æ¥åšæ‰€æœ‰çš„æ•°æ®ç»‘å®šï¼Œ`ObjectMapper`ä»…éœ€è¦åˆ›å»ºä¸€æ¬¡å³å¯ã€‚  \n\n```Java\nObjectMapper mapper = new ObjectMapper(); // create once, reuse\n```\né‡‡ç”¨é»˜è®¤æ„é€ å‡½æ•°ç›®å‰åŸºæœ¬å¤Ÿç”¨ï¼Œå½“éœ€è¦å¤„ç†ç‰¹æ®Šæƒ…å†µçš„æ—¶å€™å†å­¦ä¹ å¦‚ä½•æ ¹æ®æƒ…å†µé…ç½®ObjectMapperã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨`ObjectMapper`çš„ç¤ºä¾‹ï¼š  \n\n```Java\nMyValue value = mapper.readValue(new File(\"data.json\"), MyValue.class);\n// or:\nvalue = mapper.readValue(new URL(\"http://some.com/api/entry.json\"), MyValue.class);\n// or:\nvalue = mapper.readValue(\"{\\\"name\\\":\\\"Bob\\\", \\\"age\\\":13}\", MyValue.class);\n```\nå¦‚æœæƒ³è¦ç”ŸæˆJSONï¼Œåªéœ€è¦åè¿‡æ¥å°±è¡Œï¼š\n\n```Java\nmapper.writeValue(new File(\"result.json\"), myResultObject);\n// or:\nbyte[] jsonBytes = mapper.writeValueAsBytes(myResultObject);\n// or:\nString jsonString = mapper.writeValueAsString(myResultObject);\n```\n#### ä¸‰åˆ†é’Ÿæ•™ç¨‹ï¼šæ³›å‹é›†åˆå’Œæ ‘æ¨¡å‹\né™¤äº†å¤„ç†Beané£æ ¼çš„POJOï¼ŒJacksonåŒæ—¶å¯ä»¥å¤„ç†JDKçš„`List`å’Œ`Map`:  \n```Java\nMap<String, Integer> scoreByName = mapper.readValue(jsonSource, Map.class);\nList<String> names = mapper.readValue(jsonSource, List.class);\n\n// and can obviously write out as well\nmapper.writeValue(new File(\"names.json\"), names);\n```\nåŒ¹é…è¿™ç§ï¼Œåªè¦JSONçš„ç»“æ„åŒ¹é…ï¼Œå¹¶ä¸”ç±»å‹ç®€å•å°±å¯ä»¥ã€‚å¦‚æœæœ‰POJOå€¼ï¼Œåˆ™éœ€è¦å£°æ˜ä»–çš„å®é™…ç±»å‹(PS:POJOçš„å±æ€§å¦‚æœæ˜¯`List`ç­‰ç±»å‹ï¼Œåˆ™ä¸éœ€è¦æŒ‡å®šç±»å‹)  \n\n```Java\nMap<String, ResultValue> results = mapper.readValue(jsonSource,\n   new TypeReference<Map<String, ResultValue>>() { } );\n// why extra work? Java Type Erasure will prevent type detection otherwise })\n```\nç„¶è€Œï¼Œå¤„ç†`Map`,`List`å’Œå…¶ä»–'ç®€å•'ç±»å‹(String,Number,Boolean)å¯ä»¥æ›´è§ç®€å•ï¼Œå¯¹è±¡éå†éå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥Jacksonçš„`Tree Model`è¿Ÿæ—©æœ‰ç”¨ã€‚  \n\n```Java\n// can be read as generic JsonNode, if it can be Object or Array; or,\n// if known to be Object, as ObjectNode, if array, ArrayNode etc:\nObjectNode root = mapper.readTree(\"stuff.json\");\nString name = root.get(\"name\").asText();\nint age = root.get(\"age\").asInt();\n\n// can modify as well: this adds child Object as property 'other', set property 'type'\nroot.with(\"other\").put(\"type\", \"student\");\nString json = mapper.writeValueAsString(root);\n\n// with above, we end up with something like as 'json' String:\n// {\n//   \"name\" : \"Bob\", \"age\" : 13,\n//   \"other\" : {\n//      \"type\" : \"student\"\n//   }\n// }\n```\næ ‘æ¨¡å‹æ¯”data-bindæ›´åŠ çš„æ–¹ä¾¿ï¼Œå°¤å…¶æ˜¯é«˜åº¦åŠ¨æ€çš„æ•°æ®ç»“æ„ï¼Œæˆ–è€…JSONæ— æ³•å®Œç¾æ˜ å°„Javaç±»çš„æ—¶å€™ã€‚\n#### äº”åˆ†é’Ÿæ•™ç¨‹ï¼šStreaming parser, generator\næœ‰ä¸€ç§æ›´è§æ ‡å‡†çš„å¤„ç†æ¨¡å‹ï¼Œå«åšincremental modelï¼Œä¹Ÿå«Stream model ï¼Œè¿™ç§å¤„ç†æ–¹æ³•å’Œdata-bindæ–¹å¼åŒæ ·æ–¹ä¾¿ï¼Œå’ŒTree ModelåŒæ ·çµæ´»ã€‚data-bindå’ŒTree Model åº•å±‚éƒ½æ˜¯åŸºäºå®ƒã€‚ä½†æ˜¯åŒæ ·ä¹Ÿæš´éœ²ç»™é‚£äº›æƒ³è¦æè‡´æ€§èƒ½å’Œå®Œå…¨æŒæ§è§£æJSONçš„ç”¨æˆ·ã€‚\n\n```Java\nJsonFactory f = mapper.getFactory(); // may alternatively construct directly too\n\n// First: write simple JSON output\nFile jsonFile = new File(\"test.json\");\nJsonGenerator g = f.createGenerator(jsonFile);\n// write JSON: { \"message\" : \"Hello world!\" }\ng.writeStartObject();\ng.writeStringField(\"message\", \"Hello world!\");\ng.writeEndObject();\ng.close();\n\n// Second: read file back\nJsonParser p = f.createParser(jsonFile);\n\nJsonToken t = p.nextToken(); // Should be JsonToken.START_OBJECT\nt = p.nextToken(); // JsonToken.FIELD_NAME\nif ((t != JsonToken.FIELD_NAME) || !\"message\".equals(p.getCurrentName())) {\n   // handle error\n}\nt = p.nextToken();\nif (t != JsonToken.VALUE_STRING) {\n   // similarly\n}\nString msg = p.getText();\nSystem.out.printf(\"My message to you is: %s!\\n\", msg);\np.close(); }\n```\n#### 10åˆ†é’Ÿæ•™ç¨‹ï¼šé…ç½®\næœ‰ä¸¤ç§å…¥é—¨çš„é…ç½®æ–¹æ³•ï¼šfeature å’Œ Annotation\n##### feature é…ç½®\nä¸‹é¢æ˜¯ä¸€äº›æœ€å¸¸ç”¨çš„é…ç½®\né¦–å…ˆä»é«˜å±‚çš„data-bindé…ç½®å¼€å§‹ï¼š\n\n```Java\n// SerializationFeature for changing how JSON is written\n\n// to enable standard indentation (\"pretty-printing\"):\nmapper.enable(SerializationFeature.INDENT_OUTPUT);\n// to allow serialization of \"empty\" POJOs (no properties to serialize)\n// (without this setting, an exception is thrown in those cases)\nmapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS);\n// to write java.util.Date, Calendar as number (timestamp):\nmapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);\n\n// DeserializationFeature for changing how JSON is read as POJOs:\n\n// to prevent exception when encountering unknown property:\nmapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n// to allow coercion of JSON empty String (\"\") to null Object value:\nmapper.enable(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT);\n```\nä¸‹é¢æ˜¯ä¸€äº›å¯ä»¥æ§åˆ¶JSONåº•å±‚è§£æï¼Œç”Ÿæˆçš„é…ç½®ï¼š\n\n```Java\n// JsonParser.Feature for configuring parsing settings:\n\n// to allow C/C++ style comments in JSON (non-standard, disabled by default)\n// (note: with Jackson 2.5, there is also `mapper.enable(feature)` / `mapper.disable(feature)`)\nmapper.configure(JsonParser.Feature.ALLOW_COMMENTS, true);\n// to allow (non-standard) unquoted field names in JSON:\nmapper.configure(JsonParser.Feature.ALLOW_UNQUOTED_FIELD_NAMES, true);\n// to allow use of apostrophes (single quotes), non standard\nmapper.configure(JsonParser.Feature.ALLOW_SINGLE_QUOTES, true);\n\n// JsonGenerator.Feature for configuring low-level JSON generation:\n\n// to force escaping of non-ASCII characters:\nmapper.configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, true);\n```\n##### æ³¨è§£é…ç½®ï¼šä¿®æ”¹å±æ€§å\næœ€ç®€å•çš„ä½¿ç”¨æ³¨è§£é…ç½®çš„æ–¹å¼æ˜¯ä½¿ç”¨`@JsonProperty`:  \n\n```Java\npublic class MyBean {\n   private String _name;\n\n   // without annotation, we'd get \"theName\", but we want \"name\":\n   @JsonProperty(\"name\")\n   public String getTheName() { return _name; }\n\n   // note: it is enough to add annotation on just getter OR setter;\n   // so we can omit it here\n   public void setTheName(String n) { _name = n; }\n} \n```\n##### æ³¨è§£é…ç½®ï¼šå¿½ç•¥å±æ€§\næœ‰ä¸¤ä¸ªå¯ä»¥è®¾ç½®å¿½ç•¥å±æ€§çš„æ³¨è§£ï¼Œä¸€ä¸ªæ˜¯`@JsonIgnore` ä¿®é¥°çš„æ˜¯å•ä¸ªå±æ€§ï¼Œä¸€ä¸ªæ˜¯`@JsonIgnoreProperties` ä¿®é¥°çš„ç±»ã€‚\n\n```Java\n// means that if we see \"foo\" or \"bar\" in JSON, they will be quietly skipped\n// regardless of whether POJO has such properties\n@JsonIgnoreProperties({ \"foo\", \"bar\" })\npublic class MyBean\n{\n   // will not be written as JSON; nor assigned from JSON:\n   @JsonIgnore\n   public String internal;\n\n   // no annotation, public field is read/written normally\n   public String external;\n\n   @JsonIgnore\n   public void setCode(int c) { _code = c; }\n\n   // note: will also be ignored because setter has annotation!\n   public int getCode() { return _code; }\n} \n```\nç”±äºé‡å‘½åï¼Œæ‰€ä»¥æ³¨è§£æ˜¯åœ¨åŒ¹é…çš„çš„å­—æ®µï¼Œgetï¼Œsetä¸­å…±äº«çš„ï¼šå¦‚æœå…¶ä¸­ä¸€ä¸ªè®¾ç½®äº†`@JsonIgnore`ï¼Œå…¶ä»–çš„ä¹Ÿå—å½±å“ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ†ç¦»çš„æ³¨è§£æ¥è§£å†³é—®é¢˜ï¼š\n\n```Java\npublic class ReadButDontWriteProps {\n   private String _name;\n   @JsonProperty public void setName(String n) { _name = n; }\n   @JsonIgnore public String getName() { return _name; }\n} \n```\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`name`ä¸ä¼šè¢«å†™å…¥åˆ°JSONä¸­ï¼Œä½†æ˜¯å¦‚æœJSONä¸­æœ‰ï¼Œåˆ™ä¼šæ˜ å°„åˆ°Javaå¯¹è±¡ä¸­ã€‚\n\n##### æ³¨è§£é…ç½®ï¼šå®šåˆ¶æ³¨è§£æ„é€ å™¨\nå’Œå…¶ä»–çš„data-bindåŒ…ä¸åŒï¼Œjackson ä¸éœ€è¦å®šä¹‰é»˜è®¤çš„æ„é€ å‡½æ•°ï¼ˆå³ä¸åŒ…å«å‚æ•°çš„æ„é€ å‡½æ•°ï¼‰ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªç®€å•çš„åŒ…å«å‚æ•°çš„æ„é€ å‡½æ•°:  \n\n```Java\npublic class CtorBean\n{\n  public final String name;\n  public final int age;\n\n  @JsonCreator // constructor can be public, private, whatever\n  private CtorBean(@JsonProperty(\"name\") String name,\n    @JsonProperty(\"age\") int age)\n  {\n      this.name = name;\n      this.age = age;\n  }\n}\n```\næ„é€ å‡½æ•°åœ¨ä¸å¯å˜å¯¹è±¡ä¸­éå¸¸å®ç”¨ã€‚  \nä¹Ÿå¯ä»¥ç›´æ¥å®šä¹‰ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼š\n\n```Java\npublic class FactoryBean\n{\n    // fields etc omitted for brewity\n\n    @JsonCreator\n    public static FactoryBean create(@JsonProperty(\"name\") String name) {\n      // construct and return an instance\n    }\n}\n```\n#### å…¶ä»–ç‰¹æ€§ï¼š\nä¸€ä¸ªæœ‰ç”¨ï¼Œä½†æ˜¯ä¸è¢«å¹¿æ³›çŸ¥æ™“çš„åŠŸèƒ½å°±æ˜¯Jacksonå¯ä»¥ä»»æ„è½¬æ¢ä¸¤ä¸ªPOJOã€‚å¯ä»¥å°†å…¶æƒ³è±¡æˆä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ï¼Œå°†POJOå†™æˆJSONï¼Œç¬¬äºŒæ­¥è®²JSONå†™æˆå¦ä¸€ä¸ªPOJOã€‚å®ç°çš„æ—¶å€™ç”¨äº†æ›´åŠ é«˜æ•ˆçš„ä¸€ç§æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ç”Ÿæˆä¸­é—´çš„JSONã€‚\nè½¬æ¢åœ¨å…¼å®¹çš„ç±»å‹ä¸­è¿è¡Œçš„å¾ˆå¥½ï¼š\n\n```Java\nResultType result = mapper.convertValue(sourceObject, ResultType.class);\n```\nåªè¦è¿™ä¸¤ä¸ªPOJOçš„ç±»å‹å…¼å®¹ï¼Œå³to json å’Œ from jsonçš„æˆåŠŸï¼Œé‚£ä¹ˆå°±å¯ä»¥æˆåŠŸï¼š\n\n```Java\n// Convert from List<Integer> to int[]\nList<Integer> sourceList = ...;\nint[] ints = mapper.convertValue(sourceList, int[].class);\n// Convert a POJO into Map!\nMap<String,Object> propertyMap = mapper.convertValue(pojoValue, Map.class);\n// ... and back\nPojoType pojo = mapper.convertValue(propertyMap, PojoType.class);\n// decode Base64! (default byte[] representation is base64-encoded String)\nString base64 = \"TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJ5IGhpcyByZWFzb24sIGJ1dCBieSB0aGlz\";\nbyte[] binary = mapper.convertValue(base64, byte[].class);\n```\nåŸºæœ¬ä¸ŠJacksonå¯ä»¥æ›¿æ¢å¾ˆå¤šApache Commonsçš„ç»„ä»¶ï¼Œä¾‹å¦‚Base64çš„ç¼–ç è§£ç ï¼Œå¤„ç†åŠ¨æ€POJOç­‰ã€‚\n","date":"2018-03-31"},{"title":"ES2016, 2017å’Œ2018åˆ°åº•æœ‰å“ªäº›æ–°ä¸œè¥¿ï¼Ÿ","author":"rajaraodv","tags":["js","JavaScript","å‰ç«¯","frontend","ECMAScript","ECMAScript 2016","ECMAScript 2017","ECMAScript 2018","es6","es7","async","await","async/await"],"iso8601Date":"2018-04-03T08:00:00+08:00","basename":"Here_are_examples_of_everything_new_in_ECMAScript_2016_2017_and_2018","body":"\n\n![](1_Z-9unq6Am3vekNOa5fD1xg.png)\n\nJavascriptæ€»æ˜¯åœ¨å‘å¸ƒæ–°åŠŸèƒ½ï¼Œæƒ³è¦ä¸€ç›´è·Ÿä¸Šè„šæ­¥ä¸å¤ªå®¹æ˜“ï¼Œé…å¥—çš„demoä¹Ÿå¾ˆå°‘ï¼Œæœ¬æ–‡æ—¨åœ¨ç»“åˆå®ä¾‹å±•ç¤ºæœ€æ–°çš„18ä¸ªæ–°ç‰¹æ€§ï¼Œåšä¸ªæŠ€æœ¯çš„å¸ƒé“è€…ã€‚\n\n**ä¸‹é¢ä¾ç…§ç‰ˆæœ¬çš„å…ˆåé¡ºåºå¼€å§‹ä»‹ç»:**\n\n![](1_K09EWrqTcTwN9_dlhlzy6Q.png)\n\n## 1. Array.prototype.includes\n\né¦–å…ˆæ˜¯æ•°ç»„çš„ä¸€ä¸ªå®ä¾‹æ–¹æ³•`includes`ï¼Œè¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½å¾ˆç®€å•ï¼šç”¨äºåˆ¤æ–­æŸä¸€é¡¹æ˜¯å¦åœ¨æ•°ç»„é‡Œï¼Œå’Œè¿™ä¸ªæ–¹æ³•åŠŸèƒ½ç±»ä¼¼çš„æœ‰`indexOf`ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯`indexOf`æ— æ³•åˆ¤æ–­`NaN`ï¼Œ\nå¦‚å›¾ï¼š\n\n```Javascript\nconst arr = [1, 2, 3, 4, NaN];\n\n// es5\nif (arr.indexOf(3) >= 0) {\n  console.log(true)\n}\n\n// es2016\nif (arr.includes(e)) {\n  console.log(true)\n}\n\n// æ³¨ï¼šindexOfä¸æ”¯æŒæ£€æŸ¥`NaN`\narr.indexOf(NaN) // -1\narr.includes(NaN) // true\n```\n\n\n## 2. æ±‚å¹‚è¿ç®—ç¬¦\n\nç¬¬äºŒä¸ªæ–°åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼š**æ±‚å¹‚è¿ç®—ç¬¦** -- `**`ï¼Œç”¨äºå–ä»£ä¹‹å‰çš„æ±‚å¹‚æ–¹æ³•`Math.pow`ï¼Œ\nå¦‚å›¾ï¼š\n\n```Javascript\n// ä¹‹å‰\nMath.pow(3, 2) // 9\n\n// ç°åœ¨\n3**2 // 9\n```\n\n![](1_fV_95TaY3ocgE8hlDhhv8w.png)\n\n## 1. Object.values()\n\n`Object.values`è¿™ä¸ªæ–¹æ³•å’Œ`Object.keys`ç±»ä¼¼ï¼Œéƒ½æ˜¯è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡æ–¹æ³•åå¯ä»¥ç›´è§‚çš„çŒœåˆ°è¿”å›çš„æ˜¯å¯¹è±¡çš„å€¼(value)ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯è¿”å›è‡ªèº«åŸå‹çš„å±æ€§ï¼Œä¸åŒ…æ‹¬åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œå¦‚å›¾ï¼š\n\n```Javascript\nconst cars = {BMW: 3, Tesla: 2, Toyota: 1}\n\n// es5\nconst vals = Object.keys(cars).map(key => cars[key]) \nconsole.log(vals) // [3, 2, 1]\n\n// es2016\nconst values = Object.values(cars)\nconsole.log(values) // [3, 2, 1]\n```\n\n\n## 2. Object.entries()\n\n`Object.entries()`è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒæœ‰æ„æ€ï¼Œæœ‰ç‚¹åƒ`Object.keys`å’Œ`Object.values`çš„ç»“åˆä½“ï¼ŒåŒæ—¶è¿”å›å¯¹è±¡çš„`key`å’Œ`value`ï¼Œå¹¶å°è£…åœ¨ä¸€ä¸ªæ•°ç»„é‡Œï¼Œè¿™ä¸ªæ–¹æ³•çš„å¥½å¤„åœ¨äºä½ å¯ä»¥é€šè¿‡`for of`éå†ä¸€æ¬¡å–å‡ºkey/value æˆ–è€… æŠŠ`Object`è½¬ä¸º`Map`ï¼š\n\n**ä¾‹1**ï¼Œéå†:\n\n```Javascript\nconst cars = { BMW: 3, Tesla: 2, Toyota: 1 }\n\n// es5çš„éå†æ–¹å¼\n// éœ€è¦æŠŠ`key`å–å‡ºæ¥ï¼Œå†éå†\nObject.keys(cars).forEach(key => {\n  console.log(`key: ${key}, value: ${cars[key]}`)\n})\n\n// es2017\nfor (let [key, value] of Object.entries(cars)) {\n  console.log(`key: ${key}, value: ${cars[key]}`)\n}\n``` \n\n**ä¾‹2**ï¼ŒæŠŠobjectç›´æ¥è½¬æ¢ä¸º`Map`:\n\n```Javascript\nconst cars = { BMW: 3, Tesla: 2, Toyota: 1 }\n\n// es5\nconst map1 = new Map()\nObject.keys(cars).map(key => {\n  map1.set(key, cars[key])\n})\n\nconsole.log(map1) // Map { 'BMW': 3, 'Tesla': 2, 'Toyota': 1 }\n\n// es2016\nconst map2 = new Map(Object.entries(cars))\n\nconsole.log(map2) // Map { 'BMW': 3, 'Tesla': 2, 'Toyota': 1 }\n```\n\n## 3. String padding\n\nStringå¢åŠ äº†ä¸¤ä¸ªå®ä¾‹æ–¹æ³• -- `padStart`å’Œ`padEnd`ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥åœ¨å­—ç¬¦ä¸²çš„é¦–/å°¾æ·»åŠ å…¶ä»–å­—ç¬¦ä¸²:\n\n```Javascript\n// 'someStr'.padStart(å­—ç¬¦æ•°, [,æ·»åŠ çš„å­—ç¬¦])\n\n'hello'.padStart('10', 'a') // 'aaaaahello', æ·»åŠ äº†5ä¸ªå­—ç¬¦`a`åä¸€å…±`10`ä¸ªå­—ç¬¦\n'hello'.padEnd('10', 'b') // 'hellobbbbb'\n'hello'.padStart('7') // '  hello', åœ¨å¤´éƒ¨æ·»åŠ ä¸¤ä¸ªä¸ªç©ºæ ¼\n```\n\n### 3.1 padStartç¤ºä¾‹\n\n```Javascript\nconst formatted = [0, 1, 12, 123, 1234, 12345].map(num =>\n  num.toString().padStart(10, '0')\n)\n\nconsole.log(formatted)\n// è¾“å‡º:\n// [\n//   '0000000000',\n//   '0000000001',\n//   '0000000012,'\n//   '0000000234,'\n//   '0000001234,'\n//   '0009012345'\n// ]\n```\n\n### 3.2 padEndç¤ºä¾‹\n\n```Javascript\nconst cars = {\n  'ğŸš™BMW': '10',\n  'ğŸš˜Tesla': '5',\n  'ğŸš–Lamborghini': '0'\n}\n\nObject.entries(cars).map(([name, count]) => {\n  console.log(`${name.padEnd(20, ' -')} Count: ${count.padStart(3, '0')}`)\n});\n\n//è¾“å‡º:\n// ğŸš™BMW - - - - - - -  Count: 010\n// ğŸš˜Tesla - - - - - -  Count: 005\n// ğŸš–Lamborghini - - -  Count: 000\n```\n\n## 4.Object.getOwnPropertyDescriptors\n\nè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯è¡¥å……`Object.assign`çš„åŠŸèƒ½ï¼Œåœ¨æµ…æ‹·è´(shallow clone)å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œä¹Ÿä¼šå¤åˆ¶`getter`å’Œ`setter`æ–¹æ³•ï¼š\n\nä¸‹é¢çš„ä¾‹å­ç”¨`Object.defineProperties`æ‹·è´åŸå¯¹è±¡`Car`åˆ°æ–°å¯¹è±¡`ElectricCar`æ¥åŒºåˆ†`Object.assign`å’Œ`Object.getOwnPropertyDescriptors`ã€‚\n\n```Javascript\nconst Car = {\n  name: 'BMW',\n  price: 100000,\n  set discount(x) {\n    this.d = x\n  }\n  get discount() {\n    return this.d\n  }\n}\n\nconsole.log(Object.getOwnPropertyDescriptor(Car, 'discount')\n// è¾“å‡º:\n// {\n//   get: [Function: get],\n//   set: [Function: set],\n//   enumerable: true,\n//   configurable: true\n// }\n\nconst ElectricCar = Object.assign({}, Car)\nconsole.log(Object.getOwnPropertyDescriptor(ElectricCar, 'discount'))\n// è¾“å‡º:\n// {\n//   value: undefined,\n//   writable: true,\n//   enumerable: true,\n//   configurable: true\n// }\n\n// ä½¿ç”¨`Object.assign`åˆ›å»º`ElectricCar`åï¼Œå±æ€§`getter`å’Œ`setter`ä¸¢å¤±äº†\n```\n\n### ä½¿ç”¨`Object.getOwnPropertyDescriptors`å:\n\n```Javascript\nconst Car = {\n  name: 'BMW',\n  price: 100000,\n  set discount(x) {\n    this.d = x\n  }\n  get discount() {\n    return this.d\n  }\n}\n\nconst ElectricCar2 = Object.defineProperties({}, Object.getOwnPropertyDescriptors(Car))\n// è¾“å‡º:\n// {\n//   get: [Function: get],  <-----ğŸ‘ˆ\n//   set: [Function: set],  <-----ğŸ‘ˆ\n//   enumerable: true,\n//   configurable: true \n// }\n```\n\n## 5. åœ¨å‡½æ•°æœ€åä¸€ä¸ªå‚æ•°çš„æœ«å°¾æ·»åŠ é€—å·\n\nè¿™æ˜¯ä¸ªå¾ˆå°çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹ï¼Œåœ¨å‡½æ•°å½¢å‚æœ€åä¸€ä¸ªå‚æ•°æœ«å°¾æ·»åŠ é€—å·ï¼Œå¯ä»¥é¿å…`git blame`æç¤ºä¸å¿…è¦çš„æ”¹åŠ¨ï¼Œ\nä»£ç ç¤ºä¾‹ï¼š\n\n```Javascript\n// å‡è®¾è¿™ä¸ªå‡½æ•°ç”± `ç¨‹åºå‘˜_1` åˆ›å»º\n// è¿™ä¸ªå‡½æ•°æœ€åä¸€ä¸ªå‚æ•°`age`åæ²¡æœ‰é€—å·\nfunction Person(\n  name,\n  age\n) {\n  this.name = name\n  this.age = age\n}\n\n// å¦‚æœ `ç¨‹åºå‘˜_2` è¿™æ—¶æœ‰äº†ä»¥ä¸‹ä¿®æ”¹\nfunction Person(\n  name,\n  age, /* é‚£ä¹ˆè¿™ä¸ª`,`é€—å·ä¹Ÿä¼šå¼•èµ·`git blame`è®¤ä¸º `ç¨‹åºå‘˜_1` ä¿®æ”¹äº†è¿™ä¸€è¡Œ*/\n  gender /* æ·»åŠ äº†æ–°å‚æ•° */\n) { // æ–°æ·»åŠ \n  this.name = name\n  this.age = age\n  this.gender = gender // æ–°æ·»åŠ \n}\n\n// es2017å¯¹è¿™ä¸ªæ··æ·†çš„å¤„ç†åŠæ³•æ˜¯:\n// é€šè¿‡ `ç¨‹åºå‘˜_1`åœ¨`age`æœ«å°¾æ·»åŠ `,`é€—å·\n\n// æ›´æ–°å¦‚ä¸‹:\n\n// å‡è®¾è¿™ä¸ªå‡½æ•°ç”± `ç¨‹åºå‘˜_1` åˆ›å»º\n// åœ¨æœ€åä¸€ä¸ªå‚æ•°`age`åæ·»åŠ `,`é€—å·\nfunction Person(\n  name,\n  age, /* æ·»åŠ é€—å· */\n) {\n  this.name = name\n  this.age = age\n}\n```\n\n## 6. Async/Await\n\nè¿™ä¸ªç‰¹æ€§æ˜¯ç›®å‰ä¸ºæ­¢æœ€é‡è¦çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä½¿ç”¨`async`å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬é¿å…é¢‘ç¹è°ƒç”¨*æ¶å¿ƒçš„*`callback`ï¼Œä½¿ä»£ç ä¿æŒå¹²å‡€æ•´æ´ã€‚\n\nå½“ç¼–è¯‘å™¨è¿›å…¥`async`å‡½æ•°åï¼Œé‡åˆ°`await`å…³é”®å­—ä¼šæš‚åœæ‰§è¡Œï¼Œå¯ä»¥æŠŠ`await`åçš„è¡¨è¾¾å¼çœ‹æˆä¸€ä¸ª`promise`ï¼Œç›´åˆ°promiseè¢«`resolve`æˆ–`reject`åï¼Œå‡½æ•°æ‰ä¼šæ¢å¤æ‰§è¡Œï¼Œ\nå…·ä½“çœ‹å¦‚ä¸‹ä»£ç ï¼š\n\n```Javascript\n  \n// es5çš„`Promise`\nfunction getAmount(userId) {\n  getUser(userId)\n    .then(getBankBalance)\n    .then(amount => {\n      console.log(amount)\n    })\n}\n\n// es2017çš„`async`\nasync function getAmount2(userId) {\n  var user = await getUser(userId)\n  var amount = await getBankBalance()\n  console.log(amount)\n}\n\ngetAmount('1') // $1,000\ngetAmount2('1') // $1,000\n\nfunction getUser(userId) {\n  return new Promise(resolve => {\n    setTimeout(() => {\n      resolve('å¼ ä¸‰')\n    }, 1000)\n  })\n}\n\nfunction getBankBalance() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      if (user === 'å¼ ä¸‰') {\n        resolve('$1,000')\n      } else {\n        resolve('Unknown User')\n      }\n    }, 1000)\n  })\n}\n```\n\n### 6.1 Asyncå‡½æ•°æœ¬èº«è¿”å›ä¸€ä¸ªPromise\n\nè¦æƒ³å¾—åˆ°Asyncå‡½æ•°çš„è¿”å›å€¼ï¼Œéœ€è¦æŠŠè¿”å›å€¼å½“ä½œä¸€ä¸ªpromiseè¿›è¡Œ`then`æ±‚å€¼ã€‚\n\nå…·ä½“çœ‹å¦‚ä¸‹ä»£ç ï¼š\n\n```Javascript\nasync function doubleAndAdd(a, b) {\n  a = await doubleAfter1Sec(a)\n  b = await doubleAfter1Sec(b)\n  return a + b\n}\n\ndoubleAndAdd(1, 2).then(console.log) // 5 \n\nasync function doubleAfter1Sec(param) {\n  return new Promise(resolve => {\n    setTimeout(() => {\n      resolve(param * 2)\n    }, 1000)\n  })\n}\n```\n\n### 6.2 å¹¶è¡Œè°ƒç”¨async/await\n\nåœ¨ä¸Šä¸€ä¸ªå‡½æ•°`doubleAndAdd`é‡Œä¾æ¬¡è°ƒç”¨äº†ä¸¤ä¸ª`async`å‡½æ•°ï¼Œä½†æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½ç­‰å¾…äº†1ç§’ï¼Œæ•ˆç‡å¾ˆå·®ï¼›å› ä¸º`a`å’Œ`b`ä¹‹é—´æ²¡æœ‰è€¦åˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`Promise.all`æ¥å¹¶è¡Œæ‰§è¡Œè¿™ä¸¤æ¬¡è°ƒç”¨:\n\n```Javascript\nasync function doubleAndAdd(a, b) {\n  // ä½¿ç”¨`Promise.all`\n  // è¿™ä¸ªåœ°æ–¹ä½¿ç”¨æ•°ç»„`è§£æ„`\n  // æ¥å¾—åˆ°ä¸¤æ¬¡è°ƒç”¨çš„ç»“æœ\n  const [a, b] = Promise.all([doubleAfter1Sec(a), doubleAfter1Sec(b)])\n  return a + b\n}\n\ndoubleAndAdd(1, 2).then(console.log) // 5 \n\nasync function doubleAfter1Sec(param) {\n  return new Promise(resolve => {\n    setTimeout(() => {\n      resolve(param * 2)\n    }, 1000)\n  })\n}\n```\n\n### 6.3 async/awaitçš„é”™è¯¯å¤„ç†\n\nä½¿ç”¨`async/await`æ—¶çš„é”™è¯¯å¤„ç†æœ‰å¾ˆå¤šæ–¹æ³•ï¼š\n\n#### 1. åœ¨å‡½æ•°å†…ä½¿ç”¨try/catch\n\n```Javascript\nasync function doubleAndAdd(a, b) {\n  try {\n    a = await doubleAfter1Sec(a)\n    b = await doubleAfter1Sec(b)\n  } catch (e) {\n    return NaN\n  }\n  return a + b\n}\n\ndoubleAndAdd('one', 2).then(console.log) // NaN\ndoubleAndAdd(1, 2).then(console.log) // 5 \n\nasync function doubleAfter1Sec(param) {\n  return new Promise(resolve => {\n    setTimeout(() => {\n      const val = param * 2\n      isNaN(val) ? reject(NaN) : resolve(val)\n    }, 1000)\n  })\n}\n```\n\n#### 2. catch æ‰€æœ‰`await`è¡¨è¾¾å¼\n\nå› ä¸º`await`è¡¨è¾¾å¼è¿”å›ä¸€ä¸ª`promise`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨`await`è¡¨è¾¾å¼åç›´æ¥æ‰§è¡Œ`catch`æ¥å¤„ç†é”™è¯¯\n\n```Javascript\nasync function doubleAndAdd(a, b) {\n  a = await doubleAfter1Sec(a).catch(e => console.log(`'a' is NaN`)\n  b = await doubleAfter1Sec(b).catch(e => console.log(`'b' is NaN`))\n\n  if (!a || !b) return NaN\n  return a + b\n}\n\ndoubleAndAdd('one', 2).then(console.log) // NaN, \"a\" is NaN\ndoubleAndAdd(1, 2).then(console.log) // 5 \n\nasync function doubleAfter1Sec(param) {\n  return new Promise(resolve => {\n    setTimeout(() => {\n      const val = param * 2\n      isNaN(val) ? reject(NaN) : resolve(val)\n    }, 1000)\n  })\n}\n```\n\n#### 3. catch æ•´ä¸ªasync-awaitå‡½æ•°\n\n```Javascript\nasync function doubleAndAdd(a, b) {\n  a = await doubleAfter1Sec(a)\n  b = await doubleAfter1Sec(b)\n  return a + b\n}\n\ndoubleAndAdd('one', 2)\n  .then(console.log)\n  .catch(console.log) // ä½¿ç”¨catch\n```\n\n![](1_X755b572fEcI0vK0fRKWkw.png)\n\n> ECMAScriptç›®å‰åœ¨æœ€ç»ˆç¨¿é˜¶æ®µï¼Œå°†ä¼šåœ¨2018å¹´6æœˆæˆ–7æœˆæ­£å¼æ¨å‡ºã€‚ä¸‹é¢ä»‹ç»çš„æ‰€æœ‰ç‰¹æ€§å±äº**stage-4**ï¼Œéƒ½å°†æˆä¸ºECMAScript 2018çš„ä¸€éƒ¨åˆ†ã€‚\n\n## 1. å…±äº«å†…å­˜å’ŒåŸå­æ€§\n\nè¿™æ˜¯JSçš„ä¸€ä¸ªé«˜çº§ç‰¹æ€§ï¼Œæ˜¯JSå¼•æ“çš„æ ¸å¿ƒæ”¹è¿›ã€‚\n\n**å…±äº«å†…å­˜çš„ä¸»è¦æ€æƒ³æ˜¯ï¼š æŠŠå¤šçº¿ç¨‹çš„ç‰¹æ€§å¸¦åˆ°JSï¼Œå¼€å‘è€…ä»ä¹‹å‰ç”±JSå¼•æ“ç®¡ç†å†…å­˜å˜ä¸ºè‡ªå·±ç®¡ç†å†…å­˜ï¼Œä»è€Œå†™å‡ºé«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„ä»£ç ã€‚**\n\nè¿™ä¸ªç‰¹æ€§ç”±ä¸€ä¸ªæ–°çš„å…¨å±€å¯¹è±¡[SharedArrayBuffer](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)æ¥å®ç°ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨ä¸€å—**å…±äº«å†…å­˜ç©ºé—´**å‚¨å­˜æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ•°æ®å¯ä»¥ç”±JSçš„ä¸»çº¿ç¨‹å’Œ`web-worker`çº¿ç¨‹å…±äº«ã€‚\n\nå½“å‰ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨JSä¸»çº¿ç¨‹å’Œweb-workeré—´å…±äº«æ•°æ®æ—¶ï¼Œå¿…é¡»ä½¿ç”¨`postMessage`åœ¨ä¸åŒçº¿ç¨‹é—´ä¼ é€’æ•°æ®ï¼Œæœ‰äº†`SharedArrayBuffer`åï¼Œä¸åŒçš„çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®è¿™ä¸ªå¯¹è±¡æ¥å…±äº«æ•°æ®ã€‚\n\nä½†æ˜¯å¤šçº¿ç¨‹é—´çš„å…±äº«å†…å­˜ä¼šå¯¼è‡´ç«æ€æ¡ä»¶ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¼•å…¥äº†`åŸå­æ€§`çš„å…¨å±€å¯¹è±¡ã€‚åŸå­æ€§å¯¹è±¡æä¾›äº†å„ç§æ–¹æ³•æ¥é”ä½æ­£åœ¨è¢«æŸä¸ªçº¿ç¨‹è®¿é—®çš„å†…å­˜ï¼Œä»¥ä¿è¯å†…å­˜å®‰å…¨ã€‚\n","date":"2018-04-03"},{"title":"mybatis å…¥é—¨","tags":["Java","Mybatis","Translate","backend"],"iso8601Date":"2017-03-21T19:58:14+08:00","basename":"mybatis-started","body":"\n[åŸæ–‡é“¾æ¥](http://www.mybatis.org/mybatis-3/getting-started.html)\n#### å®‰è£…\nä½¿ç”¨Mybatisåªéœ€è¦å°†[mybatis-x.x.x.jar](https://github.com/mybatis/mybatis-3/releases)æ·»åŠ åˆ°ç±»è·¯å¾„å³å¯ã€‚\nå¦‚æœä½¿ç”¨mavenåªéœ€è¦å°†ä¸‹åˆ—ä»£ç æ·»åŠ åˆ°pom.xmlä¸­ã€‚\n```xml\n<dependency>\n  <groupId>org.mybatis</groupId>\n  <artifactId>mybatis</artifactId>\n  <version>x.x.x</version>\n</dependency>\n```\n#### æ ¹æ®XMLé…ç½®æ„å»ºSqlSessionFactory\næ¯ä¸€ä¸ªMybatisåº”ç”¨éƒ½å›´ç»•SqlSessionFactoryå±•å¼€ã€‚ä¸€ä¸ªSqlSessionFactoryå®ä¾‹ç”±SqlSessionFactoryBuilderåˆ›å»ºã€‚SqlSessionFacotryBuilderå¯ä»¥é€šè¿‡XMLçš„é…ç½®æ–‡ä»¶æˆ–è€…ä¸€ä¸ªé…ç½®å¥½çš„Configurationç±»æ¥åˆ›å»ºSqlSessionFactoryã€‚\næ ¹æ®XMLé…ç½®æ¥æ„å»ºSqlSessionFacotryéå¸¸çš„ç®€å•ã€‚æ¨èä½¿ç”¨åœ¨ç±»è·¯å¾„æ¥é…ç½®ï¼Œä½†æ˜¯åŒæ ·å¯ä»¥ä½¿ç”¨ä»»ä½•çš„InputStreamå®ä¾‹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶è·¯å¾„æˆ–è€…æ˜¯file:// çš„URLã€‚Mybatisæœ‰ä¸€ä¸ªå«`Resource`çš„å·¥å…·å‡½æ•°ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ä»ç±»è·¯å¾„æˆ–è€…å…¶ä»–æ–‡ä»¶è·¯å¾„åŠ è½½èµ„æºã€‚\n```Java\nString resource = \"org/mybatis/example/mybatis-config.xml\";\nInputStream inputStream = Resources.getResourceAsStream(resource);\nSqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);\n```\nXMLé…ç½®æ–‡ä»¶åŒ…å«äº†Mybatisçš„æ ¸å¿ƒè®¾ç½®ï¼ŒåŒ…æ‹¬å¯¹åº”æ•°æ®åº“è¿æ¥çš„æ•°æ®æºï¼ŒåŒæ ·è¿˜æœ‰ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨æ¥å†³å®šäº‹åŠ¡çš„èŒƒå›´å’Œæ§åˆ¶ã€‚å®Œæ•´çš„XMLé…ç½®ç¨åä¼šåœ¨æ–‡æ¡£ä¸­åˆ—å‡ºï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®ã€‚\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE configuration\n  PUBLIC \"-//mybatis.org//DTD Config 3.0//EN\"\n  \"http://mybatis.org/dtd/mybatis-3-config.dtd\">\n<configuration>\n  <environments default=\"development\">\n    <environment id=\"development\">\n      <transactionManager type=\"JDBC\"/>\n      <dataSource type=\"POOLED\">\n        <property name=\"driver\" value=\"${driver}\"/>\n        <property name=\"url\" value=\"${url}\"/>\n        <property name=\"username\" value=\"${username}\"/>\n        <property name=\"password\" value=\"${password}\"/>\n      </dataSource>\n    </environment>\n  </environments>\n  <mappers>\n    <mapper resource=\"org/mybatis/example/BlogMapper.xml\"/>\n  </mappers>\n</configuration>\n```\nXMLé…ç½®æ–‡ä»¶çš„å…ƒç´ è¿˜æœ‰å¾ˆå¤šï¼Œä¸Šé¢è¿™ä¸ªé…ç½®åªæ˜¯æŒ‡å‡ºäº†æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚æ³¨æ„XMLçš„headerï¼Œæ˜¯ç”¨æ¥éªŒè¯xmlæ–‡ä»¶çš„ã€‚`environment`å…ƒç´ åŒ…å«äº†ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨å’Œä¸€ä¸ªè¿æ¥æ± ã€‚`mappers`å…ƒç´ åŒ…å«äº†å¾ˆå¤š`mapper`ï¼Œmapperå¯ä»¥æ˜¯xmlé…ç½®æˆ–è€…åªJava çš„interfaceï¼Œä»–ä»¬éƒ½åŒ…å«äº†SQLä»£ç å’Œmapperçš„å®šä¹‰ã€‚\n#### ä¸ä½¿ç”¨XMLæ„å»ºSqlSessionFactory\nå¦‚æœä½ ä¸æƒ³ä½¿ç”¨XMLé…ç½®æˆ–è€…æƒ³è‡ªå·±åˆ›å»ºé…ç½®æ„é€ å™¨ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Javaæ¥æ„å»ºé…ç½®ã€‚MyBatisæä¾›äº†ä¸€ä¸ªConfigurationç±»å¯ä»¥æä¾›æ‰€æœ‰XMLé…ç½®æ–‡ä»¶æ‰€èƒ½æä¾›çš„é…ç½®ã€‚\n```Java\nDataSource dataSource = BlogDataSourceFactory.getBlogDataSource();\nTransactionFactory transactionFactory = new JdbcTransactionFactory();\nEnvironment environment = new Environment(\"development\", transactionFactory, dataSource);\nConfiguration configuration = new Configuration(environment);\nconfiguration.addMapper(BlogMapper.class);\nSqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(configuration);\n```\næ³¨æ„åœ¨è¿™ä¸ªé…ç½®ä¸­æ·»åŠ äº†ä¸€ä¸ªmapperç±»ã€‚mapperç±»åŒ…å«äº†ä¸€ä¸ªSQLæ˜ å°„çš„æ³¨è§£ï¼Œè¿™æ ·å¯ä»¥é¿å…ä½¿ç”¨XMLé…ç½®mapperã€‚ä½†æ˜¯ç”±äºJavaæ³¨è§£çš„é™åˆ¶å’Œä¸€äº›MyBatiså¤æ‚çš„mapperé…ç½®ï¼ŒXML mapperä»ç„¶æ˜¯ä¸€äº›å¤æ‚çš„é«˜çº§æ˜ å°„çš„é¦–é€‰ï¼ˆä¾‹å¦‚ï¼Œinner join)ã€‚å› æ­¤MyBatisä¼šè‡ªåŠ¨å¯»æ‰¾å¹¶åŠ è½½æ¯ä¸€ä¸ªXMLé…ç½®ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­BlogMapper.xmlå°†ä¼šè¢«ä»ç±»è·¯å¾„ä¸­åŠ è½½)ã€‚æ›´å¤šçš„ç¨åä»‹ç»ã€‚\n#### ä»SqlSessionFactoryè·å–SqlSession\n ç°åœ¨ä½ å·²ç»æœ‰äº†SqlSessionFactoryäº†ï¼Œæ ¹æ®åå­—çš„æç¤ºï¼Œå¯ä»¥ä»å®ƒå¾—åˆ°ä¸€ä¸ªSqlSessionå®ä¾‹ã€‚SqlSessionåŒ…å«äº†æ‰€æœ‰æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„SQLæ–¹æ³•ã€‚ä½ å¯ä»¥ç›´æ¥é€šè¿‡SqlSessionæ‰§è¡Œæ˜ å°„çš„SQLã€‚ä¾‹å¦‚ï¼š\n```Java\nSqlSession session = sqlSessionFactory.openSession();\ntry {\n  Blog blog = session.selectOne(\"org.mybatis.example.BlogMapper.selectBlog\", 101);\n} finally {\n  session.close();\n}\n```\nè™½ç„¶è¿™ç§æ–¹å¼å¯¹äºä¹‹å‰çš„MyBatisçš„ç”¨æˆ·æ¥è¯´å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯ç°åœ¨æœ‰ä¸€ç§è·Ÿæ¸…æ™°çš„æ–¹å¼ã€‚ä½¿ç”¨æ¥å£ï¼ˆä¾‹å¦‚ï¼šBlogMapper.classï¼‰ï¼Œè¯¥æ¥å£çš„æ–¹æ³•å®šä¹‰äº†å‚æ•°å’Œè¿”å›å€¼ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨æ›´åŠ æ¸…æ™°çš„ï¼Œç±»å‹å®‰å…¨çš„ä»£ç ï¼Œè€Œä¸å†éœ€è¦å®¹æ˜“å‘ç”Ÿé”™è¯¯çš„å¹¶ä¸”å»è¦å¼ºåˆ¶ç±»å‹è½¬æ¢çš„ä»£ç ã€‚ä¾‹å¦‚ï¼š\n```Java\nSqlSession session = sqlSessionFactory.openSession();\ntry {\n  BlogMapper mapper = session.getMapper(BlogMapper.class);\n  Blog blog = mapper.selectBlog(101);\n} finally {\n  session.close();\n}\n```\nç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åˆ°åº•æ‰§è¡Œäº†äº›ä»€ä¹ˆã€‚\n#### æ¢ç´¢æ˜ å°„çš„SQLè¯­å¥\nç°åœ¨ä½ å¯èƒ½åœ¨æƒ³SqlSessionå’ŒMapperç±»åˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆã€‚æ˜ å°„SQLè¯­å¥è¿™ä¸ªä¸»é¢˜æ¯”è¾ƒå¤§ï¼Œè¿™ä¸ªä¸»é¢˜å·®ä¸å¤šå æ®äº†æ­¤æ–‡æ¡£çš„ä¸€å¤§éƒ¨åˆ†ã€‚ä½†æ˜¯ä¸‹é¢è¿™äº›è¯­å¥ä¼šå±•ç¤ºè¿™äº›ç¤ºä¾‹åˆ°åº•æ‰§è¡Œäº†äº›ä»€ä¹ˆã€‚\næ— è®ºæ˜¯ä¸Šé¢è¿˜æ˜¯ä¸‹é¢è¿™äº›ä¾‹å­ï¼Œè¿™äº›è¯­å¥éƒ½å¯ä»¥è¢«å®šä¹‰åœ¨XMLæˆ–è€…æ³¨è§£ä¸Šã€‚è®©æˆ‘ä»¬å…ˆä½¿ç”¨XMLç±»é…ç½®ã€‚é€šè¿‡XMLæ˜ å°„å®ç°çš„MyBatiså…¨å¥—åŠŸèƒ½ä½¿å¾—MyBatisæµè¡Œäº†å¾ˆå¤šå¹´ã€‚å¦‚æœä½ ä»¥å‰ç”¨è¿‡MyBatisï¼Œè¿™äº›æ¦‚å¿µä½ å¯èƒ½å¾ˆç†Ÿæ‚‰ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸ºæ•°ä¼—å¤šçš„å¯¹XMLæ˜ å°„æ–‡æ¡£çš„æ”¹è¿›ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯ä»¥æ»¡è¶³ä¸Šé¢çš„SqlSesionè°ƒç”¨çš„XMLé…ç½®çš„æ˜ å°„è¯­å¥ã€‚\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE mapper\n  PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\"\n  \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n<mapper namespace=\"org.mybatis.example.BlogMapper\">\n  <select id=\"selectBlog\" resultType=\"Blog\">\n    select * from Blog where id = #{id}\n  </select>\n</mapper>\n```\nè™½ç„¶è¿™ä¸ªä¾‹å­å¯¹äºè¿™ä¸ªç®€å•çš„é¡¹ç›®çœ‹èµ·æ¥å¾ˆé‡é‡çº§ï¼Œå®é™…ä¸Šä»–æ˜¯å¾ˆè½»é‡çº§çš„ã€‚ä½ å¯ä»¥åœ¨ä¸€ä¸ªXMLçš„æ˜ å°„æ–‡ä»¶ä¸­å®šä¹‰è®¸å¤šçš„æ˜ å°„è¯­å¥ï¼Œå› æ­¤ä½ å¯ä»¥å‡å°‘å¾ˆå¤šçš„XMLçš„headerå’Œdoctypeå£°æ˜ã€‚æ–‡ä»¶ä½™ä¸‹çš„éƒ¨åˆ†å®Œå…¨å¯ä»¥è‡ªè§£é‡Šã€‚åœ¨å‘½åç©ºé—´`org.mybatis.example.BlogMapper`ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º`selectBlog`çš„æ˜ å°„è¯­å¥ã€‚ä»–å¯ä»¥è®©ä½ åƒä¾‹å­ä¸­é‚£æ ·é€šè¿‡å…¨é™å®šå`org.mybatis.example.BlogMapper.selectBlog`è°ƒç”¨ä»–ã€‚\n```Java\nBlog blog = session.selectOne(\"org.mybatis.example.BlogMapper.selectBlog\", 101);\n```\næ³¨æ„ä»–å’Œè°ƒç”¨çš„Javaå‡½æ•°å¾ˆç›¸ä¼¼ï¼Œè¿™ä¹ˆåšæ˜¯æœ‰åŸå› çš„ã€‚è¿™ä¸ªåå­—å¯ä»¥ç›´æ¥æ˜ å°„å…·æœ‰ç›¸åŒåå­—çš„å‘½åç©ºé—´ï¼Œå‡½æ•°åï¼Œå‚æ•°ï¼Œè¿”å›å€¼éƒ½å¯ä»¥å’Œselectè¯­å¥åŒ¹é…ã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡ç®€å•çš„è°ƒç”¨Mapperæ¥å£çš„å‡½æ•°æ¥ä½¿ç”¨æ˜ å°„çš„SQLè¯­å¥äº†ã€‚\n```Java\nBlogMapper mapper = session.getMapper(BlogMapper.class);\nBlog blog = mapper.selectBlog(101);\n```\nç¬¬äºŒä¸ªä¾‹å­æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œé¦–å…ˆä»–å¹¶ä¸ä¾èµ–äºå­—ç¬¦ä¸²å­—é¢é‡ï¼Œè¿™æ ·ä»–æ›´åŠ çš„å®‰å…¨ã€‚å…¶æ¬¡ï¼ŒIDEéƒ½æœ‰ä»£ç è¡¥å…¨ï¼Œå½“å¯¼èˆªåˆ°æ˜ å°„ä¸€å¥çš„æ—¶å€™å¯ä»¥åˆ©ç”¨è¿™ä¸ªã€‚\n> namespace çš„æ³¨æ„äº‹é¡¹  \n> MyBatisä¹‹å‰çš„ç‰ˆæœ¬**Namespace**æ˜¯å¯é€‰çš„ï¼Œè¿™æ ·æ—¢æ²¡ç”¨åˆå›°æƒ‘ã€‚ç°åœ¨namespaceæ˜¯å¿…é¡»çš„ï¼Œé€šè¿‡ä¸€ä¸ªå¾ˆé•¿çš„ï¼Œå…¨é™å®šåçš„è¯­å¥æ¥åŒºåˆ†ä¸åŒçš„è¯­å¥ã€‚  \n> æ­£å¦‚æ‰€è§ï¼Œnamespaceç»‘å®šäº†æ¥å£ï¼Œå³ä½¿ä½ ç°åœ¨ä¸ä½¿ç”¨ä»–ä»¬ï¼Œä¹Ÿè¦éµå®ˆè¿™ä¸ªè§„åˆ™ï¼Œä»¥é˜²å“ªå¤©æ”¹å˜æƒ³æ³•ã€‚ä»é•¿è¿œæ¥çœ‹ï¼Œä½¿ç”¨Namespaceå°†ä»–æ”¾åœ¨ä¸€ä¸ªJavaçš„packageåä¸­å¯ä»¥ä½¿ä»£ç æ›´æ¸…æ™°ï¼Œæé«˜å¯ç”¨æ€§ã€‚\n> åå­—è§£æï¼šä¸ºäº†å‡å°‘è¾“å…¥ï¼Œå¯¹äºæ‰€æœ‰çš„å‘½åé…ç½®ï¼ŒåŒ…æ‹¬è¯­å¥ï¼Œresult mapï¼Œ cacheï¼Œä½¿ç”¨ä¸‹åˆ—åå­—è§£æè§„åˆ™ï¼š\n> * å…¨é™å®šåï¼ˆä¾‹å¦‚ï¼šcom.mypackage.MyMapper.selectAllThingsï¼‰ç›´æ¥æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åç›´æ¥ä½¿ç”¨ã€‚\n> * çŸ­åå­—ï¼ˆä¾‹å¦‚ï¼šselectAllThingsï¼‰å¯ä»¥ä½¿ç”¨ä»»ä½•æ˜ç¡®çš„æ¡ç›®ã€‚ç„¶è€Œå¦‚æœåŒ¹é…äº†å¤šäº†ä¸ªï¼ˆä¾‹å¦‚ï¼šcom.foo.selectAllThings and com.bar.selectAllThingï¼‰ï¼Œé‚£ä¹ˆå°†ä¼šæŠ¥åå­—æ¨¡ç³Šçš„é”™è¯¯ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»ä½¿ç”¨å…¨é™å®šåã€‚\n\nå¯¹äºBlogMapperè¿˜æœ‰ä¸€ä¸ªå°è¯€çªã€‚ä»–ä»¬çš„æ˜ å°„è¯­å¥å®Œå…¨ä¸éœ€è¦XMLé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£æ¥ä»£æ›¿ã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±å¯ä»¥ä»£æ›¿XMLé…ç½®ï¼š\n```Java\npackage org.mybatis.example;\npublic interface BlogMapper {\n  @Select(\"SELECT * FROM blog WHERE id = #{id}\")\n  Blog selectBlog(int id);\n}\n```\næ³¨è§£ç›¸å¯¹æ¥è¯´æ›´åŠ çš„ç®€æ´ï¼Œä½†æ˜¯ç”±äºæ³¨è§£è‡ªèº«çš„é™åˆ¶å’Œä¸€äº›å¤æ‚è¯­å¥çš„å¤æ‚æ€§ï¼Œå¦‚æœä½¿ç”¨å¤æ‚çš„SQLè¯­å¥æœ€å¥½è¿˜æ˜¯ä½¿ç”¨XMLé…ç½®ã€‚\nè¿™ä¸ªå®Œå…¨å–å†³äºä½ å’Œä½ çš„å›¢é˜Ÿå’Œå®šä¹‰æ˜ å°„è¯­å¥çš„ä¸€è‡´æ€§ç±»å†³å®šä½¿ç”¨å“ªä¸ªæ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ ä¸éœ€è¦ä»…ä»…é€‰æ‹©ä¸€ä¸ªã€‚ä»æ³¨è§£åˆ°XMLçš„è¿ç§»æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œåä¹‹äº¦ç„¶ã€‚\n#### ä½œç”¨åŸŸå’Œç”Ÿå‘½å‘¨æœŸ\næ˜ç™½æˆ‘ä»¬ç°åœ¨æ‰€è®¨è®ºçš„ç±»çš„ä½œç”¨åŸŸå’Œç”Ÿå‘½å‘¨æœŸæ˜¯å¾ˆé‡è¦çš„ã€‚é”™è¯¯çš„ä½¿ç”¨ä¼šå¯¼è‡´å¹¶å‘é”™è¯¯ã€‚\n> **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–æ³¨å…¥æ¡†æ¶**    \n> ä¾èµ–æ³¨å…¥æ¡†æ¶å¯ä»¥åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„ï¼Œå¸¦äº‹åŠ¡ç®¡ç†çš„SqlSessionå’Œmapperå¹¶ä¸”å°†å®ƒä»¬æ³¨å…¥åˆ°éœ€è¦çš„Beanä¸­ï¼Œå› æ­¤ä½ å¯ä»¥ç›´æ¥å¿½ç•¥ä»–çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœè¦ç†Ÿæ‚‰MyBatiså’ŒDI æ¡†æ¶çš„å…³ç³»å¯ä»¥çœ‹ä¸€ä¸‹MyBatis-Spring å’ŒMyBatis-Guiceä¸¤ä¸ªé¡¹ç›®\n\n##### SqlSessionFactoryBuilder\nè¿™ä¸ªç±»è¢«åˆå§‹åŒ–ï¼Œä½¿ç”¨å®Œä¹‹åå¯ä»¥ç›´æ¥ä¸¢å¼ƒäº†ã€‚å½“ä½ åˆ›å»ºå®ŒSqlSessionFactoryä¹‹åå°±æ²¡å¿…è¦ç•™ç€ä»–äº†ã€‚å› æ­¤SqlSessionFactoryBuilderæœ€å¥½çš„ä½œç”¨åŸŸæ˜¯åœ¨æ–¹æ³•ä½œç”¨åŸŸä¸­ï¼ˆä¾‹å¦‚ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼‰ã€‚å¯ä»¥é‡ç”¨SqlSessionFactoryBuilderæ¥åˆ›å»ºå¤šä¸ªSqlSessionFactoryå®ä¾‹ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ä¸è¦ä¿ç•™å®ƒï¼Œä¿è¯æ‰€æœ‰çš„XMLéƒ½è¢«è§£æç”¨æ¥åšæ›´é‡è¦çš„äº‹æƒ…ã€‚\n##### SqlSessionFactory\nå½“SqlSesslionFactoryåˆ›å»ºäº†ä¹‹åï¼Œå°±åº”è¯¥ä¸€ç›´å­˜åœ¨ä½ çš„åº”ç”¨ä¸­ã€‚ä¸€èˆ¬æ¥è¯´æ˜¯æ²¡æœ‰ç†ç”±é‡æ–°åˆ›å»ºæˆ–å¤„ç†ä»–çš„ã€‚åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æœ€å¥½ä¸è¦å¤šæ¬¡é‡æ–°æ„å»ºSqlSessionFactoryã€‚å¦‚æœè¿™æ ·åšå°±ä¼šæœ‰åä»£ç çš„å‘³é“äº†ã€‚å› æ­¤SqlSessionFactoryçš„ä½œç”¨åŸŸæœ€å¥½æ˜¯åº”ç”¨ä½œç”¨åŸŸã€‚å®ç°çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæœ€å¥½çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨å•ä¾‹æ¨¡å¼æˆ–è€…æ˜¯é™æ€å•ä¾‹æ¨¡å¼ã€‚\n##### SqlSession\næ¯ä¸ªçº¿ç¨‹éƒ½åº”è¯¥æœ‰è‡ªå·±çš„SqlSessionã€‚SqlSessionçš„ç¤ºä¾‹ä¸èƒ½åˆ†äº«ä¸”éçº¿ç¨‹å®‰å…¨ã€‚å› æ­¤æœ€å¥½çš„ä½œç”¨åŸŸæ˜¯è¯·æ±‚ä½œç”¨åŸŸå’Œæ–¹æ³•ä½œç”¨åŸŸã€‚æ°¸è¿œä¸è¦åœ¨é™æ€åŸŸæˆ–è€…ç±»å®ä¾‹ä¸­å¼•ç”¨SqlSessionã€‚æ°¸è¿œä¸è¦å°†SqlSessionæ”¾åˆ°managed ä½œç”¨åŸŸä¸­ï¼Œä¾‹å¦‚Servletæ¡†æ¶çš„HttpSessionã€‚å¦‚æœä½¿ç”¨çš„æ˜¯webæ¡†æ¶ï¼Œå¯ä»¥å°†å…¶æ”¾åˆ°HTTP è¯·æ±‚çš„ä½œç”¨åŸŸä¸­ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œæ¥æ”¶åˆ°HTTPè¯·æ±‚çš„æ—¶å€™å¯ä»¥æ‰“å¼€SqlSesslionè¿æ¥ï¼Œå“åº”çš„æ—¶å€™å…³é—­ã€‚å…³é—­SqlSessionéå¸¸çš„é‡è¦ï¼Œæ°¸è¿œè®°å¾—å°†å…¶æ”¾åœ¨finallyå—ä¸­æ¥å…³é—­ä»–ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯ç¡®ä¿åœ¨finallyä¸­å…³é—­SqlSesslion\n```Java\nSqlSession session = sqlSessionFactory.openSession();\ntry {\n  // do work\n} finally {\n  session.close();\n}\n```\nä½¿ç”¨è¿™ä¸ªæ¨¡å¼å¯ä»¥ä¿è¯ä½ çš„ä»£ç å…³é—­äº†æ•°æ®åº“çš„è¿æ¥ã€‚\n##### Mapper Instances\nMappersæ˜¯ä½ åˆ›å»ºç”¨æ¥ç»‘å®šæ˜ å°„è¯­å¥çš„æ¥å£ã€‚æ¯ä¸€ä¸ªmapperå®ä¾‹éƒ½ä»SqlSessionä¸­è·å–ã€‚å› æ­¤mapperçš„ä½œç”¨åŸŸå’Œè·å–ä»–ä»¬çš„SqlSessionçš„ä½œç”¨åŸŸæ˜¯ä¸€æ ·çš„ã€‚ç„¶è€Œmapperæœ€å¥½çš„ç§Ÿç”¨ä¸æ˜¯æ–¹æ³•ä½œç”¨åŸŸã€‚ä»–ä»¬åº”è¯¥åœ¨ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨æ—¶åˆ›å»ºï¼Œæ–¹æ³•ç»“æŸæ—¶ä¸¢å¼ƒã€‚ä»–ä»¬ä¸éœ€è¦æ˜¾ç¤ºçš„å…³é—­ã€‚å’ŒSqlSessionç›¸åŒï¼Œå°†å®ƒä»¬æ”¾åˆ°è¯·æ±‚ä½œç”¨åŸŸä¸­ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªå±‚æ¬¡ä¸Šå¤„ç†å¦‚æ­¤å¤šçš„èµ„æºä¼šå¾ˆæ£˜æ‰‹ã€‚æ‰€ä»¥å°±ç®€å•ä¸€ç‚¹ï¼ŒæŠŠmapperå®ä¾‹æ”¾åˆ°æ–¹æ³•ä½œç”¨åŸŸä¸­ï¼Œä¸‹é¢è¿™ä¸ªä¾‹å­è§£é‡Šäº†å¦‚ä½•ä½¿ç”¨ä»–\n```Java\nSqlSession session = sqlSessionFactory.openSession();\ntry {\n  BlogMapper mapper = session.getMapper(BlogMapper.class);\n  // do work\n} finally {\n  session.close();\n}\n```\n","date":"2017-03-21"},{"title":"HTTP/2 å’ŒGO","tags":["http","HTTP/2","Translate","Go","backend"],"iso8601Date":"2015-11-12T19:39:21+08:00","basename":"HTTP-2-å’ŒGO","body":"\n[åŸæ–‡åœ°å€](https://www.ianlewis.org/en/http2-and-go)\n\nHTTP/2æ˜¯ä¸€ä¸ªæ·»åŠ äº†ä¸€äº›æ–°åŠŸèƒ½çš„HTTPçš„æ–°ç‰ˆæœ¬ï¼Œè¿™äº›åŠŸèƒ½åŒ…æ‹¬è¿æ¥å¤ç”¨ï¼Œé¦–éƒ¨å‹ç¼©ã€‚å†Goçš„æ ‡å‡†åº“ä¸­æš‚æ—¶è¿˜æ²¡æœ‰HTTP/2çš„å®ç°ï¼Œä½†æ˜¯ç°åœ¨æœ‰å¾ˆå¤šæ­£åœ¨å¼€å‘çš„åº“å¯ä»¥ç”¨æ¥åœ¨Goä¸­å®ç°HTTP/2çš„serverå’Œclientã€‚\n\nBrad Fitzpatrickå®ç°äº†ä¸€ä¸ª[golang.org/x/net/http2](https://godoc.org/golang.org/x/net/http2)çš„åº“ï¼Œè¿™ä¸ªåº“ç”šè‡³æœ€ç»ˆä¼šåŠ å…¥åˆ°æ ‡å‡†åº“ä¸­ï¼Œä¸è¿‡ä»–ç°åœ¨æ­£åœ¨å¼€å‘ï¼Œæ‰€ä»¥åœ¨å…¶ä»–çš„åº“ä¸­ã€‚å› ä¸ºä»–ç°åœ¨çš„å¼€å‘å¾ˆæ´»è·ƒï¼Œæ‰€æœ‰æƒ…å†µå› äººè€Œå¼‚ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³å®ç°HTTP/2çš„æœåŠ¡å™¨ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªåº“ã€‚\n\n### åˆ›å»ºHTTP/2æœåŠ¡å™¨\n\nä½¿ç”¨http2çš„åº“å†™ä¸€ä¸ªæœåŠ¡å™¨æ˜¯å¾ˆç®€å•çš„ã€‚http2åº“å’Œæ ‡å‡†åº“çš„httpåŒ…é›†æˆåœ¨ä¸€èµ·ï¼Œéœ€è¦è°ƒç”¨`http2.ConfigureServer()`æ¥é…ç½®ä¸€ä¸ªæ™®é€šhttpä½¿ç”¨HTTP/2åè®®ã€‚å¦‚æœéœ€è¦é€šè¿‡æµè§ˆå™¨è®¿é—®æˆ–è€…é™çº§åˆ°HTTP 1.x åè®®ï¼Œé‚£ä¹ˆä½ éœ€è¦è®¾ç½®TLS åŠ å¯†ã€‚è™½ç„¶åŠ å¯†ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æ²¡æœ‰æµè§ˆå™¨æ”¯æŒéåŠ å¯†çš„HTTP/2åè®®ã€‚\n\n```Go\npackage main\n\nimport (\n    \"log\"\n    \"net/http\"\n    \"os\"\n\n    \"golang.org/x/net/http2\"\n)\n\nfunc main() {\n    cwd, err := os.Getwd()\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    srv := &http.Server{\n        Addr:    \":8000\", // Normally \":443\"\n        Handler: http.FileServer(http.Dir(cwd)),\n    }\n    http2.ConfigureServer(srv, &http2.Server{})\n    log.Fatal(srv.ListenAndServeTLS(\"server.crt\", \"server.key\"))\n}\n```\n\n### åˆ›å»ºHTTP/2 å®¢æˆ·ç«¯\n\nç°åœ¨ä½¿ç”¨http2çš„åº“åˆ›å»ºå®¢æˆ·ç«¯å¾ˆhackyã€‚è™½ç„¶å®ƒä¼šè¾“å‡ºå¾ˆå¤šè°ƒè¯•æ—¥å¿—ï¼Œä½†æ˜¯å¯¹äºå¤§å¤šæ•°æƒ…å†µä¸‹è¿è¡Œçš„å¾ˆå¥½ã€‚å¯ä»¥ä½¿ç”¨`http2.Transport`å¯¹è±¡ï¼Œå°†ä»–ä¼ ç»™`http`åŒ…çš„clientã€‚\n\n```Go\npackage main\n\nimport (\n    \"fmt\"\n    \"io/ioutil\"\n    \"log\"\n    \"net/http\"\n\n    \"golang.org/x/net/http2\"\n)\n\nfunc main() {\n    client := http.Client{\n        // InsecureTLSDial is temporary and will likely be\n        // replaced by a different API later.\n        Transport: &http2.Transport{InsecureTLSDial: true},\n    }\n\n    resp, err := client.Get(\"https://localhost:8000/\")\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    body, err := ioutil.ReadAll(resp.Body)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    fmt.Println(string(body))\n}\n```\n\n### æ›´å¤šé˜…è¯»\n\nå¦‚æœä½ å¯¹HTTP/2åè®®æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒ[HTTP/2 ä¸»é¡µ](https://http2.github.io/)ï¼Œè¿™ä¸ªé¡µé¢æœ‰å¾ˆå¤šå…¶ä»–èµ„æ–™çš„è¿æ¥è¿˜æœ‰å…¶ä»–è¯­è¨€çš„å®ç°ã€‚\n\nå¦‚æœä½ æƒ³çŸ¥é“HTTP/2çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ˜¯å¦‚ä½•å®ç°çš„ï¼Œé‚£ä¹ˆ[Jxck's http2 implementation](https://github.com/Jxck/http2)çš„å®ç°å°±å¾ˆå€¼å¾—ä¸€è¯»ã€‚Jxcké€šè¿‡å¯¹æ ‡å‡†çš„HTTPåº“çš„TLSNextProtoè®¾ç½®ä¸€ä¸ªé’©å­æ¥å®ç°çš„ã€‚ä½ å¯ä»¥å†è¿™é‡Œé˜…è¯»ä¸€äº›[ç¤ºä¾‹](https://github.com/Jxck/http2/blob/master/sample/http.go)ã€‚\n\ngrpc-go åº“åŒæ ·ä¹Ÿæœ‰è‡ªå·±çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å®ç°ã€‚\n","date":"2015-11-12"},{"title":"ä¸ºGo Web App åˆ›å»ºä¸€ä¸ªä¸»é¡µé¢","tags":["Go","Translate","backend"],"iso8601Date":"2015-11-15T01:59:00+08:00","basename":"ä¸ºGo-Web-App-åˆ›å»ºä¸€ä¸ªä¸»é¡µé¢","body":"\n\n\n[åŸæ–‡åœ°å€](http://sanatgersappa.blogspot.com/2013/11/creating-master-page-for-your-go-web-app.html)\n\n å¤§å¤šæ•°web appéƒ½æœ‰ä¸€ä¸ªç›¸åŒçš„å¸ƒå±€ã€‚è¿™ä¸ªå¸ƒå±€å¯èƒ½åŒ…å«ä¸€ä¸ªheaderæˆ–è€…footerï¼Œç”šè‡³å¯èƒ½åŒ…å«ä¸€ä¸ªå¯¼èˆªèœå•ã€‚Goçš„æ ‡å‡†åº“æä¾›ä¸€ä¸ªç®€å•çš„æ–¹å¼æ¥åˆ›å»ºè¿™äº›åŸºæœ¬å…ƒç´ ï¼Œé€šè¿‡è¢«ä¸åŒçš„é¡µé¢é‡ç”¨ï¼Œåˆ›å»ºå‡ºæ¨¡æ¿é¡µçš„æ•ˆæœã€‚\n è¿™ä¸ªç®€å•çš„ä¾‹å­æ¥è§£é‡Šå¦‚ä½•å®ç°çš„ï¼š\n è®©æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªç®€å•çš„åŒ…å«ä¸¤ä¸ªviewçš„web appï¼Œä¸€ä¸ªæ˜¯ main ä¸€ä¸ªæ˜¯aboutã€‚è¿™ä¸¤ä¸ªviewéƒ½æœ‰ç›¸åŒçš„headerå’Œfooterã€‚\n headeræ¨¡æ¿çš„ä»£ç å¦‚ä¸‹ï¼š\n\n```html\n{ { define \"header\" }}\n<!DOCTYPE html>\n<html>\n    <head>\n        <title>{ {.Title}}</title>\n        <link rel=\"stylesheet\" href=\"//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css\">\n        <link rel=\"stylesheet\" href=\"//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css\">\n        <style type=\"text/css\">\n            body {padding-bottom: 70px;}\n            .content {margin:10px;}\n        </style>\n    </head>\n    <body>\n        <nav class=\"navbar navbar-default\" role=\"navigation\">\n          <div class=\"navbar-header\">\n            <a class=\"navbar-brand\" href=\"/\">Go App</a>\n          </div>\n          <div class=\"collapse navbar-collapse navbar-ex1-collapse\">  \n            <ul class=\"nav navbar-nav\">\n                <li><a href=\"/\">Main</a></li>\n                <li><a href=\"/about\">About</a></li>\n            </ul>\n          </div>\n        </nav>\n{ { end }}\n```\n\n footeræ¨¡æ¿çš„ä»£ç å¦‚ä¸‹ï¼š\n\n\n```html\n{ { define \"footer\" }}\n        <p class=\"navbar-text navbar-fixed-bottom\">Go Rocks!</p>    \n        <script src=\"//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js\"></script>\n    </body>\n</html>\n{ { end }}\n\n```\n\n main æ¨¡æ¿çš„ä»£ç å¦‚ä¸‹ï¼š\n\n```html\n{ {define \"main\"}}\n{ { template \"header\" .}}\n<div class=\"content\">\n    <h2>Main</h2>\n    <div>This is the Main page</div>\n</div>\n{ {template \"footer\" .}}\n{ { end}}\n```\n\n about æ¨¡æ¿çš„ä»£ç å¦‚ä¸‹ï¼š\n\n```html\n{ {define \"about\"}}\n{ { template \"header\" .}}\n<div class=\"content\">\n    <h2>About</h2>\n    <div>This is the About page</div>\n</div>\n{ {template \"footer\" .}}\n{ { end}}\n```\n\n æœåŠ¡å™¨ä»£ç å¦‚ä¸‹ï¼š\n\n```Go\npackage main\n\nimport (\n    \"html/template\"\n    \"net/http\"\n)\n\n//Compile templates on start\nvar templates = template.Must(template.ParseFiles(\"header.html\", \"footer.html\", \"main.html\", \"about.html\"))\n\n//A Page structure\ntype Page struct {\n    Title string\n}\n\n//Display the named template\nfunc display(w http.ResponseWriter, tmpl string, data interface{}) {\n    templates.ExecuteTemplate(w, tmpl, data)\n}\n\n//The handlers.\nfunc mainHandler(w http.ResponseWriter, r *http.Request) {\n    display(w, \"main\", &Page{Title: \"Home\"})\n}\n\nfunc aboutHandler(w http.ResponseWriter, r *http.Request) {\n    display(w, \"about\", &Page{Title: \"About\"})\n}\n\nfunc main() {\n    http.HandleFunc(\"/\", mainHandler)\n    http.HandleFunc(\"/about\", aboutHandler)\n\n    //Listen on port 8080\n    http.ListenAndServe(\":8080\", nil)\n}\n```\n\n æ¯ä¸€ä¸ªæ¨¡æ¿é¡µéƒ½æœ‰ä¸€ä¸ª `{ { define \"name\" }}`çš„å‘½ä»¤æ¥å®šä¹‰æ¨¡æ¿çš„åå­—ã€‚mainå’Œabouté¡µé¢é€šè¿‡`{ { template \"name\" }}`æ¥åŒ…å«headerå’Œfooterã€‚`.` å‡ºå…¥ä¸Šä¸‹æ–‡æ¥å‘½åæ¨¡æ¿ã€‚ç°åœ¨ï¼Œä¸ç®¡mainå’Œabouté¡µé¢å¦‚ä½•æ‰§è¡Œï¼Œä»–ä»¬çš„é¡µé¢éƒ½ä¼šåŒ…å«headerå’Œfooterã€‚\n ä¸¤ä¸ªé¡µé¢çš„ç»“æœå¦‚ä¸‹ï¼š\n\n![main](https://raw.githubusercontent.com/mashuai/hexo-blog/master/goweb/main.png)  \n![about](https://raw.githubusercontent.com/mashuai/hexo-blog/master/goweb/about.png)  \n","date":"2015-11-15"},{"title":"ä½¿ç”¨Goå¼€å‘HTTPä¸­é—´ä»¶","tags":["HTTP","Go","Middleware","backend"],"iso8601Date":"2015-11-12T20:07:49+08:00","basename":"ä½¿ç”¨Goå¼€å‘HTTPä¸­é—´ä»¶","body":"\n[åŸæ–‡åœ°å€](https://justinas.org/writing-http-middleware-in-go/)\n\n å†webå¼€å‘çš„èƒŒæ™¯ä¸‹ï¼Œâ€œä¸­é—´ä»¶â€é€šå¸¸æ„æ€æ˜¯â€œåŒ…è£…åŸå§‹åº”ç”¨å¹¶æ·»åŠ ä¸€äº›é¢å¤–çš„åŠŸèƒ½çš„åº”ç”¨çš„ä¸€éƒ¨åˆ†â€ã€‚è¿™ä¸ªæ¦‚å¿µä¼¼ä¹æ€»æ˜¯ä¸è¢«äººç†è§£ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºä¸­é—´ä»¶éå¸¸æ£’ã€‚\n é¦–å…ˆï¼Œä¸€ä¸ªå¥½çš„ä¸­é—´ä»¶æœ‰ä¸€ä¸ªè´£ä»»å°±æ˜¯å¯æ’æ‹”å¹¶ä¸”è‡ªè¶³ã€‚è¿™å°±æ„å‘³ç€ä½ å¯ä»¥åœ¨æ¥å£çº§åˆ«åµŒå…¥ä½ çš„ä¸­é—´ä»¶ä»–å°±èƒ½ç›´æ¥è¿è¡Œã€‚å®ƒä¸ä¼šå½±å“ä½ ç¼–ç æ–¹å¼ï¼Œä¸æ˜¯æ¡†æ¶ï¼Œä»…ä»…æ˜¯ä½ è¯·æ±‚å¤„ç†é‡Œé¢çš„ä¸€å±‚è€Œå·²ã€‚å®Œå…¨æ²¡å¿…è¦é‡å†™ä½ çš„ä»£ç ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ä¸­é—´ä»¶çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä½ å°±å¸®ä»–æ’å…¥åˆ°é‚£é‡Œï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨äº†ï¼Œå°±å¯ä»¥ç›´æ¥ç§»é™¤ã€‚\n çºµè§‚Goè¯­è¨€ï¼Œä¸­é—´ä»¶æ˜¯éå¸¸æ™®éçš„ï¼Œå³ä½¿åœ¨æ ‡å‡†åº“ä¸­ã€‚è™½ç„¶å¼€å§‹çš„æ—¶å€™ä¸ä¼šé‚£ä¹ˆæ˜æ˜¾ï¼Œåœ¨æ ‡å‡†åº“`net/http`ä¸­çš„å‡½æ•°`StripText`æˆ–è€…`TimeoutHandler`å°±æ˜¯æˆ‘ä»¬è¦å®šä¹‰å’Œçš„ä¸­é—´ä»¶çš„æ ·å­ï¼Œå¤„ç†è¯·æ±‚å’Œç›¸åº”çš„æ—¶å€™ä»–ä»¬åŒ…è£…ä½ çš„handlerï¼Œå¹¶å¤„ç†ä¸€äº›é¢å¤–çš„æ­¥éª¤ã€‚\n æˆ‘æœ€è¿‘å†™çš„GoåŒ…[nosurf](https://github.com/justinas/nosurf)åŒæ ·ä¹Ÿæ˜¯ä¸ªä¸­é—´ä»¶ã€‚æˆ‘ç‰¹æ„å°†ä»–ä»å¤´å¼€å§‹è®¾è®¡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦åœ¨åº”ç”¨å±‚æ‹…å¿ƒCSRFæ”»å‡»ï¼Œnosurfåƒå…¶ä»–çš„ä¸­é—´ä»¶ä¸€æ ·å¯ä»¥è‡ªè¶³ï¼Œå¹¶ä¸”å’Œ`net/http`çš„æ¥å£æ— ç¼è¡”æ¥ã€‚\n åŒæ ·ä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶åšï¼š\n* éšè—é•¿åº¦é˜²æ­¢ç¼“å†²æ”»å‡»\n* é€Ÿåº¦é™åˆ¶\n* å±è”½çˆ¬è™«\n* æä¾›è°ƒè¯•ä¿¡æ¯\n* æ·»åŠ HSTSï¼ŒX-Frame-Optionså¤´\n* ä»é”™è¯¯ä¸­æ¢å¤\n* ç­‰ç­‰\n\n### ç¼–å†™ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶\n\n æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä¾‹å­æ˜¯å†™ä¸€ä¸ªåªå…è®¸ä¸€ä¸ªåŸŸåä¸‹çš„ç”¨æˆ·è®¿é—®çš„ä¸­é—´ä»¶ï¼Œé€šè¿‡HTTPçš„`HOST`headerå®ç°ã€‚è¿™æ ·çš„ä¸­é—´ä»¶å¯ä»¥é˜²æ­¢[ä¸»æœºæ¬ºéª—æ”»å‡»](http://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html)ã€‚\n\n### ç±»å‹çš„æœºæ„\n\n é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå«åš`SingleHost`\n\n```Go\ntype SingleHost struct {\n    handler     http.Handler\n    allowedHost string\n}\n```\n\n å®ƒåªåŒ…å«ä¸¤ä¸ªfieldã€‚\n* å¦‚æœæ˜¯ä¸€ä¸ªå¯ç”¨çš„Hostï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šè°ƒç”¨åµŒå…¥çš„handlerã€‚\n* allowedHost å°±æ˜¯å…è®¸çš„Hostã€‚\n å› ä¸ºæˆ‘ä»¬å°†å…¶é¦–å­—æ¯å°å†™ï¼Œå› æ­¤ä»–ä»¬åªå¯¹æœ¬åŒ…å¯è§ã€‚æˆ‘ä»¬éœ€è¦ç»™å®ƒå®šä¹‰å·²ç»™æ„é€ å‡½æ•°ã€‚\n\n```Go\nfunc NewSingleHost(handler http.Handler, allowedHost string) *SingleHost {\n    return &SingleHost{handler: handler, allowedHost: allowedHost}\n}\n```\n\n### è¯·æ±‚å¤„ç†\n\n ç°åœ¨éœ€è¦å®ç°çœŸæ­£çš„é€»è¾‘åŠŸèƒ½äº†ã€‚æƒ³è¦å®ç°`http.Handler`ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ä»–çš„ä¸€ä¸ªæ–¹æ³•ã€‚\n\n```Go\ntype Handler interface {\n        ServeHTTP(ResponseWriter, *Request)\n}\n```\n\n å®ç°å¦‚ä¸‹ï¼š\n\n```Go\nfunc (s *SingleHost) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    host := r.Host\n    if host == s.allowedHost {\n        s.handler.ServeHTTP(w, r)\n    } else {\n        w.WriteHeader(403)\n    }\n}\n```\n\n`ServeHTTP`åªæ˜¯æ£€æŸ¥è¯·æ±‚çš„Hostï¼š\n* å¦‚æœHostå’Œé…ç½®çš„allowedä¸€ç›´ï¼Œé‚£ä¹ˆè°ƒç”¨handlerçš„ServeHTTPã€‚\n* å¦‚æœä¸ä¸€ç›´è¿”å›403\nå¯¹äºåä¸€ç§æƒ…å†µï¼Œä¸ä»…ä¸ä¼šå¾—åˆ°åº”ç­”ï¼Œè®¾ç½®ä¸çŸ¥é“æœ‰è¿™ä¸ªè¯·æ±‚ã€‚\nç°åœ¨æˆ‘ä»¬å·²ç»å¼€å‘å“ˆäº†ä¸­é—´ä»¶ï¼Œåªéœ€è¦å°†å…¶æ’å…¥åˆ°éœ€è¦çš„åœ°æ–¹ã€‚\n\n```Go\nsingleHosted = NewSingleHost(myHandler, \"example.com\")\nhttp.ListenAndServe(\":8080\", singleHosted)\n```\n\n### å¦ä¸€ç§æ–¹å¼\n\n æˆ‘ä»¬åˆšåˆšå†™çš„é‚£ä¸ªä¸­é—´ä»¶å¾ˆç®€å•ï¼Œå®ƒåªæœ‰15è¡Œä»£ç ã€‚å†™è¿™æ ·çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ ·æ¿æ–¹æ³•ã€‚ç”±äºGoæ”¯æŒå‡½æ•°ä¸ºä¸€ç­‰å…¬æ°‘å’Œé—­åŒ…ï¼Œå¹¶ä¸”æœ‰`http.HandlerFunc`åŒ…è£…å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»–åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œè€Œä¸æ˜¯å°†å…¶æ”¾å…¥åˆ°ä¸€ä¸ªç»“æ„ä½“ä¸­ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªä¸­é—´ä»¶çš„å†™æ³•ã€‚\n\n```Go\nfunc SingleHost(handler http.Handler, allowedHost string) http.Handler {\n    ourFunc := func(w http.ResponseWriter, r *http.Request) {\n        host := r.Host\n        if host == allowedHost {\n            handler.ServeHTTP(w, r)\n        } else {\n            w.WriteHeader(403)\n        }\n    }\n    return http.HandlerFunc(ourFunc)\n}\n```\n æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å‡½æ•°`SingleHost`ï¼Œå®ƒåŒ…è£…äº†`Handler`å’Œå…è®¸çš„Hostï¼Œåœ¨å…¶å†…éƒ¨æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªè·Ÿä¸Šé¢ä¸­é—´ä»¶ç±»ä¼¼çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å†…éƒ¨çš„å‡½æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå› æ­¤ä»–å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡ã€‚æœ€ç»ˆHandlerFuncè®©æˆ‘ä»¬å¯ä»¥å°†å…¶å˜ä¸ºHandlerã€‚\n è§‰å¾—æ˜¯ä½¿ç”¨HandlerFuncè¿˜æ˜¯è‡ªå·±å®ç°ä¸€ä¸ªhttp.Handlerå®Œå…¨å–å†³äºä½ è‡ªå·±ã€‚å¯¹äºç®€å•çš„æƒ…å†µï¼Œä¸€ä¸ªç®€å•çš„å‡½æ•°å°±å®Œå…¨å¤Ÿäº†ã€‚å¦‚æœä½ çš„ä¸­é—´ä»¶è¶Šæ¥è¶Šå¤šï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘å®ç°è‡ªå·±çš„ç»“æ„å¹¶æŠŠå®ƒä»¬åˆ†å¼€ã€‚\n åŒæ—¶æ ‡å‡†åº“åŒæ—¶ä½¿ç”¨äº†ä¸¤ç§åŠŸèƒ½ã€‚`StripPrefix`ä½¿ç”¨çš„æ˜¯HandlerFuncï¼ŒTimeoutHandlerä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„ç»“æ„ä½“ã€‚\n\n### ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­\n\n æˆ‘ä»¬çš„`SingleHost`å¹¶ä¸é‡è¦ï¼Œæˆ‘ä»¬åªæ£€æµ‹ä¸€ä¸ªå±æ€§ï¼Œè¦ä¹ˆå°†ä»–ä¼ é€’ç»™å…¶ä»–çš„handlerï¼Œè¦ä¹ˆç›´æ¥è¿”å›ã€‚ç„¶è€Œå­˜åœ¨è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬çš„ç¨‹åºéœ€è¦å¯¹å¤„ç†å®Œè¿›è¡Œåç»­å¤„ç†ã€‚\n\n### æ·»åŠ æ•°æ®æ˜¯ç®€å•çš„\n\n å¦‚æœåªæ˜¯æƒ³ç®€å•çš„æ·»åŠ æ•°æ®ï¼Œé‚£ä¹ˆä½¿ç”¨Writeå°±å¯ä»¥äº†ã€‚\n\n```Go\ntype AppendMiddleware struct {\n    handler http.Handler\n}\n\nfunc (a *AppendMiddleware) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    a.handler.ServeHTTP(w, r)\n    w.Write([]byte(\"Middleware says hello.\"))\n}\n```\n\n è¿”å›çš„ç»“æ„è‚¯å®šä¼šåŒ…å«`Middleware says hello.`\n\n### é—®é¢˜\n\n ä½†æ˜¯æ“ä½œå…¶ä»–çš„æ•°æ®æœ‰ç‚¹å›°éš¾ã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³è¦åœ¨å®ƒå‰é¢æ·»åŠ æ•°æ®è€Œä¸æ˜¯åé¢è¿½åŠ ã€‚å¦‚æœæˆ‘ä»¬åœ¨åŸHandlerä¹‹å‰è°ƒç”¨Writeï¼Œé‚£ä¹ˆå°†ä¼šå¤±å»æ§åˆ¶ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªWriteå·²ç»å°†ä»–å†™å…¥äº†ã€‚\n é€šè¿‡å…¶ä»–æ–¹æ³•ä¿®æ”¹åŸå§‹è¾“å‡ºï¼Œä¾‹å¦‚æ›¿æ¢å­—ç¬¦ä¸²ï¼Œæ”¹å˜å“åº”headerï¼Œæˆ–è€…è®¾ç½®çŠ¶æ€ç éƒ½ä¸ä¼šèµ·ä½œç”¨ï¼Œå› ä¸ºå½“handlerè¿”å›çš„æ—¶å€™æ•°æ®å·²ç»è¿”å›åˆ°å®¢æˆ·ç«¯äº†ã€‚\n ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç‰¹æ®Šçš„ResponseWriterï¼Œä»–å¯ä»¥æƒ³bufferä¸€æ ·å·¥ä½œï¼Œæ”¶é›†æ•°æ®ï¼Œå­˜å‚¨ä»¥å¤‡ä½¿ç”¨å’Œä¿®æ”¹ã€‚ç„¶åæˆ‘ä»¬å°†è¿™ä¸ªResponseWriterä¼ é€’ç»™handlerï¼Œè€Œä¸æ˜¯ä¼ é€’çœŸæ˜¯çš„RWï¼Œè¿™æ ·åœ¨å…¶ä¹‹å‰æˆ‘ä»¬å·²ç»ä¿®æ”¹äº†å®ƒäº†ã€‚\n å¹¸è¿çš„æ˜¯åœ¨æ ‡å‡†åº“ä¸­æœ‰è¿™æ ·çš„ä¸€ä¸ªå·¥å…·ã€‚åœ¨`net/http/httptest`åŒ…é‡Œçš„ResponseRecorderèƒ½åšæ‰€æœ‰æˆ‘ä»¬éœ€è¦çš„ï¼šä¿å­˜çŠ¶æ€ç ï¼Œä¸€ä¸ªå“åº”headerçš„mapï¼Œå°†bodyæ”¾å…¥byte ç¼“å†²ä¸­ã€‚è™½ç„¶å®ƒæ˜¯å†æµ‹è¯•ä¸­ä¸­ä½¿ç”¨çš„ï¼Œä½†æ˜¯å¾ˆæœåŠ¡æˆ‘ä»¬çš„æƒ…å†µã€‚\n\n```Go\ntype ModifierMiddleware struct {\n    handler http.Handler\n}\n\nfunc (m *ModifierMiddleware) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    rec := httptest.NewRecorder()\n    // passing a ResponseRecorder instead of the original RW\n    m.handler.ServeHTTP(rec, r)\n    // after this finishes, we have the response recorded\n    // and can modify it before copying it to the original RW\n\n    // we copy the original headers first\n    for k, v := range rec.Header() {\n        w.Header()[k] = v\n    }\n    // and set an additional one\n    w.Header().Set(\"X-We-Modified-This\", \"Yup\")\n    // only then the status code, as this call writes out the headers \n    w.WriteHeader(418)\n\n    // The body hasn't been written (to the real RW) yet,\n    // so we can prepend some data.\n    data := []byte(\"Middleware says hello again. \")\n\n    // But the Content-Length might have been set already,\n    // we should modify it by adding the length\n    // of our own data.\n    // Ignoring the error is fine here:\n    // if Content-Length is empty or otherwise invalid,\n    // Atoi() will return zero,\n    // which is just what we'd want in that case.\n    clen, _ := strconv.Atoi(r.Header.Get(\"Content-Length\"))\n    clen += len(data)\n    r.Header.Set(\"Content-Length\", strconv.Itoa(clen))\n\n    // finally, write out our data\n    w.Write(data)\n    // then write out the original body\n    w.Write(rec.Body.Bytes())\n}\n```\næœ€ååƒµå°¸æˆ‘ä»¬ä¸­é—´ä»¶çš„è¾“å‡ºï¼š\n\n```\nHTTP/1.1 418 I'm a teapot\nX-We-Modified-This: Yup\nContent-Type: text/plain; charset=utf-8\nContent-Length: 37\nDate: Tue, 03 Sep 2013 18:41:39 GMT\n\nMiddleware says hello again. Success!\n```\nè¿™æ ·å°±å¼€å¯äº†ä¸€ç§æ–°çš„å¯èƒ½ï¼ŒåŒ…è£…çš„handlerå®Œå…¨æ‰‹æ§åˆ¶ã€‚\n\n### å’Œå…¶ä»–handleråˆ†äº«æ•°æ®\n\n åœ¨å…¶ä»–ä¾‹å­ä¸­ï¼Œä¸­é—´ä»¶å¯èƒ½éœ€è¦æš´éœ²ä¸€äº›ä¿¡æ¯ç»™å…¶ä»–ä¸­é—´ä»¶æˆ–è€…åº”ç”¨æœ¬èº«ã€‚ä¾‹å¦‚nosurféœ€è¦ç»™å…¶ä»–ç”¨æˆ·è®¿é—®CSRF tokençš„æƒé™ã€‚\n æœ€ç®€å•æ˜¯æ˜¯ä½¿ç”¨ä¸€ä¸ªmapï¼Œä½†æ˜¯é€šå¸¸ä¸å¸Œæœ›è¿™æ ·ã€‚å®ƒå°†http.Request çš„æŒ‡é’ˆä½œä¸ºkeyï¼Œå…¶ä»–æ•°æ®ä½œä¸ºvalueã€‚ä¸‹é¢æ˜¯nosurfçš„ä¾‹å­ï¼ŒGoçš„mapéçº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥è¦è‡ªå·±æ˜¯å®ç°ã€‚\n\n```Go\ntype csrfContext struct {\n    token string\n    reason error\n}\n\nvar (\n    contextMap = make(map[*http.Request]*csrfContext)\n    cmMutex    = new(sync.RWMutex)\n)\n```\n æ•°æ®ç”±Tokenè®¾ç½®ï¼š\n\n```Go\nfunc Token(req *http.Request) string {\n    cmMutex.RLock()\n    defer cmMutex.RUnlock()\n\n    ctx, ok := contextMap[req]\n    if !ok {\n            return \"\"\n    }\n\n    return ctx.token\n}\n```\næºç å¯ä»¥å†nosurfçš„é¡¹ç›®çš„[context.go](https://github.com/justinas/nosurf/blob/master/context.go)ä¸­æ‰¾åˆ°ã€‚\n\n\n","date":"2015-11-12"},{"title":"Linux å¦‚ä½•æŸ¥æ‰¾Java ç¨‹åºCPUè´Ÿè½½è¿‡é«˜","tags":["CPU","Java","Linux","backend"],"iso8601Date":"2017-03-25T19:20:26+08:00","basename":"cpu-load-high","body":"\n\n\nå‡†å¤‡ç¨‹åºï¼š\n\n```Java\npackage test;\n\npublic class Test{\n    public static void main(String[] args){\n        new Thread(new Runnable(){\n            public void run(){\n                while(true){\n\n                }\n            }\n        }).start();\n    }\n}\n```\nå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å›å¯¼è‡´ä¸€ç›´å ç”¨CPUï¼Œç¼–è¯‘è¿è¡Œã€‚é€šè¿‡`top` è·å–CPUå ç”¨ä¿¡æ¯\n![top cpu](https://raw.githubusercontent.com/mashuai/hexo-blog/master/images/top.png)\nå¯ä»¥çœ‹åˆ°å ç”¨æœ€é«˜çš„ pidæ˜¯ 25955\né€šè¿‡`top -p 25955 -H` è·å–è¿›ç¨‹å†…éƒ¨çº¿ç¨‹çš„CPUä½¿ç”¨ç‡ã€‚\n![topph](https://raw.githubusercontent.com/mashuai/hexo-blog/master/images/tophp.png)\nå¯ä»¥å‘ç°å ç”¨æœ€é«˜çš„çº¿ç¨‹IDæ˜¯ `25965` å°†å…¶è½¬æ¢ä¸º16è¿›åˆ¶`python -c 'print hex(25965)'` å¾—åˆ°çš„å€¼æ˜¯`0x656d` \nä½¿ç”¨ `jstack -l 25955 > jstack.log` å¾—åˆ°Javaè¿›ç¨‹çš„Thread dumpï¼Œé€šè¿‡ `grep -i 0x656d -A 30 jstack.log` è·å–Java Thread idä¸º0x656dçš„çº¿ç¨‹çš„thread dumpã€‚\n![jstack](https://raw.githubusercontent.com/mashuai/hexo-blog/master/images/jstack.png)\nç„¶åå°±å¯ä»¥å®šä½ç›¸åº”ä»£ç æŸ¥æ‰¾ä»£ç å ç”¨CPUè¿‡é«˜é—®é¢˜ã€‚\n","date":"2017-03-25"},{"title":"OKHttp æ‹¦æˆªå™¨","tags":["Translate","Java","OKHttp","HTTP","backend"],"iso8601Date":"2017-03-19T23:47:42+08:00","basename":"interceptors","body":"\n\n[åŸæ–‡åœ°å€](https://github.com/square/okhttp/wiki/Interceptors)\næ‹¦æˆªå™¨æ˜¯ä¸€ç§ç›‘æ§ï¼Œé‡å†™ï¼Œé‡è¯•è¯·æ±‚çš„å¼ºå¤§æœºåˆ¶ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªè®°å½•å‡ºå‘å‡ºè¯·æ±‚å’Œæ¥å—å“åº”çš„ç®€å•çš„æ‹¦æˆªå™¨çš„ä¾‹å­ã€‚\n```Java\nclass LoggingInterceptor implements Interceptor {\n  @Override public Response intercept(Interceptor.Chain chain) throws IOException {\n    Request request = chain.request();\n\n    long t1 = System.nanoTime();\n    logger.info(String.format(\"Sending request %s on %s%n%s\",\n        request.url(), chain.connection(), request.headers()));\n\n    Response response = chain.proceed(request);\n\n    long t2 = System.nanoTime();\n    logger.info(String.format(\"Received response for %s in %.1fms%n%s\",\n        response.request().url(), (t2 - t1) / 1e6d, response.headers()));\n\n    return response;\n  }\n}\n```\nè°ƒç”¨`chain.proceed(request)`æ˜¯æ¯ä¸ªæ‹¦æˆªå™¨æœ€é‡è¦çš„å®ç°ã€‚è¿™ä¸ªçœ‹èµ·æ¥ç®€å•çš„æ–¹æ³•æ˜¯æ‰€æœ‰HTTPå·¥ä½œçš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯å¯¹è¯·æ±‚å“åº”çš„åœ°æ–¹ã€‚\næ‹¦æˆªå™¨å¯ä»¥é“¾å¼è°ƒç”¨ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ªå‹ç¼©çš„æ‹¦æˆªå™¨å’Œä¸€ä¸ªæ ¡éªŒå’Œçš„æ‹¦æˆªå™¨ï¼šä½ è¦å…ˆç¡®å®šæ˜¯å…ˆå‹ç¼©å†æ ¡éªŒï¼Œè¿˜æ˜¯å…ˆæ ¡éªŒå†å‹ç¼©ã€‚OKHTTPä½¿ç”¨åˆ—è¡¨è·Ÿè¸ªæ‹¦æˆªå™¨ï¼Œè€Œä¸”æ‹¦æˆªå™¨æ˜¯é¡ºåºå–æ¶ˆçš„ã€‚\n![Interceptors](https://raw.githubusercontent.com/wiki/square/okhttp/interceptors@2x.png)\n#### åº”ç”¨æ‹¦æˆªå™¨\næ‹¦æˆªå™¨æ³¨å†Œä¸ºåº”ç”¨æ‹¦æˆªå™¨æˆ–è€…ç½‘ç»œæ‹¦æˆªå™¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„`LoggingInterceptor`æ¥å±•ç¤ºè¿™ä¸¤è€…çš„ä¸åŒã€‚\né€šè¿‡è°ƒç”¨`OkHttpClient.Builder`çš„`addInterceptor()`æ¥æ³¨å†Œä¸€ä¸ªåº”ç”¨æ‹¦æˆªå™¨ã€‚\n```Java\nOkHttpClient client = new OkHttpClient.Builder()\n    .addInterceptor(new LoggingInterceptor())\n    .build();\n\nRequest request = new Request.Builder()\n    .url(\"http://www.publicobject.com/helloworld.txt\")\n    .header(\"User-Agent\", \"OkHttp Example\")\n    .build();\n\nResponse response = client.newCall(request).execute();\nresponse.body().close();\n```\né“¾æ¥`http://www.publicobject.com/helloworld.txt`é‡å®šå‘åˆ°é“¾æ¥`http://www.publicobject.com/helloworld.txt`,OKHttpå›è‡ªåŠ¨é‡å®šå‘ã€‚åº”ç”¨æ‹¦æˆªå™¨åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚`chain.proceed()`è¿”å›çš„å“åº”æ˜¯é‡å®šå‘ä¹‹åçš„å“åº”ã€‚\n```\nINFO: Sending request http://www.publicobject.com/helloworld.txt on null\nUser-Agent: OkHttp Example\n\nINFO: Received response for https://publicobject.com/helloworld.txt in 1179.7ms\nServer: nginx/1.4.6 (Ubuntu)\nContent-Type: text/plain\nContent-Length: 1759\nConnection: keep-alive\n```\nå› ä¸º`response.request().url()`å’Œ`request.url()`è·å–çš„URLä¸åŒï¼Œæ‰€ä»¥å¯ä»¥å¾—å‡ºä¸Šè¿°ç»“è®ºã€‚ä¸¤è¡Œæ—¥å¿—è®°å½•äº†ä¸¤ä¸ªä¸åŒçš„URLã€‚\n#### ç½‘ç»œæ‹¦æˆªå™¨\næ³¨å†Œç½‘ç»œæ‹¦æˆªå™¨å’Œåº”ç”¨æ‹¦æˆªå™¨å·®ä¸å¤šï¼Œåªæ˜¯ç”¨`addNetworkInterceptor()`ä»£æ›¿äº†`addInterceptor()`ã€‚\n```Java\nOkHttpClient client = new OkHttpClient.Builder()\n    .addNetworkInterceptor(new LoggingInterceptor())\n    .build();\n\nRequest request = new Request.Builder()\n    .url(\"http://www.publicobject.com/helloworld.txt\")\n    .header(\"User-Agent\", \"OkHttp Example\")\n    .build();\n\nResponse response = client.newCall(request).execute();\nresponse.body().close();\n```\nå½“è¿è¡Œè¿™æ®µä»£ç çš„æ—¶å€™æ‹¦æˆªå™¨è¿è¡Œäº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡åˆå§‹çš„åœ°å€`http://www.publicobject.com/helloworld.txt`ï¼Œä¸€æ¬¡æ˜¯é‡å®šå‘çš„åœ°å€`https://publicobject.com/helloworld.txt`ã€‚\n```\nINFO: Sending request http://www.publicobject.com/helloworld.txt on Connection{www.publicobject.com:80, proxy=DIRECT hostAddress=54.187.32.157 cipherSuite=none protocol=http/1.1}\nUser-Agent: OkHttp Example\nHost: www.publicobject.com\nConnection: Keep-Alive\nAccept-Encoding: gzip\n\nINFO: Received response for http://www.publicobject.com/helloworld.txt in 115.6ms\nServer: nginx/1.4.6 (Ubuntu)\nContent-Type: text/html\nContent-Length: 193\nConnection: keep-alive\nLocation: https://publicobject.com/helloworld.txt\n\nINFO: Sending request https://publicobject.com/helloworld.txt on Connection{publicobject.com:443, proxy=DIRECT hostAddress=54.187.32.157 cipherSuite=TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA protocol=http/1.1}\nUser-Agent: OkHttp Example\nHost: publicobject.com\nConnection: Keep-Alive\nAccept-Encoding: gzip\n\nINFO: Received response for https://publicobject.com/helloworld.txt in 80.9ms\nServer: nginx/1.4.6 (Ubuntu)\nContent-Type: text/plain\nContent-Length: 1759\nConnection: keep-alive\n```\nç½‘ç»œè¯·æ±‚åŒæ—¶ä¹ŸåŒ…å«äº†æ›´å¤šçš„æ•°æ®ï¼Œä¾‹å¦‚:ç”±OKHttpæ·»åŠ çš„ç”¨æ¥æ”¯æŒå“åº”å‹ç¼©çš„`Accept-Encoding: gzip`headerã€‚ç½‘ç»œæ‹¦æˆªå™¨çš„`chain`æœ‰ä¸€ä¸ªéç©ºçš„`Connection`ï¼Œç”¨æ¥æŸ¥è¯¢è¿æ¥æœåŠ¡å™¨çš„IPåœ°å€å’ŒTLSé…ç½®ä¿¡æ¯ã€‚\n#### å¦‚ä½•é€‰æ‹©æ‹¦æˆªå™¨\næ¯ç§æ‹¦æˆªå™¨éƒ½æœ‰ä¼˜ç‚¹ã€‚\n##### åº”ç”¨æ‹¦æˆªå™¨\n * æ— éœ€å…³å¿ƒåƒé‡è¯•ï¼Œé‡å®šå‘ç­‰è¿™æ ·çš„ä¸­é—´è¿‡ç¨‹ã€‚\n * å³ä½¿æ˜¯ä»ç¼“å­˜å“åº”ï¼Œä¹Ÿä¼šè°ƒç”¨ä¸€æ¬¡ã€‚\n * åªå…³å¿ƒåº”ç”¨æœ€åˆçš„ç›®çš„ï¼Œå¹¶ä¸éœ€è¦å…³å¿ƒOKHttpæ³¨å…¥çš„headerï¼Œä¾‹å¦‚`If-None-Match`\n * å…è®¸çŸ­è·¯ï¼Œä¸æ‰§è¡Œ`Chain.proceed()`\n * å…è®¸é‡è¯•ï¼Œæ‰§è¡Œå¤šæ¬¡`Chain.proceed()`\n##### ç½‘ç»œæ‹¦æˆªå™¨\n * å¯ä»¥æ“ä½œæƒ³é‡è¯•ï¼Œé‡å®šå‘è¿™æ ·çš„ä¸­é—´è¿‡ç¨‹ã€‚\n * çŸ­è·¯ç½‘ç»œè¿æ¥çš„ä»cacheè¿”å›å“åº”çš„æ—¶å€™ä¸æ‰§è¡Œã€‚\n * å¯ä»¥ç›‘æ§å‘—å‘é€åˆ°ç½‘ç»œä¸Šçš„æ•°æ®\n * è®¿é—®åŒ…å«requestçš„`Connection`\n#### é‡å†™è¯·æ±‚\næ‹¦æˆªå™¨å¯ä»¥æ·»åŠ ï¼Œåˆ é™¤ï¼Œæ›¿æ¢è¯·æ±‚å¤´ã€‚å¦‚æœè¯·æ±‚æœ‰è¯·æ±‚ä½“ï¼Œæ‹¦æˆªå™¨ä¹Ÿå¯ä»¥è½¬æ¢è¯·æ±‚ä½“ã€‚ä¾‹å¦‚ï¼šå¦‚æœè¿œç¨‹è¿æ¥çš„æœåŠ¡å™¨æ”¯æŒå‹ç¼©ï¼Œå¯ä»¥ä½¿ç”¨åº”ç”¨æ‹¦æˆªå™¨æ·»åŠ å‹ç¼©è¯·æ±‚ä½“çš„æ‹¦æˆªå™¨ã€‚\n```\n/** This interceptor compresses the HTTP request body. Many webservers can't handle this! */\nfinal class GzipRequestInterceptor implements Interceptor {\n  @Override public Response intercept(Interceptor.Chain chain) throws IOException {\n    Request originalRequest = chain.request();\n    if (originalRequest.body() == null || originalRequest.header(\"Content-Encoding\") != null) {\n      return chain.proceed(originalRequest);\n    }\n\n    Request compressedRequest = originalRequest.newBuilder()\n        .header(\"Content-Encoding\", \"gzip\")\n        .method(originalRequest.method(), gzip(originalRequest.body()))\n        .build();\n    return chain.proceed(compressedRequest);\n  }\n\n  private RequestBody gzip(final RequestBody body) {\n    return new RequestBody() {\n      @Override public MediaType contentType() {\n        return body.contentType();\n      }\n\n      @Override public long contentLength() {\n        return -1; // We don't know the compressed length in advance!\n      }\n\n      @Override public void writeTo(BufferedSink sink) throws IOException {\n        BufferedSink gzipSink = Okio.buffer(new GzipSink(sink));\n        body.writeTo(gzipSink);\n        gzipSink.close();\n      }\n    };\n  }\n}\n```\n#### é‡å†™å“åº”\nåŒæ ·æ‹¦æˆªå™¨ä¹Ÿå¯ä»¥é‡å†™å“åº”ï¼Œè½¬åŒ–è¯·æ±‚ä½“ã€‚é€šå¸¸è¿™æ ·åšæ¯”é‡å†™è¯·æ±‚å¤´æ›´å±é™©ï¼Œå› ä¸ºè¿™æ ·åšå¯èƒ½è¿”å›çš„å¹¶ä¸æ˜¯æœåŠ¡å™¨é¢„æœŸå€¼ã€‚\nå¦‚æœä½ å¤„åœ¨ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„åœºæ™¯ï¼Œå¹¶ä¸”å‡†å¤‡å¤„ç†åæœï¼Œé‡å†™å“åº”å¤´å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹å¼å¤„ç†è¿™ç±»é—®é¢˜ã€‚ä¾‹å¦‚ï¼šå¯ä»¥ä¿®å¤æœåŠ¡å™¨æœªé…ç½®çš„`Cache-Control`æ¥è·å–æ›´å¥½çš„ç¼“å­˜å“åº”é…ç½®ã€‚\n```\n/** Dangerous interceptor that rewrites the server's cache-control header. */\nprivate static final Interceptor REWRITE_CACHE_CONTROL_INTERCEPTOR = new Interceptor() {\n  @Override public Response intercept(Interceptor.Chain chain) throws IOException {\n    Response originalResponse = chain.proceed(chain.request());\n    return originalResponse.newBuilder()\n        .header(\"Cache-Control\", \"max-age=60\")\n        .build();\n  }\n};\n```\né€šå¸¸ä¸ºäº†è¡¥å……æœåŠ¡å™¨ç›¸åº”çš„ä¿®å¤ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æœ€å¥½çš„ã€‚\n#### é‚£äº›å¯ä»¥ä½¿ç”¨æ‹¦æˆªå™¨\nä½¿ç”¨æ‹¦æˆªå™¨è¦æ±‚OKHttp 2.0å³ä»¥ä¸Šã€‚ä¸è¡Œçš„æ˜¯æ‹¦æˆªå™¨ä¸å¯ä»¥å’Œ`OkUrlFactory`ï¼Œæˆ–è€…ä¾èµ–äºä»–çš„åº“åŒæ—¶ä½¿ç”¨ï¼ŒåŒ…æ‹¬[Retrofit](http://square.github.io/retrofit/)1.8ä»¥ä¸‹ï¼Œ[Picasso](http://square.github.io/picasso/)2.4ä»¥ä¸‹ã€‚\n","date":"2017-03-19"},{"title":"OKHttp https","tags":["Translate","Java","OKHttp","HTTP","backend"],"iso8601Date":"2017-03-23T21:32:29+08:00","basename":"https","body":"\n\n[åŸæ–‡é“¾æ¥](https://github.com/square/okhttp/wiki/HTTPS)\n\nOKHttpå°è¯•å¹³è¡¡ä¸¤ä¸ªç›¸äº’çŸ›ç›¾çš„å†…å®¹ï¼š\n * è¿æ¥å°½å¯èƒ½å¤šçš„ä¸»æœºã€‚åŒ…æ‹¬ä½¿ç”¨[boringssl](https://boringssl.googlesource.com/boringssl/)çš„é«˜çº§çš„ä¸»æœºå’Œä¸€äº›ä½¿ç”¨[openssl](https://www.openssl.org/)çš„è¿‡æ—¶çš„ä¸»æœºã€‚\n * è¿æ¥çš„å®‰å…¨æ€§ã€‚åŒ…æ‹¬éªŒè¯è¿œç¨‹ä¸»æœºçš„è¯ä¹¦ï¼Œé€šè¿‡å¼ºå¯†ç è¿›è¡Œæ•°æ®äº¤æ¢ã€‚\n\nåå•†è¿æ¥åˆ°HTTPSçš„æ—¶å€™ï¼ŒOKHttpéœ€è¦çŸ¥é“éœ€è¦æä¾›çš„[TLSç‰ˆæœ¬](http://square.github.io/okhttp/3.x/okhttp/okhttp3/TlsVersion.html)å’Œ[å¯†ç å¥—ä»¶](http://square.github.io/okhttp/3.x/okhttp/okhttp3/CipherSuite.html)ã€‚å¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦æœ€å¤§åŒ–é“¾æ¥å°±éœ€è¦åŒ…å«è¿‡æ—¶çš„TLSç‰ˆæœ¬å’Œå¼±è®¾è®¡çš„å¯†ç ç»„åˆã€‚ä¸€ä¸ªä¸¥æ ¼çš„å®¢æˆ·ç«¯æƒ³è¦æœ€å¤§åŒ–å®‰å…¨å°±éœ€è¦åªåŒ…å«æœ€æ–°çš„TLSç‰ˆæœ¬å’Œå¼ºå¯†ç å¥—ä»¶ã€‚\nå®‰å…¨å’Œè¿æ¥è§„èŒƒå…·ä½“æ˜¯ç”±[ConnectionSpec](http://square.github.io/okhttp/3.x/okhttp/okhttp3/ConnectionSpec.html)å®ç°çš„ã€‚OKHttpåŒ…å«ä¸‰ä¸ªå†…ç½®çš„è§„èŒƒï¼š\n * `MODERN_TLS` æ˜¯è¿æ¥ç°ä»£HTTPSæœåŠ¡å™¨çš„é…ç½®ã€‚\n * `COMPATIBLE_TLS` æ˜¯è¿æ¥éç°ä»£ï¼Œä½†å®‰å…¨çš„HTTPSæœåŠ¡å™¨çš„é…ç½®ã€‚\n * `CLEARTEXT` æ˜¯éå®‰å…¨çš„httpçš„é…ç½®ã€‚\n\né»˜è®¤OKHttpä¼šå°è¯•ä½¿ç”¨`MODERN_TLS`è¿æ¥ï¼Œå¦‚æœç°ä»£é…ç½®å¤±è´¥ï¼Œå›åˆ°ä½¿ç”¨`COMPATIBLE_TLS`é…ç½®ã€‚\nTLSç‰ˆæœ¬å’Œå¯†ç å¥—ä»¶åœ¨ä»»ä¸€ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬çš„äººä¸€ä¸ªè§„èŒƒä¸­éƒ½å¯èƒ½æ”¹å˜ã€‚ä¾‹å¦‚ï¼Œåœ¨OKHttp2.2ï¼Œå› ä¸º[POODLE](http://googleonlinesecurity.blogspot.ca/2014/10/this-poodle-bites-exploiting-ssl-30.html)æ”»å‡»å°±ç§»é™¤äº†SSL 3.0çš„æ”¯æŒã€‚åœ¨OKHttp 3.0ï¼Œç§»é™¤äº†[RC4](http://en.wikipedia.org/wiki/RC4#Security)çš„æ”¯æŒã€‚åŒæ¡Œé¢æµè§ˆå™¨ä¸€æ ·ï¼Œä½¿ç”¨ç½ªè¡Œçš„OKHttpç‰ˆæœ¬å¯ä»¥è·å¾—æœ€å¥½çš„å®‰å…¨ä¿éšœã€‚\nä¹Ÿå¯ä»¥æ ¹æ®ä¸€ç»„å®šåˆ¶çš„TLS ç‰ˆæœ¬å’Œå¯†ç å¥—ä»¶æ„å»ºè‡ªå·±çš„è§„èŒƒã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸ªé…ç½®è¦æ±‚ä½¿ç”¨ä¸‰ç»„é«˜å¼ºåº¦çš„å¯†ç å¥—ä»¶ã€‚å®ƒçš„ç¼ºç‚¹å°±æ˜¯å¿…é¡»æ˜¯Android5.0+æˆ–è€…æ˜¯æœ€æ–°çš„æµè§ˆå™¨ã€‚\n```Java\nConnectionSpec spec = new ConnectionSpec.Builder(ConnectionSpec.MODERN_TLS)  \n    .tlsVersions(TlsVersion.TLS_1_2)\n    .cipherSuites(\n          CipherSuite.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,\n          CipherSuite.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,\n          CipherSuite.TLS_DHE_RSA_WITH_AES_128_GCM_SHA256)\n    .build();\n\nOkHttpClient client = new OkHttpClient.Builder() \n    .connectionSpecs(Collections.singletonList(spec))\n    .build();\n```\n#### è¯ä¹¦é”å®š\né»˜è®¤æƒ…å†µä¸‹OKHttpä¿¡ä»»ä¸»æœºå¹³å°çš„è¯ä¹¦é¢å‘æœºæ„ã€‚è¿™ä¸ªç­–ç•¥å¯ä»¥æœ€å¤§åŒ–è¿æ¥ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½æ”¶åˆ°æƒå¨è¯ä¹¦æ”»å‡»ï¼Œä¾‹å¦‚[2011 DigiNotar attack](http://www.computerworld.com/article/2510951/cybercrime-hacking/hackers-spied-on-300-000-iranians-using-fake-google-certificate.html)ã€‚åŒæ ·ä¹Ÿå‡è®¾ä½ çš„è¯ä¹¦æ˜¯æƒå¨æœºæ„é¢å‘çš„ã€‚\nä½¿ç”¨[CertificatePinner](http://square.github.io/okhttp/3.x/okhttp/okhttp3/CertificatePinner.html)é™åˆ¶äº†å“ªäº›è¯ä¹¦å’Œè¯ä¹¦é¢å‘æœºæ„å€¼å¾—ä¿¡ä»»ã€‚ä½¿ç”¨è¯ä¹¦é”å®šå¯ä»¥æé«˜å®‰å…¨æ€§ï¼Œä½†æ˜¯é™åˆ¶äº†æœåŠ¡ç«¯å›¢é˜Ÿå‡çº§ä»–ä»¬çš„TLSè¯ä¹¦ã€‚**åœ¨æ²¡çš„åˆ°æœåŠ¡ç«¯å›¢é˜Ÿçš„è®¸å¯çš„æ—¶å€™ä¸è¦ä½¿ç”¨è¯ä¹¦é”å®š**ã€‚\n```Java\n  public CertificatePinning() {\n    client = new OkHttpClient.Builder()\n        .certificatePinner(new CertificatePinner.Builder()\n            .add(\"publicobject.com\", \"sha256/afwiKY3RxoMmLkuRW1l7QsPZTJPwDS2pdDROQjXw8ig=\")\n            .build())\n        .build();\n  }\n\n  public void run() throws Exception {\n    Request request = new Request.Builder()\n        .url(\"https://publicobject.com/robots.txt\")\n        .build();\n\n    Response response = client.newCall(request).execute();\n    if (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\n    for (Certificate certificate : response.handshake().peerCertificates()) {\n      System.out.println(CertificatePinner.pin(certificate));\n    }\n  }\n```\n#### å®šåˆ¶ä¿¡ä»»è¯ä¹¦\nä¸‹é¢æ‰€æœ‰çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä½ è‡ªå·±çš„é…ç½®ä»£æ›¿æœåŠ¡ç«¯çš„è¯ä¹¦é…ç½®ã€‚æ­£å¦‚ä¸Šè¿°æ‰€è¨€ï¼Œ**åœ¨æ²¡çš„åˆ°æœåŠ¡ç«¯å›¢é˜Ÿçš„è®¸å¯çš„æ—¶å€™ä¸è¦ä½¿ç”¨å®šåˆ¶è¯ä¹¦*ã€‚\n```Java\n  private final OkHttpClient client;\n\n  public CustomTrust() {\n    SSLContext sslContext = sslContextForTrustedCertificates(trustedCertificatesInputStream());\n    client = new OkHttpClient.Builder()\n        .sslSocketFactory(sslContext.getSocketFactory())\n        .build();\n  }\n\n  public void run() throws Exception {\n    Request request = new Request.Builder()\n        .url(\"https://publicobject.com/helloworld.txt\")\n        .build();\n\n    Response response = client.newCall(request).execute();\n    System.out.println(response.body().string());\n  }\n\n  private InputStream trustedCertificatesInputStream() {\n    ... // Full source omitted. See sample.\n  }\n\n  public SSLContext sslContextForTrustedCertificates(InputStream in) {\n    ... // Full source omitted. See sample.\n  }\n```\n","date":"2017-03-23"},{"title":"MyBatis é…ç½®","tags":["Java","Mybatis","Translate","backend"],"iso8601Date":"2017-06-28T22:13:32+08:00","basename":"mybaits-configuration","body":"\n\n[åŸæ–‡é“¾æ¥](http://www.mybatis.org/mybatis-3/configuration.html)\n\nMyBatisçš„é…ç½®åŒ…å«äº†è®¾ç½®å’Œå±æ€§ï¼Œä»–ä»¬å¯¹MyBatisçš„è¡Œä¸ºæœ‰å¾ˆå¤§çš„å½±å“ã€‚MyBatisçš„é…ç½®æ–‡ä»¶å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š\n* configuration\n    * properties\n    * settings\n    * typeAliases\n    * typeHandlers\n    * objectFactory\n    * plugins\n    * environments\n        * environment\n            * transactionManager\n            * dataSource\n    * databaseIdProvider\n    * mappers\n\n### properties\nå¯ä»¥é€šè¿‡ä¸€ä¸ªå…¸å‹çš„Java Properties ç±»å®ä¾‹é…ç½®å¯æ›¿æ¢çš„å¤–éƒ¨å±æ€§ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å­å…ƒç´ ä¼ é€’è¿™äº›é…ç½®å±æ€§ï¼Œä¾‹å¦‚\n```xml\n<properties resource=\"org/mybatis/example/config.properties\">\n  <property name=\"username\" value=\"dev_user\"/>\n  <property name=\"password\" value=\"F2Fa3!33TYyg\"/>\n</properties>\n```\nç„¶åè¿™äº›é…ç½®å±æ€§å°±å¯ä»¥åº”ç”¨äºé…ç½®æ–‡ä»¶ä¸­éœ€è¦åŠ¨æ€é…ç½®çš„å…¶ä»–å±æ€§ã€‚ä¾‹å¦‚ï¼š\n```xml\n<dataSource type=\"POOLED\">\n  <property name=\"driver\" value=\"${driver}\"/>\n  <property name=\"url\" value=\"${url}\"/>\n  <property name=\"username\" value=\"${username}\"/>\n  <property name=\"password\" value=\"${password}\"/>\n</dataSource>\n```\nåœ¨è¿™ä¸ªä¾‹å­ä¸­çš„usernameå’Œpasswordå°†ä¼šè¢«propertiesçš„é…ç½®å±æ€§æ›¿æ¢ã€‚driverå’Œurlå±æ€§ä¼šè¢«config.propertiesçš„é…ç½®æ›¿æ¢ã€‚è¿™ä¸ªä¸ºé…ç½®æä¾›äº†å¾ˆå¤šçš„é€‰é¡¹ã€‚    \nPropertiesåŒæ ·å¯ä»¥ç›´ä¼ å…¥SqlSessionFactoryBuild.build() æ–¹æ³•ä¸­ï¼Œä¾‹å¦‚ï¼š\n```Java\nSqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader, props);\n\n// ... or ...\n\nSqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader, environment, props);\n```\nå¦‚æœåŒä¸€ä¸ªå±æ€§åŒæ—¶é…ç½®åˆ°ä¸åŒçš„ä½ç½®ï¼ŒMyBatisæŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºåŠ è½½å®ƒä»¬ï¼š    \n1. åœ¨Propertieså†…çš„å­å…ƒç´ é¦–å…ˆè¢«åŠ è½½ã€‚     \n2. å…¶æ¬¡ä»resource classpathå’Œurlä¸­åŠ è½½å±æ€§å¹¶è¦†ç›–å·²å­˜åœ¨çš„å±æ€§ã€‚    \n3. ä½œä¸ºæ–¹æ³•å‚æ•°çš„å±æ€§æœ€åè¢«åŠ è½½ï¼Œå¹¶ä¸”è¦†ç›–å‰é¢ä¸¤æ¬¡ç›¸åŒçš„å±æ€§ã€‚\n\nå› æ­¤ï¼Œä¼˜å…ˆçº§æœ€é«˜çš„æ˜¯ç›´æ¥ä½œä¸ºå‚æ•°ä¼ å…¥æ–¹æ³•ï¼Œå…¶æ¬¡æ˜¯ä»resource classpathæˆ–è€…urlåŠ è½½çš„é…ç½®æ–‡ä»¶ï¼Œæœ€åæ˜¯Propertiesä¸­çš„å­å…ƒç´ å®šä¹‰çš„å±æ€§ã€‚    \nMyBatis 3.4.2 ä¹‹åå¯ä»¥å¦‚ä¸‹ä½¿ç”¨é»˜è®¤å ä½ç¬¦ã€‚\n```xml\n<dataSource type=\"POOLED\">\n  <!-- ... -->\n  <property name=\"username\" value=\"${username:ut_user}\"/> <!-- If 'username' property not present, username become 'ut_user' -->\n</dataSource>\n```\nè¿™ä¸ªåŠŸèƒ½é»˜è®¤æ˜¯æ— æ•ˆçš„ï¼Œå¦‚æœè¦å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€è¦åœ¨é…ç½®å±æ€§ä¸­å¦‚ä¸‹å¼€å¯ï¼š\n```xml\n<properties resource=\"org/mybatis/example/config.properties\">\n  <!-- ... -->\n  <property name=\"org.apache.ibatis.parsing.PropertyParser.enable-default-value\" value=\"true\"/> <!-- Enable this feature -->\n</properties>\n```\næ³¨æ„ï¼šå¦‚æœå·²ç»ä½¿ç”¨äº†â€œï¼šâ€ä½œä¸ºå±æ€§çš„é”®ä¾‹å¦‚ï¼š`db:username`ï¼Œæˆ–è€…æ˜¯åœ¨sqlçš„å®šä¹‰ä¸­ä½¿ç”¨äº†OGNLçš„ä¸‰å…ƒç¬¦ï¼Œä¾‹å¦‚ï¼š`${tableName != null ? tableName : 'global_constants'}`é‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹é»˜è®¤çš„åˆ†éš”ç¬¦ï¼Œå¦‚ä¸‹ï¼š\n```xml\n<properties resource=\"org/mybatis/example/config.properties\">\n  <!-- ... -->\n  <property name=\"org.apache.ibatis.parsing.PropertyParser.default-value-separator\" value=\"?:\"/> <!-- Change default value of separator -->\n</properties>\n```\n```xml\n<dataSource type=\"POOLED\">\n  <!-- ... -->\n  <property name=\"username\" value=\"${db:username?:ut_user}\"/>\n</dataSource>\n```\n","date":"2017-06-28"},{"title":"http.Handler ä¸Goçš„é”™è¯¯å¤„ç†","tags":["Go","Translate","backend"],"iso8601Date":"2015-11-13T05:24:57+08:00","basename":"http-Handler-ä¸Goçš„é”™è¯¯å¤„ç†","body":"\n\n[åŸæ–‡åœ°å€](http://elithrar.github.io/article/http-handler-error-handling-revisited/)\n\n åœ¨ä¹‹å‰æˆ‘å†™è¿‡ä¸€ç¯‡å…³äºé€šè¿‡ä½¿ç”¨`http.HandlerFunc`æ¥å®ç°ä¸€ä¸ªå®šåˆ¶handlerç±»å‹ç”¨æ¥é¿å…ä¸€äº›å¹³å¸¸çš„é”™è¯¯çš„[æ–‡ç« ](http://elithrar.github.io/article/custom-handlers-avoiding-globals/)ã€‚`func MyHandler(w http.ResponseWriter, r *http.Request)`çš„ç­¾åç»å¸¸å¯ä»¥çœ‹åˆ°ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„é€šç”¨çš„åŒ…å«ä¸€äº›åŸºæœ¬åŠŸèƒ½çš„handlerç±»å‹ï¼Œä½†æ˜¯å’Œå…¶ä»–äº‹æƒ…ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸€äº›ä¸è¶³ï¼š\n* å½“ä½ æƒ³è¦åœ¨ä¸€ä¸ªhandlerä¸­åœæ­¢å¤„ç†çš„æ—¶å€™ï¼Œå¿…é¡»è®°å¾—æ˜¾ç¤ºçš„è°ƒç”¨ä¸€ä¸ªreturnã€‚è¿™ä¸ªåœ¨å½“ä½ æƒ³è¦è·‘å‡ºä¸€ä¸ªä»å®šå‘ï¼ˆ301ã€302ï¼‰ï¼Œæœªæ‰¾åˆ°ï¼ˆ404ï¼‰æˆ–è€…æœåŠ¡å™¨ç«¯é”™è¯¯ï¼ˆ500ï¼‰çš„çŠ¶æ€çš„æ—¶å€™æ˜¯å¾ˆå¹³å¸¸çš„ã€‚å¦‚æœä¸è¿™ä¹ˆåšå¯èƒ½ä¼šå¼•èµ·ä¸€äº›å¾®å¦™çš„é”™è¯¯ï¼ˆå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œï¼‰ï¼Œå› ä¸ºå‡½æ•°ä¸éœ€è¦ä¸€ä¸ªè¿”å›å€¼ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šè­¦å‘Šä½ ã€‚\n* ä¸å®¹æ˜“ä¼ é€’é¢å¤–çš„å‚æ•°ï¼ˆä¾‹å¦‚ï¼Œæ•°æ®åº“è¿æ¥æ± ï¼Œé…ç½®ï¼‰ã€‚ä½ æœ€åä¸å¾—ä¸å®ç”¨ä¸€ç³»åˆ—çš„å…¨å±€å˜é‡ï¼ˆä¸ç®—å¤ªåï¼Œä½†æ˜¯è·Ÿè¸ªä»–ä»¬ä¼šå¯¼è‡´éš¾ä»¥æ‰©å±•ï¼‰æˆ–è€…å°†ä»–ä»¬å­˜åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼Œç„¶åæ¯æ¬¡éƒ½ä»å…¶å–å‡ºã€‚è¿™æ ·åšå¾ˆç¬¨é‡ã€‚\n* ä¸€ç›´åœ¨ä¸æ–­çš„é‡å¤åŒæ ·çš„è¯­å¥ã€‚æƒ³è¦è®°å½•æ•°æ®åº“åŒ…è¿”å›çš„é”™è¯¯ï¼Ÿæ—¢å¯ä»¥å†æ¯ä¸ªæŸ¥è¯¢æ–¹æ³•ä¸­è°ƒç”¨`log.Printf`ï¼Œä¹Ÿå¯ä»¥å†æ¯ä¸ªhandlerä¸­è¿”å›é”™è¯¯ã€‚å¦‚æœä½ çš„handlerå¯ä»¥è¿”å›ç»™ä¸€ä¸ªé›†ä¸­è®°å½•é”™è¯¯çš„å‡½æ•°ï¼Œå¹¶ä¸”è·‘å‡ºä¸€ä¸ª500çš„é”™è¯¯å°±æ›´å¥½äº†ã€‚\n\n æˆ‘ä»¥å‰çš„æ–¹æ³•ä¸­ä½¿ç”¨äº†`func(http.ResponseWriter, *http.Request)`ç­¾åã€‚è¿™å·²ç»è¢«è¯æ˜æ˜¯ä¸€ä¸ªç®€ä»‹çš„æ–¹å¼ï¼Œä½†æ˜¯æœ‰ä¸ªå¥‡æ€ªçš„åœ°æ–¹æ˜¯ï¼Œè¿”å›ä¸€ä¸ªæ— é”™è¯¯çš„çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œ200,302,303å¾€å¾€æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºè¦ä¹ˆä½ å·²ç»åœ¨å…¶ä»–åœ°æ–¹è®¾ç½®äº†ï¼Œè¦ä¹ˆå°±æ˜¯æ²¡ç”¨çš„ã€‚ä¾‹å¦‚ï¼š\n\n```Go\nfunc SomeHandler(w http.ResponseWriter, r *http.Request) (int, error) {\n    db, err := someDBcall()\n    if err != nil {\n        // This makes sense.\n        return 500, err\n    }\n\n    if user.LoggedIn {\n        http.Redirect(w, r, \"/dashboard\", 302)\n        // Superfluous! Our http.Redirect function handles the 302, not \n        // our return value (which is effectively ignored).\n        return 302, nil\n    }\n\n}\n```\n\nçœ‹èµ·æ¥è¿˜è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åšçš„æ›´å¥½\n\n### ä¸€äº›åŒºåˆ«\n\n é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•æ”¹è¿›å®ƒï¼Ÿæˆ‘ä»¬å…ˆåˆ—å‡ºä»£ç ï¼š\n\n```Go\npackage handler\n\n// Error represents a handler error. It provides methods for a HTTP status \n// code and embeds the built-in error interface.\ntype Error interface {\n    error\n    Status() int\n}\n\n// StatusError represents an error with an associated HTTP status code.\ntype StatusError struct {\n    Code int\n    Err  error\n}\n\n// Allows StatusError to satisfy the error interface.\nfunc (se StatusError) Error() string {\n    return se.Err.Error()\n}\n\n// Returns our HTTP status code.\nfunc (se StatusError) Status() int {\n    return se.Code\n}\n\n// A (simple) example of our application-wide configuration.\ntype Env struct {\n    DB   *sql.DB\n    Port string\n    Host string\n}\n\n// The Handler struct that takes a configured Env and a function matching\n// our useful signature.\ntype Handler struct {\n    *Env\n    H func(e *Env, w http.ResponseWriter, r *http.Request) error\n}\n\n// ServeHTTP allows our Handler type to satisfy http.Handler.\nfunc (h Handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    err := h.H(h.Env, w, r)\n    if err != nil {\n        switch e := err.(type) {\n        case Error:\n            // We can retrieve the status here and write out a specific\n            // HTTP status code.\n            log.Printf(\"HTTP %d - %s\", e.Status(), e)\n            http.Error(w, e.Error(), e.Status())\n        default:\n            // Any error types we don't specifically look out for default\n            // to serving a HTTP 500\n            http.Error(w, http.StatusText(http.StatusInternalServerError),\n                http.StatusInternalServerError)\n        }\n    }\n}\n```\n\n ä¸Šé¢çš„ä»£ç ä¸è¨€è‡ªæ˜ï¼Œä½†æ˜¯è¦è¯´æ˜ä¸€ä¸‹ä¸€äº›çªå‡ºçš„è§‚ç‚¹ï¼š\n\n* æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª`Error`ç±»å‹ï¼ˆæ¥å£ï¼‰ï¼Œä»–å†…åµŒäº†Goçš„å†…å»ºçš„erroræ¥å£ï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ª`Status() int`æ–¹æ³•ã€‚\n* æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•çš„`StatusError`ç±»å‹ï¼ˆç»“æ„ä½“ï¼‰ï¼Œå®ƒæ»¡è¶³`handler.Error`çš„æ¥å£ã€‚StatusErroræ¥å—ä¸€ä¸ªHTTPçš„çŠ¶æ€ç ï¼ˆintç±»å‹ï¼‰ï¼Œä¸€ä¸ªå¯ä»¥è®©æˆ‘ä»¬åŒ…è£…é”™è¯¯ç”¨æ¥è®°å½•æˆ–è€…æŸ¥è¯¢çš„errorç±»å‹ã€‚\n* æˆ‘ä»¬çš„`ServeHTTP`æ–¹æ³•åŒ…å¥½äº†ä¸€ä¸ª\"e := err.(type)\"çš„ç±»å‹æ–­è¨€ï¼Œå®ƒå¯ä»¥æµ‹è¯•æˆ‘ä»¬éœ€è¦å¤„ç†çš„é”™è¯¯ï¼Œå…è®¸æˆ‘ä»¬å¤„ç†é‚£äº›ç‰¹åˆ«çš„é”™è¯¯ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»–æ˜¯åªæ˜¯ä¸€ä¸ª`handler.Error`ç±»å‹ã€‚å…¶ä»–çš„é”™è¯¯ï¼Œä¾‹å¦‚å…¶ä»–åŒ…ä¸­çš„é”™è¯¯æƒ³net.Errorï¼Œæˆ–è€…å…¶ä»–æˆ‘ä»¬å®šä¹‰çš„é¢å¤–çš„é”™è¯¯ï¼Œå¦‚æœæƒ³è¦æ£€æŸ¥ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥æ£€æŸ¥ã€‚\n\n å¦‚æœæˆ‘ä»¬ä¸æƒ³æ•æ‰é‚£äº›é”™è¯¯ï¼Œé‚£ä¹ˆ`default`å°†ä¼šé»˜è®¤æ•æ‰åˆ°ã€‚è®°ä½ä¸€ç‚¹ï¼Œ`ServeHTTP`å¯ä»¥ä½¿æˆ‘ä»¬çš„Handlerç±»å‹æ»¡è¶³http.Handleræ¥å£ï¼Œè¿™æ ·ä»–å°±å¯ä»¥åœ¨ä»»ä½•ä½¿ç”¨http.Handlerçš„åœ°æ–¹ä½¿ç”¨äº†ï¼Œä¾‹å¦‚Goçš„net/httpåŒ…æˆ–è€…æ‰€æœ‰çš„å…¶ä»–çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ã€‚è¿™æ ·ä½¿å¾—å®šåˆ¶çš„handleræ›´æœ‰ç”¨ï¼Œä»–ä»¬ç”¨èµ·æ¥å¾ˆçµæ´»ã€‚\n æ³¨æ„ net åŒ…å¤„ç†äº‹æƒ…å¾ˆç®€å•ã€‚å®ƒåˆä¸€ä¸ªnet.Errorçš„æ¥å£ï¼Œå†…åµŒäº†å†…å»ºçš„erroræ¥å£ã€‚ä¸€äº›å…·ä½“çš„ç±»å‹å®ç°äº†å®ƒã€‚å‡½æ•°è¿”å›çš„å…·ä½“ç±»å‹è·Ÿé”™è¯¯çš„ç±»å‹ç›¸åŒï¼ˆDNSé”™è¯¯ï¼Œè§£æé”™è¯¯ç­‰ï¼‰ã€‚å†datastore åŒ…ä¸­å®šä¹‰çš„DBErroræœ‰ä¸€ä¸ªQuery() string æ–¹æ³•ï¼Œå¯ä»¥å¾ˆå¥½çš„è§£é‡Šã€‚\n\n### æ‰€æœ‰ç¤ºä¾‹\n\n å®ƒæœ€åæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†å…¶åˆ†åˆ°ä¸åŒçš„åŒ…ä¸­ï¼Ÿ\n\n```Go\npackage handler\n\nimport (\n    \"net/http\"\n)\n\n// Error represents a handler error. It provides methods for a HTTP status \n// code and embeds the built-in error interface.\ntype Error interface {\n    error\n    Status() int\n}\n\n// StatusError represents an error with an associated HTTP status code.\ntype StatusError struct {\n    Code int\n    Err  error\n}\n\n// Allows StatusError to satisfy the error interface.\nfunc (se StatusError) Error() string {\n    return se.Err.Error()\n}\n\n// Returns our HTTP status code.\nfunc (se StatusError) Status() int {\n    return se.Code\n}\n\n// A (simple) example of our application-wide configuration.\ntype Env struct {\n    DB   *sql.DB\n    Port string\n    Host string\n}\n\n// The Handler struct that takes a configured Env and a function matching\n// our useful signature.\ntype Handler struct {\n    *Env\n    H func(e *Env, w http.ResponseWriter, r *http.Request) error\n}\n\n// ServeHTTP allows our Handler type to satisfy http.Handler.\nfunc (h Handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    err := h.H(h.Env, w, r)\n    if err != nil {\n        switch e := err.(type) {\n        case Error:\n            // We can retrieve the status here and write out a specific\n            // HTTP status code.\n            log.Printf(\"HTTP %d - %s\", e.Status(), e)\n            http.Error(w, e.Error(), e.Status())\n        default:\n            // Any error types we don't specifically look out for default\n            // to serving a HTTP 500\n            http.Error(w, http.StatusText(http.StatusInternalServerError),\n                http.StatusInternalServerError)\n        }\n    }\n}\n\nfunc GetIndex(env *Env, w http.ResponseWriter, r *http.Request) error {\n    users, err := env.DB.GetAllUsers()\n    if err != nil {\n        // We return a status error here, which conveniently wraps the error\n        // returned from our DB queries. We can clearly define which errors \n        // are worth raising a HTTP 500 over vs. which might just be a HTTP \n        // 404, 403 or 401 (as appropriate). It's also clear where our \n        // handler should stop processing by returning early.\n        return StatusError{500, err}\n    }\n\n    fmt.Fprintf(w, \"%+v\", users)\n    return nil\n}\n```\n\n mainåŒ…ï¼š\n\n```Go\npackage main\n\nimport (\n    \"net/http\"\n    \"github.com/you/somepkg/handler\"\n)\n\nfunc main() {\n    db, err := sql.Open(\"connectionstringhere\")\n    if err != nil {\n          log.Fatal(err)\n    }\n\n    // Initialise our app-wide environment with the services/info we need.\n    env := &handler.Env{\n        DB: db,\n        Port: os.Getenv(\"PORT\"),\n        Host: os.Getenv(\"HOST\"),\n        // We might also have a custom log.Logger, our \n        // template instance, and a config struct as fields \n        // in our Env struct.\n    }\n\n    // Note that we're using http.Handle, not http.HandleFunc. The \n    // latter only accepts the http.HandlerFunc type, which is not \n    // what we have here.\n    http.Handle(\"/\", handler.Handler{env, handler.GetIndex})\n\n    // Logs the error if ListenAndServe fails.\n    log.Fatal(http.ListenAndServe(\":8000\", nil))\n}\n```\n\n åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œä¼šå°†handlerå’ŒEnvæ”¾å…¥ä¸åŒçš„åŒ…ä¸­ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†ç®€å•æ”¾åœ¨äº†åŒä¸€ä¸ªåŒ…ä¸­ã€‚\n\n","date":"2015-11-13"},{"title":"OKHttp Recipes","tags":["Java","Translate","OKHttp","HTTP","backend"],"iso8601Date":"2017-03-19T03:44:10+08:00","basename":"Recipes","body":"\n\n[åŸæ–‡åœ°å€](https://github.com/square/okhttp/wiki/Recipes)\næˆ‘ä»¬å†™äº†ä¸€äº›å»ºè®®ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨OKHttpæ¥è§£å†³ä¸€äº›å¸¸è§é—®é¢˜ã€‚\n\n#### åŒæ­¥GET\nä¸‹è½½æ–‡ä»¶ï¼Œæ‰“å°headerï¼Œæ‰“å°bodyã€‚\n`string()`æ–¹æ³•å¯¹äºå°æ–‡æ¡£çš„å“åº”æ¥è¯´æ˜¯ä¸ªæ—¢æ–¹ä¾¿æœ‰é«˜æ•ˆçš„æ–¹æ³•ã€‚ä½†æ˜¯å¦‚æœä¸€ä¸ªæ–‡æ¡£å¤ªå¤§ï¼ˆå¤§äº1Mï¼‰ï¼Œå°±ä¸è¦ä½¿ç”¨`string()`æ–¹æ³•äº†ï¼Œä»¥ä¸ºä»–ä¼šæŠŠæ•´ä¸ªæ–‡æ¡£åŠ è½½åˆ°å†…å­˜ä¸­,åœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥æŠŠbodyå½“ä½œæµæ¥å¤„ç†ã€‚  \n\n```Java\nprivate final OkHttpClient client = new OkHttpClient();\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://publicobject.com/helloworld.txt\")\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nHeaders responseHeaders = response.headers();\nfor (int i = 0; i < responseHeaders.size(); i++) {\nSystem.out.println(responseHeaders.name(i) + \": \" + responseHeaders.value(i));\n}\nSystem.out.println(response.body().string());\n    \n```\n\n #### å¼‚æ­¥GET\n åœ¨å·¥ä½œçº¿ç¨‹ä¸‹è½½æ–‡ä»¶ï¼Œå“åº”å¯è¯»åå›è°ƒã€‚åœ¨å“åº”çš„headerå‡†å¤‡å¥½çš„æ—¶å€™å›è°ƒã€‚å“åº”ä½“å¯èƒ½ä»ç„¶é˜»å¡ã€‚ç°åœ¨OKHttpæ²¡æœ‰æä¾›è·å–å“åº”ä½“çš„å¼‚æ­¥APIã€‚\n\n```Java\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://publicobject.com/helloworld.txt\")\n    .build();\n\nclient.newCall(request).enqueue(new Callback() {\n    @Override public void onFailure(Call call, IOException e) {\n    e.printStackTrace();\n    }\n\n    @Override public void onResponse(Call call, Response response) throws IOException {\n    if (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\n    Headers responseHeaders = response.headers();\n    for (int i = 0, size = responseHeaders.size(); i < size; i++) {\n        System.out.println(responseHeaders.name(i) + \": \" + responseHeaders.value(i));\n    }\n\n    System.out.println(response.body().string());\n    }\n});\n}\n```\n\n #### è®¿é—®Header\n æ€»ä½“ä¸Šè¯´Headeræœ‰ç‚¹åƒ`Map<String,String>`ï¼Œæ¯ä¸€ä¸ªå­—æ®µéƒ½æœ‰æˆ–æ²¡æœ‰å€¼ã€‚ä½†æ˜¯ä¸€äº›Headerå…è®¸æœ‰å¤šä¸ªå€¼ï¼Œå°±åƒGuavaçš„`[Multimap](http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/collect/Multimap.html)`ã€‚\n ä¾‹å¦‚HTTPæä¾›å¤šä¸ªVary`çš„å€¼æ˜¯å¾ˆå¸¸è§å¹¶ä¸”åˆæ³•çš„ã€‚OKHttpçš„APIåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½èƒ½è½»æ¾ä½¿ç”¨ã€‚\n å½“å†™å…¥è¯·æ±‚headerçš„æ—¶å€™ä½¿ç”¨`header(name,value)`è®¾ç½®ä»…æœ‰ä¸€ä¸ªçš„`name`å’Œ`value`ã€‚å¦‚æœæœ‰å­˜åœ¨çš„å€¼ï¼Œä¼šå…ˆç§»é™¤å€¼å†æ·»åŠ ã€‚ ä½¿ç”¨`addHeader(name,value)`æ·»åŠ headerä¸ä¼šç§»é™¤å·²ç»å­˜åœ¨çš„headerã€‚\n å½“è¯»å“åº”headerçš„æ—¶å€™ï¼Œ`header(name)`åªè¿”å›æœ€åä¸€ä¸ªå€¼ï¼Œé€šå¸¸ä¹Ÿä»…æœ‰ä¸€ä¸ªã€‚å¦‚æœæ²¡æœ‰å€¼ï¼Œå°†ä¼šè¿”å›nullã€‚ä»¥ä¸€ä¸ªlistçš„æ–¹å¼è·å–æ‰€æœ‰çš„å€¼å¯ä»¥ä½¿ç”¨`headers(name)`ã€‚\n å¦‚æœè¦è®¿é—®æ‰€æœ‰çš„headerï¼Œå¯ä»¥ä½¿ç”¨Headersç±»ï¼Œæ”¯æŒåæ ‡è®¿é—®ã€‚\n\n```Java\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"https://api.github.com/repos/square/okhttp/issues\")\n    .header(\"User-Agent\", \"OkHttp Headers.java\")\n    .addHeader(\"Accept\", \"application/json; q=0.5\")\n    .addHeader(\"Accept\", \"application/vnd.github.v3+json\")\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(\"Server: \" + response.header(\"Server\"));\nSystem.out.println(\"Date: \" + response.header(\"Date\"));\nSystem.out.println(\"Vary: \" + response.headers(\"Vary\"));\n}\n```\n\n #### ä½¿ç”¨POSTå‘é€Stringè¯·æ±‚ã€‚\n ä½¿ç”¨HTTPçš„POSTç»™æœåŠ¡å‘é€è¯·æ±‚ã€‚è¿™ä¸ªä¾‹å­å‘é€äº†ä¸€ä¸ªmarkdownæ–‡æ¡£åˆ°æœåŠ¡å™¨ç”¨æ¥å°†markdownæ¸²æŸ“æˆHTMLã€‚å› ä¸ºæ•´ä¸ªè¯·æ±‚æ˜¯æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ­¤APIçš„æ—¶å€™é¿å…å¤§æ–‡æ¡£ï¼ˆå°äº1Mï¼‰ã€‚\n\n```Java\npublic static final MediaType MEDIA_TYPE_MARKDOWN\n    = MediaType.parse(\"text/x-markdown; charset=utf-8\");\n\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nString postBody = \"\"\n    + \"Releases\\n\"\n    + \"--------\\n\"\n    + \"\\n\"\n    + \" * _1.0_ May 6, 2013\\n\"\n    + \" * _1.1_ June 15, 2013\\n\"\n    + \" * _1.2_ August 11, 2013\\n\";\n\nRequest request = new Request.Builder()\n    .url(\"https://api.github.com/markdown/raw\")\n    .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, postBody))\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n\n #### ä½¿ç”¨POSTå‘é€æµ\n ä½¿ç”¨POSTå°†è¯·æ±‚ä½“ä»¥æµçš„æ–¹å¼å‘é€ã€‚è¯·æ±‚ä½“åœ¨è¢«å†™å…¥çš„æ—¶å€™ç”Ÿæˆã€‚è¿™ä¸ªä¾‹å­ç›´æ¥ä½¿ç”¨äº†`[Okio](https://github.com/square/okio)`çš„ç¼“å†²åº“ã€‚å¯èƒ½ä½ æ›´ç†Ÿæ‚‰`OutputStream`å¯ä»¥é€šè¿‡`BufferedSink.outputStream`è·å–ã€‚\n\n\n```Java\npublic static final MediaType MEDIA_TYPE_MARKDOWN\n    = MediaType.parse(\"text/x-markdown; charset=utf-8\");\n\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequestBody requestBody = new RequestBody() {\n    @Override public MediaType contentType() {\n    return MEDIA_TYPE_MARKDOWN;\n    }\n\n    @Override public void writeTo(BufferedSink sink) throws IOException {\n    sink.writeUtf8(\"Numbers\\n\");\n    sink.writeUtf8(\"-------\\n\");\n    for (int i = 2; i <= 997; i++) {\n        sink.writeUtf8(String.format(\" * %s = %s\\n\", i, factor(i)));\n    }\n    }\n\n    private String factor(int n) {\n    for (int i = 2; i < n; i++) {\n        int x = n / i;\n        if (x * i == n) return factor(x) + \" Ã— \" + i;\n    }\n    return Integer.toString(n);\n    }\n};\n\nRequest request = new Request.Builder()\n    .url(\"https://api.github.com/markdown/raw\")\n    .post(requestBody)\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n\n #### ä½¿ç”¨POSTå‘é€ä¸€ä¸ªæ–‡ä»¶\n æ–‡ä»¶å¾ˆå®¹æ˜“å½“ä½œä¸€ä¸ªè¯·æ±‚ä½“ã€‚\n\n```Java\npublic static final MediaType MEDIA_TYPE_MARKDOWN\n    = MediaType.parse(\"text/x-markdown; charset=utf-8\");\n\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nFile file = new File(\"README.md\");\n\nRequest request = new Request.Builder()\n    .url(\"https://api.github.com/markdown/raw\")\n    .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, file))\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n\n #### å‘é€form å‚æ•°\n ä½¿ç”¨`FormBody.Builder`æ¥åˆ›å»ºä¸€ä¸ªåŒHTML çš„`form`æ ‡ç­¾æ–¹å¼ç›¸åŒçš„è¯·æ±‚è¸¢ã€‚åå­—å’Œå€¼ä¼šè¢«ç¼–ç æˆHTMLå…¼å®¹çš„URLç¼–ç ã€‚\n\n```Java\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequestBody formBody = new FormBody.Builder()\n    .add(\"search\", \"Jurassic Park\")\n    .build();\nRequest request = new Request.Builder()\n    .url(\"https://en.wikipedia.org/w/index.php\")\n    .post(formBody)\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n\n #### å‘é€multipartè¯·æ±‚\n `MultipartBody.Builder`å¯ä»¥åˆ›å»ºå’ŒHTMLä¸Šä¼ æ–‡ä»¶å…¼å®¹çš„è¯·æ±‚ã€‚æ¯ä¸€ä¸ªmultipartè¯·æ±‚ä½“è‡ªèº«ä¹Ÿæ˜¯è¯·æ±‚ä½“ï¼Œå¯ä»¥æœ‰è‡ªå·±çš„headerã€‚å¦‚æœæä¾›äº†ï¼Œè¿™äº›headerä»…æè¿°è‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚`Content-Dispositon`ã€‚`Content-Type`,`Content-Length`å¦‚æœå¯ç”¨ä¼šè‡ªåŠ¨æ·»åŠ ã€‚\n \n```Java\nprivate static final String IMGUR_CLIENT_ID = \"...\";\nprivate static final MediaType MEDIA_TYPE_PNG = MediaType.parse(\"image/png\");\n\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\n// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image\nRequestBody requestBody = new MultipartBody.Builder()\n    .setType(MultipartBody.FORM)\n    .addFormDataPart(\"title\", \"Square Logo\")\n    .addFormDataPart(\"image\", \"logo-square.png\",\n        RequestBody.create(MEDIA_TYPE_PNG, new File(\"website/static/logo-square.png\")))\n    .build();\n\nRequest request = new Request.Builder()\n    .header(\"Authorization\", \"Client-ID \" + IMGUR_CLIENT_ID)\n    .url(\"https://api.imgur.com/3/image\")\n    .post(requestBody)\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n #### ä½¿ç”¨Gsonè§£æå“åº”JSON\n [Gson](http://code.google.com/p/google-gson/)æ˜¯ä¸€ä¸ªå¾ˆé¡ºæ‰‹çš„è½¬æ¢Javaå¯¹è±¡å’ŒJSONçš„APIã€‚è¿™é‡Œæˆ‘ä»¬ç”¨å®ƒæ¥è§£æGitHubå“åº”çš„JSONã€‚\n æ³¨æ„ï¼Œ`ResponseBody.charStream()`ä½¿ç”¨`content-type`çš„å“åº”headeræ¥é€‰æ‹©è§£ç å“åº”æµçš„å­—ç¬¦é›†ï¼Œå¦‚æœæ²¡æœ‰æä¾›é»˜è®¤ä½¿ç”¨UTF-8ã€‚\n\n```Java\nprivate final OkHttpClient client = new OkHttpClient();\nprivate final Gson gson = new Gson();\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"https://api.github.com/gists/c2a7c39532239ff261be\")\n    .build();\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nGist gist = gson.fromJson(response.body().charStream(), Gist.class);\nfor (Map.Entry<String, GistFile> entry : gist.files.entrySet()) {\n    System.out.println(entry.getKey());\n    System.out.println(entry.getValue().content);\n}\n}\n\nstatic class Gist {\nMap<String, GistFile> files;\n}\n\nstatic class GistFile {\nString content;\n}\n```\n\n #### å“åº”ç¼“å­˜\n ä¸ºäº†æ¢æˆå“åº”éœ€è¦åˆä¸€ä¸ªå¯è¯»å†™çš„ç¼“å­˜ç›®å½•å¹¶ä¸”é™åˆ¶ç¼“å­˜çš„å¤§å°ã€‚ç¼“å­˜ç›®å½•åº”è¯¥æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”éä¿¡ä»»çš„åº”ç”¨æ— æƒè®¿é—®ã€‚  \n åŒæ—¶è®¿é—®ä¸€ä¸ªç¼“å†²ç›®å½•å›å‡ºç°é”™è¯¯ã€‚å¤§å¤šæ•°åº”ç”¨åº”è¯¥è°ƒç”¨ä¸€æ¬¡`new OkHttpClient()`ï¼Œé…ç½®å®ƒçš„ç¼“å­˜ï¼Œåœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ç»Ÿä¸€ä¸ªå®ä¾‹ã€‚å¦åˆ™ä¸¤ä¸ªç¼“å­˜å®ä¾‹ä¼šäº’ç›¸æŸå®³ï¼ŒæŸåæ¢æˆï¼Œå¯èƒ½æ˜¯ä½ çš„åº”ç”¨å´©æºƒã€‚\n å“åº”ç¼“å­˜ä½¿ç”¨HTTPçš„headeræ¥é…ç½®ã€‚å¦‚æœè¯·æ±‚å¤´æ·»åŠ äº†`Cache-Control: max-stale=3600`,OKHttpå°†ä¼šä½¿ç”¨è¿™äº›é…ç½®ã€‚æ˜¯æœåŠ¡å™¨æ¥é…ç½®å“åº”å¯ä»¥è¢«ç¼“å­˜å¤šé•¿æ—¶é—´ï¼Œé€šè¿‡å“åº”å¤´æ¥é…ç½®ï¼Œä¾‹å¦‚`Cache-Control: max-age=9600`ã€‚æœ‰ä¸€äº›headerå¯ä»¥å¼ºåˆ¶æ¢æˆå“åº”ï¼Œå¼ºåˆ¶ä¸€ä¸ªç½‘ç»œè¿”å›æˆ–è€…å¼ºåˆ¶ä¸€ä¸ªæœ‰æ¡ä»¶çš„GETç¡®å®šç¼“å­˜æ˜¯å¦æœ‰æ•ˆã€‚\n \n```Java\nprivate final OkHttpClient client;\n\npublic CacheResponse(File cacheDirectory) throws Exception {\nint cacheSize = 10 * 1024 * 1024; // 10 MiB\nCache cache = new Cache(cacheDirectory, cacheSize);\n\nclient = new OkHttpClient.Builder()\n    .cache(cache)\n    .build();\n}\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://publicobject.com/helloworld.txt\")\n    .build();\n\nResponse response1 = client.newCall(request).execute();\nif (!response1.isSuccessful()) throw new IOException(\"Unexpected code \" + response1);\n\nString response1Body = response1.body().string();\nSystem.out.println(\"Response 1 response:          \" + response1);\nSystem.out.println(\"Response 1 cache response:    \" + response1.cacheResponse());\nSystem.out.println(\"Response 1 network response:  \" + response1.networkResponse());\n\nResponse response2 = client.newCall(request).execute();\nif (!response2.isSuccessful()) throw new IOException(\"Unexpected code \" + response2);\n\nString response2Body = response2.body().string();\nSystem.out.println(\"Response 2 response:          \" + response2);\nSystem.out.println(\"Response 2 cache response:    \" + response2.cacheResponse());\nSystem.out.println(\"Response 2 network response:  \" + response2.networkResponse());\n\nSystem.out.println(\"Response 2 equals Response 1? \" + response1Body.equals(response2Body));\n}\n```\n\n ä¸ºäº†é˜»æ­¢ç¼“å†²å¯ä»¥ä½¿ç”¨`[CacheControl.FORCE_NETWORK](CacheControl.FORCE_NETWORK)`.ä¸ºäº†é˜»æ­¢ç½‘ç»œè¿æ¥å¯ä»¥ä½¿ç”¨`[CacheControl.FORCE_CACHE](http://square.github.io/okhttp/3.x/okhttp/okhttp3/CacheControl.html#FORCE_CACHE)`ã€‚è­¦å‘Šï¼šå¦‚æœä½¿ç”¨äº†`FORCE_CACHE`å¹¶ä¸”å“åº”éœ€è¦ç½‘ç»œï¼Œå°†ä¼šè¿”å›`504 Unsatisfiable Request`ã€‚\n #### å–æ¶ˆè¯·æ±‚\n ä½¿ç”¨`Call.cancel()`ç«‹å³å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨å†™ä¸€ä¸ªè¯·æ±‚æˆ–è€…è¯»ä¸€ä¸ªå“åº”å°†ä¼šæŠ›å‡ºIOExceptionã€‚å½“ä¸€ä¸ªè¯·æ±‚ä¸åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥ä¿æŠ¤ç½‘ç»œã€‚ä¾‹å¦‚å½“ç”¨æˆ·å¯¼èˆªç¦»å¼€åº”ç”¨çš„æ—¶å€™ã€‚åŒæ­¥å’Œå¼‚æ­¥çš„è¯·æ±‚éƒ½å¯ä»¥å–æ¶ˆã€‚\n \n```Java\nprivate final ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://httpbin.org/delay/2\") // This URL is served with a 2 second delay.\n    .build();\n\nfinal long startNanos = System.nanoTime();\nfinal Call call = client.newCall(request);\n\n// Schedule a job to cancel the call in 1 second.\nexecutor.schedule(new Runnable() {\n    @Override public void run() {\n    System.out.printf(\"%.2f Canceling call.%n\", (System.nanoTime() - startNanos) / 1e9f);\n    call.cancel();\n    System.out.printf(\"%.2f Canceled call.%n\", (System.nanoTime() - startNanos) / 1e9f);\n    }\n}, 1, TimeUnit.SECONDS);\n\ntry {\n    System.out.printf(\"%.2f Executing call.%n\", (System.nanoTime() - startNanos) / 1e9f);\n    Response response = call.execute();\n    System.out.printf(\"%.2f Call was expected to fail, but completed: %s%n\",\n        (System.nanoTime() - startNanos) / 1e9f, response);\n} catch (IOException e) {\n    System.out.printf(\"%.2f Call failed as expected: %s%n\",\n        (System.nanoTime() - startNanos) / 1e9f, e);\n}\n}\n```\n\n #### è¶…æ—¶\n å½“ç«¯ç‚¹ä¸å¯è¾¾çš„æ—¶å€™ä½¿ç”¨è¶…æ—¶ä½¿è¯·æ±‚å¤±è´¥ã€‚ç½‘ç»œåˆ†åŒºå¯èƒ½æ˜¯å®¢æˆ·ç«¯è¿æ¥é—®é¢˜ï¼ŒæœåŠ¡å™¨å¯ç”¨æ€§é—®é¢˜æˆ–è€…å…¶ä»–é—®é¢˜ã€‚OKHttpæ”¯æŒè¿æ¥ï¼Œè¯»ï¼Œå†™è¶…æ—¶ã€‚\n \n```Java\nprivate final OkHttpClient client;\n\npublic ConfigureTimeouts() throws Exception {\nclient = new OkHttpClient.Builder()\n    .connectTimeout(10, TimeUnit.SECONDS)\n    .writeTimeout(10, TimeUnit.SECONDS)\n    .readTimeout(30, TimeUnit.SECONDS)\n    .build();\n}\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://httpbin.org/delay/2\") // This URL is served with a 2 second delay.\n    .build();\n\nResponse response = client.newCall(request).execute();\nSystem.out.println(\"Response completed: \" + response);\n}\n ```\n\n #### è°ƒç”¨å‰é…ç½®\n æ‰€æœ‰çš„HTTPè°ƒç”¨é…ç½®éƒ½ä¼šåœ¨`OkHttpClient`ä¸­ï¼ŒåŒ…æ‹¬ï¼Œä»£ç†è®¾ç½®ï¼Œè¶…æ—¶å’Œç¼“å­˜ã€‚å½“éœ€è¦ä¿®æ”¹æŸä¸ªè°ƒç”¨çš„é…ç½®çš„æ—¶å€™ï¼Œä½¿ç”¨`OKHttpClient.newBuilder()`ã€‚è¿™ä¸ªå‡½æ•°ä¼šè¿”å›å…±äº«çš„è¿æ¥æ± ï¼Œè°ƒåº¦å™¨ï¼Œå¹¶ä¸”è·ŸåŸå§‹clientç›¸åŒçš„é…ç½®ã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´æ˜¯500mså¦ä¸€ä¸ªæ˜¯3000msã€‚\n\n ```Java\nprivate final OkHttpClient client = new OkHttpClient();\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://httpbin.org/delay/1\") // This URL is served with a 1 second delay.\n    .build();\n\ntry {\n    // Copy to customize OkHttp for this request.\n    OkHttpClient copy = client.newBuilder()\n        .readTimeout(500, TimeUnit.MILLISECONDS)\n        .build();\n\n    Response response = copy.newCall(request).execute();\n    System.out.println(\"Response 1 succeeded: \" + response);\n} catch (IOException e) {\n    System.out.println(\"Response 1 failed: \" + e);\n}\n\ntry {\n    // Copy to customize OkHttp for this request.\n    OkHttpClient copy = client.newBuilder()\n        .readTimeout(3000, TimeUnit.MILLISECONDS)\n        .build();\n\n    Response response = copy.newCall(request).execute();\n    System.out.println(\"Response 2 succeeded: \" + response);\n} catch (IOException e) {\n    System.out.println(\"Response 2 failed: \" + e);\n}\n}\n ```\n\n #### å¤„ç†è®¤è¯\n OKHttpä¼šè‡ªåŠ¨é‡è¯•è®¤è¯è¯·æ±‚ã€‚å½“å“åº”æ˜¯`401 Not Authorized`,`Authenticator`éœ€è¦ç”¨æ¥æä¾›å‡­è¯ã€‚å°†ä¼šé‡æ–°å®ç°ä¸€ä¸ªå¸¦æœ‰å‡­è¯çš„è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰å‡­è¯å¯ç”¨è·³è¿‡é‡è¯•ï¼Œè¿”å›nullã€‚\n ä½¿ç”¨` Response.challenges()`æ¥è·å–ä»»ä½•è®¤è¯å£ä»¤çš„æ–¹æ¡ˆå’ŒåŸŸã€‚å½“ä½¿ç”¨`Basic`è®¤è¯çš„æ—¶å€™ä½¿ç”¨`Credentials.basic(username,password)`æ¥ç¼–ç ä¸€ä¸ªheaderã€‚\n \n```Java\nprivate final OkHttpClient client;\n\npublic Authenticate() {\nclient = new OkHttpClient.Builder()\n    .authenticator(new Authenticator() {\n        @Override public Request authenticate(Route route, Response response) throws IOException {\n        System.out.println(\"Authenticating for response: \" + response);\n        System.out.println(\"Challenges: \" + response.challenges());\n        String credential = Credentials.basic(\"jesse\", \"password1\");\n        return response.request().newBuilder()\n            .header(\"Authorization\", credential)\n            .build();\n        }\n    })\n    .build();\n}\n\npublic void run() throws Exception {\nRequest request = new Request.Builder()\n    .url(\"http://publicobject.com/secrets/hellosecret.txt\")\n    .build();\n\nResponse response = client.newCall(request).execute();\nif (!response.isSuccessful()) throw new IOException(\"Unexpected code \" + response);\n\nSystem.out.println(response.body().string());\n}\n```\n","date":"2017-03-19"},{"title":"OKHttpçš„è°ƒç”¨","tags":["Translate","Java","OKHttp","HTTP","backend"],"iso8601Date":"2017-03-18T23:10:03+08:00","basename":"calls","body":"\n\n[åŸæ–‡åœ°å€](https://github.com/square/okhttp/wiki/Calls)\n\nHTTPå®¢æˆ·ç«¯çš„ä»»åŠ¡æ˜¯æ¥å—è¯·æ±‚å’Œäº§ç”Ÿå“åº”ã€‚ç†è®ºå¾ˆç®€å•ï¼Œä½†æ˜¯å®æˆ˜çš„æ—¶å€™å°±æœ‰ç‚¹æ£˜æ‰‹äº†ã€‚\n#### Requests\næ¯ä¸€ä¸ªHTTPè¯·æ±‚éƒ½åŒ…å«ä¸€ä¸ªURLï¼Œä¸€ä¸ªæ–¹æ³•ï¼ˆä¾‹å¦‚ï¼ŒGETï¼ŒPOSTï¼‰å’Œä¸€äº›headersã€‚è¯·æ±‚åŒæ—¶å¯ä»¥åŒ…å«ä¸€ä¸ªç‰¹å®šç±»å‹çš„æ•°æ®æµä½œä¸ºbodyã€‚\n#### Responses\nResponse é€šè¿‡ä¸€ä¸ªä¸€ä¸ªçŠ¶æ€ç ï¼ˆä¾‹å¦‚ï¼Œ200 æˆåŠŸï¼Œ404æœªæ‰¾åˆ°ï¼‰ï¼Œheadersï¼Œå’Œä¸€ä¸ªå¯é€‰çš„Bodyæ¥å“åº”è¯·æ±‚ã€‚\n##### é‡å†™è¯·æ±‚\nå½“ä½¿ç”¨OkHttpå‘é€HTTPè¯·æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨é«˜å±‚æ¬¡æè¿°è¿™ä¸ªè¯·æ±‚ï¼šé€šè¿‡è¿™ä¸ªURLå’Œè¿™äº›headersæ¥è·å–å“åº”ã€‚ä¸ºäº†å‡†ç¡®å’Œæ›´é«˜çš„æ•ˆç‡ï¼ŒOKHttpä¼šåœ¨å‘é€ä¹‹å‰é‡ç°è¯·æ±‚ã€‚\nOkHttpå°†ä¼šæ·»åŠ åŸè¯·æ±‚æ²¡æœ‰çš„headerï¼ŒåŒ…æ‹¬`Content-length`,`Transfer-Encoding`,`User-Agent`,`Host`,`Connection`ï¼Œ`Content-Type`ã€‚é™¤éå·²ç»æä¾›äº†ï¼Œå¦åˆ™OKHttpå›ä¼šæ·»åŠ  `Acceept-Encoding`æ¥å‹ç¼©å“åº”ã€‚å¦‚æœæœ‰Cookieï¼Œä¹Ÿä¼šæ·»åŠ `Cookie`ã€‚\næœ‰äº›è¯·æ±‚ä¼šç¼“å­˜å“åº”ã€‚å½“è¢«ç¼“å­˜çš„å“åº”è¿‡æœŸåï¼ŒOKHttpä¼šå‘é€ä¸€ä¸ªæœ‰æ¡ä»¶çš„GETè¯·æ±‚æ¥è·å–æ–°çš„å“åº”ï¼Œå¦‚æœæ–°ç°åœ¨çš„æ¯”ç¼“å­˜çš„å“åº”æ›´æ–°ï¼Œå°†ä¼šæ›´æ–°ç¼“å­˜è¿‡çš„å“åº”ã€‚è¿™è¦æ±‚`If-Modified-Since`å’Œ`If-None-Match`æ·»åŠ åˆ°headersä¸­ã€‚\n##### é‡å†™å“åº”\nå¦‚æœé€æ˜å‹ç¼©å¯ç”¨äº†ï¼ŒOKHttpå°†ä¼šæŠŠ`Content-Encoding`å’Œ`Content-Length`ä»headersä¸­ç§»é™¤ï¼Œå› ä¸ºä»–ä»¬ä¸æ˜¯ç”¨æ¥è§£å‹ç¼©çš„ã€‚\nå¦‚æœæ¡ä»¶GETè¯·æ±‚æˆåŠŸï¼Œä»ç½‘ä¸Šä¸‹è½½çš„å“åº”å’Œç¼“å­˜çš„å“åº”æ ¹æ®Specåˆå¹¶ã€‚\n##### åç»­è¯·æ±‚\nå½“è¯·æ±‚çš„URLè¢«è½¬ç§»äº†ï¼Œweb server å°†ä¼šè¿”å›ä¸€ä¸ª302çš„çŠ¶æ€ç æ¥è¡¨ç¤ºè¿™ä¸ªæ–‡æ¡£çš„æ–°URLï¼ŒOKHttpå°†ä¼šé‡å®šå‘åˆ°æ–°çš„URLè·å–æœ€ç»ˆçš„å“åº”ã€‚\nå¦‚æœå“åº”éœ€è¦è®¤è¯ï¼ŒOKHttpå°†ä¼šä½¿ç”¨`Authenticator`ï¼ˆå¦‚æœæä¾›äº†ä¸€ä¸ªï¼‰æ¥è®¤è¯ã€‚å¦‚æœè®¤è¯å™¨æä¾›äº†å‡­è¯ï¼Œè¯·æ±‚å›ä½¿ç”¨å‡­è¯é‡è¯•ã€‚\n##### é‡è¯•è¯·æ±‚\næœ‰æ—¶è¿æ¥å¤±è´¥ï¼Œä¾‹å¦‚ï¼šè¿æ¥æ± è¿‡æœŸæ–­å¼€é“¾æ¥ï¼Œæˆ–è€…æ— æ³•è¿æ¥æœåŠ¡å™¨ã€‚OKHttpä¼šé€šè¿‡ä¸åŒçš„å¯ç”¨è·¯ç”±æ¥é‡è¯•è¯·æ±‚ã€‚\n#### calls\né€šè¿‡é‡å†™ï¼Œé‡å®šå‘ï¼Œç»§ç»­è¯·æ±‚å’Œé‡è¯•ï¼Œä¸€ä¸ªç®€å•çš„è¯·æ±‚å¯èƒ½ä¼šäº§ç”Ÿå¾ˆå¤šè¯·æ±‚å’Œå“åº”ã€‚OKHttpä½¿ç”¨`call`å»ºç«‹ä¸€ä¸ªä¸ç®¡å¤šå°‘ä¸­é—´è¯·æ±‚å’Œå“åº”çš„ä»»åŠ¡æ¨¡å‹ã€‚æ€»çš„æ¥è¯´è¿™ä¸å¤šã€‚ä½†æ˜¯äº†è§£ä»£ç å°†ä¼šç»§ç»­å·¥ä½œï¼Œä¸ç®¡æ˜¯URLé‡å®šå‘æˆ–è€…æ˜¯è½¬ç§»æ•…éšœå…¶ä»–IPã€‚\ncallæœ‰ä¸¤ç§å·¥ä½œæ–¹\n   * åŒæ­¥ï¼šçº¿ç¨‹å°†ä¼šé˜»å¡é“åˆ°å“åº”å¯è¯»ã€‚\n   * å¼‚æ­¥ï¼šå°†è¯·æ±‚åŠ å…¥åˆ°å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—ï¼Œå½“å“åº”å¯è¯»è¯—æ—¶ï¼Œä¼šåœ¨å…¶ä»–çš„çº¿ç¨‹è·å–å›è°ƒã€‚\nè¯·æ±‚è°ƒç”¨å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹å–æ¶ˆã€‚å¦‚æœè°ƒç”¨æœªå®Œæˆï¼Œè¿™ä¸ªè¯·æ±‚å°†ä¼šå¤±è´¥ã€‚å½“è°ƒç”¨å–æ¶ˆæ—¶ï¼Œåœ¨å…ˆè¯·æ±‚è¸¢ä½“æˆ–è€…è¯»å“åº”ä½“çš„ä»£ç å°†ä¼šè·‘å‡ºIOExceptionçš„å¼‚å¸¸ã€‚\n##### è°ƒåº¦\nå¯¹äºåŒæ­¥è°ƒç”¨ï¼Œå°†ä¼šç”±è‡ªèº«çº¿ç¨‹æ§åˆ¶å¤šå°‘å¹¶å‘è¯·æ±‚ã€‚å¤ªå¤šå¹¶å‘è¿æ¥æµªè´¹èµ„æºï¼Œå¤ªå°‘åˆå›æœ‰é«˜å»¶è¿Ÿã€‚\nå¯¹äºå¼‚æ­¥æ¥è¯´ï¼ŒDispatcherå®ç°äº†æœ€å¤§å¹¶å‘çš„ç­–ç•¥ã€‚å¯ä»¥è®¾ç½®æ²¡ä¸ªæœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘ï¼ˆé»˜è®¤æ˜¯5ï¼‰å’Œæ€»ä½“çš„å¹¶å‘ï¼ˆé»˜è®¤64ï¼‰ã€‚\n","date":"2017-03-18"},{"title":"OKHttp connections","tags":["OKHttp","Translate","Java","HTTP","backend"],"iso8601Date":"2017-03-19T03:05:48+08:00","basename":"connections","body":"\n\n[åŸæ–‡åœ°å€](https://github.com/square/okhttp/wiki/Connections)\nè™½ç„¶åªæä¾›äº†URLï¼Œä½†æ˜¯OKHttpä¼šä½¿ç”¨URLï¼ŒAddressï¼ŒRouteä¸‰ç§æ–¹å¼æ¥è¿æ¥æœåŠ¡å™¨ã€‚\n\n#### URLS\nURLsä¾‹å¦‚ï¼ˆhttps://github.com/square/okhttp) æ˜¯HTTPå’ŒInternetçš„åŸºç¡€ã€‚é™¤äº†æ˜¯ä¸€ä¸ªè¡¨ç¤ºäº’è”ç½‘ä¸€åˆ‡çš„å‘½åæ–¹æ¡ˆï¼Œä¹ŸæŒ‡å®šäº†å¦‚ä½•è®¿é—®Webèµ„æºã€‚\nURLsæ˜¯æŠ½è±¡çš„ï¼š\n  * å®ƒæŒ‡å‡ºï¼Œè°ƒç”¨å¯ä»¥æ˜¯çº¯æ–‡æœ¬ï¼ˆhttpï¼‰æˆ–è€…åŠ å¯†ï¼ˆhttpsï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŒ‡å®šä¸€ç§åŠ å¯†ç®—æ³•ã€‚ä¹Ÿæ²¡æœ‰æŒ‡å®šå¦‚ä½•éªŒè¯å„ä¸ªç«¯ç‚¹çš„è¯ä¹¦([HostnameVerifier](http://developer.android.com/reference/javax/net/ssl/HostnameVerifier.html))ï¼Œæˆ–è€…æ˜¯å“ªä¸ªè¯ä¹¦å¯ä¿¡([SSLSocketFactory](http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html))\n  * å®ƒä¸ºæŒ‡å®šæ˜¯å¦éœ€è¦ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ä»¥åŠä»£ç†æœåŠ¡å™¨å¦‚ä½•æˆæƒã€‚\n å®ƒä¹Ÿæ˜¯å…·ä½“çš„ï¼Œæ¯ä¸ªURLæ ‡è¯†ä¸€ä¸ªå…·ä½“çš„è·¯å¾„ï¼ˆ/square/okhttp)å’ŒæŸ¥è¯¢ï¼ˆ?q=sharks&lang=en)ã€‚æ¯ä¸ªæœåŠ¡å™¨æœ‰å¾ˆå¤šURLã€‚\n\n #### Addresses\n AddressæŒ‡å®šäº†ä¸€ä¸ªæœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼šgithub.comï¼‰ï¼Œä»¥åŠè¿æ¥æœåŠ¡å™¨å¿…è¦çš„æ‰€æœ‰çš„é™æ€é…ç½®ï¼ŒåŒ…æ‹¬ï¼šç«¯å£å·ï¼ŒHTTPSè®¾ç½®ï¼Œä¼˜å…ˆåè®®ï¼ˆä¾‹å¦‚ï¼ŒHTTPï¼2ï¼ŒSPDYï¼‰ã€‚\n URLä½¿ç”¨äº†ç›¸åŒçš„Addressï¼Œåº•å±‚ä¹Ÿå¯èƒ½å®ç”¨äº†ç›¸åŒçš„TCPé“¾æ¥ã€‚å¤ç”¨è¿æ¥å¯ä»¥æé«˜æ€§èƒ½ï¼šä½å»¶è¿Ÿï¼Œé«˜ååï¼ˆ[TCP æ…¢å¯åŠ¨](http://www.igvita.com/2011/10/20/faster-web-vs-tcp-slow-start/))ï¼Œä½ç”µé‡ã€‚OKHttpä½¿ç”¨[ConnectionPool](http://square.github.io/okhttp/3.x/okhttp/okhttp3/ConnectionPool.html)è‡ªåŠ¨å¤ç”¨HTTPï¼1.xè¿æ¥ï¼Œå¤šè·¯å¤ç”¨HTTï¼2å’ŒSPDYçš„è¿æ¥ã€‚\n åœ¨OKHttpï¼Œaddressçš„ä¸€äº›å­—æ®µæ¥æºäºURLï¼ˆåè®®ï¼Œä¸»æœºåï¼Œç«¯å£ï¼‰ï¼Œå‰©ä¸‹çš„æ¥è‡ª[OKHttpClient](http://square.github.io/okhttp/3.x/okhttp/okhttp3/OkHttpClient.html)ã€‚\n #### Routes\n Routeæä¾›äº†è¿æ¥æœåŠ¡å™¨å¿…è¦çš„åŠ¨æ€ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼Œå…·ä½“çš„IPåœ°å€ï¼ˆé€šè¿‡DNSæŸ¥è¯¢ï¼‰ï¼Œå…·ä½“ä½¿ç”¨é‚£ä¸ªä»£ç†ï¼ˆ[ProxySelector](http://developer.android.com/reference/java/net/ProxySelector.html)ï¼‰ï¼Œånå“ªä¸ªTLSç‰ˆæœ¬ï¼ˆHTTPS).\n ä¸€ä¸ªæœåŠ¡å™¨å¯èƒ½æœ‰å¤šæ¡è·¯æœ‰ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼šå¤šå°æœåŠ¡å™¨éƒ¨ç½²åœ¨å¤šä¸ªæ•°æ®ä¸­å¿ƒï¼ŒDNSæŸ¥è¯¢è¿”å›å¤šä¸ªIPåœ°å€ã€‚\n #### Connections\n å½“å‘èµ·ä¸€ä¸ªURLçš„è¯·æ±‚çš„æ—¶å€™ï¼š\n   1. ä½¿ç”¨URLå’ŒOKHttpCLientç¡®å®šå…·ä½“çš„**Address**ã€‚è¿™ä¸ªåœ°å€æ˜ç¡®å¦‚ä½•è¿æ¥æœåŠ¡å™¨ã€‚\n   2. å°è¯•ä»**è¿æ¥æ± **ä¸­æŸ¥æ‰¾å…·ä½“Addressçš„è¿æ¥ã€‚\n   3. å¦‚æœæœªæ‰¾åˆ°æœ‰æ•ˆçš„è¿æ¥ï¼Œä½¿ç”¨Routeæ¥å°è¯•è·å–ã€‚ä¸€èˆ¬è¿™æ ·æ„å‘³ç€é€šè¿‡DNSæˆ–å»IPåœ°å€ã€‚ç„¶åï¼Œå¦‚æœéœ€è¦ï¼Œé€‰æ‹©ä¸€ä¸ªTLSçš„ç‰ˆæœ¬å’Œä»£ç†æœåŠ¡å™¨ã€‚\n   4. å¦‚æœæ˜¯ä¸€ä¸ªæ–°çš„Routeï¼Œè¦ä¹ˆä½¿ç”¨Socketç›´è¿ï¼ŒTLSéš§é“ï¼ˆHTTSæ–¹å¼ï¼‰ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨TLSã€‚ä¹Ÿä¼šè¿›è¡Œå¿…è¦çš„TLSæ¡æ‰‹ã€‚\n   5. å‘é€è¯·æ±‚ï¼Œæ¥å—å“åº”ã€‚\n å¦‚æœè¿æ¥å‘ç”Ÿé”™è¯¯ï¼ŒOKHttpä¼šé€‰æ‹©å¦ä¸€ä¸ªè·¯ç”±é‡è¯•ã€‚è¿™æ ·OKHttpå°±å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯ä¸€äº›åœ°å€æ— æ³•è®¿é—®çš„æ—¶å€™æ¢å¤è®¿é—®ã€‚åŒæ—¶å¦‚æœè¿æ¥æ± çš„è¿æ¥å¤±æ•ˆæˆ–è€…å¸¸è¯†çš„TLS ç‰ˆæœ¬ä¸æ”¯æŒä¹Ÿå¾ˆæœ‰ç”¨ã€‚\n å½“å“åº”æ¥æ”¶åˆ°äº†ä¹‹åï¼Œè¿æ¥ä¼šæ”¾å›åˆ°è¿æ¥æ± ä»¥ä¾¿ä¹‹åä½¿ç”¨ã€‚è¿æ¥åœ¨ä¸€æ®µæ—¶é—´è¿‡æœŸåå›è¢«ç§»é™¤è¿æ¥æ± ã€‚\n\n","date":"2017-03-19"},{"title":"Go Web æ¶æ„","tags":["Go","Architecture","Translate","backend","Web"],"iso8601Date":"2015-11-11T03:01:21+08:00","basename":"Go-Web-æ¶æ„","body":"\n\n[åŸæ–‡åœ°å€](https://larry-price.com/blog/2015/06/25/architecture-for-a-golang-web-app)\n\nä½¿ç”¨Golangæ¥åˆ›å»ºWebé¡¹ç›®æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚å¦‚æœä½ ä½¿ç”¨Railsï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¸ä¼šæœ‰è¿™ä¸ªæ„Ÿè§¦ã€‚æˆ‘åœ¨[Refer Madness](https://www.refer-madness.com/)ä¸­ä½¿ç”¨äº†ä¸‹é¢è¿™ä¸ªæ¶æ„ã€‚\n\n```\n-public/\n-views/\n-models/\n-utils/\n-controllers/\n-web/\n-main.go\n```\n\næˆ‘å°†æ‰“ç ´è¿™ä¸ªä½“ç³»ï¼Œä»‹ç»å„ä¸ªç›®å½•çš„ä½œç”¨ã€‚åœ¨æ¯ä¸ªç›®å½•ä¸‹ï¼Œæ–‡ä»¶åªèƒ½è®¿é—®å…¶åŒçº§æˆ–è€…ä¸Šä¸€çº§ã€‚è¿™å°±æ„å‘³ç€`utils`åªèƒ½è®¿é—®ä»–è‡ªå·±å’Œ`models`ï¼Œ`web`åªèƒ½è®¿é—®å®ƒè‡ªå·±ï¼Œ`controllers`ï¼Œ`utils`ï¼Œ`models`ã€‚`models`åªèƒ½è®¿é—®å®ƒè‡ªå·±ã€‚æˆ‘è¿™ä¹ˆåšæ˜¯ä¸ºäº†è®©å±‚æ¬¡æ¸…æ™°ï¼Œé˜²æ­¢å‡ºç°é€’å½’ä¾èµ–ã€‚ç°åœ¨æ¥åˆ†ææ¯ä¸€ä¸ªç›®å½•ï¼Œæ–‡ä»¶çš„ä½œç”¨ã€‚\n\n#### main.go\n\n`main.go`æ˜¯åˆ›å»ºä¾èµ–ï¼Œè·å–ç¯å¢ƒå˜é‡ï¼Œå¯åŠ¨æœåŠ¡çš„ä¸»è¦æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å®ƒçš„å®ä¾‹ã€‚\n\n```Go\npackage main\n\nimport (\n  \"github.com/larryprice/refermadness/utils\"\n  \"github.com/larryprice/refermadness/web\"\n  \"github.com/stretchr/graceful\"\n  \"os\"\n)\n\nfunc main() {\n  isDevelopment := os.Getenv(\"ENVIRONMENT\") == \"development\"\n  dbURL := os.Getenv(\"MONGOLAB_URI\")\n  if isDevelopment {\n    dbURL = os.Getenv(\"DB_PORT_27017_TCP_ADDR\")\n  }\n\n  dbAccessor := utils.NewDatabaseAccessor(dbURL, os.Getenv(\"DATABASE_NAME\"), 0)\n  cuAccessor := utils.NewCurrentUserAccessor(1)\n  s := web.NewServer(*dbAccessor, *cuAccessor, os.Getenv(\"GOOGLE_OAUTH2_CLIENT_ID\"),\n    os.Getenv(\"GOOGLE_OAUTH2_CLIENT_SECRET\"), os.Getenv(\"SESSION_SECRET\"),\n    isDevelopment, os.Getenv(\"GOOGLE_ANALYTICS_KEY\"))\n\n  port := os.Getenv(\"PORT\")\n  if port == \"\" {\n    port = \"3000\"\n  }\n\n  graceful.Run(\":\"+port, 0, s)\n}\n\n```\n\nå› ä¸º`main.go`å®åœ¨æœ€ä½çš„å±‚çº§ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è®¿é—®æ‰€æœ‰çš„ç›®å½•ï¼šåœ¨è¿™ä¸ªä¾‹å­é‡Œæ˜¯`web`å’Œ`utils`ã€‚åœ¨è¿™é‡Œè·å–äº†æ‰€æœ‰çš„ç¯å¢ƒå˜é‡å¹¶æŠŠå®ƒä»¬æ³¨å…¥åˆ°åˆé€‚çš„åœ°æ–¹ã€‚åœ¨`main.go`ä¸­åˆ›å»ºäº†æœåŠ¡å™¨ï¼Œæ³¨å…¥ä¾èµ–ï¼Œå¹¶ä¸”åœ¨é…ç½®çš„ç«¯å£å¯åŠ¨æœåŠ¡å™¨ã€‚\n\n#### web\n\n`web`ç›®å½•ä¸‹æ˜¯ä¸»è¦çš„æœåŠ¡ä»£ç ï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬äº†ä¸­é—´ä»¶ä»£ç ã€‚ä¸‹é¢æ˜¯`web`ç›®å½•çš„å†…éƒ¨ç»“æ„ï¼š\n\n```\n-web/\n|-middleware/\n|-server.go\n```\n\n`server.go`åŒ…å«äº†web serverçš„å®šä¹‰ã€‚è¿™ä¸ªweb server åˆ›å»ºäº†æ‰€æœ‰çš„web controllerå¹¶ä¸”ç»™negroniæ·»åŠ äº†ä¸­é—´ä»¶ã€‚ä¸‹é¢æ˜¯ä»–çš„ä¾‹å­ï¼š\n\n```Go\npackage web\n\nimport (\n  \"github.com/codegangsta/negroni\"\n  \"github.com/goincremental/negroni-sessions\"\n  \"github.com/goincremental/negroni-sessions/cookiestore\"\n  \"github.com/gorilla/mux\"\n  \"github.com/larryprice/refermadness/controllers\"\n  \"github.com/larryprice/refermadness/utils\"\n  \"github.com/larryprice/refermadness/web/middleware\"\n  \"github.com/unrolled/secure\"\n  \"gopkg.in/unrolled/render.v1\"\n  \"html/template\"\n  \"net/http\"\n)\n\ntype Server struct {\n  *negroni.Negroni\n}\n\nfunc NewServer(dba utils.DatabaseAccessor, cua utils.CurrentUserAccessor, clientID, clientSecret,\n  sessionSecret string, isDevelopment bool, gaKey string) *Server {\n  s := Server{negroni.Classic()}\n  session := utils.NewSessionManager()\n  basePage := utils.NewBasePageCreator(cua, gaKey)\n  renderer := render.New()\n\n  router := mux.NewRouter()\n\n  // ...\n\n  accountController := controllers.NewAccountController(clientID, clientSecret, isDevelopment, session, dba, cua, basePage, renderer)\n  accountController.Register(router)\n\n  // ...\n\n  s.Use(sessions.Sessions(\"refermadness\", cookiestore.New([]byte(sessionSecret))))\n  s.Use(middleware.NewAuthenticator(dba, session, cua).Middleware())\n  s.UseHandler(router)\n  return &s\n}\n```\n\n`Server`ç»“æ„ä½“æ˜¯ä¸€ä¸ª`negroni.Negroni`çš„web serverï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œæœ‰å¯¹`utils`å’Œå…¶ä»–ç¬¬ä¸‰æ–¹åŒ…çš„å¼•ç”¨ï¼Œåˆ›å»ºäº†ä¸€ä¸ªrouterï¼Œä¸€äº›controllerï¼Œå¹¶ä¸”å°†controlleræ³¨å†Œåˆ°å½“å‰routerã€‚åŒæ—¶ä¹Ÿå¼•å…¥äº†å¿…è¦çš„ä¸­é—´ä»¶ã€‚è¯´åˆ°ä¸­é—´ä»¶ï¼Œä¸‹é¢æ˜¯å®ƒçš„ä»£ç ï¼š\n\n```Go\npackage middleware\n\nimport (\n  \"github.com/codegangsta/negroni\"\n  \"github.com/larryprice/refermadness/utils\"\n  \"net/http\"\n)\n\ntype Database struct {\n  da utils.DatabaseAccessor\n}\n\nfunc NewDatabase(da utils.DatabaseAccessor) *Database {\n  return &Database{da}\n}\n\nfunc (d *Database) Middleware() negroni.HandlerFunc {\n  return func(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc) {\n    reqSession := d.da.Clone()\n    defer reqSession.Close()\n    d.da.Set(r, reqSession)\n    next(rw, r)\n  }\n}\n```\n\nè¿™ä¸ªæ˜¯é€šè¿‡HTTP routerè®¿é—®æ•°æ®åº“sessionçš„æ ‡æ³¨ä¸­é—´ä»¶ã€‚åŸºæœ¬æ–‡ä»¶æ˜¯ä»[Brian Gesiakâ€™s blog post on RESTful Go](http://modocache.svbtle.com/restful-go)ä¸­å¾—åˆ°ï¼Œå°†å…¶ä¿®æ”¹ä¸ºé€‚åˆæˆ‘çš„æ–‡ä»¶ã€‚\n\n#### controllers/\n\nè¿™é‡Œçš„controllerä¸Railsé‡Œçš„controllerçš„æ¦‚å¿µå¾ˆåƒã€‚Controlleræ³¨å†Œè‡ªå·±çš„routerï¼Œè®¾ç½®è‡ªå·±çš„å‡½æ•°è°ƒç”¨ã€‚ä¸€ä¸ªç®€çŸ­çš„ä¾‹å­å¦‚ä¸‹ï¼š\n\n```Go\npackage controllers\n\nimport (\n  \"encoding/json\"\n  \"errors\"\n  \"github.com/gorilla/mux\"\n  \"github.com/larryprice/refermadness/models\"\n  \"github.com/larryprice/refermadness/utils\"\n  \"gopkg.in/mgo.v2/bson\"\n  \"gopkg.in/unrolled/render.v1\"\n  \"html/template\"\n  \"net/http\"\n  \"strings\"\n)\n\ntype ServiceControllerImpl struct {\n  currentUser utils.CurrentUserAccessor\n  basePage    utils.BasePageCreator\n  renderer    *render.Render\n  database    utils.DatabaseAccessor\n}\n\nfunc NewServiceController(currentUser utils.CurrentUserAccessor, basePage utils.BasePageCreator,\n  renderer *render.Render, database utils.DatabaseAccessor) *ServiceControllerImpl {\n  return &ServiceControllerImpl{\n    currentUser: currentUser,\n    basePage:    basePage,\n    renderer:    renderer,\n    database:    database,\n  }\n}\n\nfunc (sc *ServiceControllerImpl) Register(router *mux.Router) {\n  router.HandleFunc(\"/service/{id}\", sc.single)\n  // ...\n}\n\n// ...\n\ntype serviceResult struct {\n  *models.Service\n  RandomCode *models.ReferralCode\n  UserCode   *models.ReferralCode\n}\n\ntype servicePage struct {\n  utils.BasePage\n  ResultString string\n}\n\nfunc (sc *ServiceControllerImpl) single(w http.ResponseWriter, r *http.Request) {\n  data, err := sc.get(w, r)\n\n  if len(r.Header[\"Content-Type\"]) == 1 && strings.Contains(r.Header[\"Content-Type\"][0], \"application/json\") {\n    if err != nil {\n      sc.renderer.JSON(w, http.StatusBadRequest, map[string]string{\n        \"error\": err.Error(),\n      })\n      return\n    }\n    sc.renderer.JSON(w, http.StatusOK, data)\n    return\n  } else if err != nil {\n    http.Error(w, err.Error(), http.StatusBadRequest)\n  }\n\n  resultString, _ := json.Marshal(data)\n  t, _ := template.ParseFiles(\"views/layout.html\", \"views/service.html\")\n  t.Execute(w, servicePage{sc.basePage.Get(r), string(resultString)})\n}\n```\n\n#### utils/\n\nåœ¨`utils`ç›®å½•ä¸‹çš„æ–‡ä»¶æä¾›äº†ä¸€äº›åº•å±‚åŠŸèƒ½ç”¨æ¥æ”¯æŒå…¶ä»–çš„ä»£ç ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸»è¦æ˜¯å®šä¹‰ä¸€ä¸ªç»“æ„ä½“æ¥è®¿é—®è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œå¤„ç†sessionï¼Œå®šä¹‰ä¸€ä¸ªç‰¹åˆ«çš„é¡µé¢æ¥ç»§æ‰¿ã€‚ä¸‹é¢æ˜¯é€šè¿‡è®¿é—®ä¸Šä¸‹æ–‡è®¾ç½®ç”¨æˆ·çš„ä¾‹å­ï¼š\n\n```Go\npackage utils\n\nimport (\n  \"github.com/gorilla/context\"\n  \"github.com/larryprice/refermadness/models\"\n  \"net/http\"\n)\n\ntype CurrentUserAccessor struct {\n  key int\n}\n\nfunc NewCurrentUserAccessor(key int) *CurrentUserAccessor {\n  return &CurrentUserAccessor{key}\n}\n\nfunc (cua *CurrentUserAccessor) Set(r *http.Request, user *models.User) {\n  context.Set(r, cua.key, user)\n}\n\nfunc (cua *CurrentUserAccessor) Clear(r *http.Request) {\n  context.Delete(r, cua.key)\n}\n\nfunc (cua *CurrentUserAccessor) Get(r *http.Request) *models.User {\n  if rv := context.Get(r, cua.key); rv != nil {\n    return rv.(*models.User)\n  }\n  return nil\n}\n```\n\n#### models/\n\nmodel æ˜¯ä¸ºäº†æè¿°æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ•°æ®ç»“æ„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨modelæ¥è®¿é—®æ•°æ®åº“ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„modelï¼Œç„¶åé€šè¿‡æŸ¥è¯¢æ•°æ®åº“ä¸ºå…¶èµ‹å€¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š\n\n```Go\npackage models\n\nimport (\n  \"gopkg.in/mgo.v2\"\n  \"gopkg.in/mgo.v2/bson\"\n  \"strings\"\n  \"time\"\n)\n\ntype Service struct {\n  // identification information\n  ID          bson.ObjectId `bson:\"_id\"`\n  Name        string        `bson:\"name\"`\n  Description string        `bson:\"description\"`\n  URL         string        `bson:\"url\"`\n  Search      string        `bson:\"search\"`\n}\n\nfunc NewService(name, description, url string, creatorID bson.ObjectId) *Service {\n  url = strings.TrimPrefix(strings.TrimPrefix(url, \"http://\"), \"https://\")\n  return &Service{\n    ID:            bson.NewObjectId(),\n    Name:          name,\n    URL:           url,\n    Description:   description,\n    Search:        strings.ToLower(name) + \";\" + strings.ToLower(description) + \";\" + strings.ToLower(url),\n  }\n}\n\nfunc (s *Service) Save(db *mgo.Database) error {\n  _, err := s.coll(db).UpsertId(s.ID, s)\n  return err\n}\n\nfunc (s *Service) FindByID(id bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).FindId(id).One(s)\n}\n\nfunc (*Service) coll(db *mgo.Database) *mgo.Collection {\n  return db.C(\"service\")\n}\n\ntype Services []Service\n\nfunc (s *Services) FindByIDs(ids []bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).Find(bson.M{\"_id\": bson.M{\"$in\": ids}}).Sort(\"name\").All(s)\n}\n\nfunc (*Services) coll(db *mgo.Database) *mgo.Collection {\n  return db.C(\"service\")\n}\n\n```\n\n#### views/\n\nå°†Golangçš„æ¨¡æ¿æ–‡ä»¶æ”¾åˆ°`views`ç›®å½•ä¸‹ã€‚è¿™æ ·ï¼Œä¸ç®¡ç”¨ä»€ä¹ˆæ ·çš„æ¨¡æ¿å¼•æ“éƒ½å¯ä»¥ç›´æ¥æ”¾åˆ°`views`ä¸‹ã€‚\n\n#### public/\n\nè·Ÿä»¥å‰ä¸€æ ·ï¼Œè¿™ä¸ªæ–‡ä»¶éƒ½æ˜¯æ”¾å…¬å¼€çš„æ–‡ä»¶çš„ï¼Œä¾‹å¦‚`css`,`img`,`scripts`ã€‚\n\n#### å¦‚ä½•è¿è¡Œ\n\næ¯«æ— ç–‘é—®ï¼Œæˆ‘æœ€å–œæ¬¢çš„å°±æ˜¯[docker](https://www.docker.com/)ï¼Œå› æ­¤æˆ‘å°†ä½¿ç”¨ä»–æ¥è¿è¡Œè¿™ä¸ªåº”ç”¨ã€‚å¦‚æœä¸ä½¿ç”¨dockerï¼Œé‚£ä¹ˆå¯ä»¥å°†æ–‡ä»¶æ”¾åˆ°`$GOPATH/src/github.com/larryprice/refermadness`,è¿è¡Œ`go get`æ¥è·å–æ‰€æœ‰çš„ä¾èµ–ï¼Œç„¶åè¿è¡Œ `go run main.go`æˆ–è€…`go build; ./refermadness`è¿è¡Œç¨‹åºã€‚å¦‚æœä½ ä¹Ÿå–œæ¬¢ä½¿ç”¨dockerï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥é€šè¿‡`Dockerfile`æ¥è¿è¡Œã€‚\n\n```\nFROM golang:1.4\n\nRUN go get github.com/codegangsta/gin\n\nADD . /go/src/github.com/larryprice/refermadness\nWORKDIR /go/src/github.com/larryprice/refermadness\nRUN go get\n```\n\nåŒæ—¶æˆ‘ä¹Ÿå¾ˆå–œæ¬¢[compose](https://github.com/docker/compose)ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿé€šè¿‡compose æ–‡ä»¶æ¥è¿è¡Œæ‰€æœ‰çš„åº”ç”¨ã€‚æˆ‘ç”¨äº†JSC ï¼ŒSASSå’Œmongodbï¼Œæ‰€ä»¥ä¸€ä¸‹æ˜¯æˆ‘çš„`docker-compose.yml`æ–‡ä»¶ã€‚\n\n```Go\nmain:\n  build: .\n  command: gin run\n  env_file: .env\n  volumes:\n    - ./:/go/src/github.com/larryprice/refermadness\n  working_dir: /go/src/github.com/larryprice/refermadness\n  ports:\n    - \"3000:3000\"\n  links:\n    - db\nsass:\n  image: larryprice/sass\n  volumes:\n    - ./public/css:/src\njsx:\n  image: larryprice/jsx\n  volumes:\n    - ./public/scripts:/src\ndb:\n  image: mongo:3.0\n  command: mongod --smallfiles --quiet --logpath=/dev/null\n  volumes_from:\n    - dbvolume\ndbvolume:\n  image: busybox:ubuntu-14.04\n  volumes:\n    - /data/db\n```\n\nç„¶åè¿è¡Œ`docker-compose up`æ¥è¿è¡Œæ‰€æœ‰çš„å®¹å™¨å¹¶å¯åŠ¨æœåŠ¡å™¨ã€‚\n\n\n","date":"2015-11-11"},{"title":"Ansible å…¥é—¨æŒ‡å—","tags":["Ansible","Translate","backend"],"iso8601Date":"2015-11-10T02:26:35+08:00","basename":"Ansible-å…¥é—¨æŒ‡å—","body":"\n\n[åŸæ–‡åœ°å€](http://docs.ansible.com/ansible/intro_getting_started.html)\n\n## å¿«é€Ÿå…¥é—¨\n\n### å‰è¨€\n\n ç°åœ¨ä½ å·²ç»çŸ¥é“å¦‚ä½•[å®‰è£…](http://docs.ansible.com/ansible/intro_installation.html)Ansibleäº†ï¼Œç°åœ¨å¯ä»¥æ·±å…¥å¹¶å¼€å§‹ä½¿ç”¨Ansibleçš„ä¸€äº›å‘½ä»¤äº†ã€‚\n æˆ‘ä»¬å¼€å§‹å±•ç¤ºçš„å¹¶ä¸æ˜¯Ansibleå¼ºå¤§çš„é…ç½®ã€éƒ¨ç½²ã€è°ƒåº¦çš„åŠŸèƒ½ã€‚è¿™äº›åŠŸèƒ½ç”±å…¶ä»–ç« èŠ‚è¦è®²çš„Playbookæ¥å¤„ç†ã€‚\n è¿™ä¸ªç« èŠ‚æ˜¯å…³äºå¦‚ä½•å¿«é€Ÿå…¥é—¨çš„ã€‚ç­‰ä½ äº†è§£äº†Ansibleçš„è¿™äº›æ¦‚å¿µä¹‹åï¼Œå°±å¯ä»¥é˜…è¯»[ç‰¹åˆ«å‘½ä»¤ç®€ä»‹](http://docs.ansible.com/ansible/intro_adhoc.html)æ¥å­¦ä¹ æ›´å¤šç»†èŠ‚ï¼Œæ¥ç€ä½ å°±å¯ä»¥æ·±å…¥ç†è§£Playbookï¼Œå¹¶ä¸”æµè§ˆæ›´å¤šçš„æœ‰è¶£åŠŸèƒ½ã€‚\n\n### è¿œç¨‹è¿æ¥ä¿¡æ¯\n\n åœ¨æˆ‘ä»¬å¼€å§‹å­¦ä¹ ä¹‹å‰ï¼Œç†è§£Ansibleæ˜¯å¦‚ä½•é€šè¿‡SSHè¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨æ˜¯å¾ˆé‡è¦çš„ã€‚\n é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå¯ä»¥ï¼ŒAnsible 1.3 åŠå…¶åç»­ç‰ˆæœ¬ä¼šä½¿ç”¨åŸç”Ÿçš„OpenSShæ¥è¿æ¥è¿œç¨‹æœåŠ¡å™¨ã€‚è¿™æ ·å°±å¯ä»¥åœ¨~/.ssh/configä¸‹å¼€å¯ControPersist(ä¸€ä¸ªé«˜æ€§èƒ½çš„åŠŸèƒ½),Kerboså’Œå…¶ä»–é€‰é¡¹ï¼Œä¾‹å¦‚è·³æ¿æœºè®¾ç½®ã€‚ç„¶åï¼Œå¦‚æœä½¿ç”¨äº†Enterprise Linux 6(Red Hat Enterprise Linux å’Œå…¶è¡ç”Ÿç‰ˆæœ¬ï¼Œä¾‹å¦‚CentOS) ç³»ç»Ÿä½œä¸ºæ§åˆ¶æœºï¼ŒOpenSSHçš„ç‰ˆæœ¬å¯èƒ½è¿‡ä½å¯¼è‡´æ— æ³•å¼€å¯ControlPersiståŠŸèƒ½ã€‚åœ¨è¿™äº›æ“ä½œç³»ç»Ÿä¸­ï¼ŒAnsibleå°†ä¼šå›é€€åˆ°ä½¿ç”¨â€œparamikoâ€ï¼Œä»–æ˜¯OpenSSHçš„ä¸€ä¸ªé«˜è´¨é‡çš„Pythonå®ç°ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨åƒKerberized SSH ç­‰è¿™æ ·çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨Federaï¼ŒOSXæˆ–è€…Ubuntuä½œä¸ºä½ çš„æ§åˆ¶æœºï¼Œç›´åˆ°ä½ ä½¿ç”¨çš„å¹³å°æœ‰äº†æ›´æ–°çš„OpenSSHï¼Œæˆ–è€…ä½ å¯ä»¥å¼€å¯åŠ é€ŸåŠŸèƒ½ã€‚[åŠ é€ŸåŠŸèƒ½](http://docs.ansible.com/ansible/playbooks_acceleration.html)ã€‚\n å¦‚æœä½¿ç”¨çš„ç‰ˆæœ¬å°äºç­‰äº1.2ï¼Œé‚£ä¹ˆé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯paramikoï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨åŸç”Ÿçš„SSHï¼Œé‚£ä¹ˆéœ€è¦åŠ ä¸Š-c ssh é€‰é¡¹æˆ–è€…å†é…ç½®æ–‡ä»¶ä¸­é…ç½®ã€‚\n å¯èƒ½å¶å°”åœ¨æŸäº›æœºå™¨ä¸Šä¸æ”¯æŒSFTPåè®®ï¼Œè™½ç„¶è¿™ç§æƒ…å†µå¾ˆå°‘ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½å‘ç”Ÿï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨[é…ç½®æ–‡ä»¶](http://docs.ansible.com/ansible/intro_configuration.html)ä¸­åˆ‡æ¢åˆ°SCPæ¨¡å¼ã€‚\n å½“éœ€è¦å’Œè¿œç¨‹ä¸»æœºä¼šè¯æ˜¯ï¼ŒAnsibleé»˜è®¤å‡è®¾ä½ ä½¿ç”¨SSH keysã€‚Ansibleé¼“åŠ±ä½¿ç”¨SSH å…å¯†ç ç™»é™†ï¼Œä½†æ˜¯ä½¿ç”¨å¯†ç ç™»é™†ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™åŠ ä¸Šå‚æ•°`--ask-pass`ã€‚å¦‚æœéœ€è¦ä½¿ç”¨sudoæƒé™ï¼Œé‚£ä¹ˆä¹Ÿè¦æä¾›`--ask-sudo-pass`å‚æ•°ã€‚\n ä»»ä½•ç®¡ç†ç³»ç»Ÿè¿è¡Œæ—¶ç¦»è¢«ç®¡ç†çš„ç³»ç»Ÿè¶Šè¿‘è¶Šå¥½ã€‚è™½ç„¶è¿™æ˜¯ä¸ªå¸¸è¯†ï¼Œä½†æ˜¯è¿˜æ˜¯å€¼å¾—åˆ†äº«çš„ã€‚å¦‚æœä½ åœ¨äº‘ç«¯ä½¿ç”¨Ansibleï¼Œé‚£ä¹ˆå°±æŠŠAnsibleè¿è¡Œåœ¨äº‘ç«¯ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒéƒ½æ¯”ç›´æ¥åœ¨å…¬å…±ç½‘ç»œä¸Šè¿è¡Œæ›´å¥½ã€‚\n ä½œä¸ºä¸€ä¸ªé«˜çº§è¯é¢˜ï¼ŒAnsibleå¹¶ä¸ä»…ä»…é€šè¿‡SSHè¿æ¥ä¸»æœºã€‚è¿æ¥ç³»ç»Ÿæ˜¯å¯æ’æ‹”çš„ï¼Œæœ‰å¾ˆå¤šé…ç½®é€‰é¡¹å¯ä»¥ç”¨æ¥æœ¬åœ°ç®¡ç†ï¼Œä¾‹å¦‚ç®¡ç†chrootï¼Œlxcï¼Œjail containerã€‚ä¸€ä¸ªå«åšâ€œAnsible-pullâ€çš„æ¨¡å¼å¯ä»¥åè½¬ç³»ç»Ÿã€‚é€šè¿‡é…ç½®å¥½çš„git checkout ä»ä¸­å¤®å­˜å‚¨åº“pullé…ç½®æ–‡ä»¶è·å–ç³»ç»Ÿçš„â€œphone homeâ€ã€‚\n\n### ç¬¬ä¸€ä¸ªå‘½ä»¤\n\n ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»å®‰è£…å¥½Ansibleäº†ï¼Œç°åœ¨å¯ä»¥å¼€å§‹è¿è¡Œä¸€äº›ç®€å•çš„å‘½ä»¤äº†ã€‚\n ç¼–è¾‘ï¼ˆæˆ–è€…åˆ›å»ºï¼‰`/etc/ansible/hosts`æ–‡ä»¶ï¼Œå‘å…¶æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¿œç¨‹ä¸»æœºåœ°å€ã€‚æœ¬æœºçš„public ssh key åº”è¯¥å·²ç»è¿½åŠ åˆ°è¿œç¨‹ä¸»æœºçš„`authorized_keys`æ–‡ä»¶ä¸­ã€‚\n\n```\n192.168.1.50\naserver.example.org\nbserver.example.org\n```\n\n è¿™æ˜¯ä¸€ä¸ªæ¸…å•æ–‡ä»¶ï¼ŒåŒæ ·ä¼šå†[ä¸»æœºæ¸…å•](http://docs.ansible.com/ansible/intro_inventory.html)ä¸­ä»‹ç»ã€‚\n å‡è®¾ä½ ä½¿ç”¨çš„æ˜¯SSHæˆæƒæ–¹å¼ï¼Œè®¾ç½®ssh angent é˜²æ­¢é‡å¤è¾“å…¥å¯†ç ã€‚\n\n```\nssh-agent bash\nssh-add ~/.ssh/id_rsa\n```\n\n(æ ¹æ®ä½ çš„è®¾ç½®ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨`--private-key`é€‰é¡¹æ¥åˆ¶å®šä¸€ä¸ªpemæ–‡ä»¶)\n ç°åœ¨å¯ä»¥pingä¸€ä¸‹æ‰€æœ‰çš„ä¸»æœºäº†ã€‚\n\n```\nansible all -m ping\n```\n\n Ansibleä¼šæƒ³SSHé‚£æ ·ä½¿ç”¨ä½ æœ¬æœºçš„ç”¨æˆ·åå»è¿æ¥è¿œç¨‹æœºå™¨ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨æœ¬æœºç”¨æˆ·åï¼Œå¯ä»¥åŠ ä¸Š`-u`çš„é€‰é¡¹ã€‚\n å¦‚æœä½ æƒ³ä½¿ç”¨sudoæƒé™ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥å°†ä¸Š`--sudo`é€‰é¡¹ã€‚\n\n```\n# as bruce\n$ ansible all -m ping -u bruce\n# as bruce sudoing to root\n$ ansible all -m ping -u bruce --sudo\n# as bruce, sudoing to batman\n$ ansible all -m ping -u bruce --sudo --sudo-user batman\n\n# With latest version of ansible `sudo` is deprecated so use become\n# as bruce, sudoing to root\n$ ansible all -m ping -u bruce -b\n# as bruce, sudoing to batman\n$ ansible all -m ping -u bruce -b --become-user batman\n```\n\n(å¦‚æœä½ çªç„¶æƒ³æ”¹å˜sudo ç”¨æˆ·ï¼Œå¯ä»¥å†é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ã€‚ä¼ é€’ç»™sudoçš„æ ‡è®°ä¾‹å¦‚-Hä¹Ÿå¯ä»¥åœ¨é‚£ä¿®æ”¹ã€‚)\n\n ç°åœ¨åœ¨ä½ æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªå®æ—¶çš„å‘½ä»¤ã€‚\n\n```\n$ ansible all -a \"/bin/echo hello\"\n```\n\n å¤ªæ£’äº†ï¼Œåˆšåˆšé€šè¿‡Ansibleä¸è¿œç¨‹ä¸»æœºä¼šè¯äº†ã€‚å¾ˆå¿«å°±å¯ä»¥é˜…è¯»[æ›´å¤šå‘½ä»¤ä»‹ç»](http://docs.ansible.com/ansible/intro_adhoc.html)æ¥å­¦ä¹ æ›´å¤šçš„å®é™…ä¾‹å­ï¼Œæµè§ˆå„ä¸ªæ¨¡å—éƒ½å¯ä»¥åšä»€ä¹ˆï¼Œä»¥åŠå­¦ä¹ Ansible [Playbooks](http://docs.ansible.com/ansible/playbooks.html)çš„è¯­æ³•ã€‚Ansibleä¸ä»…ä»…åªèƒ½ç”¨æ¥è¿è¡Œå‘½ä»¤ï¼Œä»–è¿˜æœ‰å¼ºå¤§çš„é…ç½®ç®¡ç†ç³»ç»Ÿå’Œéƒ¨ç½²åŠŸèƒ½ã€‚è¿˜æœ‰è®¸å¤šéœ€è¦å­¦ä¹ çš„çŸ¥è¯†ï¼Œä½†æ˜¯ä½ ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªå®Œå…¨å¯ä»¥è¿è¡Œçš„ç¯å¢ƒäº†ã€‚\n\n### ä¸»æœºå¯†é’¥æ£€æŸ¥\n\n Ansible 1.2.1 åŠå…¶ä¹‹åçš„ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯æœ‰ä¸»æœºå¯†é’¥æ£€æŸ¥åŠŸèƒ½çš„ã€‚\n å¦‚æœè¿œç¨‹ä¸»æœºæˆæ–°å®‰è£…å¹¶ä¸”åœ¨`know_hosts`ä¸‹æœ‰ä¸€ä¸ªä¸åŒçš„keyï¼Œç›´åˆ°ä¿®å¤ä¹‹å‰ï¼ŒAnsibleä¼šä¸€ç›´è¿”å›é”™è¯¯ã€‚å¦‚æœä¸»æœºæ²¡æœ‰åœ¨`know_hosts`æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆä¼šå‡ºç°æç¤ºæ¥ç¡®è®¤å¯†é’¥ã€‚è¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªä½ ä¸å¸Œæœ›çš„æç¤ºã€‚\n&emps; å¦‚æœä½ çŸ¥é“è¿™ä¸ªåŠŸèƒ½çš„å½±å“ï¼Œå¹¶ä¸”å¸Œæœ›å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥ä¿®æ”¹`/etc/ansible/ansible.cfg`æˆ–è€…æ˜¯`~/.ansible.cfg`æ¥å…³é—­è¿™ä¸ªåŠŸèƒ½ã€‚\n\n```\n[default]\nhost_key_checking = False\n```\n\n åŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¥ä¿®æ”¹ã€‚\n\n```\n$ export ANSIBLE_HOST_KEY_CHECKING=False\n```\n\n åŒæ—¶è¦æ³¨æ„ä¸»æœºå¯†é’¥æ£€æŸ¥å†paramikoæ¨¡å¼ä¸­æ˜¯å¾ˆæ…¢çš„ï¼Œæ‰€ä»¥å¦‚æœè¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æœ€å¥½ä½¿ç”¨sshæ¨¡å¼ã€‚\n é™¤éAnsibleçš„ä»»åŠ¡è¢«æ ‡è®°ä¸º\"no_log:True\"ï¼Œå¦åˆ™Ansibleä¼šå†è¿œç¨‹æ³¨æ„çš„syslogä¸­è®°å½•ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚è¿™ä¸ªç¨åå†åšè§£é‡Šã€‚\n å¦‚æœè¦å†æœ¬æœºå¼€å¯logå¯ä»¥æŸ¥çœ‹[é…ç½®ç« èŠ‚](http://docs.ansible.com/ansible/intro_configuration.html)æ¥è®¾ç½®â€œlog_pathâ€å¼€å¯ã€‚ä¼ä¸šç”¨æˆ·å¯èƒ½ä¼šå¯¹[Ansible Tower](http://docs.ansible.com/ansible/tower.html)ã€‚Toweræä¾›äº†ä¸€ä¸ªå¥å£®çš„æ•°æ®åº“è®°å½•æ—¥å¿—çš„åŠŸèƒ½ï¼Œè¿™æ ·å°±å¯ä»¥éšæ—¶é€šè¿‡å›¾å½¢ç•Œé¢æˆ–è€…REST API æ¥æŸ¥çœ‹ä¸»æœºï¼Œé¡¹ç›®ï¼Œç‰¹æ®Šçš„åˆ—è¡¨çš„æ—¥å¿—ã€‚\n","date":"2015-11-10"},{"title":"Vagrant & Ansible å¿«é€Ÿå…¥é—¨æ•™ç¨‹","tags":["Ansible","Translate","Vagrant","backend"],"iso8601Date":"2015-11-08T08:39:10+08:00","basename":"Vagrant-Ansible-å¿«é€Ÿå…¥é—¨æ•™ç¨‹","body":"\n\n[åŸæ–‡åœ°å€](https://adamcod.es/2014/09/23/vagrant-ansible-quickstart-tutorial.html)  \n\nå°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘ç”¨è¿‡Chefï¼ŒPuppetï¼Œç®€å•çš„Bashè„šæœ¬ç­‰ç”¨æ¥é…ç½®æœåŠ¡å™¨ï¼Œå…¶ä»–æœåŠ¡å’ŒVagrant Boxesã€‚è™½ç„¶Chefç¤¾åŒºä»ç„¶åœ¨å¿«é€Ÿæˆé•¿ï¼Œä½†æ˜¯æˆ‘å‘å¸ƒçš„å…³äº[Chef](https://adamcod.es/2013/01/15/vagrant-is-easy-chef-is-hard-part2.html)çš„æ–‡ç« ä»ç„¶æ˜¯æœ€å—æ¬¢è¿çš„æ–‡ç« ã€‚ç„¶è€Œï¼Œä¸¤ä¸ªæœˆä¹‹å‰ï¼Œå½“æˆ‘åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨Ansibleçš„æ—¶å€™æ‰€æœ‰çš„äº‹æƒ…éƒ½å˜äº†ã€‚ä»æ­¤ä¹‹åæˆ‘å†ä¹Ÿæ²¡ç”¨è¿‡å…¶ä»–çš„é…ç½®å·¥å…·ï¼Œä¹Ÿæ‰¾ä¸åˆ°ç”¨å…¶ä»–å·¥å…·çš„ç†ç”±äº†ã€‚  \n\nçœ‹è¿‡äº†ä¸å°‘å…³äºAnsibleçš„æ•™ç¨‹ï¼Œå°è¯•è¿™ä»ä¸­æ‰¾å‡ºç›¸åº”çš„æ¨¡å¼å’Œæœ€ä½³å®æˆ˜ï¼Œç„¶è€Œä¼¼ä¹åœ¨çŸ¥è¯†ä¸Šæœ‰å·¨å¤§çš„æ¨ªæ²Ÿã€‚ä½ å¯ä»¥ç”¨Ansibleåšå¾ˆå¤šäº‹æƒ…ï¼Œä½ ä¹Ÿå¯ä»¥åŒæ—¶å­¦ä¹ å¦‚ä½•ä½¿ç”¨ï¼Œä½†æ˜¯è·Ÿæˆ‘æœ€æ–°å­¦ä¹ çš„å·¥å…·ä¸€æ ·ï¼Œå´åä¸€ä¸ªå¾ˆç®€å•åœ°æ–¹å…¥æ‰‹å­¦ä¹ çš„åœ°æ–¹ã€‚ä»Šå¤©æˆ‘å¸Œæœ›é€šè¿‡ä½¿ç”¨Vagrantå’ŒAnsibleé…ç½®ä¸€ä¸ªLAMPçš„æŠ€æœ¯æ ˆæ¥çº æ­£ä»–ã€‚  \n\n## ä¸ºä»€ä¹ˆä½¿ç”¨Ansible\n\nAnsibleå’Œå…¶ä»–çš„é…ç½®ç®¡ç†å·¥å…·æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯Ansibleæ˜¯åŸºäºSSHçš„ã€‚Chefå’ŒPuppetéƒ½æ˜¯æœ‰ä¾èµ–çš„ï¼Œè€Œä¸”å¿…é¡»åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¹‹åæ‰èƒ½ä½¿ç”¨ï¼Œè€ŒAnsibleåˆ™ä¸éœ€è¦ã€‚å®ƒå¯ä»¥åœ¨ä½ æœ¬æœºè¿è¡Œï¼Œä½¿ç”¨SSHè¿æ¥ç›¸åº”ä¸»æœºï¼Œåœ¨å…¶è¿è¡Œç›¸åº”å‘½ä»¤ã€‚  \n\nä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨Bashè„šæœ¬å‘¢ï¼ŸAnsibleä¹‹æ‰€ä»¥æ¯”Bashè„šæœ¬å¥½æ˜¯å› ä¸ºä»–ç®€å•ã€‚Ansibleåªæ˜¯è¿è¡Œäº†ä¸€ç³»åˆ—ä½¿ç”¨YAMLæ ¼å¼ç¼–å†™çš„ä»»åŠ¡ã€‚åŒæ ·Ansibleè¿˜å…·æœ‰å¹‚ç­‰æ€§ï¼Œè¿™å°±æ„å‘³ç€ä½ å¯ä»¥å¤šæ¬¡è¿è¡ŒåŒæ ·çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è¿™äº›ä»»åŠ¡çš„è¾“å…¥ä¼šä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚é™¤éæ˜ç¡®è¦æ±‚è¿è¡Œä¸¤æ¬¡å¦åˆ™å®ƒä¸ä¼šå¯¹åŒä¸€ä¸ªä»»åŠ¡è¿è¡Œä¸¤æ¬¡ï¼‰ã€‚åŒæ ·è¿™ä¸ªå¯ä»¥é€šè¿‡Bashè„šæœ¬ç¼–å†™ï¼Œä½†æ˜¯ä¼šå¾ˆå¤æ‚ã€‚\n\n## Ansible å’Œ Vagrant\n\né¦–å…ˆç»™ä½ è¦ç¡®å®šå·²ç»å®‰è£…äº†Ansibleå’ŒVagrantã€‚å®ƒä»¬çš„å®‰è£…æ–‡æ¡£å¯ä»¥åœ¨å®ƒä»¬çš„ç›¸å…³ç½‘ç«™æ‰¾åˆ°ï¼Œå®ƒä»¬éƒ½å¾ˆå®¹æ˜“å®‰è£…çš„ã€‚\n\n## åŸºç¡€\n\næˆ‘ä»¬å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹æ¥å¼€å§‹æˆ‘ä»¬çš„é¡¹ç›®ã€‚\n\n```bash\nmkdir -p ~/Projects/vagrant-ansible\ncd ~/Projects/vagrant-ansible\n```\n\næ¥ç€æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºäºæœ€æ–°çš„Ubuntuçš„Vagrantfileã€‚\n\n```bash\nvagrant init ubuntu/trusty64\n```\n\nè¿è¡Œå®Œè¿™ä¸ªå‘½ä»¤ååœ¨é¡¹ç›®ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ªå«`Vagrantfile`çš„æ–‡ä»¶ã€‚å®ƒåŒ…å«äº†ä½ æƒ³è¦é…ç½®çš„å…³äºboxçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯å’Œä¸€å †ä½ ç°åœ¨ä¸éœ€è¦ç®¡çš„æ³¨é‡Šã€‚åˆ é™¤æ‰€æœ‰çš„æ³¨é‡Šï¼Œä½ å°±ä¼šç®€å•çš„å¾—åˆ°ä»¥ä¸‹çš„ä»£ç ï¼š\n\n```bash\nVAGRANTFILE_API_VERSION = \"2\"\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\n  config.vm.box = \"ubuntu/trusty64\"\nend\n```\n\næˆ‘ä»¬éœ€è¦åœ¨ä»–é…ç½®å¥½çš„é€‚åˆè®¿é—®æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä¼šå§Vagrantçš„80ç«¯å£è½¬å‘åˆ°æœ¬æœºçš„8080ç«¯å£ï¼Œå°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`end`ä¹‹å‰ã€‚\n\n```bash\nconfig.vm.network \"forworded_port\", guest: 80, host:8080\n```\n\nç°åœ¨Vagrantåªéœ€è¦é…ç½®ä¸€ä»¶äº‹æƒ…ã€‚æˆ‘ä»¬éœ€è¦é…ç½®Vagrantä½¿ç”¨Ansibleä½œä¸ºé…ç½®å™¨ï¼Œå¹¶ä¸”çŸ¥é“å»å“ªé‡Œéœ€æ‰¾è¿™äº›å‘½ä»¤ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬å°†ä¸€ä¸‹ä»£ç åŠ åˆ°`Vagrantfile`çš„`end`ä¹‹å‰ã€‚\n\n```bash\nconfig.vm.provision :ansible do |ansible|\n  ansible.playbook = \"playbook.yml\"\nend\n```\n\nä»¥ä¸Šæ‰€æœ‰çš„ä»»åŠ¡å®Œæˆä¹‹åä½ çš„`Vagrantfile`å°†ä¼šæ˜¯ä¸€ä¸‹çš„é…ç½®ã€‚  \n\n```bash\nVAGRANTFILE_API_VERSION = \"2\"\n\nVagrant.configure(VAGRANTFILE_API_VERSION) do |config|\n  config.vm.box = \"ubuntu/trusty64\"\n\n  config.vm.network \"forwarded_port\", guest: 80, host: 8080\n\n  config.vm.provision :ansible do |ansible|\n    ansible.playbook = \"playbook.yml\"\n  end\nend\n```\n\n## åŸºæœ¬æœ¯è¯­\n\nAnsibleå†ä½ çš„æœåŠ¡å™¨ä¸Šè¿è¡Œä¸€ç³»åˆ—çš„*Tasks*ã€‚æŠŠTaskæƒ³è±¡æˆä¸€ä¸ªå•ä¸€çš„Bashå‘½ä»¤ã€‚æ¥ç€æ˜¯*playbook*ï¼ŒAnsibleé€šè¿‡Playbookå¾—çŸ¥å°†å†æœåŠ¡å™¨ä¸Šè¿è¡Œä»€ä¹ˆä»»åŠ¡ã€‚æ¯ä¸€ä¸ªTaskè¿è¡Œä¸€ä¸ªAnsibleçš„*Module*ï¼ŒModuleæ˜¯Ansibleå†…å»ºçš„å„ç§å‘½ä»¤ï¼Œä¾‹å¦‚yunï¼Œåˆ›å»ºç”¨æˆ·ç­‰ã€‚ç¨åå°±ä¼šæ˜ç™½è¿™äº›æœ¯è¯­çš„å…·ä½“æ„æ€ã€‚  \n\n## ç¬¬ä¸€ä¸ªPlaybook\n\nåˆ›å»ºä¸€ä¸ªå«`playbook.yml`çš„æ–‡ä»¶ï¼Œè¿™ä¸ªåå­—å¿…é¡»å’Œ`Vagrantfile`çš„`ansible.playbook`ç›¸åŒã€‚\n\næ‰€æœ‰Ansibleçš„Playbookéƒ½å¿…é¡»æ˜¯YAMLæ ¼å¼çš„ã€‚ä¼ ç»Ÿä¸ŠYAMLæ–‡ä»¶æ˜¯ä»¥ä¸‰æ¡æ¨ªçº¿å¼€å¤´çš„ï¼Œä½†æ˜¯Ansibleå¹¶ä¸æ˜¯å¼ºåˆ¶è¦æ±‚çš„ï¼Œä¸è¿‡ç¤¾åŒºä»ç„¶ä¼šéµå¾ªè¿™ä¸ªè§„åˆ™ã€‚  \n\næ–°å»ºçš„playbookæ˜¯ä¸€ä¸ªYAMLçš„åˆ—è¡¨ã€‚è¿™ä¸ªåˆ—è¡¨åº”è¯¥åŒ…æ‹¬è¦ç®¡ç†çš„hostå’Œå„ç§è¦è¿è¡Œçš„taskï¼Œå°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`playbook.yml`æ–‡ä»¶ä¸­ã€‚\n\n```bash\n---\n- host: all\n  sudo: true\n  tasks:\n```\n\næˆ‘ä»¬ä½¿ç”¨Vagrantå¹¶ä¸”åªæœ‰ä¸€å°ä¸»æœºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé­”æ³•å€¼`all`ï¼Œæ„æ€æ˜¯åœ¨æ‰€æœ‰çš„æœºå™¨ä¸Šè¿è¡Œä»»åŠ¡ã€‚ç„¶åæˆ‘ä»¬å‘Šè¯‰Ansibleè¿è¡Œæ˜¯éœ€è¦sudoæƒé™ï¼Œæœ€åæˆ‘ä»¬æ·»åŠ äº† `tasks:` ç”¨æ¥æ·»åŠ Taskã€‚\n\nè¦å®‰è£…LAMPæŠ€æœ¯æ ˆçš„åŸºæœ¬æ­¥éª¤æ˜¯ï¼š  \n1. æ›´æ–° Apt Cache\n2. å®‰è£… Apache\n3. å®‰è£… MySQL\n4. å®‰è£… PHP\n\nè¿™å°±æ˜¯æ‰€æœ‰æˆ‘ä»¬å¿…é¡»çš„æ­¥éª¤ã€‚å› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯Ubuntuçš„boxï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦Ansibleçš„aptæ¨¡å—ã€‚\n\né¦–å…ˆæˆ‘ä»¬ç»™æ¯ä¸€ä¸ªtaskä¸€ä¸ª`name:`ï¼Œè¿™ä¸ªå¯ä»¥æ˜¯ä»»ä½•æè¿°ï¼Œå®ƒç”¨æ¥æè¿°è¿™ä¸ªä»»åŠ¡ï¼Œå¦‚ä¸‹:\n\n```bash\n- name: this should be some descriptive text\n```\n\næ¥ç€æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªAnsibleçš„æ¨¡å—ä½œä¸ºå€¼ï¼Œåœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨çš„æ˜¯aptæ¨¡å—ã€‚\n\n```bash\napt\n```\n\nç´§éšå…¶åçš„æ˜¯ä¸€äº›`key=value`çš„ç”±ç©ºæ ¼åˆ†éš”çš„é”®å€¼å¯¹ã€‚é€‰æ‹©ä½ æƒ³è¦ä¼ é€’ç»™Ansibleçš„é”®å€¼å¯¹ï¼Œå¯ä»¥é€šè¿‡Ansibleçš„æ–‡æ¡£æ¥æŸ¥è¯¢æ‰€éœ€è¦çš„é”®å€¼å¯¹ã€‚\n\nå®‰è£…Apacheçš„ä»»åŠ¡å¦‚ä¸‹ï¼š\n\n```bash\n- name: install apache\n  apt: name=apache2 state=present\n```\n\nè¿™æ ·å°±é…ç½®å¥½äº†ï¼Œå¾ˆç®€å•ï¼Œå¯¹å§ã€‚æˆ‘ä»¬å°†ç»§ç»­æ·»åŠ MySQLå’ŒPHPçš„Taskåˆ°`playbook.yml`ä¸­ï¼Œæœ€åä»£ç å¦‚ä¸‹ï¼š\n\n```bash\n---\n- hosts: all\n  sudo: true\n  tasks:\n    - name: update apt cache\n      apt: update_cache=yes\n    - name: install apache\n      apt: name=apache2 state=present\n    - name: install mysql\n      apt: name=mysql-server state=present\n    - name: install php\n      apt: name=php5 state=present\n```\n\nç°åœ¨æˆ‘ä»¬å·²ç»é…ç½®å®Œäº†ï¼Œç„¶åè¿è¡Œ`vagrant up`ï¼Œä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n![result](https://adamcod.es/img/posts/vagrant-ansible-lamp.gif)  \n\nè¿™æ ·å°±æ­å»ºå¥½äº†ã€‚å¦‚æœä½ æƒ³è®©LAMPè¿è¡Œèµ·æ¥ï¼Œä½ å°±å¯ä»¥sshåˆ°Vagrantï¼Œç„¶åå°†`info.php`æ–‡ä»¶æ·»åŠ åˆ°`/var/www/html`ä¸‹ã€‚\n```php\n<?php phpinfo();?>\n```\n\nç„¶ååœ¨æœ¬æœºæµè§ˆå™¨æ‰“å¼€[http://localhost:8080/info.php](http://localhost:8080/info.php)ï¼Œå°±ä¼šçœ‹åˆ°ä½ æƒ³è¦çœ‹åˆ°çš„ã€‚\n\n**ç¿»è¯‘åˆ°æ­¤ï¼Œå‰©ä¸‹çš„å°±æ˜¯å…³äºAnsibleçš„ä½¿ç”¨äº†ï¼Œè¿™äº›å¯ä»¥é€šè¿‡Ansibleçš„å®˜æ–¹æ–‡æ¡£æ¥å­¦ä¹ **\n\n","date":"2015-11-08"},{"title":"Vagrant å…¥é—¨æŒ‡å—","tags":["Vagrant","Translate","backend"],"iso8601Date":"2015-11-07T00:49:47+08:00","basename":"Vagrant-å…¥é—¨æŒ‡å—","body":"\n[åŸæ–‡åœ°å€](https://docs.vagrantup.com/v2/getting-started/index.html)\n## å¼€å§‹\n\nVagrant å…¥é—¨æŒ‡å—å°†ä¼šå¼•å¯¼ä½ å®Œæˆä½ çš„ç¬¬ä¸€ä¸ªVagranté¡¹ç›®ï¼Œå¹¶ä¸”ä¼šå‘ä½ å±•ç¤ºVagrantæä¾›çš„åŸºæœ¬çš„ç‰¹è‰²åŠŸèƒ½ã€‚  \nå¦‚æœä½ å¥½å¥‡Vagrantæä¾›äº†ä»€ä¹ˆå¥½çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥é˜…è¯»ä¸€ä¸‹[Why Vagrant](https://docs.vagrantup.com/v2/why-vagrant/)ã€‚  \nè¿™ç¯‡å…¥é—¨æŒ‡å—å°†ä¼šåŸºäº[VirtualBox][1]æ¥ä½¿ç”¨Vagrantï¼Œå› ä¸ºå®ƒå…è´¹ï¼Œæ”¯æŒä¸»æµå¹³å°ï¼Œå¹¶ä¸”Vagrantå†…å»ºæ”¯æŒã€‚å½“ä½ å®Œæˆè¿™ç¯‡æŒ‡å—çš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒæ›´å¤šçš„[æä¾›å•†](https://docs.vagrantup.com/v2/getting-started/providers.html)\n\n> æ›´å–œæ¬¢è¯»ä¹¦ï¼Ÿå¦‚æœä½ æ›´å–œæ¬¢è¯»å®ä½“ä¹¦ï¼Œé‚£ä¹ˆä½ å¯èƒ½å¯¹ç”±Vagrantä½œè€…ç¼–å†™ï¼ŒO'Reilly å‡ºç‰ˆçš„[Vagrant: Up and Running](http://www.amazon.com/gp/product/1449335837/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1449335837&linkCode=as2&tag=vagrant-20) æ›´æ„Ÿå…´è¶£ï¼Œ\n\n## å¯åŠ¨è¿è¡Œ\n\n```\n$ vagrant init hashicorp/precise32\n$ vagrant up\n```\n\nè¿è¡Œäº†ä¸Šé¢ä¸¤ä¸ªå‘½ä»¤ä¹‹åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªè¿è¡Œåœ¨[VirtualBox][1]è™šæ‹Ÿæœºä¸Šçš„Ubuntu 12.04 LTS 32-bitã€‚ä½ å¯ä»¥é€šè¿‡`vagrant ssh` ä»¥sshçš„æ–¹å¼ç™»é™†ï¼Œå½“ä½ ç‹åŸæ‰€æœ‰çš„æ“ä½œçš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`vagrant destory`æ¥åˆ é™¤æ‰€æœ‰çš„ç—•è¿¹ã€‚  \nç°åœ¨æƒ³è±¡ ä¸€ä¸‹ï¼Œä»¥å‰ä½ æ‰€æœ‰å·¥ä½œè¿‡çš„é¡¹ç›®ï¼Œéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªç®€å•çš„æ–¹å¼æ¥è®¾ç½®äº†ã€‚    \né€šè¿‡ä½¿ç”¨Vagrant,å¯¹äºä»»ä½•é¡¹ç›®æ¥è¯´`vagrant up` æ˜¯ä½ å”¯ä¸€éœ€è¦ä½ ç”¨åˆ°çš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼Œå®‰è£…é¡¹ç›®ä¾èµ–ï¼Œè®¾ç½®ç½‘ç»œå’ŒåŒæ­¥æ–‡ä»¶å¤¹ï¼Œä»ç„¶å¯ä»¥å¾ˆèˆ’æœçš„ä½¿ç”¨æœ¬æœºç³»ç»Ÿã€‚    \næŒ‡å—å‰©ä¸‹çš„å†…å®¹å°†ä¼šå¼•å¯¼ä½ è®¾ç½®æ›´å¤æ‚çš„é¡¹ç›®ï¼Œæ¶µç›–è·Ÿå¤šçš„Vagrantçš„ç‰¹è‰²ã€‚  \n\n## é¡¹ç›®é…ç½®\n\n ä»»ä½•Vagranté¡¹ç›®é…ç½®çš„ç¬¬ä¸€æ­¥éƒ½æ˜¯åˆ›å»ºä¸€ä¸ª[Vagrantfile](https://docs.vagrantup.com/v2/vagrantfile/)ã€‚è¯¥æ–‡ä»¶çš„ä½œç”¨æœ‰ä¸¤ä¸ª:  \n1. æŒ‡å®šé¡¹ç›®çš„æ ¹ç›®å½•ã€‚å¾ˆå¤šVagrantçš„é…ç½®è·Ÿè¿™ä¸ªç›®å½•æœ‰å…³ã€‚  \n2. æè¿°é¡¹ç›®æ‰€éœ€è¦çš„æœºå™¨ç±»å‹å’Œèµ„æºï¼Œä»¥åŠå¦‚ä½•å®‰è£…è½¯ä»¶ï¼Œå¦‚ä½•è®¿é—®ã€‚  \n\n Vagrant æœ‰ä¸€ä¸ªå†…å»ºçš„å‘½ä»¤`vagrant init`ç”¨æ¥åˆå§‹åŒ–é¡¹ç›®ã€‚å‡ºäºæœ¬æŒ‡å—çš„ç›®çš„ï¼Œè¯·åœ¨ç»ˆç«¯è¾“å…¥ä¸€ä¸‹å‘½ä»¤  \n\n```\n$ mkdir vagrant_getting_started\n$ cd vagrant_getting_started\n$ vagrant init\n```\n\n ä»¥ä¸Šå‘½ä»¤å°†åœ¨ä½ çš„å½“å‰ç›®å½•ä¸‹åˆ›å»º`Vagrantfile`ã€‚æŸ¥çœ‹Vagrantfileä¼šå‘ç°é‡Œé¢æœ‰å„ç§æ³¨é‡Šå’Œç¤ºä¾‹ã€‚ä¸è¦å› ä¸ºä»–è´Ÿè´£è€Œæ„Ÿåˆ°ææƒ§ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±èƒ½å¤Ÿä¿®æ”¹å®ƒäº†ã€‚  \n åŒæ ·ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªå·²å­˜åœ¨çš„ç›®å½•ä¸‹è¿è¡Œ`vagrant init`ï¼Œæ¥æœªä¸€ä¸ªå·²æœ‰é¡¹ç›®è®¾ç½®Vagrantç¯å¢ƒã€‚\n å¦‚æœä½ ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œé‚£ä¹ˆVagrantfileå¯ä»¥æäº¤åˆ°ç‰ˆæœ¬åº“ä¸­ã€‚è¿™æ ·å…¶ä»–ä¸è¿™ä¸ªé¡¹ç›®ç›¸å…³çš„äººå°±å¯ä»¥æ— éœ€å‰æœŸå·¥ä½œäº†ã€‚\n\n## Boxes\n\n ç”±äºä»å¤´æ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªè´¹æ—¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥Vagrantä½¿ç”¨ä¸€ä¸ªåŸºæœ¬é•œåƒæ¥å¿«é€Ÿå…‹éš†ä¸€ä¸ªè™šæ‹Ÿæœºã€‚è¿™äº›åŸºæœ¬é•œåƒå†Vagrantä¸­è¢«ç§°ä½œboxesï¼Œè€Œä¸”åœ¨åˆ›å»ºç©Vagrantfileåçš„ç¬¬ä¸€æ­¥å°±æ˜¯ä¸ºä½ çš„Vagrantç¯å¢ƒæŒ‡å®šä¸€ä¸ªboxã€‚  \n\n###  å®‰è£…box\n\n å¦‚æœä½ è¿è¡Œäº†[å¼€å§‹æŒ‡å—](https://docs.vagrantup.com/v2/getting-started/)çš„å‘½ä»¤ï¼Œé‚£ä¹ˆä½ å·²ç»åœ¨æœ¬æœºå®‰è£…äº†ä¸€ä¸ªboxï¼Œä½ å°±ä¸éœ€è¦å†æ¬¡è¿è¡Œä¸€ä¸‹å‘½ä»¤äº†ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†ä»ç„¶æ˜¯å€¼å¾—é˜…è¯»çš„ï¼Œè¿™æ ·ä½ å°±å¯ä»¥äº†è§£æ›´å¤šå…³äºå¦‚ä½•ç®¡ç†boxçš„çŸ¥è¯†ã€‚  \n Boxes ç”±Vagrantçš„`vagrant box add`å‘½ä»¤æ·»åŠ ã€‚è¿™ä¸ªå°†boxå­˜å‚¨åœ¨ä¸€ä¸ªæŒ‡å®šå‘½åçš„ç›®å½•ä¸‹ï¼Œè¿™ä¸ªå¤šä¸ªVagrantçš„ç¯å¢ƒå¯ä»¥é‡å¤åˆ©ç”¨ã€‚å¦‚æœä½ è¿˜æœªæ·»åŠ å·²ç»™boxï¼Œé‚£ä¹ˆå¯ä»¥è¿è¡Œä¸€ä¸‹å‘½ä»¤ã€‚  \n\n```\n$ vagrant box add hashicorp/precise32\n```\n\n è¿™ä¸ªå°†ä»[HashiCorp's Atlas box catalog](https://atlas.hashicorp.com/boxes/search)ä¸‹è½½ä¸€ä¸ªåå­—ä¸º`hashicorp/precise32`çš„boxã€‚ä½ å¯ä»¥ä»HashiCorp's Atlas box catalogä¸­æ‰¾åˆ°å„ç§boxã€‚å¾ˆå®¹æ˜“ä»HashiCorp's Atlas ä¸‹è½½é•œåƒï¼ŒåŒæ—¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡æœ¬åœ°æ–‡ä»¶ï¼Œå…¶ä»–URLç­‰æ·»åŠ ã€‚\n å·²æ·»åŠ çš„boxeså¯ä»¥è¢«å¤šä¸ªç¯å¢ƒé‡å¤åˆ©ç”¨ã€‚æ¯ä¸ªç¯å¢ƒéƒ½æ˜¯å°†å…¶ä½œä¸ºåŸºç¡€é•œåƒå…‹éš†ï¼Œè€Œä¸ä¼šä¿®æ”¹ä»–ã€‚è¿™å°±æ„å‘³ç€ä¸¤ä¸ªç¯å¢ƒåŒæ—¶ä½¿ç”¨äº†åˆšåˆšæ·»åŠ çš„`hashicorp/precise32`çš„boxï¼Œå…¶ä¸­ä¸€ä¸ªä¸»æœºæ·»åŠ æ–‡ä»¶å¹¶ä¸ä¼šå½±å“å¦ä¸€ä¸ªä¸»æœºã€‚  \n\n### ä½¿ç”¨box\n\n ç°åœ¨å·²ç»å§boxæ·»åŠ åˆ°Vagrantäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠä»–ä½œä¸ºä¸€ä¸ªåŸºç¡€é•œåƒä½¿ç”¨äº†ã€‚æ‰“å¼€Vagrantfileï¼Œä¿®æ”¹ä¸€ä¸‹ä»£ç :\n\n```\nVagrant.configure(\"2\") do |config|\n  config.vm.box = \"hashicorp/precise32\"\nend\n```\n åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ\"hashicorp/precise32\" çš„åå­—å¿…é¡»è·Ÿä½ add boxçš„åå­—ç›¸åŒã€‚è¿™æ˜¯VagrantçŸ¥é“boxå¦‚ä½•ç”¨çš„æ–¹å¼ã€‚å¦‚æœè¿™ä¸ªboxæ²¡æœ‰è¢«å®‰è£…è¿‡ï¼Œé‚£ä¹ˆVagrantå°†ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶ä¸”å½“å®ƒè¿è¡Œçš„æ—¶å€™è‡ªåŠ¨æ·»åŠ ã€‚  \n åœ¨ä¸‹ä¸€èŠ‚ä¸­æˆ‘ä»¬å°†å¯åŠ¨Vagrantå¹¶ä¸”ä¸å…¶è¿›è¡Œäº¤äº’ã€‚  \n\n### å¯»æ‰¾æ›´å¤šbox\n\n åœ¨æœ¬å…¥é—¨æŒ‡å—çš„ååŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬åªä¼šä½¿ç”¨ä¹‹å‰æ·»åŠ çš„\"hashicorp/precise32\"çš„boxã€‚ä½†æ˜¯ï¼Œç»“æŸæœ¬æŒ‡å—çš„æ—¶å€™ä½ çš„ç¬¬ä¸€ä¸ªé—®é¢˜å¯èƒ½å°±æ˜¯æˆ‘ä»å—æ‰¾åˆ°æ›´å¤šçš„boxã€‚  \n å¯»æ‰¾æ›´å¤šboxçš„æœ€å¥½çš„åœ°æ–¹æ˜¯[HashiCorp's Atlas box catalog](https://atlas.hashicorp.com/boxes/search)ã€‚HashiCopr çš„Altasæœ‰ä¸€ä¸ªå…¬å…±ç›®å½•ï¼Œåœ¨ç›®å½•é‡Œå¯ä»¥æ‰¾åˆ°å„ç§å…è´¹çš„ï¼Œå¯ä»¥è¿è¡Œå„ç§å¹³å°å’ŒæŠ€æœ¯çš„boxã€‚  \n HashiCorpçš„AltasåŒæ ·ä¹Ÿæœ‰ä¸€ä¸ªå¾ˆæ£’çš„æœç´¢åŠŸèƒ½ï¼Œè¿™æ ·å°±å¯ä»¥æ›´æ–¹ä¾¿çš„æ‰¾åˆ°éœ€è¦çš„boxã€‚  \n é™¤äº†å¯»æ‰¾å…è´¹çš„boxå¤–ï¼ŒHashiCorpçš„Altasè¿˜å…è®¸ä½ æ„å»ºè‡ªå·±çš„boxï¼Œä»¥åŠå¦‚æœä½ æƒ³ä¸ºè‡ªå·±çš„ç»„ç»‡åˆ›å»ºç§æœ‰boxã€‚  \n\n## å¯åŠ¨å¹¶ä¸”SSHç™»é™†\n\n æ˜¯æ—¶å€™å¯åŠ¨ä½ ç¬¬ä¸€ä¸ªVagrantç¯å¢ƒäº†ã€‚è¿è¡Œä¸€ä¸‹å‘½ä»¤:  \n\n```\nvagrant up\n```\n\n 1åˆ†é’Ÿä¹‹å†…ï¼Œè¿™ä¸ªå‘½ä»¤è¿è¡Œå®Œåï¼Œä½ å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªè¿è¡ŒUbuntuçš„è™šæ‹Ÿæœºäº†ã€‚ç”±äºVagrantè¿è¡Œè™šæ‹Ÿæœºçš„æ—¶å€™æ²¡æœ‰UIï¼Œæ‰€ä»¥ä½ ä¸ä¼šçœ‹åˆ°ä»»ä½•è¾“å‡ºã€‚ä½ å¯ä»¥SSHç™»é™†åˆ°è™šæ‹Ÿæœºæ¥éªŒè¯è™šæ‹Ÿæœºæ˜¯å¦è¿è¡Œï¼š\n\n```\nvagrant ssh\n```\n\n è¿è¡Œå®Œè¿™ä¸ªå‘½ä»¤åä½ å°±ä¼šè¿›å…¥sshä¼šè¯ä¸­ã€‚ç»§ç»­å’Œæœºå™¨äº¤äº’ï¼Œåšä»»ä½•ä½ æƒ³åšçš„äº‹æƒ…ã€‚è™½ç„¶æ˜¯ä¸´æ—¶çš„è™šæ‹Ÿæœºï¼Œä½†æ˜¯è¿˜æ˜¯è¦å°å¿ƒ`rm -rf /` è¿™ç§å‘½ä»¤ï¼Œå› ä¸ºVagrantçš„`/vagrant`ç›®å½•ä¸å®¿ä¸»æœºå™¨å…±äº«äº†åŒ…å«Vagrantfileçš„ç›®å½•ï¼Œå¦‚æœè¿è¡Œäº†ä¼šåˆ é™¤æ‰€æœ‰çš„æ–‡ä»¶çš„ã€‚å…±äº«ç›®å½•å°†ä¼šåœ¨ä¸‹èŠ‚æè¿°ã€‚  \n èŠ±ä¸€ç‚¹æ—¶é—´æ€è€ƒä¸€ä¸‹åˆšåˆšå‘ç”Ÿçš„äº‹æƒ…ï¼šé€šè¿‡ä»…ä»…1è¡Œé…ç½®å’Œ1è¡Œå‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯åŠ¨äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ï¼Œå¯ä»¥sshç™»é™†çš„è™šæ‹Ÿæœºï¼Œå¤ªé…·äº†ã€‚  \n å½“ä½ ç”¨å®Œè™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œä½ å¯ä»¥åœ¨ä¸»æœºä¸Šä½¿ç”¨`vagrant destory`æ¥æ¸…é™¤ä½ å†è™šæ‹Ÿæœºçš„ç—•è¿¹ã€‚\n\n## åŒæ­¥æ–‡ä»¶å¤¹\n\nè™½ç„¶è¿™ä¹ˆå®¹æ˜“å°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªè™šæ‹Ÿæœºæ˜¯å¾ˆçˆ½ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„äººéƒ½å–œæ¬¢é€šè¿‡sshç™»é™†ç»ˆç«¯ä¿®æ”¹æ–‡ä»¶ã€‚å¹¸è¿çš„æ˜¯ï¼Œé€šè¿‡Vagrantï¼Œä½ å¹¶ä¸æ˜¯å¿…é¡»è¿™ä¹ˆåšçš„ã€‚é€šè¿‡ä½¿ç”¨*åŒæ­¥æ–‡ä»¶å¤¹*Vagrantå°†ä¼šè‡ªåŠ¨çš„å°†æ–‡ä»¶ä»è™šæ‹ŸæœºåŒæ­¥æˆ–è€…åŒæ­¥åˆ°è™šæ‹Ÿæœºä¸­ã€‚  \n é»˜è®¤æƒ…å†µä¸‹ï¼ŒVagrantæ˜¯å…±äº«ä½ çš„é¡¹ç›®ç›®å½•ï¼ˆè®°ä½ï¼Œè¿™ä¸ªæ˜¯ä½ Vagrantfileæ‰€åœ¨çš„ç›®å½•ï¼‰åˆ°è™šæ‹Ÿæœºçš„`/vagrant`çš„ã€‚å†æ¬¡è¿è¡Œ`vagrant up` å¹¶ä¸”sshåˆ°è™šæ‹Ÿæœºã€‚\n\n```\n$ vagrant up\n...\n$ vagrant ssh\n...\nvagrant@precise32:~$ ls /vagrant\nVagrantfile\n```\n\n ä¸ç®¡ç›¸ä¸ç›¸ä¿¡ï¼Œåœ¨è™šæ‹Ÿæœºçš„è¿™ä¸ªVagrantfileå’Œå†å®¿ä¸»æœºä¸Šçš„é‚£ä¸ªVagrantfileæ˜¯åŒä¸€ä¸ªã€‚ç»§ç»­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶è¯æ˜ä¸€ä¸‹ï¼š\n\n```\nvagrant@precise32:~$ touch /vagrant/foo\nvagrant@precise32:~$ exit\n$ ls\nfoo Vagrantfile\n```\n\n å“‡ï¼`foo`å·²ç»åœ¨ä½ çš„å®¿ä¸»æœºé‡Œåˆ›å»ºäº†ã€‚æ­£å¦‚ä½ æ‰€è§ï¼ŒVagrantä¼šä¿æŒé‚£ä¸ªæ–‡ä»¶å¤¹çš„åŒæ­¥ã€‚  \n é€šè¿‡ä½¿ç”¨[åŒæ­¥æ–‡ä»¶å¤¹](https://docs.vagrantup.com/v2/synced-folders/)ï¼Œä½ å¯ä»¥ç»§ç»­åœ¨ä½ çš„ä¸»æœºä¸Šä½¿ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨ï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨çš„åŒæ­¥åˆ°è™šæ‹Ÿæœºä¸Šçš„ã€‚\n\n## é…ç½®\n\n ç°åœ¨æˆ‘ä»¬å·²ç»åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œäº†ä¸€ä»½Ubuntuçš„æ‹·è´ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜å¯ä»¥ä»å®¿ä¸»æœºä¸Šç¼–è¾‘æ–‡ä»¶åŒæ—¶åŒæ­¥åˆ°è™šæ‹Ÿæœºä¸­ã€‚ç°åœ¨è®©æˆ‘ä»¬é€šè¿‡webserveræ¥æä¾›è¿™äº›æ–‡ä»¶ã€‚  \n æˆ‘ä»¬å¯ä»¥SSHåˆ°è™šæ‹Ÿæœºç„¶åå®‰è£…webserverç„¶åæä¾›è¿™äº›æ–‡ä»¶ï¼Œä½†æ˜¯è¿™æ ·åšï¼Œæ¯ä¸€ä¸ªç”¨Vagrantçš„ç”¨æˆ·éƒ½éœ€è¦é‡å¤ç›¸åŒçš„äº‹æƒ…ã€‚ä¸è¿‡Vagrantå†…å»ºæä¾›äº†è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ã€‚ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼ŒVagrantå¯ä»¥åœ¨ä½ `vagrant up`çš„æ—¶å€™è‡ªåŠ¨å®‰è£…è½¯ä»¶ï¼Œè¿™æ ·è™šæ‹Ÿæœºå°±å¯ä»¥è¢«é‡å¤åˆ›å»ºå¹¶ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚  \n\n### å®‰è£…Apache\n\n å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®æ¥è¯´å¯ä»¥ä»…ä»…ä½¿ç”¨[Apache](http://httpd.apache.org/)ï¼Œå¹¶ä¸”æˆ‘ä»¬æ˜¯é€šè¿‡ä¸€ä¸ªshellè„šæœ¬åˆ›å»ºçš„ã€‚å†Vagrantfileç›¸åŒçš„ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåå­—ä¸º`bootstrap.sh`çš„æ–‡ä»¶ã€‚  \n\n```bash\n#!/usr/bin/env bash\n\napt-get update\napt-get install -y apache2\nif ! [ -L /var/www ]; then\n  rm -rf /var/www\n  ln -fs /vagrant /var/www\nfi \n```\n\n ç„¶åï¼Œæˆ‘ä»¬éœ€è¦é…ç½®Vagrantï¼Œè®©å®ƒåœ¨å¯åŠ¨çš„æ—¶å€™è¿è¡Œè¿™ä¸ªè„šæœ¬ã€‚æˆ‘ä»¬é€šè¿‡ä¿®æ”¹Vagrantfileæ¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œå…·ä½“ä¿®æ”¹å¦‚ä¸‹:\n\n```\nVagrant.configure(\"2\") do |config|\n  config.vm.box = \"hashicorp/precise32\"\n  config.vm.provision :shell, path: \"bootstrap.sh\"\nend\n```\n\n â€œprovisionâ€è¿™ä¸€è¡Œæ˜¯æ–°æ·»åŠ çš„ï¼Œå‘Šè¯‰Vagrantä½¿ç”¨`shell`é…ç½®å™¨è¿è¡Œ`bootstrap.sh`è„šæœ¬å¯åŠ¨æœºå™¨ã€‚è„šæœ¬çš„è·¯å¾„æ˜¯é¡¹ç›®æ›´ç›®å½•çš„ç›¸å¯¹è·¯å¾„ã€‚\n\n### é…ç½®\n\n åœ¨æ‰€æœ‰çš„äº‹æƒ…éƒ½é…ç½®å¥½å¥½ï¼Œè¿è¡Œ`vagrant up`æ¥åˆ›å»ºæœºå™¨ï¼ŒVagrantå°†ä¼šè‡ªåŠ¨çš„é…ç½®å®ƒã€‚è¿è¡Œçš„æ—¶å€™ä½ ä¼šåœ¨ç»ˆç«¯çœ‹åˆ°shellè„šæœ¬çš„è¾“å‡ºã€‚å¦‚æœè™šæ‹Ÿæœºå·²ç»å¼€å§‹è¿è¡Œäº†ï¼Œè¿è¡Œ`vagrant reload --provision`, è¿™ä¸ªå‘½ä»¤å¯ä»¥å¿«é€Ÿé‡å¯è™šæ‹Ÿæœºå¹¶ä¸”è·³è¿‡åˆå§‹çš„å¯¼å…¥æ­¥éª¤ã€‚`--provision`è¡¨ç¤ºVagrantéœ€è¦è¿è¡Œé…ç½®ï¼Œå› ä¸ºé€šå¸¸Vagrantåªè¿è¡Œç¬¬ä¸€æ­¥ã€‚\n å½“Vagrantå®Œå…¨è¿è¡Œèµ·æ¥çš„æ—¶å€™ï¼Œweb serveråŒæ—¶ä¹Ÿå¯åŠ¨äº†ã€‚ç°åœ¨è¿˜ä¸éƒ½èƒ½é€šè¿‡å®¿ä¸»æœºçš„æµè§ˆå™¨çœ‹åˆ°ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡sshåˆ°è™šæ‹Ÿæœºè¿›è¡ŒéªŒè¯ã€‚\n\n```\n$ vagrant ssh\n...\nvagrant@precise32:~$ wget -qO- 127.0.0.1\n```\n\n è¿™ä¸ªå¯ä»¥è¿è¡ŒæˆåŠŸï¼Œå› ä¸ºæˆ‘ä»¬æˆ‘ä»¬å·²ç»å®‰è£…äº†ApacheæœåŠ¡å™¨å¹¶ä¸”è®¾ç½®é»˜è®¤çš„`DocumentRoot`æŒ‡å‘äº†`/vagrant`ã€‚\n ä½ å¯ä»¥ç»§ç»­çš„åˆ›å»ºæ–‡ä»¶ï¼ŒåŒæ—¶å†ç»ˆç«¯é‡Œé¢éªŒè¯ï¼Œä¸è¿‡ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†ä¼šè®²è¿°ç½‘ç»œçš„ç›¸å…³çŸ¥è¯†ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å†æœ¬æœºçš„æµè§ˆå™¨éªŒè¯äº†ã€‚\n\n## ç½‘ç»œ\n\n ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è¿è¡Œäº†ä¸€ä¸ªweb serverï¼Œå¹¶ä¸”å¯ä»¥å†å®¿ä¸»æœºå™¨ä¸Šä¿®æ”¹ï¼ŒåŒæ—¶è‡ªåŠ¨åŒæ­¥åˆ°è™šæ‹Ÿæœºä¸­ã€‚ç„¶è€Œï¼Œç®€å•çš„ä»è™šæ‹Ÿæœºçš„ç»ˆç«¯è®¿é—®ç½‘é¡µå¹¶ä¸æ–¹ä¾¿ã€‚åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å°†ä½¿ç”¨Vagrantçš„ç½‘ç»œç‰¹æ€§ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿çš„ä»å®¿ä¸»æœºå™¨è®¿é—®è™šæ‹Ÿæœºäº†ã€‚\n\n### ç«¯å£è½¬å‘\n\n ä¸€ä¸ªæ–¹æ³•æ˜¯ä½¿ç”¨ç«¯å£è½¬å‘åŠŸèƒ½ã€‚ç«¯å£è½¬å‘å…è®¸ä½ æŒ‡å®šè™šæ‹Ÿæœºçš„ä¸€ä¸ªç«¯å£è·Ÿå®¿ä¸»æœºçš„ä¸€ä¸ªç«¯å£å…±äº«ã€‚è¿™æ ·ä½ å°±å¯ä»¥åœ¨å®¿ä¸»æœºè®¿é—®å®¿ä¸»æœºçš„ç«¯å£ï¼Œä½†æ˜¯éƒ½ä¼šè½¬å‘åˆ°è™šæ‹Ÿæœºä¸­ã€‚\n ç°åœ¨æˆ‘ä»¬é…ç½®ç«¯å£æ¥è®¿é—®è™šæ‹Ÿæœºçš„ApacheæœåŠ¡ã€‚ä¿®æ”¹Vagrantfileå¦‚ä¸‹ï¼š\n\n```\nVagrant.configure(\"2\") do |config|\n  config.vm.box = \"hashicorp/precise32\"\n  config.vm.provision :shell, path: \"bootstrap.sh\"\n  config.vm.network :forwarded_port, guest: 80, host: 4567\nend\n```\n\n è¿è¡Œ`vagrant reload`ï¼Œæˆ–è€…å¦‚æœæ²¡æœ‰å¯åŠ¨è¿‡è™šæ‹Ÿæœºè¿è¡Œ`vagrant up`ã€‚ä½¿é…ç½®ç”Ÿæ•ˆã€‚\n\n### å…¶ä»–çš„ç½‘ç»œé…ç½®\n\n Vagrantä¹Ÿæœ‰å…¶ä»–çš„ç½‘ç»œé…ç½®ï¼Œå…è®¸ä½ ç»™è™šæ‹Ÿæœºé…ç½®å›ºå®šipï¼Œæˆ–è€…æ˜¯æ¡¥æ¥ä¸¤å°è™šæ‹Ÿæœºã€‚å¦‚æœä½ å¯¹å…¶æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯»[networking](https://docs.vagrantup.com/v2/networking/)ç« èŠ‚ã€‚\n\n## å…±äº«\n\n ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å°å¯è¿è¡Œçš„æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¯ä»¥ä»æœ¬æœºç›´æ¥è®¿é—®ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªç›¸å½“å®ç”¨çš„å¼€å‘ç¯å¢ƒã€‚ä½†æ˜¯ï¼Œé™¤äº†æä¾›ä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼ŒVagrantè¿˜å¯ä»¥å¾ˆå®¹æ˜“çš„å’Œå…¶ä»–ç¯å¢ƒåˆ†äº«å’Œåˆä½œã€‚è¿™ä¸ªä¸»è¦çš„åŠŸèƒ½å«åš[Vagrant Share](https://docs.vagrantup.com/v2/share/)ã€‚\n Vagrant Shareè¿è¡Œä½ æŠŠä½ çš„Vagrantç¯å¢ƒåˆ†äº«ä½ ä¸–ç•Œä¸Šçš„æ¯ä¸€ä¸ªäººã€‚å®ƒå°†åˆ†é…ç»™ä½ ä¸€ä¸ªURLï¼Œè¿™æ ·ä¸–ç•Œä¸Šä»»ä½•ä¸€å°æœºå™¨éƒ½å¯ä»¥å®ç”¨ä½ çš„ç¯å¢ƒäº†ã€‚\n\n### ç™»å½•Harshicorp's Altas\n\n åœ¨åˆ†äº«ä½ çš„Vagrantç¯å¢ƒä¹‹å‰ï¼Œä½ éœ€è¦ä¸€ä¸ª[HashiCorp's Altas](https://atlas.hashicorp.com/)çš„è´¦å·ã€‚ä¸å¿…æ‹…å¿ƒï¼Œå®ƒæ˜¯å…è´¹çš„ã€‚\n å½“ä½ æœ‰äº†è´¦å·åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨`vagrant login`æ¥ç™»é™†\n\n```\n$ vagrant login\nUsername or Email: mitchellh\nPassword (will be hidden):\nYou're now logged in!\n```\n\n### å…±äº«\n\n å½“ä½ ç™»å½•ä¹‹åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨`vagrant share`æ¥å…±äº«ç¯å¢ƒäº†ã€‚\n\n```\n$ vagrant share\n...\n==> default: Your Vagrant Share is running!\n==> default: URL: http://frosty-weasel-0857.vagrantshare.com\n...\n```\n\n ä½ çš„URLä¼šæ˜¯ä¸åŒçš„ï¼Œæ— éœ€ä¸Šé¢çš„URLã€‚å¤åˆ¶ä¸Šé¢`vagrant share`ç”Ÿæˆçš„urlåˆ°ä½ çš„æµè§ˆå™¨ï¼Œä½ ä¼šçœ‹åˆ°æˆ‘ä»¬å·²ç»åšå¥½çš„Apacheçš„é¡µé¢ã€‚\n å¦‚æœä½ åœ¨å…±äº«ç›®å½•ä¸­æ”¹åŠ¨äº†æŸä¸ªæ–‡ä»¶ï¼Œé‡æ–°åˆ·æ–°URLï¼Œä½ ä¼šçœ‹åˆ°å·²ç»æ›´æ–°äº†ã€‚è¿™ä¸ªURLç›´æ¥è·¯ç”±åˆ°ä½ çš„Vagrantç¯å¢ƒï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥å†ä¸–ç•Œä¸Šä»»ä½•ä¸€å°è”ç½‘çš„æœºå™¨ä¸Šè®¿é—®ã€‚\n å…³é—­å…±äº«åªéœ€è¦ä½¿ç”¨`Ctrl+C`å³å¯ï¼Œé‡æ–°åˆ·æ–°URLï¼Œä½ ä¼šå‘ç°ä½ çš„ç¯å¢ƒå·²ç»ä¸å†è¢«å…±äº«äº†ã€‚\n Vagrant Shareæ¯”ç®€å•çš„HTTP share æ›´å¼ºå¤§ï¼Œæƒ³è¦äº†è§£æ›´å¤šå¯ä»¥é˜…è¯»å®Œæ•´çš„[Vagrant Share](https://docs.vagrantup.com/v2/share/)æ–‡æ¡£ã€‚\n\n## å…³é—­\n\n ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªå¼€å‘webçš„åŸºæœ¬ç¯å¢ƒã€‚ä½†æ˜¯ï¼Œç°åœ¨æ˜¯æ—¶å€™è¯´ä¸€ä¸‹å¼€å…³äº†ï¼Œå¯èƒ½æ˜¯åœ¨è¿è¡Œå…¶ä»–çš„é¡¹ç›®çš„æ—¶å€™ä½¿ç”¨ï¼Œæˆ–è€…æ˜¯åƒåˆé¥­çš„æ—¶å€™ä½¿ç”¨ï¼Œæˆ–è€…åªæ˜¯å›å®¶çš„æ—¶å€™ã€‚æˆ‘ä»¬åº”è¯¥å¦‚ä½•æ¸…ç†æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒã€‚\n é€šè¿‡Vagrantï¼Œæˆ‘ä»¬å¯ä»¥*suspend*,*halt*æˆ–è€…*destory*è™šæ‹Ÿæœºã€‚æ¯ä¸€ä¸ªéƒ½æœ‰ä»–ä»¬çš„ä¼˜ç¼ºç‚¹ï¼Œé€‰æ‹©æœ€é€‚åˆä½ çš„é‚£ä¸ªã€‚  \n* **suspend** ä½¿ç”¨`vagrant suspend`å‘½ä»¤ï¼Œä¿å­˜å½“å‰è¿è¡Œç¯å¢ƒå¹¶åœæ­¢ã€‚å½“ä½ æƒ³è¦ç»§ç»­è¿è¡Œçš„æ—¶å€™å¯ä»¥ä½¿ç”¨`vagrant up`å‘½ä»¤ï¼Œå®ƒä¼šä»ä½ ä¸Šæ¬¡suspendä¸­æ¢å¤ã€‚è¿™ä¸ªå‘½ä»¤ä¸»è¦å¥½å¤„æ˜¯é€Ÿåº¦éå¸¸å¿«ï¼Œé€šå¸¸å…³é—­ï¼Œå¯åŠ¨éƒ½åœ¨5åˆ°10ç§’ä¹‹é—´ã€‚ç¼ºç‚¹æ˜¯è™šæ‹Ÿæœºä»ç„¶ä¼šä½¿ç”¨ä½ çš„ç¡¬ç›˜ï¼Œå¹¶ä¸”åœ¨å­˜å‚¨æ‰€æœ‰çš„çŠ¶æ€çš„æ—¶å€™éœ€è¦æ›´å¤§çš„ç¡¬ç›˜ã€‚  \n* **halting** ä½¿ç”¨`vagrant halt`å‘½ä»¤å®ç°ä¼˜é›…çš„å…³é—­è™šæ‹Ÿæœºçš„æ“ä½œç³»ç»Ÿå¹¶å…³é—­è™šæ‹Ÿæœºã€‚åœ¨ä½ æƒ³è¦ä½¿ç”¨çš„æ—¶å€™å†æ¬¡è¿è¡Œ`vagrant up`å‘½ä»¤å¯åŠ¨ã€‚è¿™ä¸ªçš„å¥½å¤„æ˜¯å¯ä»¥å®Œå…¨çš„å…³é—­è™šæ‹Ÿæœºå¹¶ä¿ç•™ä½¿ç”¨çš„ç¡¬ç›˜èµ„æºï¼Œå†ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™ä¼šæ˜¯ä¸€ä¸ªå¹²å‡€çš„è™šæ‹Ÿæœºã€‚ç¼ºç‚¹æ˜¯å†·å¯åŠ¨çš„æ—¶å€™ä¼šæ…¢ä¸€ç‚¹ï¼Œå¹¶ä¸”ä»ç„¶ä¼šä½¿ç”¨ç¡¬ç›˜ç©ºé—´ã€‚\n* **destory** ä½¿ç”¨`vagrant destory`å‘½ä»¤ï¼Œå°†ä¼šæ¸…æ¥šè™šæ‹Ÿæœºæ‰€æœ‰çš„ç—•è¿¹ã€‚å®ƒå°†ä¼šåœæ­¢æ“ä½œç³»ç»Ÿï¼Œå…³é—­è™šæ‹Ÿæœºï¼Œå¹¶ä¸”æ¸…é™¤æ‰€ä½¿ç”¨çš„ç£ç›˜ç©ºé—´ã€‚ä¸‹æ¬¡ä½¿ç”¨`vagrant up`çš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜ã€‚å¥½å¤„æ˜¯ä¸ä¼šæœ‰ä»»ä½•çš„æ®‹ç•™åœ¨ä½ æœºå™¨ä¸Šï¼ŒåŒäº‹ç£ç›˜ç©ºé—´å’ŒRAMéƒ½ä¼šè¿˜ç»™æœ¬æœºã€‚åå¤„æ˜¯`vagrant up`å°†ä¼šä»å¤´å¼€å§‹ï¼Œè¿™æ ·ä¼šèŠ±è´¹æ›´é•¿çš„æ—¶é—´ã€‚\n\n## é‡æ–°æ„å»º\n\n å½“ä½ æƒ³é‡æ–°ä½¿ç”¨è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œä¸ç®¡æ˜¯æ˜¯æ˜å¤©ï¼Œä¸€å‘¨ä¹‹åï¼Œæˆ–è€…æ˜¯ä¸€å¹´ä¹‹åï¼Œéƒ½å¯ä»¥é€šè¿‡`vagrant up`æ¥è½»æ¾è¿è¡Œä»–ã€‚\n åªéœ€è¦è¿™æ ·ã€‚è€Œä¸”ç”±äºä½ çš„Vagrantéƒ½å†Vagrantfileé‡Œé¢é…ç½®çš„ï¼Œæ‰€æœ‰ä½ æˆ–è€…ä½ çš„åŒäº‹åªéœ€è¦ç®€å•çš„è¿è¡Œ`vagrant up`å³å¯é‡æ–°åˆ›å»ºç›¸åŒçš„ç¯å¢ƒã€‚\n\n### Provider\n\n åœ¨æœ¬æŒ‡å—å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸€ç›´æ”¯æŒ[VirtualBox][1]ã€‚ä½†æ˜¯Vagrantå¯ä»¥ä¸å¤šä¸ªåç«¯Providerä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚[VMware](https://docs.vagrantup.com/v2/vmware/),[AWS](http://github.com/mitchellh/vagrant-aws)ç­‰ã€‚ç»§ç»­é˜…è¯»æ¥äº†è§£å¦‚ä½•å®ƒä»¬çš„æ›´å¤šä¿¡æ¯ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚\n å½“ä½ å®‰è£…äº†å…¶ä»–çš„Providerçš„æ—¶å€™,ä½ ä¸éœ€è¦æ›´æ”¹ä½ çš„Vagrantfileï¼Œåªéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™åŠ ä¸ªå‚æ•°å³å¯ï¼š\n\n```\n$ vagrant up --provider=vmware_fusion\n```\n\nå‡†å¤‡è½¬ç§»åˆ°äº‘ç«¯äº†ï¼Ÿä½¿ç”¨AWSï¼š\n\n```\n$ vagrant up --provider=aws\n```\n\n å½“ä½ ä½¿ç”¨å…¶ä»–Providerè¿è¡Œ`vagrant up`çš„æ—¶å€™ï¼Œå…¶ä»–çš„Vagrantå‘½ä»¤ä¸è¡Œä¹Ÿè¦æŒ‡å®šProviderã€‚Vagrantå°†ä¼šè‡ªåŠ¨çš„è®¡ç®—å‡ºæ¥ã€‚æ‰€ä»¥å½“ä½ ssh,destoryçš„æˆ–è€…è¿è¡Œå…¶ä»–å‘½ä»¤çš„æ—¶å€™ï¼Œåªéœ€è¦è¾“å…¥å¹³æ—¶çš„å‘½ä»¤å³å¯ï¼Œä¾‹å¦‚ï¼š`vagrant destory`ï¼Œæ— éœ€é¢å¤–çš„å‚æ•°ã€‚\n æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ[provider](https://docs.vagrantup.com/v2/providers/)ã€‚\n[1]: https://www.virtualbox.org/\n\n\n","date":"2015-11-07"}]