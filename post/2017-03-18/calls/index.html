<!DOCTYPE html><html lang="en" data-reactroot=""><head><title data-react-helmet="true">开发笔记</title><meta data-react-helmet="true" name="title" content="开发笔记"/><meta data-react-helmet="true" property="og:description" content="原文地址

HTTP客户端的任务是接受请求和产生响应。理论很简单，但是实战的时候就有点棘手了。

Requests

每一个HTTP请求都包含一个URL，一个方法（例如，GET，POST）和一..."/><meta data-react-helmet="true" property="og:title" content="OKHttp的调用"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="description" content="原文地址

HTTP客户端的任务是接受请求和产生响应。理论很简单，但是实战的时候就有点棘手了。

Requests

每一个HTTP请求都包含一个URL，一个方法（例如，GET，POST）和一..."/><meta data-react-helmet="true" name="keywords" content="Translate,Java,OKHttp,HTTP,backend"/><link rel="preload" as="script" href="https://shjie047.github.io/bootstrap.a25244d8.js"/><link rel="preload" as="script" href="https://shjie047.github.io/templates/src/containers/Post.cc5410cf.js"/><link rel="preload" as="script" href="https://shjie047.github.io/main.c29bfb10.js"/><link rel="preload" as="style" href="https://shjie047.github.io/styles.cf83ebce.css"/><link rel="stylesheet" href="https://shjie047.github.io/styles.cf83ebce.css"/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><style data-styled-components="bDWFJH gkZsHu fuJRCL mvmj eesrXV Riikb">
/* sc-component-id: sc-bwzfXH */
.fuJRCL{padding:0 40px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;} @media only screen and (max-width:400px){.fuJRCL{padding:0 20px;}} .fuJRCL a{font-size:1.6rem;font-weight:normal;} .fuJRCL .icon-link{font-size:1.8rem;} .fuJRCL .archive{margin-left:auto;}
/* sc-component-id: sc-htpNat */
@media only screen and (max-width:920px){.mvmj{display:none;}} .mvmj a{font-size:1.4rem;} .mvmj::before{content:'';height:2.1rem;width:1px;background-color:#00000038;display:inline-block;vertical-align:middle;}
/* sc-component-id: sc-bxivhb */
.eesrXV{display:none;padding:0;margin:0;position:relative;font-size:1.4rem;} .eesrXV::before{content:'';height:2.1rem;width:1px;background-color:#00000038;display:inline-block;vertical-align:middle;} .eesrXV > i{display:inline-block;padding:1rem;color:#fff;font-weight:normal;-webkit-transition:color .3s ease;transition:color .3s ease;} .eesrXV a{font-size:1.4rem;font-weight:normal;line-height:1;display:block;padding:1.2rem 3rem 1.2rem 1rem;} .eesrXV li{margin:0;} .eesrXV ul{list-style:none;padding:0;margin:0;position:absolute;top:100%;left:0;background-color:#108db8;display:none;width:120px;padding:10px 0;} .eesrXV ul.show{display:inline-block;} @media only screen and (max-width:920px){.eesrXV{display:inline;}}
/* sc-component-id: sc-ifAKCX */
.gkZsHu{position:absolute;top:0;left:50%;top:50%;font-size:1.6rem;color:#fff;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%);font-weight:normal;cursor:pointer;} .gkZsHu:hover{color:#fff!important;}
/* sc-component-id: sc-dnqmqq */
.Riikb{position:relative;width:80%;max-width:710px;margin:4rem auto;padding-bottom:4rem;border-bottom:1px solid #ebf2f6;word-wrap:break-word;} .Riikb::after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:0 0 0 5px #fff;} .Riikb .read-more{-webkit-text-decoration:none;text-decoration:none;} .Riikb .author-thumb{width:24px;height:24px;float:left;margin-right:9px;border-radius:100%;} .Riikb .post-header{margin-bottom:3.4rem;} .Riikb .post-title a{-webkit-text-decoration:none;text-decoration:none;} .Riikb .post-meta{display:block;margin:1.75rem 0 0;font-family:Open Sans,sans-serif;font-size:1.5rem;line-height:2.2rem;color:#9eabb3;} .Riikb .post-excerpt p{margin:0;font-size:.9em;line-height:1.7em;} .Riikb .post-meta a{color:#9eabb3;-webkit-text-decoration:none;text-decoration:none;} .Riikb .post-meta a:hover{color:#9eabb3;-webkit-text-decoration:underline;text-decoration:underline;} .Riikb .post-date{display:inline-block;text-transform:uppercase;font-size:1.3rem;white-space:nowrap;} .Riikb .post-date.has-author{margin-left:8px;padding-left:12px;border-left:1px solid #d5dbde;} @media only screen and (max-width:900px){.Riikb{font-size:.95em;}} @media only screen and (max-width:500px){.Riikb{width:auto;margin:2rem 16px;padding-bottom:2rem;line-height:1.65em;}.Riikb .post-excerpt p{font-size:.85em;}.Riikb .post-meta{font-size:1.3rem;margin-top:1rem;}}</style></head><body><div id="root"><div class="sc-bdVaJa bDWFJH" data-reactroot=""><div class="headroom-wrapper"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0)" class="headroom headroom--unfixed"><a class="sc-ifAKCX gkZsHu" aria-current="false" href="https://shjie047.github.io/">开发笔记</a><nav class="sc-bwzfXH fuJRCL"><a class="icon-link" aria-current="false" href="https://shjie047.github.io/"><i class="iconfont icon-home"></i></a><span class="sc-htpNat mvmj"><a aria-current="false" href="https://shjie047.github.io/tags/backend">后端</a><a aria-current="false" href="https://shjie047.github.io/tags/mobile">移动端</a><a aria-current="false" href="https://shjie047.github.io/tags/java">Java</a></span><span class="toggled-popular sc-bxivhb eesrXV"><i class="iconfont icon-popular"></i><ul><li><a aria-current="false" href="https://shjie047.github.io/tags/backend">后端</a></li><li><a aria-current="false" href="https://shjie047.github.io/tags/mobile">移动端</a></li><li><a aria-current="false" href="https://shjie047.github.io/tags/java">Java</a></li></ul></span><a class="archive icon-link" aria-current="false" data-tip="归档" href="https://shjie047.github.io/archives"><i class="iconfont icon-archive"></i></a></nav></div></div><div class="content"><article class="sc-dnqmqq Riikb"><header class="post-header"><h1 class="post-title">OKHttp的调用</h1><section class="post-meta "><time class="post-date" dateTime="2017-03-18">2017/3/18</time><span>, </span><span><span><a aria-current="false" href="https://shjie047.github.io/tags/translate">Translate</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/java">Java</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/okhttp">OKHttp</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/http">HTTP</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/backend">backend</a></span></span></section></header><section class="post-content markdown-body"><div><p><a href="https://github.com/square/okhttp/wiki/Calls" target="_blank">原文地址</a></p><p>HTTP客户端的任务是接受请求和产生响应。理论很简单，但是实战的时候就有点棘手了。</p><h4>Requests</h4><p>每一个HTTP请求都包含一个URL，一个方法（例如，GET，POST）和一些headers。请求同时可以包含一个特定类型的数据流作为body。</p><h4>Responses</h4><p>Response 通过一个一个状态码（例如，200 成功，404未找到），headers，和一个可选的Body来响应请求。</p><h5>重写请求</h5><p>当使用OkHttp发送HTTP请求的时候，可以在高层次描述这个请求：通过这个URL和这些headers来获取响应。为了准确和更高的效率，OKHttp会在发送之前重现请求。
OkHttp将会添加原请求没有的header，包括<code>Content-length</code>,<code>Transfer-Encoding</code>,<code>User-Agent</code>,<code>Host</code>,<code>Connection</code>，<code>Content-Type</code>。除非已经提供了，否则OKHttp回会添加 <code>Acceept-Encoding</code>来压缩响应。如果有Cookie，也会添加<code>Cookie</code>。
有些请求会缓存响应。当被缓存的响应过期后，OKHttp会发送一个有条件的GET请求来获取新的响应，如果新现在的比缓存的响应更新，将会更新缓存过的响应。这要求<code>If-Modified-Since</code>和<code>If-None-Match</code>添加到headers中。</p><h5>重写响应</h5><p>如果透明压缩启用了，OKHttp将会把<code>Content-Encoding</code>和<code>Content-Length</code>从headers中移除，因为他们不是用来解压缩的。
如果条件GET请求成功，从网上下载的响应和缓存的响应根据Spec合并。</p><h5>后续请求</h5><p>当请求的URL被转移了，web server 将会返回一个302的状态码来表示这个文档的新URL，OKHttp将会重定向到新的URL获取最终的响应。
如果响应需要认证，OKHttp将会使用<code>Authenticator</code>（如果提供了一个）来认证。如果认证器提供了凭证，请求回使用凭证重试。</p><h5>重试请求</h5><p>有时连接失败，例如：连接池过期断开链接，或者无法连接服务器。OKHttp会通过不同的可用路由来重试请求。</p><h4>calls</h4><p>通过重写，重定向，继续请求和重试，一个简单的请求可能会产生很多请求和响应。OKHttp使用<code>call</code>建立一个不管多少中间请求和响应的任务模型。总的来说这不多。但是了解代码将会继续工作，不管是URL重定向或者是转移故障其他IP。
call有两种工作方</p><ul><li>同步：线程将会阻塞道到响应可读。</li><li>异步：将请求加入到其他线程的队列，当响应可读诗时，会在其他的线程获取回调。
请求调用可以在任何线程取消。如果调用未完成，这个请求将会失败。当调用取消时，在先请求踢体或者读响应体的代码将会跑出IOException的异常。</li></ul><h5>调度</h5><p>对于同步调用，将会由自身线程控制多少并发请求。太多并发连接浪费资源，太少又回有高延迟。
对于异步来说，Dispatcher实现了最大并发的策略。可以设置没个服务器的最大并发（默认是5）和总体的并发（默认64）。</p></div></section><section class="post-footer"></section></article></div><div class="__react_component_tooltip place-top type-dark " data-id="tooltip"></div></div></div><script type="text/javascript">window.__CSS_CHUNKS__ = {"main":"https://shjie047.github.io/styles.cf83ebce.css"}</script><script type="text/javascript">
                window.__routeInfo = {'path':'post/2017-03-18/calls','templateID':2,'sharedPropsHashes':{},'localProps':null,'allProps':{'post':{'title':'OKHttp\u7684\u8C03\u7528','tags':['Translate','Java','OKHttp','HTTP','backend'],'iso8601Date':'2017-03-18T23:10:03+08:00','basename':'calls','body':'\n\n[\u539F\u6587\u5730\u5740](https://github.com/square/okhttp/wiki/Calls)\n\nHTTP\u5BA2\u6237\u7AEF\u7684\u4EFB\u52A1\u662F\u63A5\u53D7\u8BF7\u6C42\u548C\u4EA7\u751F\u54CD\u5E94\u3002\u7406\u8BBA\u5F88\u7B80\u5355\uFF0C\u4F46\u662F\u5B9E\u6218\u7684\u65F6\u5019\u5C31\u6709\u70B9\u68D8\u624B\u4E86\u3002\n#### Requests\n\u6BCF\u4E00\u4E2AHTTP\u8BF7\u6C42\u90FD\u5305\u542B\u4E00\u4E2AURL\uFF0C\u4E00\u4E2A\u65B9\u6CD5\uFF08\u4F8B\u5982\uFF0CGET\uFF0CPOST\uFF09\u548C\u4E00\u4E9Bheaders\u3002\u8BF7\u6C42\u540C\u65F6\u53EF\u4EE5\u5305\u542B\u4E00\u4E2A\u7279\u5B9A\u7C7B\u578B\u7684\u6570\u636E\u6D41\u4F5C\u4E3Abody\u3002\n#### Responses\nResponse \u901A\u8FC7\u4E00\u4E2A\u4E00\u4E2A\u72B6\u6001\u7801\uFF08\u4F8B\u5982\uFF0C200 \u6210\u529F\uFF0C404\u672A\u627E\u5230\uFF09\uFF0Cheaders\uFF0C\u548C\u4E00\u4E2A\u53EF\u9009\u7684Body\u6765\u54CD\u5E94\u8BF7\u6C42\u3002\n##### \u91CD\u5199\u8BF7\u6C42\n\u5F53\u4F7F\u7528OkHttp\u53D1\u9001HTTP\u8BF7\u6C42\u7684\u65F6\u5019\uFF0C\u53EF\u4EE5\u5728\u9AD8\u5C42\u6B21\u63CF\u8FF0\u8FD9\u4E2A\u8BF7\u6C42\uFF1A\u901A\u8FC7\u8FD9\u4E2AURL\u548C\u8FD9\u4E9Bheaders\u6765\u83B7\u53D6\u54CD\u5E94\u3002\u4E3A\u4E86\u51C6\u786E\u548C\u66F4\u9AD8\u7684\u6548\u7387\uFF0COKHttp\u4F1A\u5728\u53D1\u9001\u4E4B\u524D\u91CD\u73B0\u8BF7\u6C42\u3002\nOkHttp\u5C06\u4F1A\u6DFB\u52A0\u539F\u8BF7\u6C42\u6CA1\u6709\u7684header\uFF0C\u5305\u62EC`Content-length`,`Transfer-Encoding`,`User-Agent`,`Host`,`Connection`\uFF0C`Content-Type`\u3002\u9664\u975E\u5DF2\u7ECF\u63D0\u4F9B\u4E86\uFF0C\u5426\u5219OKHttp\u56DE\u4F1A\u6DFB\u52A0 `Acceept-Encoding`\u6765\u538B\u7F29\u54CD\u5E94\u3002\u5982\u679C\u6709Cookie\uFF0C\u4E5F\u4F1A\u6DFB\u52A0`Cookie`\u3002\n\u6709\u4E9B\u8BF7\u6C42\u4F1A\u7F13\u5B58\u54CD\u5E94\u3002\u5F53\u88AB\u7F13\u5B58\u7684\u54CD\u5E94\u8FC7\u671F\u540E\uFF0COKHttp\u4F1A\u53D1\u9001\u4E00\u4E2A\u6709\u6761\u4EF6\u7684GET\u8BF7\u6C42\u6765\u83B7\u53D6\u65B0\u7684\u54CD\u5E94\uFF0C\u5982\u679C\u65B0\u73B0\u5728\u7684\u6BD4\u7F13\u5B58\u7684\u54CD\u5E94\u66F4\u65B0\uFF0C\u5C06\u4F1A\u66F4\u65B0\u7F13\u5B58\u8FC7\u7684\u54CD\u5E94\u3002\u8FD9\u8981\u6C42`If-Modified-Since`\u548C`If-None-Match`\u6DFB\u52A0\u5230headers\u4E2D\u3002\n##### \u91CD\u5199\u54CD\u5E94\n\u5982\u679C\u900F\u660E\u538B\u7F29\u542F\u7528\u4E86\uFF0COKHttp\u5C06\u4F1A\u628A`Content-Encoding`\u548C`Content-Length`\u4ECEheaders\u4E2D\u79FB\u9664\uFF0C\u56E0\u4E3A\u4ED6\u4EEC\u4E0D\u662F\u7528\u6765\u89E3\u538B\u7F29\u7684\u3002\n\u5982\u679C\u6761\u4EF6GET\u8BF7\u6C42\u6210\u529F\uFF0C\u4ECE\u7F51\u4E0A\u4E0B\u8F7D\u7684\u54CD\u5E94\u548C\u7F13\u5B58\u7684\u54CD\u5E94\u6839\u636ESpec\u5408\u5E76\u3002\n##### \u540E\u7EED\u8BF7\u6C42\n\u5F53\u8BF7\u6C42\u7684URL\u88AB\u8F6C\u79FB\u4E86\uFF0Cweb server \u5C06\u4F1A\u8FD4\u56DE\u4E00\u4E2A302\u7684\u72B6\u6001\u7801\u6765\u8868\u793A\u8FD9\u4E2A\u6587\u6863\u7684\u65B0URL\uFF0COKHttp\u5C06\u4F1A\u91CD\u5B9A\u5411\u5230\u65B0\u7684URL\u83B7\u53D6\u6700\u7EC8\u7684\u54CD\u5E94\u3002\n\u5982\u679C\u54CD\u5E94\u9700\u8981\u8BA4\u8BC1\uFF0COKHttp\u5C06\u4F1A\u4F7F\u7528`Authenticator`\uFF08\u5982\u679C\u63D0\u4F9B\u4E86\u4E00\u4E2A\uFF09\u6765\u8BA4\u8BC1\u3002\u5982\u679C\u8BA4\u8BC1\u5668\u63D0\u4F9B\u4E86\u51ED\u8BC1\uFF0C\u8BF7\u6C42\u56DE\u4F7F\u7528\u51ED\u8BC1\u91CD\u8BD5\u3002\n##### \u91CD\u8BD5\u8BF7\u6C42\n\u6709\u65F6\u8FDE\u63A5\u5931\u8D25\uFF0C\u4F8B\u5982\uFF1A\u8FDE\u63A5\u6C60\u8FC7\u671F\u65AD\u5F00\u94FE\u63A5\uFF0C\u6216\u8005\u65E0\u6CD5\u8FDE\u63A5\u670D\u52A1\u5668\u3002OKHttp\u4F1A\u901A\u8FC7\u4E0D\u540C\u7684\u53EF\u7528\u8DEF\u7531\u6765\u91CD\u8BD5\u8BF7\u6C42\u3002\n#### calls\n\u901A\u8FC7\u91CD\u5199\uFF0C\u91CD\u5B9A\u5411\uFF0C\u7EE7\u7EED\u8BF7\u6C42\u548C\u91CD\u8BD5\uFF0C\u4E00\u4E2A\u7B80\u5355\u7684\u8BF7\u6C42\u53EF\u80FD\u4F1A\u4EA7\u751F\u5F88\u591A\u8BF7\u6C42\u548C\u54CD\u5E94\u3002OKHttp\u4F7F\u7528`call`\u5EFA\u7ACB\u4E00\u4E2A\u4E0D\u7BA1\u591A\u5C11\u4E2D\u95F4\u8BF7\u6C42\u548C\u54CD\u5E94\u7684\u4EFB\u52A1\u6A21\u578B\u3002\u603B\u7684\u6765\u8BF4\u8FD9\u4E0D\u591A\u3002\u4F46\u662F\u4E86\u89E3\u4EE3\u7801\u5C06\u4F1A\u7EE7\u7EED\u5DE5\u4F5C\uFF0C\u4E0D\u7BA1\u662FURL\u91CD\u5B9A\u5411\u6216\u8005\u662F\u8F6C\u79FB\u6545\u969C\u5176\u4ED6IP\u3002\ncall\u6709\u4E24\u79CD\u5DE5\u4F5C\u65B9\n   * \u540C\u6B65\uFF1A\u7EBF\u7A0B\u5C06\u4F1A\u963B\u585E\u9053\u5230\u54CD\u5E94\u53EF\u8BFB\u3002\n   * \u5F02\u6B65\uFF1A\u5C06\u8BF7\u6C42\u52A0\u5165\u5230\u5176\u4ED6\u7EBF\u7A0B\u7684\u961F\u5217\uFF0C\u5F53\u54CD\u5E94\u53EF\u8BFB\u8BD7\u65F6\uFF0C\u4F1A\u5728\u5176\u4ED6\u7684\u7EBF\u7A0B\u83B7\u53D6\u56DE\u8C03\u3002\n\u8BF7\u6C42\u8C03\u7528\u53EF\u4EE5\u5728\u4EFB\u4F55\u7EBF\u7A0B\u53D6\u6D88\u3002\u5982\u679C\u8C03\u7528\u672A\u5B8C\u6210\uFF0C\u8FD9\u4E2A\u8BF7\u6C42\u5C06\u4F1A\u5931\u8D25\u3002\u5F53\u8C03\u7528\u53D6\u6D88\u65F6\uFF0C\u5728\u5148\u8BF7\u6C42\u8E22\u4F53\u6216\u8005\u8BFB\u54CD\u5E94\u4F53\u7684\u4EE3\u7801\u5C06\u4F1A\u8DD1\u51FAIOException\u7684\u5F02\u5E38\u3002\n##### \u8C03\u5EA6\n\u5BF9\u4E8E\u540C\u6B65\u8C03\u7528\uFF0C\u5C06\u4F1A\u7531\u81EA\u8EAB\u7EBF\u7A0B\u63A7\u5236\u591A\u5C11\u5E76\u53D1\u8BF7\u6C42\u3002\u592A\u591A\u5E76\u53D1\u8FDE\u63A5\u6D6A\u8D39\u8D44\u6E90\uFF0C\u592A\u5C11\u53C8\u56DE\u6709\u9AD8\u5EF6\u8FDF\u3002\n\u5BF9\u4E8E\u5F02\u6B65\u6765\u8BF4\uFF0CDispatcher\u5B9E\u73B0\u4E86\u6700\u5927\u5E76\u53D1\u7684\u7B56\u7565\u3002\u53EF\u4EE5\u8BBE\u7F6E\u6CA1\u4E2A\u670D\u52A1\u5668\u7684\u6700\u5927\u5E76\u53D1\uFF08\u9ED8\u8BA4\u662F5\uFF09\u548C\u603B\u4F53\u7684\u5E76\u53D1\uFF08\u9ED8\u8BA464\uFF09\u3002\n','date':'2017-03-18'}},'siteData':{'title':'React Static'}};</script><script defer="" type="text/javascript" src="https://shjie047.github.io/bootstrap.a25244d8.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/templates/src/containers/Post.cc5410cf.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/main.c29bfb10.js"></script></body></html>