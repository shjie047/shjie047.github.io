<!DOCTYPE html><html lang="en" data-reactroot=""><head><title data-react-helmet="true">代码拾遗 - 更懂代码的媒体</title><meta data-react-helmet="true" name="title" content="代码拾遗 - 更懂代码的媒体"/><meta data-react-helmet="true" property="og:description" content="原文地址

使用Golang来创建Web项目是一件很麻烦的事情。如果你使用Rails，那么你可能不会有这个感触。我在Refer Madness中使用了下面这个架构。

bash
-public/
-views/
-..."/><meta data-react-helmet="true" property="og:title" content="Go Web 架构"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="description" content="原文地址

使用Golang来创建Web项目是一件很麻烦的事情。如果你使用Rails，那么你可能不会有这个感触。我在Refer Madness中使用了下面这个架构。

bash
-public/
-views/
-..."/><meta data-react-helmet="true" name="keywords" content="Go,Architecture,Translate,Backend,Web"/><link rel="preload" as="script" href="https://shjie047.github.io/bootstrap.d5ea8805.js"/><link rel="preload" as="script" href="https://shjie047.github.io/templates/src/containers/Post.5710f9d8.js"/><link rel="preload" as="script" href="https://shjie047.github.io/main.1a92e948.js"/><link rel="preload" as="style" href="https://shjie047.github.io/styles.b4b608e0.css"/><link rel="stylesheet" href="https://shjie047.github.io/styles.b4b608e0.css"/><link data-react-helmet="true" rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAABe3PX/Y972/2nf9v9v4Pb/cuD3/3bh9/954fj/e+L4/3ri+f954fj/duH3/3Lg9/9u4Pb/ad/1/2Td9v9d3PX/ZN32/2rf9v9w4Pf/duH3/3vi+P9/4/f/geT4/4Pk+P+C5Pj/guT4/3/j+P964vj/duH4/3Hg9/9r3/b/ZN32/2re9v9x4Pb/d+H4/37j+P+D5fb/h+b2/4vm9/+M5vf/jOb3/4vm9v+H5vb/g+X3/37j9/944ff/ceD2/2nf9/9v4Pb/deH3/37j9/+F5fj/i+X5/4/n+P+U5/n/luj5/5bo+f+V6Pj/j+b4/4vl+P+F5Pj/fuP4/3Xh9/9v4Pf/cuD2/3vi+P+C5Pj/iub4/5Hn+P+Y6fn/nOn6/5/p+/+f6vr/nen6/5no+v+S5vn/iuT4/4Pk+f954/f/ceD3/3fh9/+A4/j/iOX4/5Dm9v+Y6fr/nun5/6Pr+f+m6fj/p+v6/6Pp+P+e6fn/mOv6/5Hp+f+I5ff/gOP3/3bh9/954ff/g+T3/4rk9/+Y7fv/nOf2/6fu+/+x8Pn/ufj9/7Px+f+y9f3/qfP//5fh7/+N3+//jej5/4Lk9/964fj/eeH4/4Pj9v+Q7f//g8fW/2qWn/98qbP/aoWM/3OQl/9tiI7/cY+X/2OCif+Iv8n/ebXD/5Hv//+C4vb/eeH5/3rh+P+D4vX/k/L//3Ssuv9ihY7/d5+p/2eEiv92lJr/VGdp/2yMkf9ffIL/jcrW/3y9y/+P7P7/g+P3/3ri+P954fj/guT3/4rl+P+V6vr/f7zJ/5zc5f+w8f3/vvv//5LByv+p5/D/qvT//5/s+/+U6fv/i+X4/4Hk+P944fj/d+H3/4Dj+P+H5ff/j+b4/57z//+h7vv/o+r5/6bp+P+u9P7/puz6/57o+f+X6Pn/j+b4/4fl+P9/4/j/duH3/3Lg9/984vj/hOT4/4rm+P+Q5fb/l+j4/5zq+v+f6vr/nen4/5zp+f+Y6fn/kef4/4rm+P+D5ff/e+P3/3Pg9v9v3/b/duH3/37j+P+F5Pj/iuX6/4/m+f+U6Pj/luj5/5bp+f+T6Pj/kOb4/4vl+P+E5fj/feP4/3bh+P9v3/f/ad/2/3Dg9/934ff/fuP3/4Tk9/+I5ff/iuX4/4zl+f+N5fr/iuX4/4fl+P+E5Pj/f+P3/3fi9/9w4Pb/ad/2/2Pe9v9q3/b/cOD3/3Xh9/974vf/gOP3/4Lk+P+D5Pj/hOT4/4Lk+P9/4/j/e+L3/3bh9/9x4Pf/at/2/2Td9v9e3PX/Zd32/2re9v9u4Pb/cuD3/3fh9/954fj/euH4/3nh+P944fj/deH3/3Ph9v9v3/f/at72/2Td9v9d3Pb/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><style data-styled-components="enNFoQ fJTUOz jvzENE AjcTS ljxEMT gjHXKT hAbzAj fvIFII jUVlgh epPIZB hGUhQB">
/* sc-component-id: sc-bdVaJa */
.AjcTS{position:absolute;width:100%;} .AjcTS.fixed{position:fixed;background:#fff;top:-65px;z-index:800;border-bottom:1px solid #e1e1e1;} .AjcTS .logo{background-image:url(https://shjie047.github.io/static/logo.2b22c228.png);} .AjcTS.frontend,.AjcTS.frontend > *{background-color:#108db8!important;} .AjcTS.backend,.AjcTS.backend > *{background-color:rgba(0,100,0,1)!important;} .AjcTS.mobile,.AjcTS.mobile > *{background-color:rgb(219,112,147)!important;} .AjcTS.mobile nav a,.AjcTS.frontend nav a,.AjcTS.backend nav a{color:#fff;} .AjcTS.mobile .logo,.AjcTS.frontend .logo,.AjcTS.backend .logo{background-image:url(https://shjie047.github.io/static/codemore_white.2439fcc8.png);}
/* sc-component-id: sc-bwzfXH */
.gjHXKT{height:50px;max-width:1000px;margin:0 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:#fff;} .gjHXKT.fixed{position:fixed;left:0;right:0;top:0;border-bottom:1px solid #f1f1f1;} .gjHXKT.showBorder{border-bottom:1px solid #e7e7e7;} @media only screen and (max-width:400px){.gjHXKT{padding:0 20px;}} .gjHXKT a{font-size:1.6rem;font-weight:normal;} .gjHXKT .icon-link{font-size:1.8rem;} .gjHXKT .icon-btn{-webkit-apparance:none;background-color:transparent;border:none;outline:none;color:#fff;cursor:pointer;}
/* sc-component-id: sc-htpNat */
@media only screen and (max-width:920px){.hAbzAj{display:none;}} .hAbzAj a{font-size:1.5rem;} .hAbzAj::before{content:'';height:2.1rem;width:1px;background-color:#00000038;display:inline-block;vertical-align:middle;}
/* sc-component-id: sc-bxivhb */
.fvIFII{margin-left:auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;overflow:hidden;} .fvIFII .search{cursor:pointer;margin-left:10px;} .fvIFII .search i{font-size:20px;}
/* sc-component-id: sc-keyframes-enNFoQ */
@-webkit-keyframes enNFoQ{0%{opacity:0;bottom:100%;}100%{opacity:1;bottom:0;}} @keyframes enNFoQ{0%{opacity:0;bottom:100%;}100%{opacity:1;bottom:0;}}
/* sc-component-id: sc-bZQynM */
.jUVlgh::after{content:'';display:table;} @media screen and (max-width:717px){.jUVlgh{padding:1rem;}}
/* sc-component-id: sc-keyframes-fJTUOz */
@-webkit-keyframes fJTUOz{0%{width:0px;padding:4px 0;}100%{width:160px;padding:4px 5px;}} @keyframes fJTUOz{0%{width:0px;padding:4px 0;}100%{width:160px;padding:4px 5px;}}
/* sc-component-id: sc-htoDjs */
.ljxEMT{position:absolute;top:0;left:50%;top:50%;color:#fff;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%);background-repeat:no-repeat;background-size:100% auto;width:10rem;height:2.5rem;}
/* sc-component-id: sc-iwsKbI */
.epPIZB{position:relative;width:80%;max-width:740px;margin:4rem auto;padding-bottom:4rem;border-bottom:1px solid #ebf2f6;word-wrap:break-word;} .epPIZB::after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:0 0 0 5px #fff;} .epPIZB .read-more{-webkit-text-decoration:none;text-decoration:none;} .epPIZB .author-thumb{width:24px;height:24px;float:left;margin-right:9px;border-radius:100%;} .epPIZB .post-header{margin-bottom:3.4rem;} .epPIZB .post-title a{-webkit-text-decoration:none;text-decoration:none;} .epPIZB .post-meta{display:block;margin:1.75rem 0 0;font-family:Open Sans,sans-serif;font-size:1.5rem;line-height:2.2rem;color:#9eabb3;} .epPIZB .post-excerpt p{margin:0;font-size:.9em;line-height:1.7em;} .epPIZB .post-meta a{color:#9eabb3;-webkit-text-decoration:none;text-decoration:none;} .epPIZB .post-meta a:hover{color:#9eabb3;-webkit-text-decoration:underline;text-decoration:underline;} .epPIZB .post-date{display:inline-block;text-transform:uppercase;font-size:1.3rem;white-space:nowrap;} .epPIZB .post-date.has-author{margin-left:8px;padding-left:12px;border-left:1px solid #d5dbde;} @media only screen and (max-width:900px){.epPIZB{font-size:.95em;}} @media only screen and (max-width:500px){.epPIZB{width:auto;margin:2rem 16px;padding-bottom:2rem;line-height:1.65em;}.epPIZB .post-excerpt p{font-size:.85em;}.epPIZB .post-meta{font-size:1.3rem;margin-top:1rem;}.epPIZB pre{padding:0!important;}} .epPIZB pre{padding:1.2rem;} .epPIZB pre > code{overflow-x:auto;box-shadow:0 0 15px rgba(0,0,0,.35);padding:1.5rem;} .epPIZB blockquote{border-left:3px solid #061e35!important;margin-left:-23px!important;padding-bottom:2px!important;padding-left:20px!important;color:#24292e!important;} .epPIZB blockquote p{color:#24292e!important;} .epPIZB blockquote a{color:#061e35!important;}
/* sc-component-id: sc-gZMcBi */
.hGUhQB{position:fixed;top:50%;-webkit-transform:translate(0,-50%);-ms-transform:translate(0,-50%);transform:translate(0,-50%);right:3rem;} .hGUhQB h3{font-size:16px;font-weight:400!important;} .hGUhQB ul{font-weight:300!important;margin:0;padding:0;font-size:12px;padding-left:3rem;padding-top:.2rem;} .hGUhQB li{max-width:160px;}</style></head><body><div id="root"><div class="sc-EHOje jvzENE" data-reactroot=""><div class="sc-bdVaJa AjcTS"><div style="max-width:1000px;margin:0 auto;background:#fff;height:65px;position:relative"><div class="logo sc-htoDjs ljxEMT"></div></div><nav class="main-nav sc-bwzfXH gjHXKT"><a class="icon-link" aria-current="false" href="https://shjie047.github.io/"><i class="iconfont icon-home"></i></a><span class="sc-htpNat hAbzAj"><a aria-current="false" href="https://shjie047.github.io/cates/frontend">前端</a><a aria-current="false" href="https://shjie047.github.io/cates/backend">后端</a><a aria-current="false" href="https://shjie047.github.io/cates/mobile">移动端</a></span><div class="sc-bxivhb fvIFII"><a class="archive icon-link" aria-current="false" data-tip="归档" data-for="tip-one" href="https://shjie047.github.io/archives"><i class="iconfont icon-archive"></i></a><a class="search"><i class="iconfont icon-search"></i></a></div></nav></div><div style="height:115px"></div><div class="sc-bZQynM jUVlgh"><article class="sc-iwsKbI epPIZB"><header class="post-header"><h1 class="post-title">Go Web 架构</h1><section class="post-meta "><time class="post-date" dateTime="2015-11-11">2015/11/11</time><span>, </span><span><span><a aria-current="false" href="https://shjie047.github.io/tags/Go">Go</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/Architecture">Architecture</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/Translate">Translate</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/Backend">Backend</a><span>, </span></span><span><a aria-current="false" href="https://shjie047.github.io/tags/Web">Web</a></span></span></section><div style="max-width:1000px;max-height:667px;margin:3rem 0"><img style="width:100%;height:100%;left:0;top:0;margin:auto" class="cover" src="http://p6jqy6mfr.bkt.clouddn.com/stock-photo-251622641.jpg" alt=""/></div></header><section class="post-content markdown-body"><div><p><a href="https://larry-price.com/blog/2015/06/25/architecture-for-a-golang-web-app" target="_blank">原文地址</a></p><p>使用Golang来创建Web项目是一件很麻烦的事情。如果你使用Rails，那么你可能不会有这个感触。我在<a href="https://www.refer-madness.com/" target="_blank">Refer Madness</a>中使用了下面这个架构。</p><pre><code class="language-bash">-public/
-views/
-models/
-utils/
-controllers/
-web/
-main.go</code></pre><p>我将打破这个体系，介绍各个目录的作用。在每个目录下，文件只能访问其同级或者上一级。这就意味着<code>utils</code>只能访问他自己和<code>models</code>，<code>web</code>只能访问它自己，<code>controllers</code>，<code>utils</code>，<code>models</code>。<code>models</code>只能访问它自己。我这么做是为了让层次清晰，防止出现递归依赖。现在来分析每一个目录，文件的作用。</p><h4>main.go</h4><p><code>main.go</code>是创建依赖，获取环境变量，启动服务的主要文件。下面是它的实例。</p><pre><code class="language-Go">package main

import (
  &quot;github.com/larryprice/refermadness/utils&quot;
  &quot;github.com/larryprice/refermadness/web&quot;
  &quot;github.com/stretchr/graceful&quot;
  &quot;os&quot;
)

func main() {
  isDevelopment := os.Getenv(&quot;ENVIRONMENT&quot;) == &quot;development&quot;
  dbURL := os.Getenv(&quot;MONGOLAB_URI&quot;)
  if isDevelopment {
    dbURL = os.Getenv(&quot;DB_PORT_27017_TCP_ADDR&quot;)
  }

  dbAccessor := utils.NewDatabaseAccessor(dbURL, os.Getenv(&quot;DATABASE_NAME&quot;), 0)
  cuAccessor := utils.NewCurrentUserAccessor(1)
  s := web.NewServer(*dbAccessor, *cuAccessor, os.Getenv(&quot;GOOGLE_OAUTH2_CLIENT_ID&quot;),
    os.Getenv(&quot;GOOGLE_OAUTH2_CLIENT_SECRET&quot;), os.Getenv(&quot;SESSION_SECRET&quot;),
    isDevelopment, os.Getenv(&quot;GOOGLE_ANALYTICS_KEY&quot;))

  port := os.Getenv(&quot;PORT&quot;)
  if port == &quot;&quot; {
    port = &quot;3000&quot;
  }

  graceful.Run(&quot;:&quot;+port, 0, s)
}</code></pre><p>因为<code>main.go</code>实在最低的层级，所以它可以访问所有的目录：在这个例子里是<code>web</code>和<code>utils</code>。在这里获取了所有的环境变量并把它们注入到合适的地方。在<code>main.go</code>中创建了服务器，注入依赖，并且在配置的端口启动服务器。</p><h4>web</h4><p><code>web</code>目录下是主要的服务代码，同时也包括了中间件代码。下面是<code>web</code>目录的内部结构：</p><pre><code class="language-bash">-web/
|-middleware/
|-server.go</code></pre><p><code>server.go</code>包含了web server的定义。这个web server 创建了所有的web controller并且给negroni添加了中间件。下面是他的例子：</p><pre><code class="language-Go">package web

import (
  &quot;github.com/codegangsta/negroni&quot;
  &quot;github.com/goincremental/negroni-sessions&quot;
  &quot;github.com/goincremental/negroni-sessions/cookiestore&quot;
  &quot;github.com/gorilla/mux&quot;
  &quot;github.com/larryprice/refermadness/controllers&quot;
  &quot;github.com/larryprice/refermadness/utils&quot;
  &quot;github.com/larryprice/refermadness/web/middleware&quot;
  &quot;github.com/unrolled/secure&quot;
  &quot;gopkg.in/unrolled/render.v1&quot;
  &quot;html/template&quot;
  &quot;net/http&quot;
)

type Server struct {
  *negroni.Negroni
}

func NewServer(dba utils.DatabaseAccessor, cua utils.CurrentUserAccessor, clientID, clientSecret,
  sessionSecret string, isDevelopment bool, gaKey string) *Server {
  s := Server{negroni.Classic()}
  session := utils.NewSessionManager()
  basePage := utils.NewBasePageCreator(cua, gaKey)
  renderer := render.New()

  router := mux.NewRouter()

  // ...

  accountController := controllers.NewAccountController(clientID, clientSecret, isDevelopment, session, dba, cua, basePage, renderer)
  accountController.Register(router)

  // ...

  s.Use(sessions.Sessions(&quot;refermadness&quot;, cookiestore.New([]byte(sessionSecret))))
  s.Use(middleware.NewAuthenticator(dba, session, cua).Middleware())
  s.UseHandler(router)
  return &amp;s
}</code></pre><p><code>Server</code>结构体是一个<code>negroni.Negroni</code>的web server，在这个文件里有对<code>utils</code>和其他第三方包的引用，创建了一个router，一些controller，并且将controller注册到当前router。同时也引入了必要的中间件。说到中间件，下面是它的代码：</p><pre><code class="language-Go">package middleware

import (
  &quot;github.com/codegangsta/negroni&quot;
  &quot;github.com/larryprice/refermadness/utils&quot;
  &quot;net/http&quot;
)

type Database struct {
  da utils.DatabaseAccessor
}

func NewDatabase(da utils.DatabaseAccessor) *Database {
  return &amp;Database{da}
}

func (d *Database) Middleware() negroni.HandlerFunc {
  return func(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc) {
    reqSession := d.da.Clone()
    defer reqSession.Close()
    d.da.Set(r, reqSession)
    next(rw, r)
  }
}</code></pre><p>这个是通过HTTP router访问数据库session的标注中间件。基本文件是从<a href="http://modocache.svbtle.com/restful-go" target="_blank">Brian Gesiak’s blog post on RESTful Go</a>中得到，将其修改为适合我的文件。</p><h4>controllers/</h4><p>这里的controller与Rails里的controller的概念很像。Controller注册自己的router，设置自己的函数调用。一个简短的例子如下：</p><pre><code class="language-Go">package controllers

import (
  &quot;encoding/json&quot;
  &quot;errors&quot;
  &quot;github.com/gorilla/mux&quot;
  &quot;github.com/larryprice/refermadness/models&quot;
  &quot;github.com/larryprice/refermadness/utils&quot;
  &quot;gopkg.in/mgo.v2/bson&quot;
  &quot;gopkg.in/unrolled/render.v1&quot;
  &quot;html/template&quot;
  &quot;net/http&quot;
  &quot;strings&quot;
)

type ServiceControllerImpl struct {
  currentUser utils.CurrentUserAccessor
  basePage    utils.BasePageCreator
  renderer    *render.Render
  database    utils.DatabaseAccessor
}

func NewServiceController(currentUser utils.CurrentUserAccessor, basePage utils.BasePageCreator,
  renderer *render.Render, database utils.DatabaseAccessor) *ServiceControllerImpl {
  return &amp;ServiceControllerImpl{
    currentUser: currentUser,
    basePage:    basePage,
    renderer:    renderer,
    database:    database,
  }
}

func (sc *ServiceControllerImpl) Register(router *mux.Router) {
  router.HandleFunc(&quot;/service/{id}&quot;, sc.single)
  // ...
}

// ...

type serviceResult struct {
  *models.Service
  RandomCode *models.ReferralCode
  UserCode   *models.ReferralCode
}

type servicePage struct {
  utils.BasePage
  ResultString string
}

func (sc *ServiceControllerImpl) single(w http.ResponseWriter, r *http.Request) {
  data, err := sc.get(w, r)

  if len(r.Header[&quot;Content-Type&quot;]) == 1 &amp;&amp; strings.Contains(r.Header[&quot;Content-Type&quot;][0], &quot;application/json&quot;) {
    if err != nil {
      sc.renderer.JSON(w, http.StatusBadRequest, map[string]string{
        &quot;error&quot;: err.Error(),
      })
      return
    }
    sc.renderer.JSON(w, http.StatusOK, data)
    return
  } else if err != nil {
    http.Error(w, err.Error(), http.StatusBadRequest)
  }

  resultString, _ := json.Marshal(data)
  t, _ := template.ParseFiles(&quot;views/layout.html&quot;, &quot;views/service.html&quot;)
  t.Execute(w, servicePage{sc.basePage.Get(r), string(resultString)})
}</code></pre><h4>utils/</h4><p>在<code>utils</code>目录下的文件提供了一些底层功能用来支持其他的代码。在这个例子中，主要是定义一个结构体来访问请求的上下文，处理session，定义一个特别的页面来继承。下面是通过访问上下文设置用户的例子：</p><pre><code class="language-Go">package utils

import (
  &quot;github.com/gorilla/context&quot;
  &quot;github.com/larryprice/refermadness/models&quot;
  &quot;net/http&quot;
)

type CurrentUserAccessor struct {
  key int
}

func NewCurrentUserAccessor(key int) *CurrentUserAccessor {
  return &amp;CurrentUserAccessor{key}
}

func (cua *CurrentUserAccessor) Set(r *http.Request, user *models.User) {
  context.Set(r, cua.key, user)
}

func (cua *CurrentUserAccessor) Clear(r *http.Request) {
  context.Delete(r, cua.key)
}

func (cua *CurrentUserAccessor) Get(r *http.Request) *models.User {
  if rv := context.Get(r, cua.key); rv != nil {
    return rv.(*models.User)
  }
  return nil
}</code></pre><h4>models/</h4><p>model 是为了描述数据库中的数据的数据结构。在这个例子中使用model来访问数据库，创建一个空的model，然后通过查询数据库为其赋值。下面是一个例子：</p><pre><code class="language-Go">package models

import (
  &quot;gopkg.in/mgo.v2&quot;
  &quot;gopkg.in/mgo.v2/bson&quot;
  &quot;strings&quot;
  &quot;time&quot;
)

type Service struct {
  // identification information
  ID          bson.ObjectId `bson:&quot;_id&quot;`
  Name        string        `bson:&quot;name&quot;`
  Description string        `bson:&quot;description&quot;`
  URL         string        `bson:&quot;url&quot;`
  Search      string        `bson:&quot;search&quot;`
}

func NewService(name, description, url string, creatorID bson.ObjectId) *Service {
  url = strings.TrimPrefix(strings.TrimPrefix(url, &quot;http://&quot;), &quot;https://&quot;)
  return &amp;Service{
    ID:            bson.NewObjectId(),
    Name:          name,
    URL:           url,
    Description:   description,
    Search:        strings.ToLower(name) + &quot;;&quot; + strings.ToLower(description) + &quot;;&quot; + strings.ToLower(url),
  }
}

func (s *Service) Save(db *mgo.Database) error {
  _, err := s.coll(db).UpsertId(s.ID, s)
  return err
}

func (s *Service) FindByID(id bson.ObjectId, db *mgo.Database) error {
  return s.coll(db).FindId(id).One(s)
}

func (*Service) coll(db *mgo.Database) *mgo.Collection {
  return db.C(&quot;service&quot;)
}

type Services []Service

func (s *Services) FindByIDs(ids []bson.ObjectId, db *mgo.Database) error {
  return s.coll(db).Find(bson.M{&quot;_id&quot;: bson.M{&quot;$in&quot;: ids}}).Sort(&quot;name&quot;).All(s)
}

func (*Services) coll(db *mgo.Database) *mgo.Collection {
  return db.C(&quot;service&quot;)
}</code></pre><h4>views/</h4><p>将Golang的模板文件放到<code>views</code>目录下。这样，不管用什么样的模板引擎都可以直接放到<code>views</code>下。</p><h4>public/</h4><p>跟以前一样，这个文件都是放公开的文件的，例如<code>css</code>,<code>img</code>,<code>scripts</code>。</p><h4>如何运行</h4><p>毫无疑问，我最喜欢的就是<a href="https://www.docker.com/" target="_blank">docker</a>，因此我将使用他来运行这个应用。如果不使用docker，那么可以将文件放到<code>$GOPATH/src/github.com/larryprice/refermadness</code>,运行<code>go get</code>来获取所有的依赖，然后运行 <code>go run main.go</code>或者<code>go build; ./refermadness</code>运行程序。如果你也喜欢使用docker，那么可以直接通过<code>Dockerfile</code>来运行。</p><pre><code class="language-bash">FROM golang:1.4

RUN go get github.com/codegangsta/gin

ADD . /go/src/github.com/larryprice/refermadness
WORKDIR /go/src/github.com/larryprice/refermadness
RUN go get</code></pre><p>同时我也很喜欢<a href="https://github.com/docker/compose" target="_blank">compose</a>，所以我也通过compose 文件来运行所有的应用。我用了JSC ，SASS和mongodb，所以一下是我的<code>docker-compose.yml</code>文件。</p><pre><code class="language-Go">main:
  build: .
  command: gin run
  env_file: .env
  volumes:
    - ./:/go/src/github.com/larryprice/refermadness
  working_dir: /go/src/github.com/larryprice/refermadness
  ports:
    - &quot;3000:3000&quot;
  links:
    - db
sass:
  image: larryprice/sass
  volumes:
    - ./public/css:/src
jsx:
  image: larryprice/jsx
  volumes:
    - ./public/scripts:/src
db:
  image: mongo:3.0
  command: mongod --smallfiles --quiet --logpath=/dev/null
  volumes_from:
    - dbvolume
dbvolume:
  image: busybox:ubuntu-14.04
  volumes:
    - /data/db</code></pre><p>然后运行<code>docker-compose up</code>来运行所有的容器并启动服务器。</p></div></section><section class="post-footer"></section><div class="sc-gZMcBi hGUhQB"><h3>相关阅读:</h3><ul><li><a aria-current="false" href="https://shjie047.github.io/cates/Backend/post/2015-11-12/HTTP-2-And-GO">HTTP/2 和GO</a></li><li><a aria-current="false" href="https://shjie047.github.io/cates/Backend/post/2015-11-15/create-a-homepage-for-Go-Web-App">为Go Web App 创建一个主页面</a></li><li><a aria-current="false" href="https://shjie047.github.io/cates/Backend/post/2015-11-12/develop-HTTP-middleware-using-Go">使用Go开发HTTP中间件</a></li><li><a aria-current="false" href="https://shjie047.github.io/cates/Backend/post/2015-11-13/http-Handler-And-Go-error-handle">http.Handler 与Go的错误处理</a></li></ul></div></article></div><div class="__react_component_tooltip place-top type-dark " data-id="tooltip"></div><div class="__react_component_tooltip place-top type-dark " data-id="tooltip"></div></div></div><script type="text/javascript">window.__CSS_CHUNKS__ = {"main":"https://shjie047.github.io/styles.b4b608e0.css"}</script><script type="text/javascript">
                window.__routeInfo = {'path':'cates/Backend/post/2015-11-11/Go-Web-architecture','templateID':1,'sharedPropsHashes':{'tags':'Zpc8p0'},'localProps':null,'allProps':{'post':{'title':'Go Web \u67B6\u6784','cover':'http://p6jqy6mfr.bkt.clouddn.com/stock-photo-251622641.jpg','iso8601Date':'2015-11-11T03:01:21+08:00','basename':'Go-Web-architecture','tags':['Go','Architecture','Translate','Backend','Web'],'date':'2015-11-11','cate':'Backend','summary':'\u539F\u6587\u5730\u5740\n\n\u4F7F\u7528Golang\u6765\u521B\u5EFAWeb\u9879\u76EE\u662F\u4E00\u4EF6\u5F88\u9EBB\u70E6\u7684\u4E8B\u60C5\u3002\u5982\u679C\u4F60\u4F7F\u7528Rails\uFF0C\u90A3\u4E48\u4F60\u53EF\u80FD\u4E0D\u4F1A\u6709\u8FD9\u4E2A\u611F\u89E6\u3002\u6211\u5728Refer Madness\u4E2D\u4F7F\u7528\u4E86\u4E0B\u9762\u8FD9\u4E2A\u67B6\u6784\u3002\n\nbash\n-public/\n-views/\n-models/\n-utils/\n-controllers/\n-web/\n-main.go\n\n\n\u6211\u5C06\u6253\u7834\u8FD9\u4E2A\u4F53\u7CFB\uFF0C\u4ECB\u7ECD\u5404\u4E2A\u76EE\u5F55\u7684\u4F5C\u7528\u3002\u5728\u6BCF\u4E2A\u76EE\u5F55\u4E0B\uFF0C\u6587\u4EF6\u53EA\u80FD\u8BBF\u95EE\u5176\u540C\u7EA7\u6216\u8005\u4E0A\u4E00\u7EA7\u3002\u8FD9\u5C31\u610F\u5473\u7740utils\u53EA\u80FD\u8BBF\u95EE\u4ED6\u81EA\u5DF1\u548Cmodels\uFF0Cweb\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\uFF0Ccontrollers\uFF0Cutils\uFF0Cmodels\u3002models\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\u3002\u6211\u8FD9\u4E48\u505A\u662F\u4E3A\u4E86\u8BA9\u5C42\u6B21\u6E05\u6670\uFF0C\u9632\u6B62\u51FA\u73B0\u9012\u5F52\u4F9D\u8D56\u3002\u73B0\u5728\u6765\u5206\u6790\u6BCF\u4E00\u4E2A\u76EE\u5F55\uFF0C\u6587\u4EF6\u7684\u4F5C\u7528\u3002\n\nmain.go\n\nmain.go\u662F\u521B\u5EFA\u4F9D\u8D56\uFF0C\u83B7\u53D6\u73AF\u5883\u53D8\u91CF\uFF0C\u542F\u52A8\u670D\u52A1\u7684\u4E3B\u8981\u6587\u4EF6\u3002\u4E0B\u9762\u662F\u5B83\u7684\u5B9E\u4F8B\u3002\n\n`Go\npackage main\n\nimport (\n  &quot;github.com/larryprice/refermadness/utils&quot;\n  &quot;github.com/larryprice/refermadness/web&quot;\n  &quot;github.com/stretchr/graceful&quot;\n  &quot;os&quot;\n)\n\nfunc main() {\n  isDevelopment := os.Getenv(&quot;ENVIRONMENT&quot;) == &quot;development&quot;\n  dbURL := os.Getenv(&quot;MONGOLABURI&quot;)\n  if isDevelopment {\n    dbURL = os.Getenv(&quot;DBPORT27017TCP_ADDR&quot;)\n  }\n\n  dbAccessor := utils.NewDatabaseAccessor(dbURL, os.Getenv(&quot;DATABASE_NAME&quot;), 0)\n  cuAccessor := utils.NewCurrentUserAccessor(1)\n  s := web.NewServer(dbAccessor, cuAccessor, os.Getenv(&quot;GOOGLEOAUTH2CLIENTID&quot;),\n    os.Getenv(&quot;GOOGLEOAUTH2CLIENTSECRET&quot;), os.Getenv(&quot;SESSIONSECRET&quot;),\n    isDevelopment, os.Getenv(&quot;GOOGLEANALYTICS_KEY&quot;))\n\n  port := os.Getenv(&quot;PORT&quot;)\n  if port == &quot;&quot; {\n    port = &quot;3000&quot;\n  }\n\n  graceful.Run(&quot;:&quot;+port, 0, s)\n}\n\n`\n\n\u56E0\u4E3Amain.go\u5B9E\u5728\u6700\u4F4E\u7684\u5C42\u7EA7\uFF0C\u6240\u4EE5\u5B83\u53EF\u4EE5\u8BBF\u95EE\u6240\u6709\u7684\u76EE\u5F55\uFF1A\u5728\u8FD9\u4E2A\u4F8B\u5B50\u91CC\u662Fweb\u548Cutils\u3002\u5728\u8FD9\u91CC\u83B7\u53D6\u4E86\u6240\u6709\u7684\u73AF\u5883\u53D8\u91CF\u5E76\u628A\u5B83\u4EEC\u6CE8\u5165\u5230\u5408\u9002\u7684\u5730\u65B9\u3002\u5728main.go\u4E2D\u521B\u5EFA\u4E86\u670D\u52A1\u5668\uFF0C\u6CE8\u5165\u4F9D\u8D56\uFF0C\u5E76\u4E14\u5728\u914D\u7F6E\u7684\u7AEF\u53E3\u542F\u52A8\u670D\u52A1\u5668\u3002\n\nweb\n\nweb\u76EE\u5F55\u4E0B\u662F\u4E3B\u8981\u7684\u670D\u52A1\u4EE3\u7801\uFF0C\u540C\u65F6\u4E5F\u5305\u62EC\u4E86\u4E2D\u95F4\u4EF6\u4EE3\u7801\u3002\u4E0B\u9762\u662Fweb\u76EE\u5F55\u7684\u5185\u90E8\u7ED3\u6784\uFF1A\n\nbash\n-web/\n|-middleware/\n|-server.go\n\n\nserver.go\u5305\u542B\u4E86web server\u7684\u5B9A\u4E49\u3002\u8FD9\u4E2Aweb server \u521B\u5EFA\u4E86\u6240\u6709\u7684web controller\u5E76\u4E14\u7ED9negroni\u6DFB\u52A0\u4E86\u4E2D\u95F4\u4EF6\u3002\u4E0B\u9762\u662F\u4ED6\u7684\u4F8B\u5B50\uFF1A\n\n`Go\npackage web\n\nimport (\n  &quot;github.com/codegangsta/negroni&quot;\n  &quot;github.com/goincremental/negroni-sessions&quot;\n  &quot;github.com/goincremental/negroni-sessions/cookiestore&quot;\n  &quot;github.com/gorilla/mux&quot;\n  &quot;github.com/larryprice/refermadness/controllers&quot;\n  &quot;github.com/larryprice/refermadness/utils&quot;\n  &quot;github.com/larryprice/refermadness/web/middleware&quot;\n  &quot;github.com/unrolled/secure&quot;\n  &quot;gopkg.in/unrolled/render.v1&quot;\n  &quot;html/template&quot;\n  &quot;net/http&quot;\n)\n\ntype Server struct {\n  *negroni.Negroni\n}\n\nfunc NewServer(dba utils.DatabaseAccessor, cua utils.CurrentUserAccessor, clientID, clientSecret,\n  sessionSecret string, isDevelopment bool, gaKey string) *Server {\n  s := Server{negroni.Classic()}\n  session := utils.NewSessionManager()\n  basePage := utils.NewBasePageCreator(cua, gaKey)\n  renderer := render.New()\n\n  router := mux.NewRouter()\n\n  // ...\n\n  accountController := controllers.NewAccountController(clientID, clientSecret, isDevelopment, session, dba, cua, basePage, renderer)\n  accountController.Register(router)\n\n  // ...\n\n  s.Use(sessions.Sessions(&quot;refermadness&quot;, cookiestore.New([]byte(sessionSecret))))\n  s.Use(middleware.NewAuthenticator(dba, session, cua).Middleware())\n  s.UseHandler(router)\n  return &amp;s\n}\n`\n\nServer\u7ED3\u6784\u4F53\u662F\u4E00\u4E2Anegroni.Negroni\u7684web server\uFF0C\u5728\u8FD9\u4E2A\u6587\u4EF6\u91CC\u6709\u5BF9utils\u548C\u5176\u4ED6\u7B2C\u4E09\u65B9\u5305\u7684\u5F15\u7528\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2Arouter\uFF0C\u4E00\u4E9Bcontroller\uFF0C\u5E76\u4E14\u5C06controller\u6CE8\u518C\u5230\u5F53\u524Drouter\u3002\u540C\u65F6\u4E5F\u5F15\u5165\u4E86\u5FC5\u8981\u7684\u4E2D\u95F4\u4EF6\u3002\u8BF4\u5230\u4E2D\u95F4\u4EF6\uFF0C\u4E0B\u9762\u662F\u5B83\u7684\u4EE3\u7801\uFF1A\n\n`Go\npackage middleware\n\nimport (\n  &quot;github.com/codegangsta/negroni&quot;\n  &quot;github.com/larryprice/refermadness/utils&quot;\n  &quot;net/http&quot;\n)\n\ntype Database struct {\n  da utils.DatabaseAccessor\n}\n\nfunc NewDatabase(da utils.DatabaseAccessor) *Database {\n  return &amp;Database{da}\n}\n\nfunc (d Database) Middleware() negroni.HandlerFunc {\n  return func(rw http.ResponseWriter, r http.Request, next http.HandlerFunc) {\n    reqSession := d.da.Clone()\n    defer reqSession.Close()\n    d.da.Set(r, reqSession)\n    next(rw, r)\n  }\n}\n`\n\n\u8FD9\u4E2A\u662F\u901A\u8FC7HTTP router\u8BBF\u95EE\u6570\u636E\u5E93session\u7684\u6807\u6CE8\u4E2D\u95F4\u4EF6\u3002\u57FA\u672C\u6587\u4EF6\u662F\u4ECEBrian Gesiak\u2019s blog post on RESTful Go\u4E2D\u5F97\u5230\uFF0C\u5C06\u5176\u4FEE\u6539\u4E3A\u9002\u5408\u6211\u7684\u6587\u4EF6\u3002\n\ncontrollers/\n\n\u8FD9\u91CC\u7684controller\u4E0ERails\u91CC\u7684controller\u7684\u6982\u5FF5\u5F88\u50CF\u3002Controller\u6CE8\u518C\u81EA\u5DF1\u7684router\uFF0C\u8BBE\u7F6E\u81EA\u5DF1\u7684\u51FD\u6570\u8C03\u7528\u3002\u4E00\u4E2A\u7B80\u77ED\u7684\u4F8B\u5B50\u5982\u4E0B\uFF1A\n\n`Go\npackage controllers\n\nimport (\n  &quot;encoding/json&quot;\n  &quot;errors&quot;\n  &quot;github.com/gorilla/mux&quot;\n  &quot;github.com/larryprice/refermadness/models&quot;\n  &quot;github.com/larryprice/refermadness/utils&quot;\n  &quot;gopkg.in/mgo.v2/bson&quot;\n  &quot;gopkg.in/unrolled/render.v1&quot;\n  &quot;html/template&quot;\n  &quot;net/http&quot;\n  &quot;strings&quot;\n)\n\ntype ServiceControllerImpl struct {\n  currentUser utils.CurrentUserAccessor\n  basePage    utils.BasePageCreator\n  renderer    *render.Render\n  database    utils.DatabaseAccessor\n}\n\nfunc NewServiceController(currentUser utils.CurrentUserAccessor, basePage utils.BasePageCreator,\n  renderer render.Render, database utils.DatabaseAccessor) ServiceControllerImpl {\n  return &amp;ServiceControllerImpl{\n    currentUser: currentUser,\n    basePage:    basePage,\n    renderer:    renderer,\n    database:    database,\n  }\n}\n\nfunc (sc ServiceControllerImpl) Register(router mux.Router) {\n  router.HandleFunc(&quot;/service/{id}&quot;, sc.single)\n  // ...\n}\n\n// ...\n\ntype serviceResult struct {\n  models.Service\n  RandomCode models.ReferralCode\n  UserCode   *models.ReferralCode\n}\n\ntype servicePage struct {\n  utils.BasePage\n  ResultString string\n}\n\nfunc (sc ServiceControllerImpl) single(w http.ResponseWriter, r http.Request) {\n  data, err := sc.get(w, r)\n\n  if len(r.Header[&quot;Content-Type&quot;]) == 1 &amp;&amp; strings.Contains(r.Header[&quot;Content-Type&quot;][0], &quot;application/json&quot;) {\n    if err != nil {\n      sc.renderer.JSON(w, http.StatusBadRequest, map[string]string{\n        &quot;error&quot;: err.Error(),\n      })\n      return\n    }\n    sc.renderer.JSON(w, http.StatusOK, data)\n    return\n  } else if err != nil {\n    http.Error(w, err.Error(), http.StatusBadRequest)\n  }\n\n  resultString,  := json.Marshal(data)\n  t,  := template.ParseFiles(&quot;views/layout.html&quot;, &quot;views/service.html&quot;)\n  t.Execute(w, servicePage{sc.basePage.Get(r), string(resultString)})\n}\n`\n\nutils/\n\n\u5728utils\u76EE\u5F55\u4E0B\u7684\u6587\u4EF6\u63D0\u4F9B\u4E86\u4E00\u4E9B\u5E95\u5C42\u529F\u80FD\u7528\u6765\u652F\u6301\u5176\u4ED6\u7684\u4EE3\u7801\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C\u4E3B\u8981\u662F\u5B9A\u4E49\u4E00\u4E2A\u7ED3\u6784\u4F53\u6765\u8BBF\u95EE\u8BF7\u6C42\u7684\u4E0A\u4E0B\u6587\uFF0C\u5904\u7406session\uFF0C\u5B9A\u4E49\u4E00\u4E2A\u7279\u522B\u7684\u9875\u9762\u6765\u7EE7\u627F\u3002\u4E0B\u9762\u662F\u901A\u8FC7\u8BBF\u95EE\u4E0A\u4E0B\u6587\u8BBE\u7F6E\u7528\u6237\u7684\u4F8B\u5B50\uFF1A\n\n`Go\npackage utils\n\nimport (\n  &quot;github.com/gorilla/context&quot;\n  &quot;github.com/larryprice/refermadness/models&quot;\n  &quot;net/http&quot;\n)\n\ntype CurrentUserAccessor struct {\n  key int\n}\n\nfunc NewCurrentUserAccessor(key int) *CurrentUserAccessor {\n  return &amp;CurrentUserAccessor{key}\n}\n\nfunc (cua CurrentUserAccessor) Set(r http.Request, user *models.User) {\n  context.Set(r, cua.key, user)\n}\n\nfunc (cua CurrentUserAccessor) Clear(r http.Request) {\n  context.Delete(r, cua.key)\n}\n\nfunc (cua CurrentUserAccessor) Get(r http.Request) models.User {\n  if rv := context.Get(r, cua.key); rv != nil {\n    return rv.(models.User)\n  }\n  return nil\n}\n`\n\nmodels/\n\nmodel \u662F\u4E3A\u4E86\u63CF\u8FF0\u6570\u636E\u5E93\u4E2D\u7684\u6570\u636E\u7684\u6570\u636E\u7ED3\u6784\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\u4F7F\u7528model\u6765\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C\u521B\u5EFA\u4E00\u4E2A\u7A7A\u7684model\uFF0C\u7136\u540E\u901A\u8FC7\u67E5\u8BE2\u6570\u636E\u5E93\u4E3A\u5176\u8D4B\u503C\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\uFF1A\n\n`Go\npackage models\n\nimport (\n  &quot;gopkg.in/mgo.v2&quot;\n  &quot;gopkg.in/mgo.v2/bson&quot;\n  &quot;strings&quot;\n  &quot;time&quot;\n)\n\ntype Service struct {\n  // identification information\n  ID          bson.ObjectId bson:&quot;_id&quot;\n  Name        string        bson:&quot;name&quot;\n  Description string        bson:&quot;description&quot;\n  URL         string        bson:&quot;url&quot;\n  Search      string        bson:&quot;search&quot;\n}\n\nfunc NewService(name, description, url string, creatorID bson.ObjectId) *Service {\n  url = strings.TrimPrefix(strings.TrimPrefix(url, &quot;http://&quot;), &quot;https://&quot;)\n  return &amp;Service{\n    ID:            bson.NewObjectId(),\n    Name:          name,\n    URL:           url,\n    Description:   description,\n    Search:        strings.ToLower(name) + &quot;;&quot; + strings.ToLower(description) + &quot;;&quot; + strings.ToLower(url),\n  }\n}\n\nfunc (s Service) Save(db mgo.Database) error {\n  _, err := s.coll(db).UpsertId(s.ID, s)\n  return err\n}\n\nfunc (s Service) FindByID(id bson.ObjectId, db mgo.Database) error {\n  return s.coll(db).FindId(id).One(s)\n}\n\nfunc (Service) coll(db mgo.Database) *mgo.Collection {\n  return db.C(&quot;service&quot;)\n}\n\ntype Services []Service\n\nfunc (s Services) FindByIDs(ids []bson.ObjectId, db mgo.Database) error {\n  return s.coll(db).Find(bson.M{&quot;_id&quot;: bson.M{&quot;$in&quot;: ids}}).Sort(&quot;name&quot;).All(s)\n}\n\nfunc (Services) coll(db mgo.Database) *mgo.Collection {\n  return db.C(&quot;service&quot;)\n}\n\n`\n\nviews/\n\n\u5C06Golang\u7684\u6A21\u677F\u6587\u4EF6\u653E\u5230views\u76EE\u5F55\u4E0B\u3002\u8FD9\u6837\uFF0C\u4E0D\u7BA1\u7528\u4EC0\u4E48\u6837\u7684\u6A21\u677F\u5F15\u64CE\u90FD\u53EF\u4EE5\u76F4\u63A5\u653E\u5230views\u4E0B\u3002\n\npublic/\n\n\u8DDF\u4EE5\u524D\u4E00\u6837\uFF0C\u8FD9\u4E2A\u6587\u4EF6\u90FD\u662F\u653E\u516C\u5F00\u7684\u6587\u4EF6\u7684\uFF0C\u4F8B\u5982css,img,scripts\u3002\n\n\u5982\u4F55\u8FD0\u884C\n\n\u6BEB\u65E0\u7591\u95EE\uFF0C\u6211\u6700\u559C\u6B22\u7684\u5C31\u662Fdocker\uFF0C\u56E0\u6B64\u6211\u5C06\u4F7F\u7528\u4ED6\u6765\u8FD0\u884C\u8FD9\u4E2A\u5E94\u7528\u3002\u5982\u679C\u4E0D\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u5C06\u6587\u4EF6\u653E\u5230$GOPATH/src/github.com/larryprice/refermadness,\u8FD0\u884Cgo get\u6765\u83B7\u53D6\u6240\u6709\u7684\u4F9D\u8D56\uFF0C\u7136\u540E\u8FD0\u884C go run main.go\u6216\u8005go build; ./refermadness\u8FD0\u884C\u7A0B\u5E8F\u3002\u5982\u679C\u4F60\u4E5F\u559C\u6B22\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u76F4\u63A5\u901A\u8FC7Dockerfile\u6765\u8FD0\u884C\u3002\n\n`bash\nFROM golang:1.4\n\nRUN go get github.com/codegangsta/gin\n\nADD . /go/src/github.com/larryprice/refermadness\nWORKDIR /go/src/github.com/larryprice/refermadness\nRUN go get\n`\n\n\u540C\u65F6\u6211\u4E5F\u5F88\u559C\u6B22compose\uFF0C\u6240\u4EE5\u6211\u4E5F\u901A\u8FC7compose \u6587\u4EF6\u6765\u8FD0\u884C\u6240\u6709\u7684\u5E94\u7528\u3002\u6211\u7528\u4E86JSC \uFF0CSASS\u548Cmongodb\uFF0C\u6240\u4EE5\u4E00\u4E0B\u662F\u6211\u7684docker-compose.yml\u6587\u4EF6\u3002\n\nGo\nmain:\n  build: .\n  command: gin run\n  env_file: .env\n  volumes:\n    - ./:/go/src/github.com/larryprice/refermadness\n  working_dir: /go/src/github.com/larryprice/refermadness\n  ports:\n    - &quot;3000:3000&quot;\n  links:\n    - db\nsass:\n  image: larryprice/sass\n  volumes:\n    - ./public/css:/src\njsx:\n  image: larryprice/jsx\n  volumes:\n    - ./public/scripts:/src\ndb:\n  image: mongo:3.0\n  command: mongod --smallfiles --quiet --logpath=/dev/null\n  volumes_from:\n    - dbvolume\ndbvolume:\n  image: busybox:ubuntu-14.04\n  volumes:\n    - /data/db\n\n\n\u7136\u540E\u8FD0\u884Cdocker-compose up\u6765\u8FD0\u884C\u6240\u6709\u7684\u5BB9\u5668\u5E76\u542F\u52A8\u670D\u52A1\u5668\u3002','readingtime':19,'url':'/cates/Backend/post/2015-11-11/Go-Web-architecture','dirs':['go'],'relatives':[{'url':'/cates/Backend/post/2015-11-12/HTTP-2-And-GO','title':'HTTP/2 \u548CGO'},{'url':'/cates/Backend/post/2015-11-15/create-a-homepage-for-Go-Web-App','title':'\u4E3AGo Web App \u521B\u5EFA\u4E00\u4E2A\u4E3B\u9875\u9762'},{'url':'/cates/Backend/post/2015-11-12/develop-HTTP-middleware-using-Go','title':'\u4F7F\u7528Go\u5F00\u53D1HTTP\u4E2D\u95F4\u4EF6'},{'url':'/cates/Backend/post/2015-11-13/http-Handler-And-Go-error-handle','title':'http.Handler \u4E0EGo\u7684\u9519\u8BEF\u5904\u7406'}],'body':'\n\n[\u539F\u6587\u5730\u5740](https://larry-price.com/blog/2015/06/25/architecture-for-a-golang-web-app)\n\n\u4F7F\u7528Golang\u6765\u521B\u5EFAWeb\u9879\u76EE\u662F\u4E00\u4EF6\u5F88\u9EBB\u70E6\u7684\u4E8B\u60C5\u3002\u5982\u679C\u4F60\u4F7F\u7528Rails\uFF0C\u90A3\u4E48\u4F60\u53EF\u80FD\u4E0D\u4F1A\u6709\u8FD9\u4E2A\u611F\u89E6\u3002\u6211\u5728[Refer Madness](https://www.refer-madness.com/)\u4E2D\u4F7F\u7528\u4E86\u4E0B\u9762\u8FD9\u4E2A\u67B6\u6784\u3002\n\n```bash\n-public/\n-views/\n-models/\n-utils/\n-controllers/\n-web/\n-main.go\n```\n\n\u6211\u5C06\u6253\u7834\u8FD9\u4E2A\u4F53\u7CFB\uFF0C\u4ECB\u7ECD\u5404\u4E2A\u76EE\u5F55\u7684\u4F5C\u7528\u3002\u5728\u6BCF\u4E2A\u76EE\u5F55\u4E0B\uFF0C\u6587\u4EF6\u53EA\u80FD\u8BBF\u95EE\u5176\u540C\u7EA7\u6216\u8005\u4E0A\u4E00\u7EA7\u3002\u8FD9\u5C31\u610F\u5473\u7740`utils`\u53EA\u80FD\u8BBF\u95EE\u4ED6\u81EA\u5DF1\u548C`models`\uFF0C`web`\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\uFF0C`controllers`\uFF0C`utils`\uFF0C`models`\u3002`models`\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\u3002\u6211\u8FD9\u4E48\u505A\u662F\u4E3A\u4E86\u8BA9\u5C42\u6B21\u6E05\u6670\uFF0C\u9632\u6B62\u51FA\u73B0\u9012\u5F52\u4F9D\u8D56\u3002\u73B0\u5728\u6765\u5206\u6790\u6BCF\u4E00\u4E2A\u76EE\u5F55\uFF0C\u6587\u4EF6\u7684\u4F5C\u7528\u3002\n\n#### main.go\n\n`main.go`\u662F\u521B\u5EFA\u4F9D\u8D56\uFF0C\u83B7\u53D6\u73AF\u5883\u53D8\u91CF\uFF0C\u542F\u52A8\u670D\u52A1\u7684\u4E3B\u8981\u6587\u4EF6\u3002\u4E0B\u9762\u662F\u5B83\u7684\u5B9E\u4F8B\u3002\n\n```Go\npackage main\n\nimport (\n  "github.com/larryprice/refermadness/utils"\n  "github.com/larryprice/refermadness/web"\n  "github.com/stretchr/graceful"\n  "os"\n)\n\nfunc main() {\n  isDevelopment := os.Getenv("ENVIRONMENT") == "development"\n  dbURL := os.Getenv("MONGOLAB_URI")\n  if isDevelopment {\n    dbURL = os.Getenv("DB_PORT_27017_TCP_ADDR")\n  }\n\n  dbAccessor := utils.NewDatabaseAccessor(dbURL, os.Getenv("DATABASE_NAME"), 0)\n  cuAccessor := utils.NewCurrentUserAccessor(1)\n  s := web.NewServer(*dbAccessor, *cuAccessor, os.Getenv("GOOGLE_OAUTH2_CLIENT_ID"),\n    os.Getenv("GOOGLE_OAUTH2_CLIENT_SECRET"), os.Getenv("SESSION_SECRET"),\n    isDevelopment, os.Getenv("GOOGLE_ANALYTICS_KEY"))\n\n  port := os.Getenv("PORT")\n  if port == "" {\n    port = "3000"\n  }\n\n  graceful.Run(":"+port, 0, s)\n}\n\n```\n\n\u56E0\u4E3A`main.go`\u5B9E\u5728\u6700\u4F4E\u7684\u5C42\u7EA7\uFF0C\u6240\u4EE5\u5B83\u53EF\u4EE5\u8BBF\u95EE\u6240\u6709\u7684\u76EE\u5F55\uFF1A\u5728\u8FD9\u4E2A\u4F8B\u5B50\u91CC\u662F`web`\u548C`utils`\u3002\u5728\u8FD9\u91CC\u83B7\u53D6\u4E86\u6240\u6709\u7684\u73AF\u5883\u53D8\u91CF\u5E76\u628A\u5B83\u4EEC\u6CE8\u5165\u5230\u5408\u9002\u7684\u5730\u65B9\u3002\u5728`main.go`\u4E2D\u521B\u5EFA\u4E86\u670D\u52A1\u5668\uFF0C\u6CE8\u5165\u4F9D\u8D56\uFF0C\u5E76\u4E14\u5728\u914D\u7F6E\u7684\u7AEF\u53E3\u542F\u52A8\u670D\u52A1\u5668\u3002\n\n#### web\n\n`web`\u76EE\u5F55\u4E0B\u662F\u4E3B\u8981\u7684\u670D\u52A1\u4EE3\u7801\uFF0C\u540C\u65F6\u4E5F\u5305\u62EC\u4E86\u4E2D\u95F4\u4EF6\u4EE3\u7801\u3002\u4E0B\u9762\u662F`web`\u76EE\u5F55\u7684\u5185\u90E8\u7ED3\u6784\uFF1A\n\n```bash\n-web/\n|-middleware/\n|-server.go\n```\n\n`server.go`\u5305\u542B\u4E86web server\u7684\u5B9A\u4E49\u3002\u8FD9\u4E2Aweb server \u521B\u5EFA\u4E86\u6240\u6709\u7684web controller\u5E76\u4E14\u7ED9negroni\u6DFB\u52A0\u4E86\u4E2D\u95F4\u4EF6\u3002\u4E0B\u9762\u662F\u4ED6\u7684\u4F8B\u5B50\uFF1A\n\n```Go\npackage web\n\nimport (\n  "github.com/codegangsta/negroni"\n  "github.com/goincremental/negroni-sessions"\n  "github.com/goincremental/negroni-sessions/cookiestore"\n  "github.com/gorilla/mux"\n  "github.com/larryprice/refermadness/controllers"\n  "github.com/larryprice/refermadness/utils"\n  "github.com/larryprice/refermadness/web/middleware"\n  "github.com/unrolled/secure"\n  "gopkg.in/unrolled/render.v1"\n  "html/template"\n  "net/http"\n)\n\ntype Server struct {\n  *negroni.Negroni\n}\n\nfunc NewServer(dba utils.DatabaseAccessor, cua utils.CurrentUserAccessor, clientID, clientSecret,\n  sessionSecret string, isDevelopment bool, gaKey string) *Server {\n  s := Server{negroni.Classic()}\n  session := utils.NewSessionManager()\n  basePage := utils.NewBasePageCreator(cua, gaKey)\n  renderer := render.New()\n\n  router := mux.NewRouter()\n\n  // ...\n\n  accountController := controllers.NewAccountController(clientID, clientSecret, isDevelopment, session, dba, cua, basePage, renderer)\n  accountController.Register(router)\n\n  // ...\n\n  s.Use(sessions.Sessions("refermadness", cookiestore.New([]byte(sessionSecret))))\n  s.Use(middleware.NewAuthenticator(dba, session, cua).Middleware())\n  s.UseHandler(router)\n  return &s\n}\n```\n\n`Server`\u7ED3\u6784\u4F53\u662F\u4E00\u4E2A`negroni.Negroni`\u7684web server\uFF0C\u5728\u8FD9\u4E2A\u6587\u4EF6\u91CC\u6709\u5BF9`utils`\u548C\u5176\u4ED6\u7B2C\u4E09\u65B9\u5305\u7684\u5F15\u7528\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2Arouter\uFF0C\u4E00\u4E9Bcontroller\uFF0C\u5E76\u4E14\u5C06controller\u6CE8\u518C\u5230\u5F53\u524Drouter\u3002\u540C\u65F6\u4E5F\u5F15\u5165\u4E86\u5FC5\u8981\u7684\u4E2D\u95F4\u4EF6\u3002\u8BF4\u5230\u4E2D\u95F4\u4EF6\uFF0C\u4E0B\u9762\u662F\u5B83\u7684\u4EE3\u7801\uFF1A\n\n```Go\npackage middleware\n\nimport (\n  "github.com/codegangsta/negroni"\n  "github.com/larryprice/refermadness/utils"\n  "net/http"\n)\n\ntype Database struct {\n  da utils.DatabaseAccessor\n}\n\nfunc NewDatabase(da utils.DatabaseAccessor) *Database {\n  return &Database{da}\n}\n\nfunc (d *Database) Middleware() negroni.HandlerFunc {\n  return func(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc) {\n    reqSession := d.da.Clone()\n    defer reqSession.Close()\n    d.da.Set(r, reqSession)\n    next(rw, r)\n  }\n}\n```\n\n\u8FD9\u4E2A\u662F\u901A\u8FC7HTTP router\u8BBF\u95EE\u6570\u636E\u5E93session\u7684\u6807\u6CE8\u4E2D\u95F4\u4EF6\u3002\u57FA\u672C\u6587\u4EF6\u662F\u4ECE[Brian Gesiak\u2019s blog post on RESTful Go](http://modocache.svbtle.com/restful-go)\u4E2D\u5F97\u5230\uFF0C\u5C06\u5176\u4FEE\u6539\u4E3A\u9002\u5408\u6211\u7684\u6587\u4EF6\u3002\n\n#### controllers/\n\n\u8FD9\u91CC\u7684controller\u4E0ERails\u91CC\u7684controller\u7684\u6982\u5FF5\u5F88\u50CF\u3002Controller\u6CE8\u518C\u81EA\u5DF1\u7684router\uFF0C\u8BBE\u7F6E\u81EA\u5DF1\u7684\u51FD\u6570\u8C03\u7528\u3002\u4E00\u4E2A\u7B80\u77ED\u7684\u4F8B\u5B50\u5982\u4E0B\uFF1A\n\n```Go\npackage controllers\n\nimport (\n  "encoding/json"\n  "errors"\n  "github.com/gorilla/mux"\n  "github.com/larryprice/refermadness/models"\n  "github.com/larryprice/refermadness/utils"\n  "gopkg.in/mgo.v2/bson"\n  "gopkg.in/unrolled/render.v1"\n  "html/template"\n  "net/http"\n  "strings"\n)\n\ntype ServiceControllerImpl struct {\n  currentUser utils.CurrentUserAccessor\n  basePage    utils.BasePageCreator\n  renderer    *render.Render\n  database    utils.DatabaseAccessor\n}\n\nfunc NewServiceController(currentUser utils.CurrentUserAccessor, basePage utils.BasePageCreator,\n  renderer *render.Render, database utils.DatabaseAccessor) *ServiceControllerImpl {\n  return &ServiceControllerImpl{\n    currentUser: currentUser,\n    basePage:    basePage,\n    renderer:    renderer,\n    database:    database,\n  }\n}\n\nfunc (sc *ServiceControllerImpl) Register(router *mux.Router) {\n  router.HandleFunc("/service/{id}", sc.single)\n  // ...\n}\n\n// ...\n\ntype serviceResult struct {\n  *models.Service\n  RandomCode *models.ReferralCode\n  UserCode   *models.ReferralCode\n}\n\ntype servicePage struct {\n  utils.BasePage\n  ResultString string\n}\n\nfunc (sc *ServiceControllerImpl) single(w http.ResponseWriter, r *http.Request) {\n  data, err := sc.get(w, r)\n\n  if len(r.Header["Content-Type"]) == 1 && strings.Contains(r.Header["Content-Type"][0], "application/json") {\n    if err != nil {\n      sc.renderer.JSON(w, http.StatusBadRequest, map[string]string{\n        "error": err.Error(),\n      })\n      return\n    }\n    sc.renderer.JSON(w, http.StatusOK, data)\n    return\n  } else if err != nil {\n    http.Error(w, err.Error(), http.StatusBadRequest)\n  }\n\n  resultString, _ := json.Marshal(data)\n  t, _ := template.ParseFiles("views/layout.html", "views/service.html")\n  t.Execute(w, servicePage{sc.basePage.Get(r), string(resultString)})\n}\n```\n\n#### utils/\n\n\u5728`utils`\u76EE\u5F55\u4E0B\u7684\u6587\u4EF6\u63D0\u4F9B\u4E86\u4E00\u4E9B\u5E95\u5C42\u529F\u80FD\u7528\u6765\u652F\u6301\u5176\u4ED6\u7684\u4EE3\u7801\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C\u4E3B\u8981\u662F\u5B9A\u4E49\u4E00\u4E2A\u7ED3\u6784\u4F53\u6765\u8BBF\u95EE\u8BF7\u6C42\u7684\u4E0A\u4E0B\u6587\uFF0C\u5904\u7406session\uFF0C\u5B9A\u4E49\u4E00\u4E2A\u7279\u522B\u7684\u9875\u9762\u6765\u7EE7\u627F\u3002\u4E0B\u9762\u662F\u901A\u8FC7\u8BBF\u95EE\u4E0A\u4E0B\u6587\u8BBE\u7F6E\u7528\u6237\u7684\u4F8B\u5B50\uFF1A\n\n```Go\npackage utils\n\nimport (\n  "github.com/gorilla/context"\n  "github.com/larryprice/refermadness/models"\n  "net/http"\n)\n\ntype CurrentUserAccessor struct {\n  key int\n}\n\nfunc NewCurrentUserAccessor(key int) *CurrentUserAccessor {\n  return &CurrentUserAccessor{key}\n}\n\nfunc (cua *CurrentUserAccessor) Set(r *http.Request, user *models.User) {\n  context.Set(r, cua.key, user)\n}\n\nfunc (cua *CurrentUserAccessor) Clear(r *http.Request) {\n  context.Delete(r, cua.key)\n}\n\nfunc (cua *CurrentUserAccessor) Get(r *http.Request) *models.User {\n  if rv := context.Get(r, cua.key); rv != nil {\n    return rv.(*models.User)\n  }\n  return nil\n}\n```\n\n#### models/\n\nmodel \u662F\u4E3A\u4E86\u63CF\u8FF0\u6570\u636E\u5E93\u4E2D\u7684\u6570\u636E\u7684\u6570\u636E\u7ED3\u6784\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\u4F7F\u7528model\u6765\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C\u521B\u5EFA\u4E00\u4E2A\u7A7A\u7684model\uFF0C\u7136\u540E\u901A\u8FC7\u67E5\u8BE2\u6570\u636E\u5E93\u4E3A\u5176\u8D4B\u503C\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\uFF1A\n\n```Go\npackage models\n\nimport (\n  "gopkg.in/mgo.v2"\n  "gopkg.in/mgo.v2/bson"\n  "strings"\n  "time"\n)\n\ntype Service struct {\n  // identification information\n  ID          bson.ObjectId `bson:"_id"`\n  Name        string        `bson:"name"`\n  Description string        `bson:"description"`\n  URL         string        `bson:"url"`\n  Search      string        `bson:"search"`\n}\n\nfunc NewService(name, description, url string, creatorID bson.ObjectId) *Service {\n  url = strings.TrimPrefix(strings.TrimPrefix(url, "http://"), "https://")\n  return &Service{\n    ID:            bson.NewObjectId(),\n    Name:          name,\n    URL:           url,\n    Description:   description,\n    Search:        strings.ToLower(name) + ";" + strings.ToLower(description) + ";" + strings.ToLower(url),\n  }\n}\n\nfunc (s *Service) Save(db *mgo.Database) error {\n  _, err := s.coll(db).UpsertId(s.ID, s)\n  return err\n}\n\nfunc (s *Service) FindByID(id bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).FindId(id).One(s)\n}\n\nfunc (*Service) coll(db *mgo.Database) *mgo.Collection {\n  return db.C("service")\n}\n\ntype Services []Service\n\nfunc (s *Services) FindByIDs(ids []bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).Find(bson.M{"_id": bson.M{"$in": ids}}).Sort("name").All(s)\n}\n\nfunc (*Services) coll(db *mgo.Database) *mgo.Collection {\n  return db.C("service")\n}\n\n```\n\n#### views/\n\n\u5C06Golang\u7684\u6A21\u677F\u6587\u4EF6\u653E\u5230`views`\u76EE\u5F55\u4E0B\u3002\u8FD9\u6837\uFF0C\u4E0D\u7BA1\u7528\u4EC0\u4E48\u6837\u7684\u6A21\u677F\u5F15\u64CE\u90FD\u53EF\u4EE5\u76F4\u63A5\u653E\u5230`views`\u4E0B\u3002\n\n#### public/\n\n\u8DDF\u4EE5\u524D\u4E00\u6837\uFF0C\u8FD9\u4E2A\u6587\u4EF6\u90FD\u662F\u653E\u516C\u5F00\u7684\u6587\u4EF6\u7684\uFF0C\u4F8B\u5982`css`,`img`,`scripts`\u3002\n\n#### \u5982\u4F55\u8FD0\u884C\n\n\u6BEB\u65E0\u7591\u95EE\uFF0C\u6211\u6700\u559C\u6B22\u7684\u5C31\u662F[docker](https://www.docker.com/)\uFF0C\u56E0\u6B64\u6211\u5C06\u4F7F\u7528\u4ED6\u6765\u8FD0\u884C\u8FD9\u4E2A\u5E94\u7528\u3002\u5982\u679C\u4E0D\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u5C06\u6587\u4EF6\u653E\u5230`$GOPATH/src/github.com/larryprice/refermadness`,\u8FD0\u884C`go get`\u6765\u83B7\u53D6\u6240\u6709\u7684\u4F9D\u8D56\uFF0C\u7136\u540E\u8FD0\u884C `go run main.go`\u6216\u8005`go build; ./refermadness`\u8FD0\u884C\u7A0B\u5E8F\u3002\u5982\u679C\u4F60\u4E5F\u559C\u6B22\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u76F4\u63A5\u901A\u8FC7`Dockerfile`\u6765\u8FD0\u884C\u3002\n\n```bash\nFROM golang:1.4\n\nRUN go get github.com/codegangsta/gin\n\nADD . /go/src/github.com/larryprice/refermadness\nWORKDIR /go/src/github.com/larryprice/refermadness\nRUN go get\n```\n\n\u540C\u65F6\u6211\u4E5F\u5F88\u559C\u6B22[compose](https://github.com/docker/compose)\uFF0C\u6240\u4EE5\u6211\u4E5F\u901A\u8FC7compose \u6587\u4EF6\u6765\u8FD0\u884C\u6240\u6709\u7684\u5E94\u7528\u3002\u6211\u7528\u4E86JSC \uFF0CSASS\u548Cmongodb\uFF0C\u6240\u4EE5\u4E00\u4E0B\u662F\u6211\u7684`docker-compose.yml`\u6587\u4EF6\u3002\n\n```Go\nmain:\n  build: .\n  command: gin run\n  env_file: .env\n  volumes:\n    - ./:/go/src/github.com/larryprice/refermadness\n  working_dir: /go/src/github.com/larryprice/refermadness\n  ports:\n    - "3000:3000"\n  links:\n    - db\nsass:\n  image: larryprice/sass\n  volumes:\n    - ./public/css:/src\njsx:\n  image: larryprice/jsx\n  volumes:\n    - ./public/scripts:/src\ndb:\n  image: mongo:3.0\n  command: mongod --smallfiles --quiet --logpath=/dev/null\n  volumes_from:\n    - dbvolume\ndbvolume:\n  image: busybox:ubuntu-14.04\n  volumes:\n    - /data/db\n```\n\n\u7136\u540E\u8FD0\u884C`docker-compose up`\u6765\u8FD0\u884C\u6240\u6709\u7684\u5BB9\u5668\u5E76\u542F\u52A8\u670D\u52A1\u5668\u3002\n\n\n'},'tags':['Vagrant','Translate','Backend','Ansible','Go','Architecture','Web','Http','HTTP/2','HTTP','Middleware','Java','OKHttp','Mybatis','CPU','Linux','Dartlang','Dart','Flutter','CrossPlatform','Mobile','JS','Javascript','Frontend','NodeJS','Node','NPM','JSON','Jackson','ECMAScript','ECMAScript2016','ECMAScript2017','ECMAScript2018','ES6','ES7','Async','Await','Async/Await','Java8','APM','Performance','Spring','SpringMVC','Hyperapp','React']},'siteData':{'title':'\u4EE3\u7801\u62FE\u9057'}};</script><script defer="" type="text/javascript" src="https://shjie047.github.io/bootstrap.d5ea8805.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/templates/src/containers/Post.5710f9d8.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/main.1a92e948.js"></script></body></html>