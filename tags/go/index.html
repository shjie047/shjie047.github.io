<!DOCTYPE html><html lang="en" data-reactroot=""><head><title data-react-helmet="true">代码拾遗</title><meta data-react-helmet="true" property="og:description" content="这是一个互联网相关的技术类博客、开发笔记，提供全面的、前沿的计算机前端、后端教程，包括最新的国外技术文章，掌握最新的互联网技术资讯、趋势"/><meta data-react-helmet="true" property="og:title" content="代码拾遗"/><meta data-react-helmet="true" property="og:type" content="文章"/><meta data-react-helmet="true" name="title" content="代码拾遗"/><meta data-react-helmet="true" name="description" content="这是一个互联网相关的技术类博客、开发笔记，提供全面的、前沿的计算机前端、后端教程，包括最新的国外技术文章，掌握最新的互联网技术资讯、趋势"/><meta data-react-helmet="true" name="keywords" content="前端,后端,Java,Javascript,js,开发,教程,技术"/><link rel="preload" as="script" href="https://shjie047.github.io/bootstrap.26150f1d.js"/><link rel="preload" as="script" href="https://shjie047.github.io/templates/src/containers/Blog.15f46eeb.js"/><link rel="preload" as="script" href="https://shjie047.github.io/main.7f3dbdf6.js"/><link rel="preload" as="style" href="https://shjie047.github.io/styles.0fdbbfe7.css"/><link rel="stylesheet" href="https://shjie047.github.io/styles.0fdbbfe7.css"/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><style data-styled-components="fJTUOz bDWFJH eNooeC bGYHop goZMZM faAjVQ bzbSEp gETGao OfwXa svbMq">
/* sc-component-id: sc-bwzfXH */
.bGYHop{padding:0 40px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;} @media only screen and (max-width:400px){.bGYHop{padding:0 20px;}} .bGYHop a{font-size:1.6rem;font-weight:normal;} .bGYHop .icon-link{font-size:1.8rem;} .bGYHop .icon-btn{-webkit-apparance:none;background-color:transparent;border:none;outline:none;color:#fff;cursor:pointer;}
/* sc-component-id: sc-keyframes-fJTUOz */
@-webkit-keyframes fJTUOz{0%{width:0px;padding:4px 0;}100%{width:160px;padding:4px 5px;}} @keyframes fJTUOz{0%{width:0px;padding:4px 0;}100%{width:160px;padding:4px 5px;}}
/* sc-component-id: sc-htpNat */
.bzbSEp{margin-left:auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;overflow:hidden;} .bzbSEp .search-input input{-webkit-apparance:none;border:0;outline:0;padding:4px 5px;margin:0;background-color:#fff;width:160px;-webkit-animation:.2s fJTUOz ease;animation:.2s fJTUOz ease;}
/* sc-component-id: sc-bxivhb */
@media only screen and (max-width:920px){.goZMZM{display:none;}} .goZMZM a{font-size:1.4rem;} .goZMZM::before{content:'';height:2.1rem;width:1px;background-color:#00000038;display:inline-block;vertical-align:middle;}
/* sc-component-id: sc-ifAKCX */
.faAjVQ{display:none;padding:0;margin:0;position:relative;font-size:1.4rem;} .faAjVQ::before{content:'';height:2.1rem;width:1px;background-color:#00000038;display:inline-block;vertical-align:middle;} .faAjVQ > i{display:inline-block;padding:1rem;color:#fff;font-weight:normal;-webkit-transition:color .3s ease;transition:color .3s ease;} .faAjVQ a{font-size:1.4rem;font-weight:normal;line-height:1;display:block;padding:1.2rem 3rem 1.2rem 1rem;} .faAjVQ li{margin:0;} .faAjVQ ul{list-style:none;padding:0;margin:0;position:absolute;top:100%;left:0;background-color:#108db8;display:none;width:120px;padding:10px 0;} .faAjVQ ul.show{display:inline-block;} @media only screen and (max-width:920px){.faAjVQ{display:inline;}}
/* sc-component-id: sc-EHOje */
.eNooeC{font-family:'yy';position:absolute;top:0;left:50%;top:50%;color:#fff;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-letter-spacing:.2rem;-moz-letter-spacing:.2rem;-ms-letter-spacing:.2rem;letter-spacing:.2rem;font-weight:normal;font-size:2.2rem;cursor:pointer;} .eNooeC:hover{color:#fff!important;}
/* sc-component-id: sc-iwsKbI */
.gETGao{position:relative;width:80%;max-width:710px;margin:4rem auto;padding-bottom:4rem;border-bottom:1px solid #ebf2f6;word-wrap:break-word;} .gETGao::after{display:block;content:"";width:7px;height:7px;border:1px solid #e7eef2;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:0 0 0 5px #fff;} .gETGao .read-more{-webkit-text-decoration:none;text-decoration:none;} .gETGao .author-thumb{width:24px;height:24px;float:left;margin-right:9px;border-radius:100%;} .gETGao .post-header{margin-bottom:3.4rem;} .gETGao .post-title a{-webkit-text-decoration:none;text-decoration:none;} .gETGao .post-meta{display:block;margin:1.75rem 0 0;font-family:Open Sans,sans-serif;font-size:1.5rem;line-height:2.2rem;color:#9eabb3;} .gETGao .post-excerpt p{margin:0;font-size:.9em;line-height:1.7em;} .gETGao .post-meta a{color:#9eabb3;-webkit-text-decoration:none;text-decoration:none;} .gETGao .post-meta a:hover{color:#9eabb3;-webkit-text-decoration:underline;text-decoration:underline;} .gETGao .post-date{display:inline-block;text-transform:uppercase;font-size:1.3rem;white-space:nowrap;} .gETGao .post-date.has-author{margin-left:8px;padding-left:12px;border-left:1px solid #d5dbde;} @media only screen and (max-width:900px){.gETGao{font-size:.95em;}} @media only screen and (max-width:500px){.gETGao{width:auto;margin:2rem 16px;padding-bottom:2rem;line-height:1.65em;}.gETGao .post-excerpt p{font-size:.85em;}.gETGao .post-meta{font-size:1.3rem;margin-top:1rem;}} .gETGao pre{padding:1.2rem;} .gETGao pre > code{overflow-x:auto;box-shadow:0 0 15px rgba(0,0,0,.35);padding:1.5rem;}
/* sc-component-id: sc-gZMcBi */
.OfwXa{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;color:#9eabb3;font-size:1.3rem;margin-bottom:3rem;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
/* sc-component-id: sc-VigVT */
.svbMq{margin:0 2.5rem;}</style></head><body><div id="root"><div class="sc-bdVaJa bDWFJH" data-reactroot=""><div class="headroom-wrapper"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0)" class="headroom headroom--unfixed"><a class="sc-EHOje eNooeC" aria-current="false" href="https://shjie047.github.io/">代码拾遗</a><nav class="sc-bwzfXH bGYHop"><a class="icon-link" aria-current="false" href="https://shjie047.github.io/"><i class="iconfont icon-home"></i></a><span class="sc-bxivhb goZMZM"><a aria-current="false" href="https://shjie047.github.io/tags/frontend">前端</a><a aria-current="false" href="https://shjie047.github.io/tags/backend">后端</a><a aria-current="false" href="https://shjie047.github.io/tags/mobile">移动端</a><a aria-current="false" href="https://shjie047.github.io/tags/java">Java</a></span><span class="toggled-popular sc-ifAKCX faAjVQ"><i class="iconfont icon-popular"></i><ul><li><a aria-current="false" href="https://shjie047.github.io/tags/backend">后端</a></li><li><a aria-current="false" href="https://shjie047.github.io/tags/mobile">移动端</a></li><li><a aria-current="false" href="https://shjie047.github.io/tags/java">Java</a></li></ul></span><div class="sc-htpNat bzbSEp"><button class="search-btn icon-btn"><i class="iconfont icon-search"></i></button><a class="archive icon-link" aria-current="false" data-tip="归档" href="https://shjie047.github.io/archives"><i class="iconfont icon-archive"></i></a></div></nav></div></div><div class="content"><div><div><article class="sc-iwsKbI gETGao"><header class="post-header"><h2 class="post-title"><a aria-current="false" href="https://shjie047.github.io/post/2015-11-15/为Go-Web-App-创建一个主页面/">为Go Web App 创建一个主页面</a></h2></header><section class="post-excerpt"><p>原文地址

 大多数web app都有一个相同的布局。这个布局可能包含一个header或者footer，甚至可能包含一个导航菜单。Go的标准库提供一个简单的方式来创建这些基本元素，通过被不同的页面重用，创建出模板页的效果。
 ...<a class="read-more" aria-current="false" href="https://shjie047.github.io/post/2015-11-15/为Go-Web-App-创建一个主页面/">»</a></p></section><footer class="post-meta"><time class="post-date" dateTime="2015-11-15">2015-11-15</time></footer></article><article class="sc-iwsKbI gETGao"><header class="post-header"><h2 class="post-title"><a aria-current="false" href="https://shjie047.github.io/post/2015-11-13/http-Handler-与Go的错误处理/">http.Handler 与Go的错误处理</a></h2></header><section class="post-excerpt"><p>原文地址

 在之前我写过一篇关于通过使用http.HandlerFunc来实现一个定制handler类型用来避免一些平常的错误的文章。func MyHandler(w http.ResponseWriter, r *http.Request)的签名经常可以看到。这是一个有用的通...<a class="read-more" aria-current="false" href="https://shjie047.github.io/post/2015-11-13/http-Handler-与Go的错误处理/">»</a></p></section><footer class="post-meta"><time class="post-date" dateTime="2015-11-13">2015-11-13</time></footer></article><article class="sc-iwsKbI gETGao"><header class="post-header"><h2 class="post-title"><a aria-current="false" href="https://shjie047.github.io/post/2015-11-12/使用Go开发HTTP中间件/">使用Go开发HTTP中间件</a></h2></header><section class="post-excerpt"><p>原文地址

 再web开发的背景下，“中间件”通常意思是“包装原始应用并添加一些额外的功能的应用的一部分”。这个概念似乎总是不被人理解，但是我认为中间件非常棒。
 首先，一个好的中间件有一个责任就是可插拔并且...<a class="read-more" aria-current="false" href="https://shjie047.github.io/post/2015-11-12/使用Go开发HTTP中间件/">»</a></p></section><footer class="post-meta"><time class="post-date" dateTime="2015-11-12">2015-11-12</time></footer></article><article class="sc-iwsKbI gETGao"><header class="post-header"><h2 class="post-title"><a aria-current="false" href="https://shjie047.github.io/post/2015-11-12/HTTP-2-和GO/">HTTP/2 和GO</a></h2></header><section class="post-excerpt"><p>原文地址

HTTP/2是一个添加了一些新功能的HTTP的新版本，这些功能包括连接复用，首部压缩。再Go的标准库中暂时还没有HTTP/2的实现，但是现在有很多正在开发的库可以用来在Go中实现HTTP/2的server和client。

Brad F...<a class="read-more" aria-current="false" href="https://shjie047.github.io/post/2015-11-12/HTTP-2-和GO/">»</a></p></section><footer class="post-meta"><time class="post-date" dateTime="2015-11-12">2015-11-12</time></footer></article><article class="sc-iwsKbI gETGao"><header class="post-header"><h2 class="post-title"><a aria-current="false" href="https://shjie047.github.io/post/2015-11-11/Go-Web-架构/">Go Web 架构</a></h2></header><section class="post-excerpt"><p>原文地址

使用Golang来创建Web项目是一件很麻烦的事情。如果你使用Rails，那么你可能不会有这个感触。我在Refer Madness中使用了下面这个架构。


-public/
-views/
-models/
-utils/
-controllers/
-web/
-main.go...<a class="read-more" aria-current="false" href="https://shjie047.github.io/post/2015-11-11/Go-Web-架构/">»</a></p></section><footer class="post-meta"><time class="post-date" dateTime="2015-11-11">2015-11-11</time></footer></article></div><div class="sc-gZMcBi OfwXa"><div class="sc-VigVT svbMq">Page <!-- -->1<!-- --> of <!-- -->1</div></div></div></div><div class="__react_component_tooltip place-top type-dark " data-id="tooltip"></div></div></div><script type="text/javascript">window.__CSS_CHUNKS__ = {"main":"https://shjie047.github.io/styles.0fdbbfe7.css"}</script><script type="text/javascript">
                window.__routeInfo = {'path':'tags/go','templateID':3,'sharedPropsHashes':{},'localProps':null,'allProps':{'posts':[{'title':'Go Web \u67B6\u6784','tags':['Go','Architecture','Translate','backend','Web'],'iso8601Date':'2015-11-11T03:01:21+08:00','basename':'Go-Web-\u67B6\u6784','body':'\n\n[\u539F\u6587\u5730\u5740](https://larry-price.com/blog/2015/06/25/architecture-for-a-golang-web-app)\n\n\u4F7F\u7528Golang\u6765\u521B\u5EFAWeb\u9879\u76EE\u662F\u4E00\u4EF6\u5F88\u9EBB\u70E6\u7684\u4E8B\u60C5\u3002\u5982\u679C\u4F60\u4F7F\u7528Rails\uFF0C\u90A3\u4E48\u4F60\u53EF\u80FD\u4E0D\u4F1A\u6709\u8FD9\u4E2A\u611F\u89E6\u3002\u6211\u5728[Refer Madness](https://www.refer-madness.com/)\u4E2D\u4F7F\u7528\u4E86\u4E0B\u9762\u8FD9\u4E2A\u67B6\u6784\u3002\n\n```\n-public/\n-views/\n-models/\n-utils/\n-controllers/\n-web/\n-main.go\n```\n\n\u6211\u5C06\u6253\u7834\u8FD9\u4E2A\u4F53\u7CFB\uFF0C\u4ECB\u7ECD\u5404\u4E2A\u76EE\u5F55\u7684\u4F5C\u7528\u3002\u5728\u6BCF\u4E2A\u76EE\u5F55\u4E0B\uFF0C\u6587\u4EF6\u53EA\u80FD\u8BBF\u95EE\u5176\u540C\u7EA7\u6216\u8005\u4E0A\u4E00\u7EA7\u3002\u8FD9\u5C31\u610F\u5473\u7740`utils`\u53EA\u80FD\u8BBF\u95EE\u4ED6\u81EA\u5DF1\u548C`models`\uFF0C`web`\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\uFF0C`controllers`\uFF0C`utils`\uFF0C`models`\u3002`models`\u53EA\u80FD\u8BBF\u95EE\u5B83\u81EA\u5DF1\u3002\u6211\u8FD9\u4E48\u505A\u662F\u4E3A\u4E86\u8BA9\u5C42\u6B21\u6E05\u6670\uFF0C\u9632\u6B62\u51FA\u73B0\u9012\u5F52\u4F9D\u8D56\u3002\u73B0\u5728\u6765\u5206\u6790\u6BCF\u4E00\u4E2A\u76EE\u5F55\uFF0C\u6587\u4EF6\u7684\u4F5C\u7528\u3002\n\n#### main.go\n\n`main.go`\u662F\u521B\u5EFA\u4F9D\u8D56\uFF0C\u83B7\u53D6\u73AF\u5883\u53D8\u91CF\uFF0C\u542F\u52A8\u670D\u52A1\u7684\u4E3B\u8981\u6587\u4EF6\u3002\u4E0B\u9762\u662F\u5B83\u7684\u5B9E\u4F8B\u3002\n\n```Go\npackage main\n\nimport (\n  "github.com/larryprice/refermadness/utils"\n  "github.com/larryprice/refermadness/web"\n  "github.com/stretchr/graceful"\n  "os"\n)\n\nfunc main() {\n  isDevelopment := os.Getenv("ENVIRONMENT") == "development"\n  dbURL := os.Getenv("MONGOLAB_URI")\n  if isDevelopment {\n    dbURL = os.Getenv("DB_PORT_27017_TCP_ADDR")\n  }\n\n  dbAccessor := utils.NewDatabaseAccessor(dbURL, os.Getenv("DATABASE_NAME"), 0)\n  cuAccessor := utils.NewCurrentUserAccessor(1)\n  s := web.NewServer(*dbAccessor, *cuAccessor, os.Getenv("GOOGLE_OAUTH2_CLIENT_ID"),\n    os.Getenv("GOOGLE_OAUTH2_CLIENT_SECRET"), os.Getenv("SESSION_SECRET"),\n    isDevelopment, os.Getenv("GOOGLE_ANALYTICS_KEY"))\n\n  port := os.Getenv("PORT")\n  if port == "" {\n    port = "3000"\n  }\n\n  graceful.Run(":"+port, 0, s)\n}\n\n```\n\n\u56E0\u4E3A`main.go`\u5B9E\u5728\u6700\u4F4E\u7684\u5C42\u7EA7\uFF0C\u6240\u4EE5\u5B83\u53EF\u4EE5\u8BBF\u95EE\u6240\u6709\u7684\u76EE\u5F55\uFF1A\u5728\u8FD9\u4E2A\u4F8B\u5B50\u91CC\u662F`web`\u548C`utils`\u3002\u5728\u8FD9\u91CC\u83B7\u53D6\u4E86\u6240\u6709\u7684\u73AF\u5883\u53D8\u91CF\u5E76\u628A\u5B83\u4EEC\u6CE8\u5165\u5230\u5408\u9002\u7684\u5730\u65B9\u3002\u5728`main.go`\u4E2D\u521B\u5EFA\u4E86\u670D\u52A1\u5668\uFF0C\u6CE8\u5165\u4F9D\u8D56\uFF0C\u5E76\u4E14\u5728\u914D\u7F6E\u7684\u7AEF\u53E3\u542F\u52A8\u670D\u52A1\u5668\u3002\n\n#### web\n\n`web`\u76EE\u5F55\u4E0B\u662F\u4E3B\u8981\u7684\u670D\u52A1\u4EE3\u7801\uFF0C\u540C\u65F6\u4E5F\u5305\u62EC\u4E86\u4E2D\u95F4\u4EF6\u4EE3\u7801\u3002\u4E0B\u9762\u662F`web`\u76EE\u5F55\u7684\u5185\u90E8\u7ED3\u6784\uFF1A\n\n```\n-web/\n|-middleware/\n|-server.go\n```\n\n`server.go`\u5305\u542B\u4E86web server\u7684\u5B9A\u4E49\u3002\u8FD9\u4E2Aweb server \u521B\u5EFA\u4E86\u6240\u6709\u7684web controller\u5E76\u4E14\u7ED9negroni\u6DFB\u52A0\u4E86\u4E2D\u95F4\u4EF6\u3002\u4E0B\u9762\u662F\u4ED6\u7684\u4F8B\u5B50\uFF1A\n\n```Go\npackage web\n\nimport (\n  "github.com/codegangsta/negroni"\n  "github.com/goincremental/negroni-sessions"\n  "github.com/goincremental/negroni-sessions/cookiestore"\n  "github.com/gorilla/mux"\n  "github.com/larryprice/refermadness/controllers"\n  "github.com/larryprice/refermadness/utils"\n  "github.com/larryprice/refermadness/web/middleware"\n  "github.com/unrolled/secure"\n  "gopkg.in/unrolled/render.v1"\n  "html/template"\n  "net/http"\n)\n\ntype Server struct {\n  *negroni.Negroni\n}\n\nfunc NewServer(dba utils.DatabaseAccessor, cua utils.CurrentUserAccessor, clientID, clientSecret,\n  sessionSecret string, isDevelopment bool, gaKey string) *Server {\n  s := Server{negroni.Classic()}\n  session := utils.NewSessionManager()\n  basePage := utils.NewBasePageCreator(cua, gaKey)\n  renderer := render.New()\n\n  router := mux.NewRouter()\n\n  // ...\n\n  accountController := controllers.NewAccountController(clientID, clientSecret, isDevelopment, session, dba, cua, basePage, renderer)\n  accountController.Register(router)\n\n  // ...\n\n  s.Use(sessions.Sessions("refermadness", cookiestore.New([]byte(sessionSecret))))\n  s.Use(middleware.NewAuthenticator(dba, session, cua).Middleware())\n  s.UseHandler(router)\n  return &s\n}\n```\n\n`Server`\u7ED3\u6784\u4F53\u662F\u4E00\u4E2A`negroni.Negroni`\u7684web server\uFF0C\u5728\u8FD9\u4E2A\u6587\u4EF6\u91CC\u6709\u5BF9`utils`\u548C\u5176\u4ED6\u7B2C\u4E09\u65B9\u5305\u7684\u5F15\u7528\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2Arouter\uFF0C\u4E00\u4E9Bcontroller\uFF0C\u5E76\u4E14\u5C06controller\u6CE8\u518C\u5230\u5F53\u524Drouter\u3002\u540C\u65F6\u4E5F\u5F15\u5165\u4E86\u5FC5\u8981\u7684\u4E2D\u95F4\u4EF6\u3002\u8BF4\u5230\u4E2D\u95F4\u4EF6\uFF0C\u4E0B\u9762\u662F\u5B83\u7684\u4EE3\u7801\uFF1A\n\n```Go\npackage middleware\n\nimport (\n  "github.com/codegangsta/negroni"\n  "github.com/larryprice/refermadness/utils"\n  "net/http"\n)\n\ntype Database struct {\n  da utils.DatabaseAccessor\n}\n\nfunc NewDatabase(da utils.DatabaseAccessor) *Database {\n  return &Database{da}\n}\n\nfunc (d *Database) Middleware() negroni.HandlerFunc {\n  return func(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc) {\n    reqSession := d.da.Clone()\n    defer reqSession.Close()\n    d.da.Set(r, reqSession)\n    next(rw, r)\n  }\n}\n```\n\n\u8FD9\u4E2A\u662F\u901A\u8FC7HTTP router\u8BBF\u95EE\u6570\u636E\u5E93session\u7684\u6807\u6CE8\u4E2D\u95F4\u4EF6\u3002\u57FA\u672C\u6587\u4EF6\u662F\u4ECE[Brian Gesiak\u2019s blog post on RESTful Go](http://modocache.svbtle.com/restful-go)\u4E2D\u5F97\u5230\uFF0C\u5C06\u5176\u4FEE\u6539\u4E3A\u9002\u5408\u6211\u7684\u6587\u4EF6\u3002\n\n#### controllers/\n\n\u8FD9\u91CC\u7684controller\u4E0ERails\u91CC\u7684controller\u7684\u6982\u5FF5\u5F88\u50CF\u3002Controller\u6CE8\u518C\u81EA\u5DF1\u7684router\uFF0C\u8BBE\u7F6E\u81EA\u5DF1\u7684\u51FD\u6570\u8C03\u7528\u3002\u4E00\u4E2A\u7B80\u77ED\u7684\u4F8B\u5B50\u5982\u4E0B\uFF1A\n\n```Go\npackage controllers\n\nimport (\n  "encoding/json"\n  "errors"\n  "github.com/gorilla/mux"\n  "github.com/larryprice/refermadness/models"\n  "github.com/larryprice/refermadness/utils"\n  "gopkg.in/mgo.v2/bson"\n  "gopkg.in/unrolled/render.v1"\n  "html/template"\n  "net/http"\n  "strings"\n)\n\ntype ServiceControllerImpl struct {\n  currentUser utils.CurrentUserAccessor\n  basePage    utils.BasePageCreator\n  renderer    *render.Render\n  database    utils.DatabaseAccessor\n}\n\nfunc NewServiceController(currentUser utils.CurrentUserAccessor, basePage utils.BasePageCreator,\n  renderer *render.Render, database utils.DatabaseAccessor) *ServiceControllerImpl {\n  return &ServiceControllerImpl{\n    currentUser: currentUser,\n    basePage:    basePage,\n    renderer:    renderer,\n    database:    database,\n  }\n}\n\nfunc (sc *ServiceControllerImpl) Register(router *mux.Router) {\n  router.HandleFunc("/service/{id}", sc.single)\n  // ...\n}\n\n// ...\n\ntype serviceResult struct {\n  *models.Service\n  RandomCode *models.ReferralCode\n  UserCode   *models.ReferralCode\n}\n\ntype servicePage struct {\n  utils.BasePage\n  ResultString string\n}\n\nfunc (sc *ServiceControllerImpl) single(w http.ResponseWriter, r *http.Request) {\n  data, err := sc.get(w, r)\n\n  if len(r.Header["Content-Type"]) == 1 && strings.Contains(r.Header["Content-Type"][0], "application/json") {\n    if err != nil {\n      sc.renderer.JSON(w, http.StatusBadRequest, map[string]string{\n        "error": err.Error(),\n      })\n      return\n    }\n    sc.renderer.JSON(w, http.StatusOK, data)\n    return\n  } else if err != nil {\n    http.Error(w, err.Error(), http.StatusBadRequest)\n  }\n\n  resultString, _ := json.Marshal(data)\n  t, _ := template.ParseFiles("views/layout.html", "views/service.html")\n  t.Execute(w, servicePage{sc.basePage.Get(r), string(resultString)})\n}\n```\n\n#### utils/\n\n\u5728`utils`\u76EE\u5F55\u4E0B\u7684\u6587\u4EF6\u63D0\u4F9B\u4E86\u4E00\u4E9B\u5E95\u5C42\u529F\u80FD\u7528\u6765\u652F\u6301\u5176\u4ED6\u7684\u4EE3\u7801\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C\u4E3B\u8981\u662F\u5B9A\u4E49\u4E00\u4E2A\u7ED3\u6784\u4F53\u6765\u8BBF\u95EE\u8BF7\u6C42\u7684\u4E0A\u4E0B\u6587\uFF0C\u5904\u7406session\uFF0C\u5B9A\u4E49\u4E00\u4E2A\u7279\u522B\u7684\u9875\u9762\u6765\u7EE7\u627F\u3002\u4E0B\u9762\u662F\u901A\u8FC7\u8BBF\u95EE\u4E0A\u4E0B\u6587\u8BBE\u7F6E\u7528\u6237\u7684\u4F8B\u5B50\uFF1A\n\n```Go\npackage utils\n\nimport (\n  "github.com/gorilla/context"\n  "github.com/larryprice/refermadness/models"\n  "net/http"\n)\n\ntype CurrentUserAccessor struct {\n  key int\n}\n\nfunc NewCurrentUserAccessor(key int) *CurrentUserAccessor {\n  return &CurrentUserAccessor{key}\n}\n\nfunc (cua *CurrentUserAccessor) Set(r *http.Request, user *models.User) {\n  context.Set(r, cua.key, user)\n}\n\nfunc (cua *CurrentUserAccessor) Clear(r *http.Request) {\n  context.Delete(r, cua.key)\n}\n\nfunc (cua *CurrentUserAccessor) Get(r *http.Request) *models.User {\n  if rv := context.Get(r, cua.key); rv != nil {\n    return rv.(*models.User)\n  }\n  return nil\n}\n```\n\n#### models/\n\nmodel \u662F\u4E3A\u4E86\u63CF\u8FF0\u6570\u636E\u5E93\u4E2D\u7684\u6570\u636E\u7684\u6570\u636E\u7ED3\u6784\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\u4F7F\u7528model\u6765\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C\u521B\u5EFA\u4E00\u4E2A\u7A7A\u7684model\uFF0C\u7136\u540E\u901A\u8FC7\u67E5\u8BE2\u6570\u636E\u5E93\u4E3A\u5176\u8D4B\u503C\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\uFF1A\n\n```Go\npackage models\n\nimport (\n  "gopkg.in/mgo.v2"\n  "gopkg.in/mgo.v2/bson"\n  "strings"\n  "time"\n)\n\ntype Service struct {\n  // identification information\n  ID          bson.ObjectId `bson:"_id"`\n  Name        string        `bson:"name"`\n  Description string        `bson:"description"`\n  URL         string        `bson:"url"`\n  Search      string        `bson:"search"`\n}\n\nfunc NewService(name, description, url string, creatorID bson.ObjectId) *Service {\n  url = strings.TrimPrefix(strings.TrimPrefix(url, "http://"), "https://")\n  return &Service{\n    ID:            bson.NewObjectId(),\n    Name:          name,\n    URL:           url,\n    Description:   description,\n    Search:        strings.ToLower(name) + ";" + strings.ToLower(description) + ";" + strings.ToLower(url),\n  }\n}\n\nfunc (s *Service) Save(db *mgo.Database) error {\n  _, err := s.coll(db).UpsertId(s.ID, s)\n  return err\n}\n\nfunc (s *Service) FindByID(id bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).FindId(id).One(s)\n}\n\nfunc (*Service) coll(db *mgo.Database) *mgo.Collection {\n  return db.C("service")\n}\n\ntype Services []Service\n\nfunc (s *Services) FindByIDs(ids []bson.ObjectId, db *mgo.Database) error {\n  return s.coll(db).Find(bson.M{"_id": bson.M{"$in": ids}}).Sort("name").All(s)\n}\n\nfunc (*Services) coll(db *mgo.Database) *mgo.Collection {\n  return db.C("service")\n}\n\n```\n\n#### views/\n\n\u5C06Golang\u7684\u6A21\u677F\u6587\u4EF6\u653E\u5230`views`\u76EE\u5F55\u4E0B\u3002\u8FD9\u6837\uFF0C\u4E0D\u7BA1\u7528\u4EC0\u4E48\u6837\u7684\u6A21\u677F\u5F15\u64CE\u90FD\u53EF\u4EE5\u76F4\u63A5\u653E\u5230`views`\u4E0B\u3002\n\n#### public/\n\n\u8DDF\u4EE5\u524D\u4E00\u6837\uFF0C\u8FD9\u4E2A\u6587\u4EF6\u90FD\u662F\u653E\u516C\u5F00\u7684\u6587\u4EF6\u7684\uFF0C\u4F8B\u5982`css`,`img`,`scripts`\u3002\n\n#### \u5982\u4F55\u8FD0\u884C\n\n\u6BEB\u65E0\u7591\u95EE\uFF0C\u6211\u6700\u559C\u6B22\u7684\u5C31\u662F[docker](https://www.docker.com/)\uFF0C\u56E0\u6B64\u6211\u5C06\u4F7F\u7528\u4ED6\u6765\u8FD0\u884C\u8FD9\u4E2A\u5E94\u7528\u3002\u5982\u679C\u4E0D\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u5C06\u6587\u4EF6\u653E\u5230`$GOPATH/src/github.com/larryprice/refermadness`,\u8FD0\u884C`go get`\u6765\u83B7\u53D6\u6240\u6709\u7684\u4F9D\u8D56\uFF0C\u7136\u540E\u8FD0\u884C `go run main.go`\u6216\u8005`go build; ./refermadness`\u8FD0\u884C\u7A0B\u5E8F\u3002\u5982\u679C\u4F60\u4E5F\u559C\u6B22\u4F7F\u7528docker\uFF0C\u90A3\u4E48\u53EF\u4EE5\u76F4\u63A5\u901A\u8FC7`Dockerfile`\u6765\u8FD0\u884C\u3002\n\n```\nFROM golang:1.4\n\nRUN go get github.com/codegangsta/gin\n\nADD . /go/src/github.com/larryprice/refermadness\nWORKDIR /go/src/github.com/larryprice/refermadness\nRUN go get\n```\n\n\u540C\u65F6\u6211\u4E5F\u5F88\u559C\u6B22[compose](https://github.com/docker/compose)\uFF0C\u6240\u4EE5\u6211\u4E5F\u901A\u8FC7compose \u6587\u4EF6\u6765\u8FD0\u884C\u6240\u6709\u7684\u5E94\u7528\u3002\u6211\u7528\u4E86JSC \uFF0CSASS\u548Cmongodb\uFF0C\u6240\u4EE5\u4E00\u4E0B\u662F\u6211\u7684`docker-compose.yml`\u6587\u4EF6\u3002\n\n```Go\nmain:\n  build: .\n  command: gin run\n  env_file: .env\n  volumes:\n    - ./:/go/src/github.com/larryprice/refermadness\n  working_dir: /go/src/github.com/larryprice/refermadness\n  ports:\n    - "3000:3000"\n  links:\n    - db\nsass:\n  image: larryprice/sass\n  volumes:\n    - ./public/css:/src\njsx:\n  image: larryprice/jsx\n  volumes:\n    - ./public/scripts:/src\ndb:\n  image: mongo:3.0\n  command: mongod --smallfiles --quiet --logpath=/dev/null\n  volumes_from:\n    - dbvolume\ndbvolume:\n  image: busybox:ubuntu-14.04\n  volumes:\n    - /data/db\n```\n\n\u7136\u540E\u8FD0\u884C`docker-compose up`\u6765\u8FD0\u884C\u6240\u6709\u7684\u5BB9\u5668\u5E76\u542F\u52A8\u670D\u52A1\u5668\u3002\n\n\n','date':'2015-11-11'},{'title':'HTTP/2 \u548CGO','tags':['http','HTTP/2','Translate','Go','backend'],'iso8601Date':'2015-11-12T19:39:21+08:00','basename':'HTTP-2-\u548CGO','body':'\n[\u539F\u6587\u5730\u5740](https://www.ianlewis.org/en/http2-and-go)\n\nHTTP/2\u662F\u4E00\u4E2A\u6DFB\u52A0\u4E86\u4E00\u4E9B\u65B0\u529F\u80FD\u7684HTTP\u7684\u65B0\u7248\u672C\uFF0C\u8FD9\u4E9B\u529F\u80FD\u5305\u62EC\u8FDE\u63A5\u590D\u7528\uFF0C\u9996\u90E8\u538B\u7F29\u3002\u518DGo\u7684\u6807\u51C6\u5E93\u4E2D\u6682\u65F6\u8FD8\u6CA1\u6709HTTP/2\u7684\u5B9E\u73B0\uFF0C\u4F46\u662F\u73B0\u5728\u6709\u5F88\u591A\u6B63\u5728\u5F00\u53D1\u7684\u5E93\u53EF\u4EE5\u7528\u6765\u5728Go\u4E2D\u5B9E\u73B0HTTP/2\u7684server\u548Cclient\u3002\n\nBrad Fitzpatrick\u5B9E\u73B0\u4E86\u4E00\u4E2A[golang.org/x/net/http2](https://godoc.org/golang.org/x/net/http2)\u7684\u5E93\uFF0C\u8FD9\u4E2A\u5E93\u751A\u81F3\u6700\u7EC8\u4F1A\u52A0\u5165\u5230\u6807\u51C6\u5E93\u4E2D\uFF0C\u4E0D\u8FC7\u4ED6\u73B0\u5728\u6B63\u5728\u5F00\u53D1\uFF0C\u6240\u4EE5\u5728\u5176\u4ED6\u7684\u5E93\u4E2D\u3002\u56E0\u4E3A\u4ED6\u73B0\u5728\u7684\u5F00\u53D1\u5F88\u6D3B\u8DC3\uFF0C\u6240\u6709\u60C5\u51B5\u56E0\u4EBA\u800C\u5F02\uFF0C\u4F46\u662F\u5982\u679C\u4F60\u60F3\u5B9E\u73B0HTTP/2\u7684\u670D\u52A1\u5668\uFF0C\u4ECD\u7136\u53EF\u4EE5\u4F7F\u7528\u8FD9\u4E2A\u5E93\u3002\n\n### \u521B\u5EFAHTTP/2\u670D\u52A1\u5668\n\n\u4F7F\u7528http2\u7684\u5E93\u5199\u4E00\u4E2A\u670D\u52A1\u5668\u662F\u5F88\u7B80\u5355\u7684\u3002http2\u5E93\u548C\u6807\u51C6\u5E93\u7684http\u5305\u96C6\u6210\u5728\u4E00\u8D77\uFF0C\u9700\u8981\u8C03\u7528`http2.ConfigureServer()`\u6765\u914D\u7F6E\u4E00\u4E2A\u666E\u901Ahttp\u4F7F\u7528HTTP/2\u534F\u8BAE\u3002\u5982\u679C\u9700\u8981\u901A\u8FC7\u6D4F\u89C8\u5668\u8BBF\u95EE\u6216\u8005\u964D\u7EA7\u5230HTTP 1.x \u534F\u8BAE\uFF0C\u90A3\u4E48\u4F60\u9700\u8981\u8BBE\u7F6ETLS \u52A0\u5BC6\u3002\u867D\u7136\u52A0\u5BC6\u4E0D\u662F\u5FC5\u987B\u7684\uFF0C\u4F46\u662F\u73B0\u5728\u8FD8\u6CA1\u6709\u6D4F\u89C8\u5668\u652F\u6301\u975E\u52A0\u5BC6\u7684HTTP/2\u534F\u8BAE\u3002\n\n```Go\npackage main\n\nimport (\n    "log"\n    "net/http"\n    "os"\n\n    "golang.org/x/net/http2"\n)\n\nfunc main() {\n    cwd, err := os.Getwd()\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    srv := &http.Server{\n        Addr:    ":8000", // Normally ":443"\n        Handler: http.FileServer(http.Dir(cwd)),\n    }\n    http2.ConfigureServer(srv, &http2.Server{})\n    log.Fatal(srv.ListenAndServeTLS("server.crt", "server.key"))\n}\n```\n\n### \u521B\u5EFAHTTP/2 \u5BA2\u6237\u7AEF\n\n\u73B0\u5728\u4F7F\u7528http2\u7684\u5E93\u521B\u5EFA\u5BA2\u6237\u7AEF\u5F88hacky\u3002\u867D\u7136\u5B83\u4F1A\u8F93\u51FA\u5F88\u591A\u8C03\u8BD5\u65E5\u5FD7\uFF0C\u4F46\u662F\u5BF9\u4E8E\u5927\u591A\u6570\u60C5\u51B5\u4E0B\u8FD0\u884C\u7684\u5F88\u597D\u3002\u53EF\u4EE5\u4F7F\u7528`http2.Transport`\u5BF9\u8C61\uFF0C\u5C06\u4ED6\u4F20\u7ED9`http`\u5305\u7684client\u3002\n\n```Go\npackage main\n\nimport (\n    "fmt"\n    "io/ioutil"\n    "log"\n    "net/http"\n\n    "golang.org/x/net/http2"\n)\n\nfunc main() {\n    client := http.Client{\n        // InsecureTLSDial is temporary and will likely be\n        // replaced by a different API later.\n        Transport: &http2.Transport{InsecureTLSDial: true},\n    }\n\n    resp, err := client.Get("https://localhost:8000/")\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    body, err := ioutil.ReadAll(resp.Body)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    fmt.Println(string(body))\n}\n```\n\n### \u66F4\u591A\u9605\u8BFB\n\n\u5982\u679C\u4F60\u5BF9HTTP/2\u534F\u8BAE\u611F\u5174\u8DA3\uFF0C\u90A3\u4E48\u53EF\u4EE5\u53C2\u8003[HTTP/2 \u4E3B\u9875](https://http2.github.io/)\uFF0C\u8FD9\u4E2A\u9875\u9762\u6709\u5F88\u591A\u5176\u4ED6\u8D44\u6599\u7684\u8FDE\u63A5\u8FD8\u6709\u5176\u4ED6\u8BED\u8A00\u7684\u5B9E\u73B0\u3002\n\n\u5982\u679C\u4F60\u60F3\u77E5\u9053HTTP/2\u7684\u670D\u52A1\u7AEF\u548C\u5BA2\u6237\u7AEF\u662F\u5982\u4F55\u5B9E\u73B0\u7684\uFF0C\u90A3\u4E48[Jxck\'s http2 implementation](https://github.com/Jxck/http2)\u7684\u5B9E\u73B0\u5C31\u5F88\u503C\u5F97\u4E00\u8BFB\u3002Jxck\u901A\u8FC7\u5BF9\u6807\u51C6\u7684HTTP\u5E93\u7684TLSNextProto\u8BBE\u7F6E\u4E00\u4E2A\u94A9\u5B50\u6765\u5B9E\u73B0\u7684\u3002\u4F60\u53EF\u4EE5\u518D\u8FD9\u91CC\u9605\u8BFB\u4E00\u4E9B[\u793A\u4F8B](https://github.com/Jxck/http2/blob/master/sample/http.go)\u3002\n\ngrpc-go \u5E93\u540C\u6837\u4E5F\u6709\u81EA\u5DF1\u7684\u670D\u52A1\u7AEF\u548C\u5BA2\u6237\u7AEF\u7684\u5B9E\u73B0\u3002\n','date':'2015-11-12'},{'title':'http.Handler \u4E0EGo\u7684\u9519\u8BEF\u5904\u7406','tags':['Go','Translate','backend'],'iso8601Date':'2015-11-13T05:24:57+08:00','basename':'http-Handler-\u4E0EGo\u7684\u9519\u8BEF\u5904\u7406','body':'\n\n[\u539F\u6587\u5730\u5740](http://elithrar.github.io/article/http-handler-error-handling-revisited/)\n\n \u5728\u4E4B\u524D\u6211\u5199\u8FC7\u4E00\u7BC7\u5173\u4E8E\u901A\u8FC7\u4F7F\u7528`http.HandlerFunc`\u6765\u5B9E\u73B0\u4E00\u4E2A\u5B9A\u5236handler\u7C7B\u578B\u7528\u6765\u907F\u514D\u4E00\u4E9B\u5E73\u5E38\u7684\u9519\u8BEF\u7684[\u6587\u7AE0](http://elithrar.github.io/article/custom-handlers-avoiding-globals/)\u3002`func MyHandler(w http.ResponseWriter, r *http.Request)`\u7684\u7B7E\u540D\u7ECF\u5E38\u53EF\u4EE5\u770B\u5230\u3002\u8FD9\u662F\u4E00\u4E2A\u6709\u7528\u7684\u901A\u7528\u7684\u5305\u542B\u4E00\u4E9B\u57FA\u672C\u529F\u80FD\u7684handler\u7C7B\u578B\uFF0C\u4F46\u662F\u548C\u5176\u4ED6\u4E8B\u60C5\u4E00\u6837\uFF0C\u4E5F\u6709\u4E00\u4E9B\u4E0D\u8DB3\uFF1A\n* \u5F53\u4F60\u60F3\u8981\u5728\u4E00\u4E2Ahandler\u4E2D\u505C\u6B62\u5904\u7406\u7684\u65F6\u5019\uFF0C\u5FC5\u987B\u8BB0\u5F97\u663E\u793A\u7684\u8C03\u7528\u4E00\u4E2Areturn\u3002\u8FD9\u4E2A\u5728\u5F53\u4F60\u60F3\u8981\u8DD1\u51FA\u4E00\u4E2A\u4ECE\u5B9A\u5411\uFF08301\u3001302\uFF09\uFF0C\u672A\u627E\u5230\uFF08404\uFF09\u6216\u8005\u670D\u52A1\u5668\u7AEF\u9519\u8BEF\uFF08500\uFF09\u7684\u72B6\u6001\u7684\u65F6\u5019\u662F\u5F88\u5E73\u5E38\u7684\u3002\u5982\u679C\u4E0D\u8FD9\u4E48\u505A\u53EF\u80FD\u4F1A\u5F15\u8D77\u4E00\u4E9B\u5FAE\u5999\u7684\u9519\u8BEF\uFF08\u51FD\u6570\u4F1A\u7EE7\u7EED\u6267\u884C\uFF09\uFF0C\u56E0\u4E3A\u51FD\u6570\u4E0D\u9700\u8981\u4E00\u4E2A\u8FD4\u56DE\u503C\uFF0C\u7F16\u8BD1\u5668\u4E5F\u4E0D\u4F1A\u8B66\u544A\u4F60\u3002\n* \u4E0D\u5BB9\u6613\u4F20\u9012\u989D\u5916\u7684\u53C2\u6570\uFF08\u4F8B\u5982\uFF0C\u6570\u636E\u5E93\u8FDE\u63A5\u6C60\uFF0C\u914D\u7F6E\uFF09\u3002\u4F60\u6700\u540E\u4E0D\u5F97\u4E0D\u5B9E\u7528\u4E00\u7CFB\u5217\u7684\u5168\u5C40\u53D8\u91CF\uFF08\u4E0D\u7B97\u592A\u574F\uFF0C\u4F46\u662F\u8DDF\u8E2A\u4ED6\u4EEC\u4F1A\u5BFC\u81F4\u96BE\u4EE5\u6269\u5C55\uFF09\u6216\u8005\u5C06\u4ED6\u4EEC\u5B58\u5230\u8BF7\u6C42\u4E0A\u4E0B\u6587\u4E2D\uFF0C\u7136\u540E\u6BCF\u6B21\u90FD\u4ECE\u5176\u53D6\u51FA\u3002\u8FD9\u6837\u505A\u5F88\u7B28\u91CD\u3002\n* \u4E00\u76F4\u5728\u4E0D\u65AD\u7684\u91CD\u590D\u540C\u6837\u7684\u8BED\u53E5\u3002\u60F3\u8981\u8BB0\u5F55\u6570\u636E\u5E93\u5305\u8FD4\u56DE\u7684\u9519\u8BEF\uFF1F\u65E2\u53EF\u4EE5\u518D\u6BCF\u4E2A\u67E5\u8BE2\u65B9\u6CD5\u4E2D\u8C03\u7528`log.Printf`\uFF0C\u4E5F\u53EF\u4EE5\u518D\u6BCF\u4E2Ahandler\u4E2D\u8FD4\u56DE\u9519\u8BEF\u3002\u5982\u679C\u4F60\u7684handler\u53EF\u4EE5\u8FD4\u56DE\u7ED9\u4E00\u4E2A\u96C6\u4E2D\u8BB0\u5F55\u9519\u8BEF\u7684\u51FD\u6570\uFF0C\u5E76\u4E14\u8DD1\u51FA\u4E00\u4E2A500\u7684\u9519\u8BEF\u5C31\u66F4\u597D\u4E86\u3002\n\n \u6211\u4EE5\u524D\u7684\u65B9\u6CD5\u4E2D\u4F7F\u7528\u4E86`func(http.ResponseWriter, *http.Request)`\u7B7E\u540D\u3002\u8FD9\u5DF2\u7ECF\u88AB\u8BC1\u660E\u662F\u4E00\u4E2A\u7B80\u4ECB\u7684\u65B9\u5F0F\uFF0C\u4F46\u662F\u6709\u4E2A\u5947\u602A\u7684\u5730\u65B9\u662F\uFF0C\u8FD4\u56DE\u4E00\u4E2A\u65E0\u9519\u8BEF\u7684\u72B6\u6001\uFF0C\u4F8B\u5982\uFF0C200,302,303\u5F80\u5F80\u662F\u591A\u4F59\u7684\uFF0C\u56E0\u4E3A\u8981\u4E48\u4F60\u5DF2\u7ECF\u5728\u5176\u4ED6\u5730\u65B9\u8BBE\u7F6E\u4E86\uFF0C\u8981\u4E48\u5C31\u662F\u6CA1\u7528\u7684\u3002\u4F8B\u5982\uFF1A\n\n```Go\nfunc SomeHandler(w http.ResponseWriter, r *http.Request) (int, error) {\n    db, err := someDBcall()\n    if err != nil {\n        // This makes sense.\n        return 500, err\n    }\n\n    if user.LoggedIn {\n        http.Redirect(w, r, "/dashboard", 302)\n        // Superfluous! Our http.Redirect function handles the 302, not \n        // our return value (which is effectively ignored).\n        return 302, nil\n    }\n\n}\n```\n\n\u770B\u8D77\u6765\u8FD8\u884C\uFF0C\u4F46\u662F\u6211\u4EEC\u53EF\u4EE5\u505A\u7684\u66F4\u597D\n\n### \u4E00\u4E9B\u533A\u522B\n\n \u90A3\u4E48\u6211\u4EEC\u5E94\u8BE5\u5982\u4F55\u6539\u8FDB\u5B83\uFF1F\u6211\u4EEC\u5148\u5217\u51FA\u4EE3\u7801\uFF1A\n\n```Go\npackage handler\n\n// Error represents a handler error. It provides methods for a HTTP status \n// code and embeds the built-in error interface.\ntype Error interface {\n    error\n    Status() int\n}\n\n// StatusError represents an error with an associated HTTP status code.\ntype StatusError struct {\n    Code int\n    Err  error\n}\n\n// Allows StatusError to satisfy the error interface.\nfunc (se StatusError) Error() string {\n    return se.Err.Error()\n}\n\n// Returns our HTTP status code.\nfunc (se StatusError) Status() int {\n    return se.Code\n}\n\n// A (simple) example of our application-wide configuration.\ntype Env struct {\n    DB   *sql.DB\n    Port string\n    Host string\n}\n\n// The Handler struct that takes a configured Env and a function matching\n// our useful signature.\ntype Handler struct {\n    *Env\n    H func(e *Env, w http.ResponseWriter, r *http.Request) error\n}\n\n// ServeHTTP allows our Handler type to satisfy http.Handler.\nfunc (h Handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    err := h.H(h.Env, w, r)\n    if err != nil {\n        switch e := err.(type) {\n        case Error:\n            // We can retrieve the status here and write out a specific\n            // HTTP status code.\n            log.Printf("HTTP %d - %s", e.Status(), e)\n            http.Error(w, e.Error(), e.Status())\n        default:\n            // Any error types we don\'t specifically look out for default\n            // to serving a HTTP 500\n            http.Error(w, http.StatusText(http.StatusInternalServerError),\n                http.StatusInternalServerError)\n        }\n    }\n}\n```\n\n \u4E0A\u9762\u7684\u4EE3\u7801\u4E0D\u8A00\u81EA\u660E\uFF0C\u4F46\u662F\u8981\u8BF4\u660E\u4E00\u4E0B\u4E00\u4E9B\u7A81\u51FA\u7684\u89C2\u70B9\uFF1A\n\n* \u6211\u4EEC\u81EA\u5B9A\u4E49\u4E86\u4E00\u4E2A`Error`\u7C7B\u578B\uFF08\u63A5\u53E3\uFF09\uFF0C\u4ED6\u5185\u5D4C\u4E86Go\u7684\u5185\u5EFA\u7684error\u63A5\u53E3\uFF0C\u540C\u65F6\u63D0\u4F9B\u4E86\u4E00\u4E2A`Status() int`\u65B9\u6CD5\u3002\n* \u6211\u4EEC\u63D0\u4F9B\u4E86\u4E00\u4E2A\u7B80\u5355\u7684`StatusError`\u7C7B\u578B\uFF08\u7ED3\u6784\u4F53\uFF09\uFF0C\u5B83\u6EE1\u8DB3`handler.Error`\u7684\u63A5\u53E3\u3002StatusError\u63A5\u53D7\u4E00\u4E2AHTTP\u7684\u72B6\u6001\u7801\uFF08int\u7C7B\u578B\uFF09\uFF0C\u4E00\u4E2A\u53EF\u4EE5\u8BA9\u6211\u4EEC\u5305\u88C5\u9519\u8BEF\u7528\u6765\u8BB0\u5F55\u6216\u8005\u67E5\u8BE2\u7684error\u7C7B\u578B\u3002\n* \u6211\u4EEC\u7684`ServeHTTP`\u65B9\u6CD5\u5305\u597D\u4E86\u4E00\u4E2A"e := err.(type)"\u7684\u7C7B\u578B\u65AD\u8A00\uFF0C\u5B83\u53EF\u4EE5\u6D4B\u8BD5\u6211\u4EEC\u9700\u8981\u5904\u7406\u7684\u9519\u8BEF\uFF0C\u5141\u8BB8\u6211\u4EEC\u5904\u7406\u90A3\u4E9B\u7279\u522B\u7684\u9519\u8BEF\u3002\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\uFF0C\u4ED6\u662F\u53EA\u662F\u4E00\u4E2A`handler.Error`\u7C7B\u578B\u3002\u5176\u4ED6\u7684\u9519\u8BEF\uFF0C\u4F8B\u5982\u5176\u4ED6\u5305\u4E2D\u7684\u9519\u8BEF\u60F3net.Error\uFF0C\u6216\u8005\u5176\u4ED6\u6211\u4EEC\u5B9A\u4E49\u7684\u989D\u5916\u7684\u9519\u8BEF\uFF0C\u5982\u679C\u60F3\u8981\u68C0\u67E5\uFF0C\u540C\u6837\u4E5F\u53EF\u4EE5\u68C0\u67E5\u3002\n\n \u5982\u679C\u6211\u4EEC\u4E0D\u60F3\u6355\u6349\u90A3\u4E9B\u9519\u8BEF\uFF0C\u90A3\u4E48`default`\u5C06\u4F1A\u9ED8\u8BA4\u6355\u6349\u5230\u3002\u8BB0\u4F4F\u4E00\u70B9\uFF0C`ServeHTTP`\u53EF\u4EE5\u4F7F\u6211\u4EEC\u7684Handler\u7C7B\u578B\u6EE1\u8DB3http.Handler\u63A5\u53E3\uFF0C\u8FD9\u6837\u4ED6\u5C31\u53EF\u4EE5\u5728\u4EFB\u4F55\u4F7F\u7528http.Handler\u7684\u5730\u65B9\u4F7F\u7528\u4E86\uFF0C\u4F8B\u5982Go\u7684net/http\u5305\u6216\u8005\u6240\u6709\u7684\u5176\u4ED6\u7684\u7B2C\u4E09\u65B9\u6846\u67B6\u3002\u8FD9\u6837\u4F7F\u5F97\u5B9A\u5236\u7684handler\u66F4\u6709\u7528\uFF0C\u4ED6\u4EEC\u7528\u8D77\u6765\u5F88\u7075\u6D3B\u3002\n \u6CE8\u610F net \u5305\u5904\u7406\u4E8B\u60C5\u5F88\u7B80\u5355\u3002\u5B83\u53C8\u4E00\u4E2Anet.Error\u7684\u63A5\u53E3\uFF0C\u5185\u5D4C\u4E86\u5185\u5EFA\u7684error\u63A5\u53E3\u3002\u4E00\u4E9B\u5177\u4F53\u7684\u7C7B\u578B\u5B9E\u73B0\u4E86\u5B83\u3002\u51FD\u6570\u8FD4\u56DE\u7684\u5177\u4F53\u7C7B\u578B\u8DDF\u9519\u8BEF\u7684\u7C7B\u578B\u76F8\u540C\uFF08DNS\u9519\u8BEF\uFF0C\u89E3\u6790\u9519\u8BEF\u7B49\uFF09\u3002\u518Ddatastore \u5305\u4E2D\u5B9A\u4E49\u7684DBError\u6709\u4E00\u4E2AQuery() string \u65B9\u6CD5\uFF0C\u53EF\u4EE5\u5F88\u597D\u7684\u89E3\u91CA\u3002\n\n### \u6240\u6709\u793A\u4F8B\n\n \u5B83\u6700\u540E\u662F\u4EC0\u4E48\u6837\u5B50\u7684\uFF1F\u6211\u4EEC\u662F\u5426\u53EF\u4EE5\u5C06\u5176\u5206\u5230\u4E0D\u540C\u7684\u5305\u4E2D\uFF1F\n\n```Go\npackage handler\n\nimport (\n    "net/http"\n)\n\n// Error represents a handler error. It provides methods for a HTTP status \n// code and embeds the built-in error interface.\ntype Error interface {\n    error\n    Status() int\n}\n\n// StatusError represents an error with an associated HTTP status code.\ntype StatusError struct {\n    Code int\n    Err  error\n}\n\n// Allows StatusError to satisfy the error interface.\nfunc (se StatusError) Error() string {\n    return se.Err.Error()\n}\n\n// Returns our HTTP status code.\nfunc (se StatusError) Status() int {\n    return se.Code\n}\n\n// A (simple) example of our application-wide configuration.\ntype Env struct {\n    DB   *sql.DB\n    Port string\n    Host string\n}\n\n// The Handler struct that takes a configured Env and a function matching\n// our useful signature.\ntype Handler struct {\n    *Env\n    H func(e *Env, w http.ResponseWriter, r *http.Request) error\n}\n\n// ServeHTTP allows our Handler type to satisfy http.Handler.\nfunc (h Handler) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    err := h.H(h.Env, w, r)\n    if err != nil {\n        switch e := err.(type) {\n        case Error:\n            // We can retrieve the status here and write out a specific\n            // HTTP status code.\n            log.Printf("HTTP %d - %s", e.Status(), e)\n            http.Error(w, e.Error(), e.Status())\n        default:\n            // Any error types we don\'t specifically look out for default\n            // to serving a HTTP 500\n            http.Error(w, http.StatusText(http.StatusInternalServerError),\n                http.StatusInternalServerError)\n        }\n    }\n}\n\nfunc GetIndex(env *Env, w http.ResponseWriter, r *http.Request) error {\n    users, err := env.DB.GetAllUsers()\n    if err != nil {\n        // We return a status error here, which conveniently wraps the error\n        // returned from our DB queries. We can clearly define which errors \n        // are worth raising a HTTP 500 over vs. which might just be a HTTP \n        // 404, 403 or 401 (as appropriate). It\'s also clear where our \n        // handler should stop processing by returning early.\n        return StatusError{500, err}\n    }\n\n    fmt.Fprintf(w, "%+v", users)\n    return nil\n}\n```\n\n main\u5305\uFF1A\n\n```Go\npackage main\n\nimport (\n    "net/http"\n    "github.com/you/somepkg/handler"\n)\n\nfunc main() {\n    db, err := sql.Open("connectionstringhere")\n    if err != nil {\n          log.Fatal(err)\n    }\n\n    // Initialise our app-wide environment with the services/info we need.\n    env := &handler.Env{\n        DB: db,\n        Port: os.Getenv("PORT"),\n        Host: os.Getenv("HOST"),\n        // We might also have a custom log.Logger, our \n        // template instance, and a config struct as fields \n        // in our Env struct.\n    }\n\n    // Note that we\'re using http.Handle, not http.HandleFunc. The \n    // latter only accepts the http.HandlerFunc type, which is not \n    // what we have here.\n    http.Handle("/", handler.Handler{env, handler.GetIndex})\n\n    // Logs the error if ListenAndServe fails.\n    log.Fatal(http.ListenAndServe(":8000", nil))\n}\n```\n\n \u5728\u5B9E\u9645\u4F7F\u7528\u65F6\uFF0C\u4F1A\u5C06handler\u548CEnv\u653E\u5165\u4E0D\u540C\u7684\u5305\u4E2D\uFF0C\u8FD9\u91CC\u53EA\u662F\u4E3A\u4E86\u7B80\u5355\u653E\u5728\u4E86\u540C\u4E00\u4E2A\u5305\u4E2D\u3002\n\n','date':'2015-11-13'},{'title':'\u4E3AGo Web App \u521B\u5EFA\u4E00\u4E2A\u4E3B\u9875\u9762','tags':['Go','Translate','backend'],'iso8601Date':'2015-11-15T01:59:00+08:00','basename':'\u4E3AGo-Web-App-\u521B\u5EFA\u4E00\u4E2A\u4E3B\u9875\u9762','body':'\n\n\n[\u539F\u6587\u5730\u5740](http://sanatgersappa.blogspot.com/2013/11/creating-master-page-for-your-go-web-app.html)\n\n \u5927\u591A\u6570web app\u90FD\u6709\u4E00\u4E2A\u76F8\u540C\u7684\u5E03\u5C40\u3002\u8FD9\u4E2A\u5E03\u5C40\u53EF\u80FD\u5305\u542B\u4E00\u4E2Aheader\u6216\u8005footer\uFF0C\u751A\u81F3\u53EF\u80FD\u5305\u542B\u4E00\u4E2A\u5BFC\u822A\u83DC\u5355\u3002Go\u7684\u6807\u51C6\u5E93\u63D0\u4F9B\u4E00\u4E2A\u7B80\u5355\u7684\u65B9\u5F0F\u6765\u521B\u5EFA\u8FD9\u4E9B\u57FA\u672C\u5143\u7D20\uFF0C\u901A\u8FC7\u88AB\u4E0D\u540C\u7684\u9875\u9762\u91CD\u7528\uFF0C\u521B\u5EFA\u51FA\u6A21\u677F\u9875\u7684\u6548\u679C\u3002\n \u8FD9\u4E2A\u7B80\u5355\u7684\u4F8B\u5B50\u6765\u89E3\u91CA\u5982\u4F55\u5B9E\u73B0\u7684\uFF1A\n \u8BA9\u6211\u4EEC\u6765\u521B\u5EFA\u4E00\u4E2A\u7B80\u5355\u7684\u5305\u542B\u4E24\u4E2Aview\u7684web app\uFF0C\u4E00\u4E2A\u662F main \u4E00\u4E2A\u662Fabout\u3002\u8FD9\u4E24\u4E2Aview\u90FD\u6709\u76F8\u540C\u7684header\u548Cfooter\u3002\n header\u6A21\u677F\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A\n\n```html\n{ { define "header" }}\n<!DOCTYPE html>\n<html>\n    <head>\n        <title>{ {.Title}}</title>\n        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">\n        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">\n        <style type="text/css">\n            body {padding-bottom: 70px;}\n            .content {margin:10px;}\n        <\/style>\n    </head>\n    <body>\n        <nav class="navbar navbar-default" role="navigation">\n          <div class="navbar-header">\n            <a class="navbar-brand" href="https://shjie047.github.io/">Go App</a>\n          </div>\n          <div class="collapse navbar-collapse navbar-ex1-collapse">  \n            <ul class="nav navbar-nav">\n                <li><a href="https://shjie047.github.io/">Main</a></li>\n                <li><a href="https://shjie047.github.io/about">About</a></li>\n            </ul>\n          </div>\n        </nav>\n{ { end }}\n```\n\n footer\u6A21\u677F\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A\n\n\n```html\n{ { define "footer" }}\n        <p class="navbar-text navbar-fixed-bottom">Go Rocks!</p>    \n        <"+"script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"><\/script>\n    </body>\n</html>\n{ { end }}\n\n```\n\n main \u6A21\u677F\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A\n\n```html\n{ {define "main"}}\n{ { template "header" .}}\n<div class="content">\n    <h2>Main</h2>\n    <div>This is the Main page</div>\n</div>\n{ {template "footer" .}}\n{ { end}}\n```\n\n about \u6A21\u677F\u7684\u4EE3\u7801\u5982\u4E0B\uFF1A\n\n```html\n{ {define "about"}}\n{ { template "header" .}}\n<div class="content">\n    <h2>About</h2>\n    <div>This is the About page</div>\n</div>\n{ {template "footer" .}}\n{ { end}}\n```\n\n \u670D\u52A1\u5668\u4EE3\u7801\u5982\u4E0B\uFF1A\n\n```Go\npackage main\n\nimport (\n    "html/template"\n    "net/http"\n)\n\n//Compile templates on start\nvar templates = template.Must(template.ParseFiles("header.html", "footer.html", "main.html", "about.html"))\n\n//A Page structure\ntype Page struct {\n    Title string\n}\n\n//Display the named template\nfunc display(w http.ResponseWriter, tmpl string, data interface{}) {\n    templates.ExecuteTemplate(w, tmpl, data)\n}\n\n//The handlers.\nfunc mainHandler(w http.ResponseWriter, r *http.Request) {\n    display(w, "main", &Page{Title: "Home"})\n}\n\nfunc aboutHandler(w http.ResponseWriter, r *http.Request) {\n    display(w, "about", &Page{Title: "About"})\n}\n\nfunc main() {\n    http.HandleFunc("/", mainHandler)\n    http.HandleFunc("/about", aboutHandler)\n\n    //Listen on port 8080\n    http.ListenAndServe(":8080", nil)\n}\n```\n\n \u6BCF\u4E00\u4E2A\u6A21\u677F\u9875\u90FD\u6709\u4E00\u4E2A `{ { define "name" }}`\u7684\u547D\u4EE4\u6765\u5B9A\u4E49\u6A21\u677F\u7684\u540D\u5B57\u3002main\u548Cabout\u9875\u9762\u901A\u8FC7`{ { template "name" }}`\u6765\u5305\u542Bheader\u548Cfooter\u3002`.` \u51FA\u5165\u4E0A\u4E0B\u6587\u6765\u547D\u540D\u6A21\u677F\u3002\u73B0\u5728\uFF0C\u4E0D\u7BA1main\u548Cabout\u9875\u9762\u5982\u4F55\u6267\u884C\uFF0C\u4ED6\u4EEC\u7684\u9875\u9762\u90FD\u4F1A\u5305\u542Bheader\u548Cfooter\u3002\n \u4E24\u4E2A\u9875\u9762\u7684\u7ED3\u679C\u5982\u4E0B\uFF1A\n\n![main](https://raw.githubusercontent.com/mashuai/hexo-blog/master/goweb/main.png)  \n![about](https://raw.githubusercontent.com/mashuai/hexo-blog/master/goweb/about.png)  \n','date':'2015-11-15'},{'title':'\u4F7F\u7528Go\u5F00\u53D1HTTP\u4E2D\u95F4\u4EF6','tags':['HTTP','Go','Middleware','backend'],'iso8601Date':'2015-11-12T20:07:49+08:00','basename':'\u4F7F\u7528Go\u5F00\u53D1HTTP\u4E2D\u95F4\u4EF6','body':'\n[\u539F\u6587\u5730\u5740](https://justinas.org/writing-http-middleware-in-go/)\n\n \u518Dweb\u5F00\u53D1\u7684\u80CC\u666F\u4E0B\uFF0C\u201C\u4E2D\u95F4\u4EF6\u201D\u901A\u5E38\u610F\u601D\u662F\u201C\u5305\u88C5\u539F\u59CB\u5E94\u7528\u5E76\u6DFB\u52A0\u4E00\u4E9B\u989D\u5916\u7684\u529F\u80FD\u7684\u5E94\u7528\u7684\u4E00\u90E8\u5206\u201D\u3002\u8FD9\u4E2A\u6982\u5FF5\u4F3C\u4E4E\u603B\u662F\u4E0D\u88AB\u4EBA\u7406\u89E3\uFF0C\u4F46\u662F\u6211\u8BA4\u4E3A\u4E2D\u95F4\u4EF6\u975E\u5E38\u68D2\u3002\n \u9996\u5148\uFF0C\u4E00\u4E2A\u597D\u7684\u4E2D\u95F4\u4EF6\u6709\u4E00\u4E2A\u8D23\u4EFB\u5C31\u662F\u53EF\u63D2\u62D4\u5E76\u4E14\u81EA\u8DB3\u3002\u8FD9\u5C31\u610F\u5473\u7740\u4F60\u53EF\u4EE5\u5728\u63A5\u53E3\u7EA7\u522B\u5D4C\u5165\u4F60\u7684\u4E2D\u95F4\u4EF6\u4ED6\u5C31\u80FD\u76F4\u63A5\u8FD0\u884C\u3002\u5B83\u4E0D\u4F1A\u5F71\u54CD\u4F60\u7F16\u7801\u65B9\u5F0F\uFF0C\u4E0D\u662F\u6846\u67B6\uFF0C\u4EC5\u4EC5\u662F\u4F60\u8BF7\u6C42\u5904\u7406\u91CC\u9762\u7684\u4E00\u5C42\u800C\u5DF2\u3002\u5B8C\u5168\u6CA1\u5FC5\u8981\u91CD\u5199\u4F60\u7684\u4EE3\u7801\uFF0C\u5982\u679C\u4F60\u60F3\u4F7F\u7528\u4E2D\u95F4\u4EF6\u7684\u4E00\u4E2A\u529F\u80FD\uFF0C\u4F60\u5C31\u5E2E\u4ED6\u63D2\u5165\u5230\u90A3\u91CC\uFF0C\u5982\u679C\u4E0D\u60F3\u4F7F\u7528\u4E86\uFF0C\u5C31\u53EF\u4EE5\u76F4\u63A5\u79FB\u9664\u3002\n \u7EB5\u89C2Go\u8BED\u8A00\uFF0C\u4E2D\u95F4\u4EF6\u662F\u975E\u5E38\u666E\u904D\u7684\uFF0C\u5373\u4F7F\u5728\u6807\u51C6\u5E93\u4E2D\u3002\u867D\u7136\u5F00\u59CB\u7684\u65F6\u5019\u4E0D\u4F1A\u90A3\u4E48\u660E\u663E\uFF0C\u5728\u6807\u51C6\u5E93`net/http`\u4E2D\u7684\u51FD\u6570`StripText`\u6216\u8005`TimeoutHandler`\u5C31\u662F\u6211\u4EEC\u8981\u5B9A\u4E49\u548C\u7684\u4E2D\u95F4\u4EF6\u7684\u6837\u5B50\uFF0C\u5904\u7406\u8BF7\u6C42\u548C\u76F8\u5E94\u7684\u65F6\u5019\u4ED6\u4EEC\u5305\u88C5\u4F60\u7684handler\uFF0C\u5E76\u5904\u7406\u4E00\u4E9B\u989D\u5916\u7684\u6B65\u9AA4\u3002\n \u6211\u6700\u8FD1\u5199\u7684Go\u5305[nosurf](https://github.com/justinas/nosurf)\u540C\u6837\u4E5F\u662F\u4E2A\u4E2D\u95F4\u4EF6\u3002\u6211\u7279\u610F\u5C06\u4ED6\u4ECE\u5934\u5F00\u59CB\u8BBE\u8BA1\u3002\u5728\u5927\u591A\u6570\u60C5\u51B5\u4E0B\uFF0C\u4F60\u4E0D\u9700\u8981\u5728\u5E94\u7528\u5C42\u62C5\u5FC3CSRF\u653B\u51FB\uFF0Cnosurf\u50CF\u5176\u4ED6\u7684\u4E2D\u95F4\u4EF6\u4E00\u6837\u53EF\u4EE5\u81EA\u8DB3\uFF0C\u5E76\u4E14\u548C`net/http`\u7684\u63A5\u53E3\u65E0\u7F1D\u8854\u63A5\u3002\n \u540C\u6837\u4F60\u8FD8\u53EF\u4EE5\u4F7F\u7528\u4E2D\u95F4\u4EF6\u505A\uFF1A\n* \u9690\u85CF\u957F\u5EA6\u9632\u6B62\u7F13\u51B2\u653B\u51FB\n* \u901F\u5EA6\u9650\u5236\n* \u5C4F\u853D\u722C\u866B\n* \u63D0\u4F9B\u8C03\u8BD5\u4FE1\u606F\n* \u6DFB\u52A0HSTS\uFF0CX-Frame-Options\u5934\n* \u4ECE\u9519\u8BEF\u4E2D\u6062\u590D\n* \u7B49\u7B49\n\n### \u7F16\u5199\u4E00\u4E2A\u7B80\u5355\u7684\u4E2D\u95F4\u4EF6\n\n \u6211\u4EEC\u7684\u7B2C\u4E00\u4E2A\u4F8B\u5B50\u662F\u5199\u4E00\u4E2A\u53EA\u5141\u8BB8\u4E00\u4E2A\u57DF\u540D\u4E0B\u7684\u7528\u6237\u8BBF\u95EE\u7684\u4E2D\u95F4\u4EF6\uFF0C\u901A\u8FC7HTTP\u7684`HOST`header\u5B9E\u73B0\u3002\u8FD9\u6837\u7684\u4E2D\u95F4\u4EF6\u53EF\u4EE5\u9632\u6B62[\u4E3B\u673A\u6B3A\u9A97\u653B\u51FB](http://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html)\u3002\n\n### \u7C7B\u578B\u7684\u673A\u6784\n\n \u9996\u5148\u6211\u4EEC\u5B9A\u4E49\u4E00\u4E2A\u7ED3\u6784\u4F53\uFF0C\u53EB\u505A`SingleHost`\n\n```Go\ntype SingleHost struct {\n    handler     http.Handler\n    allowedHost string\n}\n```\n\n \u5B83\u53EA\u5305\u542B\u4E24\u4E2Afield\u3002\n* \u5982\u679C\u662F\u4E00\u4E2A\u53EF\u7528\u7684Host\uFF0C\u90A3\u4E48\u6211\u4EEC\u4F1A\u8C03\u7528\u5D4C\u5165\u7684handler\u3002\n* allowedHost \u5C31\u662F\u5141\u8BB8\u7684Host\u3002\n \u56E0\u4E3A\u6211\u4EEC\u5C06\u5176\u9996\u5B57\u6BCD\u5C0F\u5199\uFF0C\u56E0\u6B64\u4ED6\u4EEC\u53EA\u5BF9\u672C\u5305\u53EF\u89C1\u3002\u6211\u4EEC\u9700\u8981\u7ED9\u5B83\u5B9A\u4E49\u5DF2\u7ED9\u6784\u9020\u51FD\u6570\u3002\n\n```Go\nfunc NewSingleHost(handler http.Handler, allowedHost string) *SingleHost {\n    return &SingleHost{handler: handler, allowedHost: allowedHost}\n}\n```\n\n### \u8BF7\u6C42\u5904\u7406\n\n \u73B0\u5728\u9700\u8981\u5B9E\u73B0\u771F\u6B63\u7684\u903B\u8F91\u529F\u80FD\u4E86\u3002\u60F3\u8981\u5B9E\u73B0`http.Handler`\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u5B9E\u73B0\u4ED6\u7684\u4E00\u4E2A\u65B9\u6CD5\u3002\n\n```Go\ntype Handler interface {\n        ServeHTTP(ResponseWriter, *Request)\n}\n```\n\n \u5B9E\u73B0\u5982\u4E0B\uFF1A\n\n```Go\nfunc (s *SingleHost) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    host := r.Host\n    if host == s.allowedHost {\n        s.handler.ServeHTTP(w, r)\n    } else {\n        w.WriteHeader(403)\n    }\n}\n```\n\n`ServeHTTP`\u53EA\u662F\u68C0\u67E5\u8BF7\u6C42\u7684Host\uFF1A\n* \u5982\u679CHost\u548C\u914D\u7F6E\u7684allowed\u4E00\u76F4\uFF0C\u90A3\u4E48\u8C03\u7528handler\u7684ServeHTTP\u3002\n* \u5982\u679C\u4E0D\u4E00\u76F4\u8FD4\u56DE403\n\u5BF9\u4E8E\u540E\u4E00\u79CD\u60C5\u51B5\uFF0C\u4E0D\u4EC5\u4E0D\u4F1A\u5F97\u5230\u5E94\u7B54\uFF0C\u8BBE\u7F6E\u4E0D\u77E5\u9053\u6709\u8FD9\u4E2A\u8BF7\u6C42\u3002\n\u73B0\u5728\u6211\u4EEC\u5DF2\u7ECF\u5F00\u53D1\u54C8\u4E86\u4E2D\u95F4\u4EF6\uFF0C\u53EA\u9700\u8981\u5C06\u5176\u63D2\u5165\u5230\u9700\u8981\u7684\u5730\u65B9\u3002\n\n```Go\nsingleHosted = NewSingleHost(myHandler, "example.com")\nhttp.ListenAndServe(":8080", singleHosted)\n```\n\n### \u53E6\u4E00\u79CD\u65B9\u5F0F\n\n \u6211\u4EEC\u521A\u521A\u5199\u7684\u90A3\u4E2A\u4E2D\u95F4\u4EF6\u5F88\u7B80\u5355\uFF0C\u5B83\u53EA\u670915\u884C\u4EE3\u7801\u3002\u5199\u8FD9\u6837\u7684\u4E2D\u95F4\u4EF6\uFF0C\u53EF\u4EE5\u4F7F\u7528\u6837\u677F\u65B9\u6CD5\u3002\u7531\u4E8EGo\u652F\u6301\u51FD\u6570\u4E3A\u4E00\u7B49\u516C\u6C11\u548C\u95ED\u5305\uFF0C\u5E76\u4E14\u6709`http.HandlerFunc`\u5305\u88C5\u51FD\u6570\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u4ED6\u521B\u5EFA\u4E00\u4E2A\u4E2D\u95F4\u4EF6\uFF0C\u800C\u4E0D\u662F\u5C06\u5176\u653E\u5165\u5230\u4E00\u4E2A\u7ED3\u6784\u4F53\u4E2D\u3002\u4E0B\u9762\u662F\u8FD9\u4E2A\u4E2D\u95F4\u4EF6\u7684\u5199\u6CD5\u3002\n\n```Go\nfunc SingleHost(handler http.Handler, allowedHost string) http.Handler {\n    ourFunc := func(w http.ResponseWriter, r *http.Request) {\n        host := r.Host\n        if host == allowedHost {\n            handler.ServeHTTP(w, r)\n        } else {\n            w.WriteHeader(403)\n        }\n    }\n    return http.HandlerFunc(ourFunc)\n}\n```\n \u6211\u4EEC\u5B9A\u4E49\u4E86\u4E00\u4E2A\u7B80\u5355\u7684\u51FD\u6570`SingleHost`\uFF0C\u5B83\u5305\u88C5\u4E86`Handler`\u548C\u5141\u8BB8\u7684Host\uFF0C\u5728\u5176\u5185\u90E8\u6211\u4EEC\u5B9E\u73B0\u4E86\u4E00\u4E2A\u8DDF\u4E0A\u9762\u4E2D\u95F4\u4EF6\u7C7B\u4F3C\u7684\u529F\u80FD\u3002\u6211\u4EEC\u5185\u90E8\u7684\u51FD\u6570\u5C31\u662F\u4E00\u4E2A\u95ED\u5305\uFF0C\u56E0\u6B64\u4ED6\u53EF\u4EE5\u8BBF\u95EE\u5916\u90E8\u51FD\u6570\u7684\u53D8\u91CF\u3002\u6700\u7EC8HandlerFunc\u8BA9\u6211\u4EEC\u53EF\u4EE5\u5C06\u5176\u53D8\u4E3AHandler\u3002\n \u89C9\u5F97\u662F\u4F7F\u7528HandlerFunc\u8FD8\u662F\u81EA\u5DF1\u5B9E\u73B0\u4E00\u4E2Ahttp.Handler\u5B8C\u5168\u53D6\u51B3\u4E8E\u4F60\u81EA\u5DF1\u3002\u5BF9\u4E8E\u7B80\u5355\u7684\u60C5\u51B5\uFF0C\u4E00\u4E2A\u7B80\u5355\u7684\u51FD\u6570\u5C31\u5B8C\u5168\u591F\u4E86\u3002\u5982\u679C\u4F60\u7684\u4E2D\u95F4\u4EF6\u8D8A\u6765\u8D8A\u591A\uFF0C\u90A3\u4E48\u5C31\u53EF\u4EE5\u8003\u8651\u5B9E\u73B0\u81EA\u5DF1\u7684\u7ED3\u6784\u5E76\u628A\u5B83\u4EEC\u5206\u5F00\u3002\n \u540C\u65F6\u6807\u51C6\u5E93\u540C\u65F6\u4F7F\u7528\u4E86\u4E24\u79CD\u529F\u80FD\u3002`StripPrefix`\u4F7F\u7528\u7684\u662FHandlerFunc\uFF0CTimeoutHandler\u4F7F\u7528\u7684\u662F\u81EA\u5B9A\u4E49\u7684\u7ED3\u6784\u4F53\u3002\n\n### \u4E00\u4E2A\u66F4\u590D\u6742\u7684\u4F8B\u5B50\n\n \u6211\u4EEC\u7684`SingleHost`\u5E76\u4E0D\u91CD\u8981\uFF0C\u6211\u4EEC\u53EA\u68C0\u6D4B\u4E00\u4E2A\u5C5E\u6027\uFF0C\u8981\u4E48\u5C06\u4ED6\u4F20\u9012\u7ED9\u5176\u4ED6\u7684handler\uFF0C\u8981\u4E48\u76F4\u63A5\u8FD4\u56DE\u3002\u7136\u800C\u5B58\u5728\u8FD9\u79CD\u60C5\u51B5\uFF0C\u6211\u4EEC\u7684\u7A0B\u5E8F\u9700\u8981\u5BF9\u5904\u7406\u5B8C\u8FDB\u884C\u540E\u7EED\u5904\u7406\u3002\n\n### \u6DFB\u52A0\u6570\u636E\u662F\u7B80\u5355\u7684\n\n \u5982\u679C\u53EA\u662F\u60F3\u7B80\u5355\u7684\u6DFB\u52A0\u6570\u636E\uFF0C\u90A3\u4E48\u4F7F\u7528Write\u5C31\u53EF\u4EE5\u4E86\u3002\n\n```Go\ntype AppendMiddleware struct {\n    handler http.Handler\n}\n\nfunc (a *AppendMiddleware) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    a.handler.ServeHTTP(w, r)\n    w.Write([]byte("Middleware says hello."))\n}\n```\n\n \u8FD4\u56DE\u7684\u7ED3\u6784\u80AF\u5B9A\u4F1A\u5305\u542B`Middleware says hello.`\n\n### \u95EE\u9898\n\n \u4F46\u662F\u64CD\u4F5C\u5176\u4ED6\u7684\u6570\u636E\u6709\u70B9\u56F0\u96BE\u3002\u4F8B\u5982\u6211\u4EEC\u60F3\u8981\u5728\u5B83\u524D\u9762\u6DFB\u52A0\u6570\u636E\u800C\u4E0D\u662F\u540E\u9762\u8FFD\u52A0\u3002\u5982\u679C\u6211\u4EEC\u5728\u539FHandler\u4E4B\u524D\u8C03\u7528Write\uFF0C\u90A3\u4E48\u5C06\u4F1A\u5931\u53BB\u63A7\u5236\uFF0C\u56E0\u4E3A\u7B2C\u4E00\u4E2AWrite\u5DF2\u7ECF\u5C06\u4ED6\u5199\u5165\u4E86\u3002\n \u901A\u8FC7\u5176\u4ED6\u65B9\u6CD5\u4FEE\u6539\u539F\u59CB\u8F93\u51FA\uFF0C\u4F8B\u5982\u66FF\u6362\u5B57\u7B26\u4E32\uFF0C\u6539\u53D8\u54CD\u5E94header\uFF0C\u6216\u8005\u8BBE\u7F6E\u72B6\u6001\u7801\u90FD\u4E0D\u4F1A\u8D77\u4F5C\u7528\uFF0C\u56E0\u4E3A\u5F53handler\u8FD4\u56DE\u7684\u65F6\u5019\u6570\u636E\u5DF2\u7ECF\u8FD4\u56DE\u5230\u5BA2\u6237\u7AEF\u4E86\u3002\n \u4E3A\u4E86\u5B9E\u73B0\u8FD9\u4E2A\u529F\u80FD\uFF0C\u6211\u4EEC\u9700\u8981\u4E00\u4E2A\u7279\u6B8A\u7684ResponseWriter\uFF0C\u4ED6\u53EF\u4EE5\u60F3buffer\u4E00\u6837\u5DE5\u4F5C\uFF0C\u6536\u96C6\u6570\u636E\uFF0C\u5B58\u50A8\u4EE5\u5907\u4F7F\u7528\u548C\u4FEE\u6539\u3002\u7136\u540E\u6211\u4EEC\u5C06\u8FD9\u4E2AResponseWriter\u4F20\u9012\u7ED9handler\uFF0C\u800C\u4E0D\u662F\u4F20\u9012\u771F\u662F\u7684RW\uFF0C\u8FD9\u6837\u5728\u5176\u4E4B\u524D\u6211\u4EEC\u5DF2\u7ECF\u4FEE\u6539\u4E86\u5B83\u4E86\u3002\n \u5E78\u8FD0\u7684\u662F\u5728\u6807\u51C6\u5E93\u4E2D\u6709\u8FD9\u6837\u7684\u4E00\u4E2A\u5DE5\u5177\u3002\u5728`net/http/httptest`\u5305\u91CC\u7684ResponseRecorder\u80FD\u505A\u6240\u6709\u6211\u4EEC\u9700\u8981\u7684\uFF1A\u4FDD\u5B58\u72B6\u6001\u7801\uFF0C\u4E00\u4E2A\u54CD\u5E94header\u7684map\uFF0C\u5C06body\u653E\u5165byte \u7F13\u51B2\u4E2D\u3002\u867D\u7136\u5B83\u662F\u518D\u6D4B\u8BD5\u4E2D\u4E2D\u4F7F\u7528\u7684\uFF0C\u4F46\u662F\u5F88\u670D\u52A1\u6211\u4EEC\u7684\u60C5\u51B5\u3002\n\n```Go\ntype ModifierMiddleware struct {\n    handler http.Handler\n}\n\nfunc (m *ModifierMiddleware) ServeHTTP(w http.ResponseWriter, r *http.Request) {\n    rec := httptest.NewRecorder()\n    // passing a ResponseRecorder instead of the original RW\n    m.handler.ServeHTTP(rec, r)\n    // after this finishes, we have the response recorded\n    // and can modify it before copying it to the original RW\n\n    // we copy the original headers first\n    for k, v := range rec.Header() {\n        w.Header()[k] = v\n    }\n    // and set an additional one\n    w.Header().Set("X-We-Modified-This", "Yup")\n    // only then the status code, as this call writes out the headers \n    w.WriteHeader(418)\n\n    // The body hasn\'t been written (to the real RW) yet,\n    // so we can prepend some data.\n    data := []byte("Middleware says hello again. ")\n\n    // But the Content-Length might have been set already,\n    // we should modify it by adding the length\n    // of our own data.\n    // Ignoring the error is fine here:\n    // if Content-Length is empty or otherwise invalid,\n    // Atoi() will return zero,\n    // which is just what we\'d want in that case.\n    clen, _ := strconv.Atoi(r.Header.Get("Content-Length"))\n    clen += len(data)\n    r.Header.Set("Content-Length", strconv.Itoa(clen))\n\n    // finally, write out our data\n    w.Write(data)\n    // then write out the original body\n    w.Write(rec.Body.Bytes())\n}\n```\n\u6700\u540E\u50F5\u5C38\u6211\u4EEC\u4E2D\u95F4\u4EF6\u7684\u8F93\u51FA\uFF1A\n\n```\nHTTP/1.1 418 I\'m a teapot\nX-We-Modified-This: Yup\nContent-Type: text/plain; charset=utf-8\nContent-Length: 37\nDate: Tue, 03 Sep 2013 18:41:39 GMT\n\nMiddleware says hello again. Success!\n```\n\u8FD9\u6837\u5C31\u5F00\u542F\u4E86\u4E00\u79CD\u65B0\u7684\u53EF\u80FD\uFF0C\u5305\u88C5\u7684handler\u5B8C\u5168\u624B\u63A7\u5236\u3002\n\n### \u548C\u5176\u4ED6handler\u5206\u4EAB\u6570\u636E\n\n \u5728\u5176\u4ED6\u4F8B\u5B50\u4E2D\uFF0C\u4E2D\u95F4\u4EF6\u53EF\u80FD\u9700\u8981\u66B4\u9732\u4E00\u4E9B\u4FE1\u606F\u7ED9\u5176\u4ED6\u4E2D\u95F4\u4EF6\u6216\u8005\u5E94\u7528\u672C\u8EAB\u3002\u4F8B\u5982nosurf\u9700\u8981\u7ED9\u5176\u4ED6\u7528\u6237\u8BBF\u95EECSRF token\u7684\u6743\u9650\u3002\n \u6700\u7B80\u5355\u662F\u662F\u4F7F\u7528\u4E00\u4E2Amap\uFF0C\u4F46\u662F\u901A\u5E38\u4E0D\u5E0C\u671B\u8FD9\u6837\u3002\u5B83\u5C06http.Request \u7684\u6307\u9488\u4F5C\u4E3Akey\uFF0C\u5176\u4ED6\u6570\u636E\u4F5C\u4E3Avalue\u3002\u4E0B\u9762\u662Fnosurf\u7684\u4F8B\u5B50\uFF0CGo\u7684map\u975E\u7EBF\u7A0B\u5B89\u5168\uFF0C\u6240\u4EE5\u8981\u81EA\u5DF1\u662F\u5B9E\u73B0\u3002\n\n```Go\ntype csrfContext struct {\n    token string\n    reason error\n}\n\nvar (\n    contextMap = make(map[*http.Request]*csrfContext)\n    cmMutex    = new(sync.RWMutex)\n)\n```\n \u6570\u636E\u7531Token\u8BBE\u7F6E\uFF1A\n\n```Go\nfunc Token(req *http.Request) string {\n    cmMutex.RLock()\n    defer cmMutex.RUnlock()\n\n    ctx, ok := contextMap[req]\n    if !ok {\n            return ""\n    }\n\n    return ctx.token\n}\n```\n\u6E90\u7801\u53EF\u4EE5\u518Dnosurf\u7684\u9879\u76EE\u7684[context.go](https://github.com/justinas/nosurf/blob/master/context.go)\u4E2D\u627E\u5230\u3002\n\n\n','date':'2015-11-12'}]},'siteData':{'title':'React Static'}};</script><script defer="" type="text/javascript" src="https://shjie047.github.io/bootstrap.26150f1d.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/templates/src/containers/Blog.15f46eeb.js"></script><script defer="" type="text/javascript" src="https://shjie047.github.io/main.7f3dbdf6.js"></script></body></html>